import { AIRecommendationEngine } from '../service/AIRecommendationService';
import { Recommendation, RecommendationContext, UserBehavior, BehaviorType, BehaviorContext } from '../model/UserBehaviorModel';
import { ActivityDetail } from '../model/ActivityModel';
import { LocationService } from '../utils/LocationUtils';
import { AnimationUtils } from '../utils/AnimationUtils';

/**
 * æ™ºèƒ½æ¨èå¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºä¸ªæ€§åŒ–æ¨èå†…å®¹
 */
@Component
export struct SmartRecommendationCard {
  @Prop recommendation: Recommendation;
  @Prop userId: string;
  @State isAnimating: boolean = false;
  @State isFavorited: boolean = false;

  private aiEngine: AIRecommendationEngine = AIRecommendationEngine.getInstance();

  // å¤„ç†æ¨èç‚¹å‡»
  private async handleRecommendationClick() {
    if (this.isAnimating) return;
    
    this.isAnimating = true;
    
    // è®°å½•ç”¨æˆ·è¡Œä¸º
    await this.recordUserBehavior(BehaviorType.CLICK);
    
    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
    await AnimationUtils.favoriteToggleAnimation(
      this.getUIContext(),
      { scale: (value) => {} },
      true,
      200
    );
    
    this.isAnimating = false;
    
    // è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µé¢
    // router.pushUrl({
    //   url: 'pages/activity/ActivityDetailPage',
    //   params: { id: this.recommendation.targetId }
    // });
  }

  // å¤„ç†æ”¶è—æ“ä½œ
  private async handleFavoriteToggle() {
    if (this.isAnimating) return;
    
    this.isAnimating = true;
    this.isFavorited = !this.isFavorited;
    
    // è®°å½•ç”¨æˆ·è¡Œä¸º
    await this.recordUserBehavior(
      this.isFavorited ? BehaviorType.FAVORITE : BehaviorType.VIEW
    );
    
    // æ·»åŠ æ”¶è—åŠ¨ç”»
    await AnimationUtils.favoriteToggleAnimation(
      this.getUIContext(),
      { scale: (value) => {} },
      this.isFavorited,
      300
    );
    
    this.isAnimating = false;
  }

  // è®°å½•ç”¨æˆ·è¡Œä¸º
  private async recordUserBehavior(behaviorType: BehaviorType) {
    const context: BehaviorContext = {
      timeOfDay: this.getTimeOfDay(),
      dayOfWeek: this.getDayOfWeek(),
      season: this.getCurrentSeason()
    };
    
    const behavior: UserBehavior = {
      id: `behavior_${Date.now()}`,
      userId: this.userId,
      behaviorType: behaviorType,
      targetId: this.recommendation.targetId,
      targetType: this.recommendation.targetType,
      timestamp: Date.now(),
      context: context
    };
    
    await this.aiEngine.recordUserBehavior(behavior);
  }

  // è·å–æ—¶é—´æ®µ
  private getTimeOfDay(): string {
    const hour = new Date().getHours();
    if (hour < 6) return 'night';
    if (hour < 12) return 'morning';
    if (hour < 18) return 'afternoon';
    return 'evening';
  }

  // è·å–æ˜ŸæœŸå‡ 
  private getDayOfWeek(): string {
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    return days[new Date().getDay()];
  }

  // è·å–å½“å‰å­£èŠ‚
  private getCurrentSeason(): string {
    const month = new Date().getMonth() + 1;
    if (month >= 3 && month <= 5) return 'spring';
    if (month >= 6 && month <= 8) return 'summer';
    if (month >= 9 && month <= 11) return 'autumn';
    return 'winter';
  }

  build() {
    Column() {
      // æ¨èæ ‡ç­¾
      Row() {
        Text('ğŸ¤– AIæ¨è')
          .fontSize(12)
          .fontColor('#1e40af')
          .backgroundColor('#f0f8ff')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(12)
        
        Blank()
        
        // æ¨èåˆ†æ•°
        Text(`${Math.round(this.recommendation.score * 100)}%`)
          .fontSize(12)
          .fontColor('#059669')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 8 })

      // æ¨èå›¾ç‰‡
      Stack() {
        Image(this.recommendation.imageUrl)
          .width('100%')
          .height(120)
          .borderRadius(12)
          .objectFit(ImageFit.Cover)
        
        // æ¨èç†ç”±æ ‡ç­¾
        Text(this.recommendation.reason)
          .fontSize(10)
          .fontColor(Color.White)
          .backgroundColor('rgba(0, 0, 0, 0.6)')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(8)
          .position({ x: 8, y: 8 })
      }
      .width('100%')
      .height(120)
      .margin({ bottom: 12 })

      // æ¨èå†…å®¹
      Column() {
        Text(this.recommendation.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 4 })
        
        Text(this.recommendation.description)
          .fontSize(14)
          .fontColor('#6b7280')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        // æ ‡ç­¾
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.recommendation?.tags ?? [], (tag: string, index: number) => {
            Text(`#${tag}`)
              .fontSize(10)
              .fontColor('#1e40af')
              .backgroundColor('#f0f8ff')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .margin({ right: 4, bottom: 4 })
          }, (tag: string, index: number) => `srec-tag-${index}-${tag}`)
        }
        .width('100%')
        .margin({ bottom: 12 })

        // æ“ä½œæŒ‰é’®
        Row() {
          Button() {
            Text('æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(14)
              .fontColor(Color.White)
          }
          .layoutWeight(1)
          .height(36)
          .backgroundColor('#1e40af')
          .borderRadius(18)
          .onClick(() => {
            this.handleRecommendationClick();
          })
          
          Button() {
            Text(this.isFavorited ? 'â¤ï¸' : 'ğŸ¤')
              .fontSize(16)
          }
          .width(36)
          .height(36)
          .backgroundColor(Color.Transparent)
          .borderRadius(18)
          .margin({ left: 8 })
          .onClick(() => {
            this.handleFavoriteToggle();
          })
        }
        .width('100%')
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .scale({ x: this.isAnimating ? 0.95 : 1, y: this.isAnimating ? 0.95 : 1 })
    .animation({
      duration: 200,
      curve: Curve.EaseInOut
    })
  }
}

/**
 * æ™ºèƒ½æ¨èåˆ—è¡¨ç»„ä»¶
 * æ˜¾ç¤ºä¸ªæ€§åŒ–æ¨èåˆ—è¡¨
 */
@Component
export struct SmartRecommendationList {
  @Prop userId: string;
  @Prop availableActivities: ActivityDetail[];
  @State recommendations: Recommendation[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';

  private aiEngine: AIRecommendationEngine = AIRecommendationEngine.getInstance();
  private locationService: LocationService = LocationService.getInstance();

  async aboutToAppear() {
    await this.loadRecommendations();
  }

  // åŠ è½½æ¨è
  private async loadRecommendations() {
    this.isLoading = true;
    this.errorMessage = '';
    
    try {
      // è·å–å½“å‰ä¸Šä¸‹æ–‡
      const context = await this.getRecommendationContext();
      
      // è·å–ä¸ªæ€§åŒ–æ¨è
      this.recommendations = await this.aiEngine.getPersonalizedRecommendations(
        this.userId,
        context,
        this.availableActivities
      );
      
      console.log(`è·å–åˆ° ${this.recommendations.length} ä¸ªä¸ªæ€§åŒ–æ¨è`);
    } catch (error) {
      console.error('åŠ è½½æ¨èå¤±è´¥:', error);
      this.errorMessage = 'æ¨èåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    }
    
    this.isLoading = false;
  }

  // è·å–æ¨èä¸Šä¸‹æ–‡
  private async getRecommendationContext(): Promise<RecommendationContext> {
    const currentLocation = await this.locationService.getCurrentLocation();
    
    const context: RecommendationContext = {
      currentLocation: currentLocation ? {
        latitude: currentLocation.latitude,
        longitude: currentLocation.longitude
      } : undefined,
      timeOfDay: this.getTimeOfDay(),
      weather: 'sunny', // æ¨¡æ‹Ÿå¤©æ°”ï¼Œå®é™…åº”ä»å¤©æ°”APIè·å–
      season: this.getCurrentSeason(),
      budget: 500, // æ¨¡æ‹Ÿé¢„ç®—
      timeAvailable: 4, // æ¨¡æ‹Ÿå¯ç”¨æ—¶é—´
      companions: 2 // æ¨¡æ‹ŸåŒè¡Œäººæ•°
    };
    
    return context;
  }

  // åˆ·æ–°æ¨è
  private async refreshRecommendations() {
    await this.loadRecommendations();
  }

  // è·å–æ—¶é—´æ®µ
  private getTimeOfDay(): string {
    const hour = new Date().getHours();
    if (hour < 6) return 'night';
    if (hour < 12) return 'morning';
    if (hour < 18) return 'afternoon';
    return 'evening';
  }

  // è·å–å½“å‰å­£èŠ‚
  private getCurrentSeason(): string {
    const month = new Date().getMonth() + 1;
    if (month >= 3 && month <= 5) return 'spring';
    if (month >= 6 && month <= 8) return 'summer';
    if (month >= 9 && month <= 11) return 'autumn';
    return 'winter';
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ğŸ¤– æ™ºèƒ½æ¨è')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
        
        Blank()
        
        Button() {
          Text('ğŸ”„')
            .fontSize(16)
            .fontColor('#6b7280')
        }
        .width(32)
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        .onClick(() => {
          this.refreshRecommendations();
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      // æ¨èå†…å®¹
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#1e40af')
          
          Text('AIæ­£åœ¨ä¸ºæ‚¨åˆ†æ...')
            .fontSize(14)
            .fontColor('#6b7280')
            .margin({ top: 12 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.errorMessage) {
        Column() {
          Text('âš ï¸')
            .fontSize(32)
            .fontColor('#f59e0b')
            .margin({ bottom: 8 })
          
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#6b7280')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 12 })
          
          Button() {
            Text('é‡è¯•')
              .fontSize(14)
              .fontColor(Color.White)
          }
          .height(32)
          .backgroundColor('#1e40af')
          .borderRadius(16)
          .onClick(() => {
            this.refreshRecommendations();
          })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.recommendations.length === 0) {
        Column() {
          Text('ğŸ¯')
            .fontSize(32)
            .fontColor('#6b7280')
            .margin({ bottom: 8 })
          
          Text('æš‚æ— ä¸ªæ€§åŒ–æ¨è')
            .fontSize(14)
            .fontColor('#6b7280')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.recommendations ?? [], (recommendation: Recommendation, index: number) => {
              SmartRecommendationCard({
                recommendation: recommendation,
                userId: this.userId
              })
              .margin({ bottom: 16 })
            }, (recommendation: Recommendation, index: number) => `srec-${index}-${recommendation.targetId}`)
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .scrollBar(BarState.Auto)
        .layoutWeight(1)
      }
    }
    .width('100%')
    .layoutWeight(1)
  }
}
