import { ARNavigationService, ARNavigationPoint, ARNavigationRoute, ARNavigationStatus } from '../service/ARNavigationService';
import { LocationInfo } from '../model/LocationModel';
import { AnimationUtils } from '../utils/AnimationUtils';

/**
 * ARå¯¼èˆªç®­å¤´ç»„ä»¶
 * æ˜¾ç¤ºå¯¼èˆªæ–¹å‘ç®­å¤´
 */
@Component
export struct ARNavigationArrow {
  @Prop navigationPoint: ARNavigationPoint;
  @Prop isVisible: boolean = true;
  @State arrowRotation: number = 0;
  @State pulseScale: number = 1.0;

  aboutToAppear() {
    this.startArrowAnimation();
  }

  // å¼€å§‹ç®­å¤´åŠ¨ç”»
  private startArrowAnimation() {
    // æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arrowRotation = this.navigationPoint.bearing;
    }, 100);

    // è„‰å†²åŠ¨ç”»
    setInterval(() => {
      this.pulseScale = this.pulseScale === 1.0 ? 1.2 : 1.0;
    }, 1000);
  }

  build() {
    if (this.isVisible) {
      Stack() {
        // ç®­å¤´èƒŒæ™¯
        Circle()
          .width(60)
          .height(60)
          .fill('#1e40af')
          .opacity(0.8)
        
        // ç®­å¤´å›¾æ ‡
        Text(this.navigationPoint.icon)
          .fontSize(24)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
        
        // è·ç¦»æ ‡ç­¾
        Text(`${this.navigationPoint.distance}m`)
          .fontSize(10)
          .fontColor(Color.White)
          .backgroundColor('rgba(0,0,0,0.6)')
          .padding({ left: 4, right: 4, top: 2, bottom: 2 })
          .borderRadius(8)
          .position({ x: 0, y: 35 })
      }
      .scale({ x: this.pulseScale, y: this.pulseScale })
      .rotate({ angle: this.arrowRotation })
      .animation({
        duration: 300,
        curve: Curve.EaseInOut
      })
    }
  }
}

/**
 * ARå¯¼èˆªä¿¡æ¯é¢æ¿
 * æ˜¾ç¤ºå¯¼èˆªä¿¡æ¯
 */
@Component
export struct ARNavigationInfoPanel {
  @Prop navigationPoint: ARNavigationPoint;
  @Prop isVisible: boolean = true;
  @State panelHeight: number = 0;

  build() {
    if (this.isVisible) {
      Column() {
        // å¯¼èˆªæ ‡é¢˜
        Text(this.navigationPoint.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .margin({ bottom: 8 })
        
        // å¯¼èˆªæè¿°
        Text(this.navigationPoint.description)
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ bottom: 12 })
        
        // è·ç¦»ä¿¡æ¯
        Row() {
          Text('ðŸ“')
            .fontSize(16)
            .margin({ right: 8 })
          
          Text(`${this.navigationPoint.distance}ç±³`)
            .fontSize(16)
            .fontColor('#059669')
            .fontWeight(FontWeight.Medium)
        }
        .justifyContent(FlexAlign.Start)
        .margin({ bottom: 8 })
        
        // æ–¹ä½ä¿¡æ¯
        Row() {
          Text('ðŸ§­')
            .fontSize(16)
            .margin({ right: 8 })
          
          Text(`æ–¹ä½è§’: ${Math.round(this.navigationPoint.bearing)}Â°`)
            .fontSize(14)
            .fontColor('#6b7280')
        }
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: 'rgba(0,0,0,0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .margin({ bottom: 16 })
    }
  }
}

/**
 * ARå¯¼èˆªæŽ§åˆ¶é¢æ¿
 * æä¾›å¯¼èˆªæŽ§åˆ¶åŠŸèƒ½
 */
@Component
export struct ARNavigationControlPanel {
  @Prop navigationStatus: ARNavigationStatus;
  @Prop onStartNavigation: () => void = () => {};
  @Prop onStopNavigation: () => void = () => {};
  @Prop onToggleNavigation: () => void = () => {};
  @Prop onCalibrate: () => void = () => {};

  build() {
    Row() {
      // å¼€å§‹/åœæ­¢å¯¼èˆªæŒ‰é’®
      Button() {
        Text(this.navigationStatus === ARNavigationStatus.IDLE ? 'å¼€å§‹å¯¼èˆª' : 'åœæ­¢å¯¼èˆª')
          .fontSize(14)
          .fontColor(Color.White)
      }
      .layoutWeight(1)
      .height(40)
      .backgroundColor(this.navigationStatus === ARNavigationStatus.IDLE ? '#059669' : '#dc2626')
      .borderRadius(20)
      .onClick(() => {
        if (this.navigationStatus === ARNavigationStatus.IDLE) {
          this.onStartNavigation();
        } else {
          this.onStopNavigation();
        }
      })
      
      // æš‚åœ/æ¢å¤æŒ‰é’®
      if (this.navigationStatus === ARNavigationStatus.NAVIGATING || 
          this.navigationStatus === ARNavigationStatus.PAUSED) {
        Button() {
          Text(this.navigationStatus === ARNavigationStatus.PAUSED ? 'â–¶ï¸' : 'â¸ï¸')
            .fontSize(16)
        }
        .width(40)
        .height(40)
        .backgroundColor('#f59e0b')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.onToggleNavigation();
        })
      }
      
      // æ ¡å‡†æŒ‰é’®
      Button() {
        Text('ðŸŽ¯')
          .fontSize(16)
        Text('æ ¡å‡†')
          .fontSize(10)
          .fontColor(Color.White)
          .margin({ top: 2 })
      }
      .width(50)
      .height(40)
      .backgroundColor('#6366f1')
      .borderRadius(20)
      .margin({ left: 8 })
      .onClick(() => {
        this.onCalibrate();
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }
}

/**
 * ARå¯¼èˆªä¸»ç•Œé¢
 * é›†æˆæ‰€æœ‰ARå¯¼èˆªåŠŸèƒ½
 */
@Component
export struct ARNavigationView {
  @State navigationService: ARNavigationService = ARNavigationService.getInstance();
  @State currentNavigationPoint: ARNavigationPoint | null = null;
  @State navigationStatus: ARNavigationStatus = ARNavigationStatus.IDLE;
  @State isARInitialized: boolean = false;
  @State showInfoPanel: boolean = true;
  @State cameraViewHeight: number = 300;

  // æ¨¡æ‹Ÿè·¯çº¿æ•°æ®
  private mockRoute: ARNavigationRoute = {
    id: 'route_1',
    startPoint: {
      latitude: 22.5431,
      longitude: 114.0579,
      address: 'æ·±åœ³å¸‚å—å±±åŒº',
      city: 'æ·±åœ³å¸‚',
      province: 'å¹¿ä¸œçœ',
      country: 'ä¸­å›½',
      accuracy: 10,
      timestamp: Date.now()
    },
    endPoint: {
      latitude: 22.5531,
      longitude: 114.0679,
      address: 'ä¸–ç•Œä¹‹çª—',
      city: 'æ·±åœ³å¸‚',
      province: 'å¹¿ä¸œçœ',
      country: 'ä¸­å›½',
      accuracy: 10,
      timestamp: Date.now()
    },
    waypoints: [],
    totalDistance: 1000,
    estimatedTime: 15,
    routeType: 'walking'
  };

  async aboutToAppear() {
    await this.initializeAR();
  }

  // åˆå§‹åŒ–AR
  private async initializeAR() {
    this.isARInitialized = await this.navigationService.initializeAR();
    if (this.isARInitialized) {
      this.navigationStatus = ARNavigationStatus.IDLE;
      console.log('ARå¯¼èˆªåˆå§‹åŒ–æˆåŠŸ');
    } else {
      console.error('ARå¯¼èˆªåˆå§‹åŒ–å¤±è´¥');
    }
  }

  // å¼€å§‹å¯¼èˆª
  private async startNavigation() {
    if (!this.isARInitialized) {
      await this.initializeAR();
    }
    
    const success = await this.navigationService.startARNavigation(this.mockRoute);
    if (success) {
      this.navigationStatus = ARNavigationStatus.NAVIGATING;
      this.updateNavigationPoint();
    }
  }

  // åœæ­¢å¯¼èˆª
  private stopNavigation() {
    this.navigationService.stopARNavigation();
    this.navigationStatus = ARNavigationStatus.IDLE;
    this.currentNavigationPoint = null;
  }

  // åˆ‡æ¢å¯¼èˆªçŠ¶æ€
  private toggleNavigation() {
    this.navigationService.toggleARNavigation();
    this.navigationStatus = this.navigationService.getNavigationStatus();
  }

  // æ ¡å‡†AR
  private async calibrateAR() {
    this.navigationStatus = ARNavigationStatus.CALIBRATING;
    
    // æ¨¡æ‹Ÿæ ¡å‡†è¿‡ç¨‹
    setTimeout(async () => {
      await this.navigationService.updateCurrentLocation();
      this.navigationStatus = ARNavigationStatus.IDLE;
    }, 2000);
  }

  // æ›´æ–°å¯¼èˆªç‚¹
  private updateNavigationPoint() {
    this.currentNavigationPoint = this.navigationService.getNextNavigationPoint();
  }

  // åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤º
  private toggleInfoPanel() {
    this.showInfoPanel = !this.showInfoPanel;
  }

  build() {
    Column() {
      // ARç›¸æœºè§†å›¾åŒºåŸŸ
      Stack() {
        // ç›¸æœºèƒŒæ™¯ï¼ˆæ¨¡æ‹Ÿï¼‰
        Column() {
          Text('ðŸ“·')
            .fontSize(48)
            .fontColor('#6b7280')
            .margin({ bottom: 8 })
          
          Text('ARç›¸æœºè§†å›¾')
            .fontSize(16)
            .fontColor('#6b7280')
            .margin({ bottom: 4 })
          
          Text('å®žæ—¶æ˜¾ç¤ºå¯¼èˆªç®­å¤´å’Œæ–¹å‘æŒ‡å¼•')
            .fontSize(12)
            .fontColor('#9ca3af')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(this.cameraViewHeight)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#f8fafc')
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        
        // ARå¯¼èˆªç®­å¤´
        if (this.currentNavigationPoint && this.navigationStatus === ARNavigationStatus.NAVIGATING) {
          ARNavigationArrow({
            navigationPoint: this.currentNavigationPoint,
            isVisible: true
          })
          .position({ x: '50%', y: '50%' })
          .translate({ x: -30, y: -30 })
        }
        
        // çŠ¶æ€æŒ‡ç¤ºå™¨
        if (this.navigationStatus === ARNavigationStatus.CALIBRATING) {
          Column() {
            LoadingProgress()
              .width(30)
              .height(30)
              .color('#1e40af')
            
            Text('ARæ ¡å‡†ä¸­...')
              .fontSize(12)
              .fontColor('#6b7280')
              .margin({ top: 8 })
          }
          .position({ x: '50%', y: '50%' })
          .translate({ x: -50, y: -20 })
        }
      }
      .width('100%')
      .height(this.cameraViewHeight)
      .margin({ bottom: 16 })

      // å¯¼èˆªä¿¡æ¯é¢æ¿
      if (this.showInfoPanel && this.currentNavigationPoint) {
        ARNavigationInfoPanel({
          navigationPoint: this.currentNavigationPoint,
          isVisible: true
        })
        .margin({ left: 16, right: 16, bottom: 16 })
      }

      // å¯¼èˆªæŽ§åˆ¶é¢æ¿
      ARNavigationControlPanel({
        navigationStatus: this.navigationStatus,
        onStartNavigation: () => this.startNavigation(),
        onStopNavigation: () => this.stopNavigation(),
        onToggleNavigation: () => this.toggleNavigation(),
        onCalibrate: () => this.calibrateAR()
      })
      .margin({ bottom: 16 })

      // åº•éƒ¨æ“ä½œæ 
      Row() {
        Button() {
          Text('ðŸ“')
            .fontSize(16)
            .margin({ right: 4 })
          Text('å®šä½')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .height(36)
        .backgroundColor('#f1f5f9')
        .borderRadius(18)
        .onClick(async () => {
          await this.navigationService.updateCurrentLocation();
          this.updateNavigationPoint();
        })
        
        Blank()
        
        Button() {
          Text(this.showInfoPanel ? 'ðŸ“‹' : 'ðŸ“‹')
            .fontSize(16)
            .margin({ right: 4 })
          Text(this.showInfoPanel ? 'éšè—' : 'æ˜¾ç¤º')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .height(36)
        .backgroundColor('#f1f5f9')
        .borderRadius(18)
        .onClick(() => {
          this.toggleInfoPanel();
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }
}
