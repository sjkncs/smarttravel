import { SocialTravelService } from '../service/SocialTravelService';
import { SocialUser, TravelShare, Comment, TravelChallenge, NearbyUser, ShareType } from '../model/SocialModel';
import { AnimationUtils } from '../utils/AnimationUtils';

/**
 * æ—…è¡Œåˆ†äº«å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºç”¨æˆ·çš„æ—…è¡Œåˆ†äº«å†…å®¹
 */
@Component
export struct TravelShareCard {
  @Prop share: TravelShare;
  @Prop currentUserId: string;
  @State isLiked: boolean = false;
  @State isAnimating: boolean = false;
  @State showComments: boolean = false;
  @State comments: Comment[] = [];
  @State newComment: string = '';

  private socialService: SocialTravelService = SocialTravelService.getInstance();

  async aboutToAppear() {
    await this.loadComments();
  }

  // åŠ è½½è¯„è®º
  private async loadComments() {
    this.comments = await this.socialService.getShareComments(this.share.id);
  }

  // å¤„ç†ç‚¹èµ
  private async handleLike() {
    if (this.isAnimating) return;
    
    this.isAnimating = true;
    
    if (this.isLiked) {
      await this.socialService.unlikeShare(this.share.id, this.currentUserId);
      this.isLiked = false;
    } else {
      await this.socialService.likeShare(this.share.id, this.currentUserId);
      this.isLiked = true;
    }
    
    // æ·»åŠ ç‚¹èµåŠ¨ç”»
    await AnimationUtils.favoriteToggleAnimation(
      this.getUIContext(),
      { scale: (value) => {} },
      this.isLiked,
      200
    );
    
    this.isAnimating = false;
  }

  // å¤„ç†è¯„è®º
  private async handleComment() {
    if (!this.newComment.trim()) return;
    
    try {
      await this.socialService.addComment(this.share.id, this.currentUserId, this.newComment);
      this.newComment = '';
      await this.loadComments();
    } catch (error) {
      console.error('æ·»åŠ è¯„è®ºå¤±è´¥:', error);
    }
  }

  // åˆ‡æ¢è¯„è®ºæ˜¾ç¤º
  private toggleComments() {
    this.showComments = !this.showComments;
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    
    if (diff < 60000) return 'åˆšåˆš';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
    return `${Math.floor(diff / 86400000)}å¤©å‰`;
  }

  build() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨
      Row() {
        // ç”¨æˆ·å¤´åƒ
        Image(this.share.userId === this.currentUserId ? 
          (this.socialService.getCurrentUser()?.avatar || '') : 
          (this.socialService.getUserById(this.share.userId)?.avatar || ''))
          .width(40)
          .height(40)
          .borderRadius(20)
          .objectFit(ImageFit.Cover)
        
        // ç”¨æˆ·ä¿¡æ¯
        Column() {
          Text(this.share.userId === this.currentUserId ? 
            (this.socialService.getCurrentUser()?.nickname || 'æˆ‘') : 
            (this.socialService.getUserById(this.share.userId)?.nickname || 'æœªçŸ¥ç”¨æˆ·'))
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .alignSelf(ItemAlign.Start)
          
          Text(this.formatTime(this.share.createdAt))
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        .layoutWeight(1)
        
        // æ›´å¤šæŒ‰é’®
        Button() {
          Text('â‹¯')
            .fontSize(16)
            .fontColor('#6b7280')
        }
        .width(32)
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // åˆ†äº«å†…å®¹
      Column() {
        Text(this.share.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        Text(this.share.content)
          .fontSize(14)
          .fontColor('#4b5563')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 12 })
        
        // åˆ†äº«å›¾ç‰‡
        if (this.share.images && this.share.images.length > 0) {
          Image(this.share.images[0])
            .width('100%')
            .height(200)
            .borderRadius(12)
            .objectFit(ImageFit.Cover)
            .margin({ bottom: 12 })
        }
        
        // ä½ç½®ä¿¡æ¯
        if (this.share.location) {
          Row() {
            Text('ğŸ“')
              .fontSize(14)
              .margin({ right: 6 })
            
            Text(this.share.location.name)
              .fontSize(12)
              .fontColor('#6b7280')
          }
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 12 })
        }
        
        // æ ‡ç­¾
        if (this.share.tags && this.share.tags.length > 0) {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.share.tags ?? [], (tag: string, index: number) => {
              Text(`#${tag}`)
                .fontSize(10)
                .fontColor('#1e40af')
                .backgroundColor('#f0f8ff')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(8)
                .margin({ right: 4, bottom: 4 })
            }, (tag: string, index: number) => `share-tag-${this.share.id}-${index}-${tag}`)
          }
          .width('100%')
          .margin({ bottom: 12 })
        }
      }
      .alignItems(HorizontalAlign.Start)

      // äº’åŠ¨æŒ‰é’®
      Row() {
        Button() {
          Text(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
            .fontSize(16)
            .margin({ right: 4 })
          Text(this.share.likes.toString())
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        .onClick(() => {
          this.handleLike();
        })
        
        Button() {
          Text('ğŸ’¬')
            .fontSize(16)
            .margin({ right: 4 })
          Text(this.share.comments.toString())
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        .onClick(() => {
          this.toggleComments();
        })
        
        Button() {
          Text('ğŸ“¤')
            .fontSize(16)
            .margin({ right: 4 })
          Text(this.share.shares.toString())
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        
        Blank()
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¯„è®ºåŒºåŸŸ
      if (this.showComments) {
        Column() {
          // è¯„è®ºåˆ—è¡¨
          ForEach(this.comments ?? [], (comment: Comment, index: number) => {
            Row() {
              Image(this.socialService.getUserById(comment.userId)?.avatar || '')
                .width(24)
                .height(24)
                .borderRadius(12)
                .objectFit(ImageFit.Cover)
              
              Column() {
                Text(this.socialService.getUserById(comment.userId)?.nickname || 'æœªçŸ¥ç”¨æˆ·')
                  .fontSize(12)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1f2937')
                  .alignSelf(ItemAlign.Start)
                
                Text(comment.content)
                  .fontSize(12)
                  .fontColor('#4b5563')
                  .alignSelf(ItemAlign.Start)
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 8 })
              .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 8 })
          }, (comment: Comment, index: number) => `cmt-${this.share.id}-${index}-${comment.userId}`)
          
          // æ·»åŠ è¯„è®º
          Row() {
            TextInput({ placeholder: 'æ·»åŠ è¯„è®º...' })
              .layoutWeight(1)
              .height(32)
              .fontSize(12)
              .onChange((value: string) => {
                this.newComment = value;
              })
            
            Button() {
              Text('å‘é€')
                .fontSize(12)
                .fontColor(Color.White)
            }
            .height(32)
            .backgroundColor('#1e40af')
            .borderRadius(16)
            .margin({ left: 8 })
            .onClick(() => {
              this.handleComment();
            })
          }
          .width('100%')
          .margin({ top: 8 })
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .margin({ bottom: 12 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
  }
}

/**
 * é™„è¿‘ç”¨æˆ·å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºé™„è¿‘çš„æ—…è¡Œç”¨æˆ·
 */
@Component
export struct NearbyUserCard {
  @Prop nearbyUser: NearbyUser;
  @Prop currentUserId: string;
  @State isFollowing: boolean = false;

  private socialService: SocialTravelService = SocialTravelService.getInstance();

  // å¤„ç†å…³æ³¨
  private async handleFollow() {
    if (this.isFollowing) {
      await this.socialService.unfollowUser(this.currentUserId, this.nearbyUser.user.userId);
      this.isFollowing = false;
    } else {
      await this.socialService.followUser(this.currentUserId, this.nearbyUser.user.userId);
      this.isFollowing = true;
    }
  }

  // æ ¼å¼åŒ–è·ç¦»
  private formatDistance(distance: number): string {
    if (distance < 1000) {
      return `${Math.round(distance)}m`;
    } else {
      return `${(distance / 1000).toFixed(1)}km`;
    }
  }

  build() {
    Row() {
      // ç”¨æˆ·å¤´åƒ
      Stack() {
        Image(this.nearbyUser.user.avatar)
          .width(50)
          .height(50)
          .borderRadius(25)
          .objectFit(ImageFit.Cover)
        
        // åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
        Circle()
          .width(12)
          .height(12)
          .fill(this.nearbyUser.isOnline ? '#10b981' : '#6b7280')
          .position({ x: 38, y: 38 })
      }
      
      // ç”¨æˆ·ä¿¡æ¯
      Column() {
        Text(this.nearbyUser.user.nickname)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
        
        Text(this.nearbyUser.user.bio || 'çƒ­çˆ±æ—…è¡Œçš„æ¢ç´¢è€…')
          .fontSize(12)
          .fontColor('#6b7280')
          .alignSelf(ItemAlign.Start)
          .margin({ top: 2 })
        
        Row() {
          Text('ğŸ“')
            .fontSize(10)
            .margin({ right: 4 })
          
          Text(this.formatDistance(this.nearbyUser.distance))
            .fontSize(10)
            .fontColor('#059669')
        }
        .justifyContent(FlexAlign.Start)
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
      
      // å…³æ³¨æŒ‰é’®
      Button() {
        Text(this.isFollowing ? 'å·²å…³æ³¨' : 'å…³æ³¨')
          .fontSize(12)
          .fontColor(this.isFollowing ? '#6b7280' : Color.White)
      }
      .height(28)
      .backgroundColor(this.isFollowing ? '#f1f5f9' : '#1e40af')
      .borderRadius(14)
      .onClick(() => {
        this.handleFollow();
      })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 8 })
  }
}

/**
 * æ—…è¡ŒæŒ‘æˆ˜å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºæ—…è¡ŒæŒ‘æˆ˜ä¿¡æ¯
 */
@Component
export struct TravelChallengeCard {
  @Prop challenge: TravelChallenge;
  @Prop currentUserId: string;
  @State isJoined: boolean = false;
  @State progress: number = 0;

  private socialService: SocialTravelService = SocialTravelService.getInstance();

  async aboutToAppear() {
    this.isJoined = this.challenge.participants.includes(this.currentUserId);
    if (this.isJoined) {
      // è·å–ç”¨æˆ·è¿›åº¦
      const userProgress = this.socialService.getUserById(this.currentUserId);
      // è¿™é‡Œåº”è¯¥ä»å®é™…æ•°æ®è·å–è¿›åº¦
      this.progress = 0;
    }
  }

  // å‚ä¸æŒ‘æˆ˜
  private async handleJoin() {
    if (this.isJoined) return;
    
    const success = await this.socialService.joinChallenge(this.currentUserId, this.challenge.id);
    if (success) {
      this.isJoined = true;
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  build() {
    Column() {
      // æŒ‘æˆ˜å¤´éƒ¨
      Row() {
        Text(this.challenge.icon)
          .fontSize(24)
          .margin({ right: 12 })
        
        Column() {
          Text(this.challenge.title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .alignSelf(ItemAlign.Start)
          
          Text(this.challenge.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.Start)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // æŒ‘æˆ˜è¿›åº¦
      if (this.isJoined) {
        Column() {
          Row() {
            Text('è¿›åº¦:')
              .fontSize(12)
              .fontColor('#6b7280')
            
            Text(`${this.progress}/${this.challenge.target} ${this.challenge.unit}`)
              .fontSize(12)
              .fontColor('#059669')
              .fontWeight(FontWeight.Medium)
              .margin({ left: 8 })
          }
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 8 })
          
          // è¿›åº¦æ¡
          Progress({ value: this.progress, total: this.challenge.target })
            .width('100%')
            .height(6)
            .color('#059669')
            .backgroundColor('#e5e7eb')
        }
        .width('100%')
        .margin({ bottom: 12 })
      }
      
      // æŒ‘æˆ˜ä¿¡æ¯
      Row() {
        Column() {
          Text('å¥–åŠ±')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(`${this.challenge.reward.points}ç§¯åˆ†`)
            .fontSize(12)
            .fontColor('#f59e0b')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text('å‚ä¸äººæ•°')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(this.challenge.participants.length.toString())
            .fontSize(12)
            .fontColor('#1e40af')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Column() {
          Text('æˆªæ­¢æ—¶é—´')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(this.formatTime(this.challenge.endDate))
            .fontSize(12)
            .fontColor('#dc2626')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Blank()
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // å‚ä¸æŒ‰é’®
      Button() {
        Text(this.isJoined ? 'å·²å‚ä¸' : 'å‚ä¸æŒ‘æˆ˜')
          .fontSize(14)
          .fontColor(Color.White)
      }
      .width('100%')
      .height(36)
      .backgroundColor(this.isJoined ? '#6b7280' : this.challenge.color)
      .borderRadius(18)
      .enabled(!this.isJoined)
      .onClick(() => {
        this.handleJoin();
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
  }
}
