import { geoLocationManager } from '@kit.LocationKit';
import { abilityAccessCtrl, bundleManager } from '@kit.AbilityKit';

@Component
export struct LocationBubble {
  @State isVisible: boolean = false;
  @State permissionStatus: string = 'denied';
  @State locationInfo: string = '';

  aboutToAppear() {
    this.checkLocationPermission();
  }

  // æ£€æŸ¥å®šä½æƒé™çŠ¶æ€
  private async checkLocationPermission() {
    try {
      // èŽ·å–tokenID
      let tokenID: number;
      try {
        const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION);
        tokenID = bundleInfo.appInfo.accessTokenId;
      } catch (err) {
        console.error('èŽ·å–bundleä¿¡æ¯å¤±è´¥:', err);
        this.permissionStatus = 'denied';
        this.isVisible = true;
        this.locationInfo = 'æ— æ³•èŽ·å–åº”ç”¨ä¿¡æ¯';
        return;
      }

      // æ£€æŸ¥æƒé™çŠ¶æ€
      const grantStatus = await abilityAccessCtrl.createAtManager().checkAccessToken(tokenID, 'ohos.permission.LOCATION');
      this.permissionStatus = grantStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED ? 'granted' : 'denied';
      
      if (this.permissionStatus === 'denied') {
        this.isVisible = true;
        this.locationInfo = 'éœ€è¦å¼€å¯å®šä½æƒé™ä»¥èŽ·å–å‘¨è¾¹æ™¯ç‚¹æŽ¨è';
      } else if (this.permissionStatus === 'granted') {
        this.isVisible = false;
        this.getLocationInfo();
      }
    } catch (error) {
      console.error('æ£€æŸ¥å®šä½æƒé™å¤±è´¥:', error);
      this.isVisible = true;
      this.locationInfo = 'å®šä½æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è®¾ç½®';
    }
  }

  // èŽ·å–ä½ç½®ä¿¡æ¯
  private async getLocationInfo() {
    try {
      const location = await geoLocationManager.getCurrentLocation();
      this.locationInfo = `å½“å‰ä½ç½®: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
    } catch (error) {
      console.error('èŽ·å–ä½ç½®å¤±è´¥:', error);
      this.locationInfo = 'èŽ·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
    }
  }

  // è¯·æ±‚å®šä½æƒé™
  private async requestLocationPermission() {
    try {
      // ä½¿ç”¨æ­£ç¡®çš„æƒé™è¯·æ±‚æ–¹æ³•
      // ä½¿ç”¨æ­£ç¡®çš„æƒé™è¯·æ±‚æ–¹æ³• - éœ€è¦ä¼ å…¥context
      const permission = await abilityAccessCtrl.createAtManager().requestPermissionsFromUser(getContext(), ['ohos.permission.LOCATION']);
      if (permission && permission.authResults && permission.authResults[0] === 0) {
        this.permissionStatus = 'granted';
        this.isVisible = false;
        this.getLocationInfo();
      } else {
        this.locationInfo = 'æƒé™è¯·æ±‚å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¼€å¯å®šä½æƒé™';
      }
    } catch (error) {
      console.error('è¯·æ±‚å®šä½æƒé™å¤±è´¥:', error);
      this.locationInfo = 'æƒé™è¯·æ±‚å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¼€å¯å®šä½æƒé™';
    }
  }

  // å…³é—­æ°”æ³¡
  private closeBubble() {
    this.isVisible = false;
  }

  build() {
    if (this.isVisible) {
      Stack() {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.3)')
          .onClick(() => {
            this.closeBubble();
          })
        
        // æ°”æ³¡å†…å®¹
        Column() {
          // æ°”æ³¡å¤´éƒ¨
          Row() {
            Text('ðŸ“')
              .fontSize(24)
              .fontColor('#1e40af')
            
            Text('å®šä½æœåŠ¡')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b')
              .margin({ left: 8 })
            
            Blank()
            
            Button() {
              Text('âœ•')
                .fontSize(16)
                .fontColor('#64748b')
            }
            .width(30)
            .height(30)
            .backgroundColor(Color.Transparent)
            .borderRadius(15)
            .onClick(() => {
              this.closeBubble();
            })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 12 })
          
          // æ°”æ³¡å†…å®¹
          Column() {
            Text(this.locationInfo)
              .fontSize(16)
              .fontColor('#475569')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })
            
            // æ“ä½œæŒ‰é’®
            Row() {
              Button() {
                Text('å–æ¶ˆ')
                  .fontSize(16)
                  .fontColor('#64748b')
              }
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#f1f5f9')
              .borderRadius(22)
              .margin({ right: 8 })
              .onClick(() => {
                this.closeBubble();
              })
              
              Button() {
                Text('å¼€å¯å®šä½')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(Color.White)
              }
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#1e40af')
              .borderRadius(22)
              .margin({ left: 8 })
              .onClick(() => {
                this.requestLocationPermission();
              })
            }
            .width('100%')
          }
          .padding({ left: 20, right: 20, bottom: 20 })
        }
        .width(320)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .shadow({
          radius: 20,
          color: 'rgba(0,0,0,0.15)',
          offsetX: 0,
          offsetY: 8
        })
        .position({ x: '50%', y: '50%' })
        .translate({ x: -160, y: -100 })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1000)
    }
  }
}
