import { NetworkConnectionManager } from '../managers/NetworkConnectionManager';
import { NetworkInfo, NetworkConnectivity } from '../services/NetworkService';

/**
 * ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ç»„ä»¶
 * æ˜¾ç¤ºå½“å‰ç½‘ç»œçŠ¶æ€ï¼ˆWi-Fi/èœ‚çª/ä¸å¯ç”¨ï¼‰
 */
@Component
export struct NetworkStatusIndicator {
  @State private networkInfo: NetworkInfo | null = null;
  @State private isExpanded: boolean = false;
  private manager: NetworkConnectionManager = NetworkConnectionManager.getInstance();
  private networkCallback = (info: NetworkInfo) => {
    this.networkInfo = info;
  };

  aboutToAppear() {
    // è®¢é˜…ç½‘ç»œå˜åŒ–
    this.manager.subscribe(this.networkCallback);
    // è·å–å½“å‰ç½‘ç»œä¿¡æ¯
    this.networkInfo = this.manager.getCurrentNetworkInfo();
  }

  aboutToDisappear() {
    // å–æ¶ˆè®¢é˜…
    this.manager.unsubscribe(this.networkCallback);
  }

  build() {
    if (this.isExpanded) {
      this.ExpandedView()
    } else {
      this.CompactView()
    }
  }

  @Builder CompactView() {
    Row() {
      Text(NetworkConnectionManager.getNetworkIcon(this.networkInfo))
        .fontSize(16)
        .margin({ right: 4 })

      Text(this.getCompactText())
        .fontSize(12)
        .fontColor(this.getStatusColor())
    }
    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
    .backgroundColor(this.getBackgroundColor())
    .borderRadius(12)
    .onClick(() => {
      this.isExpanded = !this.isExpanded;
    })
  }

  @Builder ExpandedView() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç½‘ç»œçŠ¶æ€')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)

        Text('âœ•')
          .fontSize(16)
          .fontColor('#999')
          .onClick(() => {
            this.isExpanded = false;
          })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ç½‘ç»œå›¾æ ‡å’ŒçŠ¶æ€
      Row() {
        Text(NetworkConnectionManager.getNetworkIcon(this.networkInfo))
          .fontSize(32)
          .margin({ right: 12 })

        Column() {
          Text(NetworkConnectionManager.getNetworkStatusText(this.networkInfo))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1a1a1a')

          if (this.networkInfo) {
            Text(this.getDetailText())
              .fontSize(12)
              .fontColor('#666')
              .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¿é€šæ€§æç¤º
      if (this.networkInfo) {
        this.ConnectivityTip()
      }

      // åˆ·æ–°æŒ‰é’®
      Button('åˆ·æ–°')
        .width('100%')
        .height(36)
        .fontSize(14)
        .backgroundColor('#f0f0f0')
        .fontColor('#666')
        .onClick(() => {
          this.manager.refreshNetworkInfo();
        })
    }
    .width(280)
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 12,
      color: 'rgba(0,0,0,0.15)',
      offsetX: 0,
      offsetY: 4
    })
    .onClick(() => {
      // é˜»æ­¢äº‹ä»¶å†’æ³¡
    })
  }

  @Builder ConnectivityTip() {
    Row() {
      Text(this.getConnectivityIcon())
        .fontSize(14)
        .margin({ right: 6 })

      Text(this.getConnectivityTipText())
        .fontSize(12)
        .fontColor(this.getConnectivityTipColor())
        .layoutWeight(1)
    }
    .width('100%')
    .padding(8)
    .backgroundColor(this.getConnectivityTipBackground())
    .borderRadius(8)
    .margin({ bottom: 12 })
  }

  private getCompactText(): string {
    if (!this.networkInfo) {
      return 'æ£€æŸ¥ä¸­...';
    }

    switch (this.networkInfo.connectivity) {
      case NetworkConnectivity.VALIDATED:
        return 'å·²è¿æ¥';
      case NetworkConnectivity.CHECKING:
        return 'æ£€æŸ¥ä¸­';
      case NetworkConnectivity.NOT_VALIDATED:
        return 'æ— äº’è”ç½‘';
      case NetworkConnectivity.UNAVAILABLE:
        return 'ä¸å¯ç”¨';
      default:
        return 'æœªçŸ¥';
    }
  }

  private getDetailText(): string {
    if (!this.networkInfo) {
      return '';
    }

    const parts: string[] = [];
    parts.push(`ç½‘ç»œID: ${this.networkInfo.netId}`);

    if (this.networkInfo.isMetered) {
      parts.push('è®¡è´¹ç½‘ç»œ');
    } else {
      parts.push('å…è´¹ç½‘ç»œ');
    }

    return parts.join(' Â· ');
  }

  private getConnectivityIcon(): string {
    if (!this.networkInfo) {
      return 'â„¹ï¸';
    }

    switch (this.networkInfo.connectivity) {
      case NetworkConnectivity.VALIDATED:
        return 'âœ…';
      case NetworkConnectivity.CHECKING:
        return 'ğŸ”„';
      case NetworkConnectivity.NOT_VALIDATED:
        return 'âš ï¸';
      case NetworkConnectivity.UNAVAILABLE:
        return 'âŒ';
      default:
        return 'â„¹ï¸';
    }
  }

  private getConnectivityTipText(): string {
    if (!this.networkInfo) {
      return 'æ­£åœ¨è·å–ç½‘ç»œä¿¡æ¯...';
    }

    switch (this.networkInfo.connectivity) {
      case NetworkConnectivity.VALIDATED:
        return 'ç½‘ç»œæ­£å¸¸ï¼Œå¯ä»¥è®¿é—®äº’è”ç½‘';
      case NetworkConnectivity.CHECKING:
        return 'æ­£åœ¨éªŒè¯ç½‘ç»œè¿é€šæ€§ï¼Œè¯·ç¨å€™...';
      case NetworkConnectivity.NOT_VALIDATED:
        return 'ç½‘ç»œå·²è¿æ¥ï¼Œä½†æ— æ³•è®¿é—®äº’è”ç½‘';
      case NetworkConnectivity.UNAVAILABLE:
        return 'ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
      default:
        return 'ç½‘ç»œçŠ¶æ€æœªçŸ¥';
    }
  }

  private getStatusColor(): string {
    if (!this.networkInfo) {
      return '#666';
    }

    switch (this.networkInfo.connectivity) {
      case NetworkConnectivity.VALIDATED:
        return '#52c41a'; // ç»¿è‰²
      case NetworkConnectivity.CHECKING:
        return '#1890ff'; // è“è‰²
      case NetworkConnectivity.NOT_VALIDATED:
        return '#faad14'; // æ©™è‰²
      case NetworkConnectivity.UNAVAILABLE:
        return '#f5222d'; // çº¢è‰²
      default:
        return '#666';
    }
  }

  private getBackgroundColor(): string {
    if (!this.networkInfo) {
      return '#f0f0f0';
    }

    switch (this.networkInfo.connectivity) {
      case NetworkConnectivity.VALIDATED:
        return '#f6ffed'; // æµ…ç»¿
      case NetworkConnectivity.CHECKING:
        return '#e6f7ff'; // æµ…è“
      case NetworkConnectivity.NOT_VALIDATED:
        return '#fffbe6'; // æµ…æ©™
      case NetworkConnectivity.UNAVAILABLE:
        return '#fff1f0'; // æµ…çº¢
      default:
        return '#f0f0f0';
    }
  }

  private getConnectivityTipColor(): string {
    return this.getStatusColor();
  }

  private getConnectivityTipBackground(): string {
    return this.getBackgroundColor();
  }
}
