/**
 * AIæ™ºèƒ½åŠ©æ‰‹ç»„ä»¶ - å¯åœ¨ä»»ä½•é¡µé¢ä½¿ç”¨
 * æä¾›è¯­éŸ³äº¤äº’ã€æ™ºèƒ½æ¨èã€å›¾åƒè¯†åˆ«ç­‰AIåŠŸèƒ½
 */
import { AIEngineManager, AIInput } from '../ai/AIEngineManager';

@Component
export struct AIAssistantWidget {
  @State isExpanded: boolean = false;
  @State aiResponse: string = '';
  @State isProcessing: boolean = false;
  @State inputText: string = '';
  
  private aiEngine = AIEngineManager.getInstance();

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      // AIåŠ©æ‰‹æ‚¬æµ®çƒ
      if (!this.isExpanded) {
        this.FloatingButton()
      } else {
        this.AIPanel()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder FloatingButton() {
    Button() {
      Column() {
        Text('ğŸ¤–')
          .fontSize(28)
        Text('AIåŠ©æ‰‹')
          .fontSize(10)
          .fontColor(Color.White)
          .margin({ top: 4 })
      }
    }
    .width(70)
    .height(70)
    .borderRadius(35)
    .backgroundColor('#0A59F7')
    .margin({ right: 20, bottom: 80 })
    .shadow({
      radius: 10,
      color: 'rgba(10, 89, 247, 0.3)',
      offsetX: 0,
      offsetY: 4
    })
    .onClick(() => {
      this.isExpanded = true;
    })
  }

  @Builder AIPanel() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Text('âœ•')
          .fontSize(24)
          .fontColor('#9ca3af')
          .onClick(() => {
            this.isExpanded = false;
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius({ topLeft: 16, topRight: 16 })

      // AIåŠŸèƒ½èœå•
      Scroll() {
        Column({ space: 12 }) {
          this.QuickAction('ğŸ¤ è¯­éŸ³å’¨è¯¢', 'è¯´å‡ºæ‚¨çš„éœ€æ±‚', () => this.handleVoice())
          this.QuickAction('ğŸ“· æ‹ç…§è¯†åˆ«', 'è¯†åˆ«æ™¯ç‚¹ã€ç¾é£Ÿ', () => this.handleCamera())
          this.QuickAction('âœ¨ æ™ºèƒ½æ¨è', 'ä¸ºæ‚¨æ¨èç²¾é€‰å†…å®¹', () => this.handleRecommend())
          this.QuickAction('ğŸ—ºï¸ è¡Œç¨‹è§„åˆ’', 'è§„åˆ’å®Œç¾è¡Œç¨‹', () => this.handlePlanTrip())
          
          // è¾“å…¥æ¡†
          Column({ space: 8 }) {
            Text('ğŸ’¬ æ–‡å­—å’¨è¯¢')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
            
            TextArea({ placeholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜...', text: this.inputText })
              .height(80)
              .borderRadius(8)
              .backgroundColor('#f3f4f6')
              .onChange((value) => {
                this.inputText = value;
              })
            
            Button('å‘é€')
              .width('100%')
              .backgroundColor('#0A59F7')
              .onClick(() => {
                this.handleTextInput();
              })
          }
          .width('100%')
          .padding(12)
          .backgroundColor(Color.White)
          .borderRadius(12)

          // AIå“åº”åŒºåŸŸ
          if (this.aiResponse) {
            Column({ space: 8 }) {
              Text('AIå›å¤ï¼š')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1f2937')
                .alignSelf(ItemAlign.Start)
              
              Text(this.aiResponse)
                .fontSize(14)
                .lineHeight(22)
                .fontColor('#374151')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#eef2ff')
            .borderRadius(12)
          }

          // åŠ è½½çŠ¶æ€
          if (this.isProcessing) {
            Row() {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#0A59F7')
              Text('AIæ€è€ƒä¸­...')
                .fontSize(14)
                .fontColor('#6b7280')
                .margin({ left: 8 })
            }
          }
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#f9fafb')
    }
    .width('90%')
    .height('70%')
    .margin({ right: 20, bottom: 20 })
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 20,
      color: 'rgba(0, 0, 0, 0.15)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder QuickAction(title: string, desc: string, action: () => void) {
    Row() {
      Column({ space: 4 }) {
        Text(title)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1f2937')
        Text(desc)
          .fontSize(12)
          .fontColor('#6b7280')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('â†’')
        .fontSize(20)
        .fontColor('#9ca3af')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(action)
  }

  /**
   * å¤„ç†è¯­éŸ³è¾“å…¥
   */
  private async handleVoice() {
    this.isProcessing = true;
    this.aiResponse = '';

    try {
      // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const input: AIInput = {
        type: 'voice',
        data: { text: 'æ¨èé™„è¿‘çš„ç¾é£Ÿ' }
      };

      const result = await this.aiEngine.process(input);
      
      if (result.success) {
        this.aiResponse = 'æ ¹æ®æ‚¨çš„ä½ç½®å’Œåå¥½ï¼Œä¸ºæ‚¨æ¨èï¼š\n\n' +
          '1. ğŸ¦ æ·±åœ³æ¹¾æµ·é²œå¤§æ’æ¡£ (è¯„åˆ†4.8)\n' +
          '   è·ç¦»1.2kmï¼Œäººå‡Â¥120\n\n' +
          '2. ğŸŒ¶ï¸ å·å‘³ç«é”…åŸ (è¯„åˆ†4.7)\n' +
          '   è·ç¦»2.5kmï¼Œäººå‡Â¥150';
      }
    } catch (error) {
      this.aiResponse = 'æŠ±æ­‰ï¼ŒAIå¤„ç†å‡ºé”™äº†';
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å¤„ç†æ‹ç…§è¯†åˆ«
   */
  private async handleCamera() {
    this.isProcessing = true;
    this.aiResponse = '';

    try {
      await new Promise(resolve => setTimeout(resolve, 800));
      
      this.aiResponse = 'ğŸ“¸ è¯†åˆ«ç»“æœï¼š\n\n' +
        'æ™¯ç‚¹ï¼šæ·±åœ³å¹³å®‰é‡‘èä¸­å¿ƒ\n' +
        'é«˜åº¦ï¼š599ç±³\n' +
        'å»ºæˆï¼š2017å¹´\n\n' +
        'ğŸ’¡ æ¨èï¼šè§‚å…‰å±‚ä½äº541ç±³ï¼Œé—¨ç¥¨Â¥200\n' +
        'æœ€ä½³æ‹æ‘„æ—¶é—´ï¼šå‚æ™š18:00-19:00';
    } catch (error) {
      this.aiResponse = 'è¯†åˆ«å¤±è´¥';
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å¤„ç†æ™ºèƒ½æ¨è
   */
  private async handleRecommend() {
    this.isProcessing = true;
    this.aiResponse = '';

    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      this.aiResponse = 'âœ¨ æ ¹æ®æ‚¨çš„å…´è¶£ï¼Œä¸ºæ‚¨æ¨èï¼š\n\n' +
        'ğŸï¸ ä¸œéƒ¨åä¾¨åŸ (åŒ¹é…åº¦95%)\n' +
        '   ç†ç”±ï¼šæ‚¨å–œæ¬¢è‡ªç„¶é£å…‰\n\n' +
        'ğŸ¢ æ¬¢ä¹è°·å¤œåœº (åŒ¹é…åº¦88%)\n' +
        '   ç†ç”±ï¼šé™„è¿‘çƒ­é—¨æ´»åŠ¨\n\n' +
        'ğŸŒ… æ·±åœ³æ¹¾çœ‹æ—¥è½ (åŒ¹é…åº¦85%)\n' +
        '   ç†ç”±ï¼šå¤©æ°”å¾ˆå¥½';
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å¤„ç†è¡Œç¨‹è§„åˆ’
   */
  private async handlePlanTrip() {
    this.isProcessing = true;
    this.aiResponse = '';

    try {
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      this.aiResponse = 'ğŸ—ºï¸ ä¸ºæ‚¨è§„åˆ’å‘¨æœ«2æ—¥æ¸¸ï¼š\n\n' +
        'ã€Day 1ã€‘\n' +
        '09:00 ä¸œéƒ¨åä¾¨åŸ\n' +
        '12:00 å±±é¡¶é¤å…åˆé¤\n' +
        '14:00 èŒ¶æºªè°·\n' +
        '18:00 æ·±åœ³æ¹¾æ™šé¤+æ—¥è½\n\n' +
        'ã€Day 2ã€‘\n' +
        '09:30 ä¸–ç•Œä¹‹çª—\n' +
        '12:30 æ¬¢ä¹æµ·å²¸åˆé¤\n' +
        '15:00 æµ·ä¸Šä¸–ç•Œ\n\n' +
        'é¢„ç®—ï¼šÂ¥1850  è·ç¦»ï¼š45km';
    } finally {
      this.isProcessing = false;
    }
  }

  /**
   * å¤„ç†æ–‡å­—è¾“å…¥
   */
  private async handleTextInput() {
    if (!this.inputText.trim()) {
      return;
    }

    this.isProcessing = true;
    const userInput = this.inputText;
    this.inputText = '';

    try {
      const input: AIInput = {
        type: 'text',
        data: { text: userInput }
      };

      const result = await this.aiEngine.process(input);
      
      if (result.success) {
        // æ ¹æ®æ„å›¾ç”Ÿæˆå›å¤
        const intent = result.data.intent;
        
        switch (intent) {
          case 'query_restaurant':
            this.aiResponse = 'ä¸ºæ‚¨æ¨èä»¥ä¸‹é¤å…ï¼š\n' +
              '1. æ·±åœ³æ¹¾æµ·é²œå¤§æ’æ¡£\n' +
              '2. å·å‘³ç«é”…åŸ\n' +
              '3. æ—¥å¼æ–™ç†åº—';
            break;
          case 'query_hotel':
            this.aiResponse = 'ä¸ºæ‚¨æ¨èé…’åº—ï¼š\n' +
              '1. æ·±åœ³æ¹¾ä¸‡è±ªé…’åº—\n' +
              '2. é¦™æ ¼é‡Œæ‹‰å¤§é…’åº—';
            break;
          default:
            this.aiResponse = `æ”¶åˆ°æ‚¨çš„å’¨è¯¢ï¼š"${userInput}"\n\n` +
              'æˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n' +
              'â€¢ æ¨èé¤å…å’Œæ™¯ç‚¹\n' +
              'â€¢ è§„åˆ’æ—…è¡Œè¡Œç¨‹\n' +
              'â€¢ è¯†åˆ«æ™¯ç‚¹å’Œç¾é£Ÿ';
        }
      }
    } catch (error) {
      this.aiResponse = 'æŠ±æ­‰ï¼Œå¤„ç†å¤±è´¥';
    } finally {
      this.isProcessing = false;
    }
  }
}
