import { EcoTravelService } from '../service/EcoTravelService';
import { CarbonFootprintRecord, EcoGoal, EcoSuggestion, GreenAttraction, 
         EcoAccommodation, EcoTransportation, EcoStats, EcoReport, 
         EcoActionType, CarbonFootprintType, EcoLevel } from '../model/EcoTravelModel';
import { AnimationUtils } from '../utils/AnimationUtils';

/**
 * ç¢³è¶³è¿¹å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºç”¨æˆ·çš„ç¢³è¶³è¿¹è®°å½•
 */
@Component
export struct CarbonFootprintCard {
  @Prop record: CarbonFootprintRecord;
  @State isExpanded: boolean = false;

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  // è·å–è¡Œä¸ºç±»å‹å›¾æ ‡
  private getActionIcon(action: EcoActionType): string {
    const icons: Record<EcoActionType, string> = {
      [EcoActionType.WALKING]: 'ğŸš¶',
      [EcoActionType.CYCLING]: 'ğŸš´',
      [EcoActionType.PUBLIC_TRANSPORT]: 'ğŸš‡',
      [EcoActionType.ELECTRIC_VEHICLE]: 'ğŸš—',
      [EcoActionType.CARPOOLING]: 'ğŸš™',
      [EcoActionType.OFFSET_CARBON]: 'ğŸŒ±',
      [EcoActionType.PLASTIC_FREE]: 'â™»ï¸',
      [EcoActionType.LOCAL_FOOD]: 'ğŸƒ',
      [EcoActionType.GREEN_ACCOMMODATION]: 'ğŸ¨',
      [EcoActionType.WASTE_REDUCTION]: 'ğŸ—‘ï¸'
    };
    return icons[action] || 'ğŸŒ';
  }

  // è·å–è¡Œä¸ºç±»å‹åç§°
  private getActionName(action: EcoActionType): string {
    const names: Record<EcoActionType, string> = {
      [EcoActionType.WALKING]: 'æ­¥è¡Œ',
      [EcoActionType.CYCLING]: 'éª‘è¡Œ',
      [EcoActionType.PUBLIC_TRANSPORT]: 'å…¬å…±äº¤é€š',
      [EcoActionType.ELECTRIC_VEHICLE]: 'ç”µåŠ¨è½¦',
      [EcoActionType.CARPOOLING]: 'æ‹¼è½¦',
      [EcoActionType.OFFSET_CARBON]: 'ç¢³æŠµæ¶ˆ',
      [EcoActionType.PLASTIC_FREE]: 'æ— å¡‘æ–™',
      [EcoActionType.LOCAL_FOOD]: 'æœ¬åœ°é£Ÿç‰©',
      [EcoActionType.GREEN_ACCOMMODATION]: 'ç»¿è‰²ä½å®¿',
      [EcoActionType.WASTE_REDUCTION]: 'å‡å°‘æµªè´¹'
    };
    return names[action] || 'ç¯ä¿è¡Œä¸º';
  }

  build() {
    Column() {
      // ä¸»è¦ä¿¡æ¯
      Row() {
        Text(this.getActionIcon(this.record.action))
          .fontSize(24)
          .margin({ right: 12 })
        
        Column() {
          Text(this.getActionName(this.record.action))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .alignSelf(ItemAlign.Start)
          
          Text(`${this.record.carbonEmission.toFixed(2)} kg COâ‚‚`)
            .fontSize(14)
            .fontColor('#059669')
            .fontWeight(FontWeight.Medium)
            .alignSelf(ItemAlign.Start)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        Column() {
          Text(this.formatTime(this.record.timestamp))
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.End)
          
          if (this.record.distance) {
            Text(`${this.record.distance} km`)
              .fontSize(12)
              .fontColor('#6b7280')
              .alignSelf(ItemAlign.End)
              .margin({ top: 2 })
          }
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .margin({ bottom: 8 })

      // è¯¦ç»†ä¿¡æ¯ï¼ˆå¯å±•å¼€ï¼‰
      if (this.isExpanded) {
        Column() {
          if (this.record.location) {
            Row() {
              Text('ğŸ“')
                .fontSize(14)
                .margin({ right: 6 })
              
              Text(this.record.location.address)
                .fontSize(12)
                .fontColor('#6b7280')
            }
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 8 })
          }
          
          if (this.record.duration) {
            Row() {
              Text('â±ï¸')
                .fontSize(14)
                .margin({ right: 6 })
              
              Text(`${this.record.duration} å°æ—¶`)
                .fontSize(12)
                .fontColor('#6b7280')
            }
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 8 })
          }
          
          Row() {
            Text('ğŸ“Š')
              .fontSize(14)
              .margin({ right: 6 })
            
            Text(`${this.record.amount || 1} ${this.record.unit}`)
              .fontSize(12)
              .fontColor('#6b7280')
          }
          .justifyContent(FlexAlign.Start)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .margin({ bottom: 8 })
      }

      // å±•å¼€/æ”¶èµ·æŒ‰é’®
      Button() {
        Text(this.isExpanded ? 'æ”¶èµ·' : 'è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#1e40af')
      }
      .height(24)
      .backgroundColor(Color.Transparent)
      .borderRadius(12)
      .onClick(() => {
        this.isExpanded = !this.isExpanded;
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 12 })
  }
}

/**
 * ç¯ä¿å»ºè®®å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºç¯ä¿å»ºè®®å’Œæç¤º
 */
@Component
export struct EcoSuggestionCard {
  @Prop suggestion: EcoSuggestion;
  @State isExpanded: boolean = false;

  // è·å–éš¾åº¦é¢œè‰²
  private getDifficultyColor(difficulty: EcoLevel): string {
    const colors: Record<EcoLevel, string> = {
      [EcoLevel.BEGINNER]: '#10b981',
      [EcoLevel.INTERMEDIATE]: '#f59e0b',
      [EcoLevel.ADVANCED]: '#ef4444',
      [EcoLevel.EXPERT]: '#8b5cf6'
    };
    return colors[difficulty] || '#6b7280';
  }

  // è·å–éš¾åº¦åç§°
  private getDifficultyName(difficulty: EcoLevel): string {
    const names: Record<EcoLevel, string> = {
      [EcoLevel.BEGINNER]: 'åˆçº§',
      [EcoLevel.INTERMEDIATE]: 'ä¸­çº§',
      [EcoLevel.ADVANCED]: 'é«˜çº§',
      [EcoLevel.EXPERT]: 'ä¸“å®¶'
    };
    return names[difficulty] || 'æœªçŸ¥';
  }

  // è·å–è¡Œä¸ºç±»å‹å›¾æ ‡
  private getActionIcon(action: EcoActionType): string {
    const icons: Record<EcoActionType, string> = {
      [EcoActionType.WALKING]: 'ğŸš¶',
      [EcoActionType.CYCLING]: 'ğŸš´',
      [EcoActionType.PUBLIC_TRANSPORT]: 'ğŸš‡',
      [EcoActionType.ELECTRIC_VEHICLE]: 'ğŸš—',
      [EcoActionType.CARPOOLING]: 'ğŸš™',
      [EcoActionType.OFFSET_CARBON]: 'ğŸŒ±',
      [EcoActionType.PLASTIC_FREE]: 'â™»ï¸',
      [EcoActionType.LOCAL_FOOD]: 'ğŸƒ',
      [EcoActionType.GREEN_ACCOMMODATION]: 'ğŸ¨',
      [EcoActionType.WASTE_REDUCTION]: 'ğŸ—‘ï¸'
    };
    return icons[action] || 'ğŸŒ';
  }

  build() {
    Column() {
      // å»ºè®®å¤´éƒ¨
      Row() {
        Text(this.getActionIcon(this.suggestion.category))
          .fontSize(24)
          .margin({ right: 12 })
        
        Column() {
          Text(this.suggestion.title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .alignSelf(ItemAlign.Start)
          
          Text(this.suggestion.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.Start)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        // éš¾åº¦æ ‡ç­¾
        Text(this.getDifficultyName(this.suggestion.difficulty))
          .fontSize(10)
          .fontColor(Color.White)
          .backgroundColor(this.getDifficultyColor(this.suggestion.difficulty))
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(8)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // å½±å“å’Œæ”¶ç›Š
      Row() {
        Column() {
          Text('ç¯ä¿å½±å“')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(`${this.suggestion.impact}/5`)
            .fontSize(14)
            .fontColor('#059669')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text('èŠ‚çœç¢³æ’æ”¾')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(`${this.suggestion.savings.carbon}kg COâ‚‚`)
            .fontSize(14)
            .fontColor('#059669')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Column() {
          Text('èŠ‚çœè´¹ç”¨')
            .fontSize(10)
            .fontColor('#6b7280')
          
          Text(`Â¥${this.suggestion.savings.money}`)
            .fontSize(14)
            .fontColor('#f59e0b')
            .fontWeight(FontWeight.Medium)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Blank()
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¯¦ç»†æç¤ºï¼ˆå¯å±•å¼€ï¼‰
      if (this.isExpanded && this.suggestion.tips.length > 0) {
        Column() {
          Text('ğŸ’¡ å®æ–½å»ºè®®')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })
          
          ForEach(this.suggestion.tips, (tip: string, index: number) => {
            Row() {
              Text(`${index + 1}.`)
                .fontSize(12)
                .fontColor('#6b7280')
                .margin({ right: 8 })
              
              Text(tip)
                .fontSize(12)
                .fontColor('#4b5563')
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 4 })
          })
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f0f8ff')
        .borderRadius(8)
        .margin({ bottom: 12 })
      }

      // å±•å¼€/æ”¶èµ·æŒ‰é’®
      Button() {
        Text(this.isExpanded ? 'æ”¶èµ·' : 'æŸ¥çœ‹å»ºè®®')
          .fontSize(12)
          .fontColor('#1e40af')
      }
      .height(28)
      .backgroundColor('#f0f8ff')
      .borderRadius(14)
      .onClick(() => {
        this.isExpanded = !this.isExpanded;
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
  }
}

/**
 * ç»¿è‰²æ™¯ç‚¹å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºç»¿è‰²æ™¯ç‚¹ä¿¡æ¯
 */
@Component
export struct GreenAttractionCard {
  @Prop attraction: GreenAttraction;
  @State isExpanded: boolean = false;

  build() {
    Column() {
      // æ™¯ç‚¹å›¾ç‰‡
      Stack() {
        Image(this.attraction.images[0])
          .width('100%')
          .height(120)
          .borderRadius(12)
          .objectFit(ImageFit.Cover)
        
        // ç¯ä¿è¯„çº§
        Row() {
          Text('ğŸŒ±')
            .fontSize(12)
            .margin({ right: 4 })
          
          Text(`${this.attraction.rating}/5`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .backgroundColor('rgba(0,0,0,0.6)')
        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
        .borderRadius(8)
        .position({ x: 8, y: 8 })
      }
      .width('100%')
      .height(120)
      .margin({ bottom: 12 })

      // æ™¯ç‚¹ä¿¡æ¯
      Column() {
        Text(this.attraction.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 4 })
        
        Text(this.attraction.description)
          .fontSize(12)
          .fontColor('#6b7280')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        // ç¯ä¿ç‰¹è‰²
        if (this.attraction.ecoFeatures.length > 0) {
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.attraction.ecoFeatures, (feature: string) => {
              Text(`ğŸŒ¿ ${feature}`)
                .fontSize(10)
                .fontColor('#059669')
                .backgroundColor('#f0fdf4')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(8)
                .margin({ right: 4, bottom: 4 })
            })
          }
          .width('100%')
          .margin({ bottom: 8 })
        }
        
        // è¯¦ç»†æ´»åŠ¨ï¼ˆå¯å±•å¼€ï¼‰
        if (this.isExpanded && this.attraction.activities.length > 0) {
          Column() {
            Text('ğŸ¯ å¯è¿›è¡Œçš„æ´»åŠ¨')
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1f2937')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 6 })
            
            ForEach(this.attraction.activities, (activity: string) => {
              Text(`â€¢ ${activity}`)
                .fontSize(11)
                .fontColor('#4b5563')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 2 })
            })
          }
          .width('100%')
          .padding(8)
          .backgroundColor('#f8fafc')
          .borderRadius(8)
          .margin({ bottom: 8 })
        }
        
        // å±•å¼€/æ”¶èµ·æŒ‰é’®
        Button() {
          Text(this.isExpanded ? 'æ”¶èµ·' : 'æŸ¥çœ‹è¯¦æƒ…')
            .fontSize(12)
            .fontColor('#1e40af')
        }
        .height(28)
        .backgroundColor('#f0f8ff')
        .borderRadius(14)
        .onClick(() => {
          this.isExpanded = !this.isExpanded;
        })
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
  }
}

/**
 * ç¯ä¿ç»Ÿè®¡å¡ç‰‡ç»„ä»¶
 * æ˜¾ç¤ºç”¨æˆ·çš„ç¯ä¿ç»Ÿè®¡æ•°æ®
 */
@Component
export struct EcoStatsCard {
  @Prop stats: EcoStats;
  @State isExpanded: boolean = false;

  // è·å–ç­‰çº§é¢œè‰²
  private getLevelColor(level: EcoLevel): string {
    const colors: Record<EcoLevel, string> = {
      [EcoLevel.BEGINNER]: '#6b7280',
      [EcoLevel.INTERMEDIATE]: '#10b981',
      [EcoLevel.ADVANCED]: '#f59e0b',
      [EcoLevel.EXPERT]: '#8b5cf6'
    };
    return colors[level] || '#6b7280';
  }

  // è·å–ç­‰çº§åç§°
  private getLevelName(level: EcoLevel): string {
    const names: Record<EcoLevel, string> = {
      [EcoLevel.BEGINNER]: 'ç¯ä¿æ–°æ‰‹',
      [EcoLevel.INTERMEDIATE]: 'ç¯ä¿è¾¾äºº',
      [EcoLevel.ADVANCED]: 'ç¯ä¿ä¸“å®¶',
      [EcoLevel.EXPERT]: 'ç¯ä¿å¤§å¸ˆ'
    };
    return names[level] || 'æœªçŸ¥';
  }

  build() {
    Column() {
      // ç­‰çº§å’Œå¾½ç« 
      Row() {
        Column() {
          Text('ğŸŒ±')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text(this.getLevelName(this.stats.ecoLevel))
            .fontSize(12)
            .fontColor(this.getLevelColor(this.stats.ecoLevel))
            .fontWeight(FontWeight.Medium)
        }
        .alignItems(HorizontalAlign.Center)
        
        Blank()
        
        // è¿ç»­å¤©æ•°
        Column() {
          Text(`${this.stats.currentStreak}`)
            .fontSize(20)
            .fontColor('#059669')
            .fontWeight(FontWeight.Bold)
          
          Text('è¿ç»­å¤©æ•°')
            .fontSize(10)
            .fontColor('#6b7280')
        }
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .margin({ bottom: 16 })

      // ç»Ÿè®¡æ•°æ®
      Row() {
        Column() {
          Text(`${this.stats.totalCarbonSaved.toFixed(1)}`)
            .fontSize(16)
            .fontColor('#059669')
            .fontWeight(FontWeight.Bold)
          
          Text('èŠ‚çœç¢³æ’æ”¾')
            .fontSize(10)
            .fontColor('#6b7280')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text(`Â¥${this.stats.totalMoneySaved.toFixed(0)}`)
            .fontSize(16)
            .fontColor('#f59e0b')
            .fontWeight(FontWeight.Bold)
          
          Text('èŠ‚çœè´¹ç”¨')
            .fontSize(10)
            .fontColor('#6b7280')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Column() {
          Text(this.stats.totalEcoActions.toString())
            .fontSize(16)
            .fontColor('#1e40af')
            .fontWeight(FontWeight.Bold)
          
          Text('ç¯ä¿è¡Œä¸º')
            .fontSize(10)
            .fontColor('#6b7280')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 20 })
        
        Blank()
      }
      .width('100%')
      .margin({ bottom: 12 })

      // è¯¦ç»†ç»Ÿè®¡ï¼ˆå¯å±•å¼€ï¼‰
      if (this.isExpanded) {
        Column() {
          Row() {
            Text('æœ€é•¿è¿ç»­:')
              .fontSize(12)
              .fontColor('#6b7280')
            
            Text(`${this.stats.longestStreak}å¤©`)
              .fontSize(12)
              .fontColor('#059669')
              .fontWeight(FontWeight.Medium)
              .margin({ left: 8 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 8 })
          
          if (this.stats.achievements.length > 0) {
            Column() {
              Text('ğŸ† æˆå°±')
                .fontSize(12)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1f2937')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 6 })
              
              ForEach(this.stats.achievements, (achievement: string) => {
                Text(`â€¢ ${achievement}`)
                  .fontSize(11)
                  .fontColor('#4b5563')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 2 })
              })
            }
            .width('100%')
            .padding(8)
            .backgroundColor('#f8fafc')
            .borderRadius(8)
          }
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f0f8ff')
        .borderRadius(8)
        .margin({ bottom: 12 })
      }

      // å±•å¼€/æ”¶èµ·æŒ‰é’®
      Button() {
        Text(this.isExpanded ? 'æ”¶èµ·' : 'æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#1e40af')
      }
      .height(28)
      .backgroundColor('#f0f8ff')
      .borderRadius(14)
      .onClick(() => {
        this.isExpanded = !this.isExpanded;
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
  }
}
