import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface TransportDetail {
  id: string;
  name: string;
  type: string;
  icon: string;
  description: string;
  price: string;
  operatingHours: string;
  routes: RouteInfo[];
  tips: string[];
  paymentMethods: string[];
  features: string[];
}

interface RouteInfo {
  routeName: string;
  stations: string[];
  duration: string;
  frequency: string;
}

@Entry
@Component
export struct TransportDetailPage {
  @State transportDetail: TransportDetail = {} as TransportDetail;
  @State isLoading: boolean = true;
  @State selectedRouteIndex: number = 0;
  @State selectedRoute: RouteInfo | null = null;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    const transportId = params['id'] as string || '1';
    this.loadTransportDetail(transportId);
  }

  private loadTransportDetail(transportId: string) {
    setTimeout(() => {
      const detail: TransportDetail = {
        id: transportId,
        name: 'æ·±åœ³åœ°é“',
        type: 'åœ°é“',
        icon: 'ğŸš‡',
        description: 'æ·±åœ³åœ°é“æ˜¯æ·±åœ³å¸‚çš„åŸå¸‚è½¨é“äº¤é€šç³»ç»Ÿï¼Œè¦†ç›–å…¨å¸‚ä¸»è¦åŒºåŸŸï¼Œæ˜¯å¸‚æ°‘å‡ºè¡Œçš„é‡è¦äº¤é€šå·¥å…·ã€‚',
        price: 'èµ·æ­¥ä»·2å…ƒï¼Œæœ€é«˜10å…ƒ',
        operatingHours: '06:00 - 23:00',
        routes: [
          {
            routeName: '1å·çº¿(ç½—å®çº¿)',
            stations: ['ç½—æ¹–', 'å›½è´¸', 'è€è¡—', 'å¤§å‰§é™¢', 'ç§‘å­¦é¦†', 'åå¼ºè·¯', 'å²—å¦', 'ä¼šå±•ä¸­å¿ƒ', 'è´­ç‰©å…¬å›­', 'é¦™èœœæ¹–', 'è½¦å…¬åº™', 'ç«¹å­æ—', 'ä¾¨åŸä¸œ', 'åä¾¨åŸ', 'ä¸–ç•Œä¹‹çª—', 'ç™½çŸ³æ´²', 'é«˜æ–°å›­', 'æ·±å¤§', 'æ¡ƒå›­', 'å¤§æ–°', 'é²¤é±¼é—¨', 'å‰æµ·æ¹¾', 'æ–°å®‰', 'å®å®‰ä¸­å¿ƒ', 'å®ä½“', 'åªæ´²', 'è¥¿ä¹¡', 'å›ºæˆ', 'åç‘', 'æœºåœºä¸œ'],
            duration: 'çº¦60åˆ†é’Ÿå…¨ç¨‹',
            frequency: 'é«˜å³°æœŸ2-3åˆ†é’Ÿï¼Œå¹³å³°æœŸ4-6åˆ†é’Ÿ'
          },
          {
            routeName: '2å·çº¿(è›‡å£çº¿)',
            stations: ['èµ¤æ¹¾', 'è›‡å£æ¸¯', 'æµ·ä¸Šä¸–ç•Œ', 'æ°´æ¹¾', 'ä¸œè§’å¤´', 'æ¹¾å¦', 'æµ·æœˆ', 'ç™»è‰¯', 'åæµ·', 'ç§‘è‹‘', 'çº¢æ ‘æ¹¾', 'ä¸–ç•Œä¹‹çª—', 'ä¾¨åŸåŒ—', 'æ·±åº·', 'å®‰æ‰˜å±±', 'ä¾¨é¦™', 'é¦™èœœ', 'é¦™æ¢…åŒ—', 'æ™¯ç”°', 'è²èŠ±è¥¿', 'ç¦ç”°', 'å¸‚æ°‘ä¸­å¿ƒ', 'å²—å¦åŒ—', 'åå¼ºåŒ—', 'ç‡•å—', 'å¤§å‰§é™¢', 'æ¹–è´', 'é»„è´å²­', 'æ–°ç§€'],
            duration: 'çº¦50åˆ†é’Ÿå…¨ç¨‹',
            frequency: 'é«˜å³°æœŸ2-4åˆ†é’Ÿï¼Œå¹³å³°æœŸ5-8åˆ†é’Ÿ'
          }
        ],
        tips: [
          'æ”¯æŒæ·±åœ³é€šã€å¾®ä¿¡ã€æ”¯ä»˜å®æ‰«ç æ”¯ä»˜',
          'é«˜å³°æœŸ(7:00-9:00, 17:30-19:30)è¾ƒä¸ºæ‹¥æŒ¤',
          'è€äººã€å„¿ç«¥ã€æ®‹ç–¾äººå¯äº«å—ä¼˜æƒ ç¥¨ä»·',
          'ç¦æ­¢æºå¸¦æ˜“ç‡ƒæ˜“çˆ†å±é™©å“',
          'è½¦å¢å†…ç¦æ­¢é¥®é£Ÿ'
        ],
        paymentMethods: ['æ·±åœ³é€š', 'å¾®ä¿¡æ”¯ä»˜', 'æ”¯ä»˜å®', 'é“¶è”é—ªä»˜', 'æ•°å­—äººæ°‘å¸'],
        features: ['ç©ºè°ƒè½¦å¢', 'æ— éšœç¢è®¾æ–½', 'å…è´¹WiFi', 'æ‰‹æœºå……ç”µ', 'LEDä¿¡æ¯æ˜¾ç¤º']
      };
      this.transportDetail = detail;
      this.updateSelectedRoute(detail.routes);
      this.isLoading = false;
    }, 800);
  }

  private navigateToRoute() {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/transport/RouteNavigationPage',
        params: {
          transportType: this.transportDetail.type,
          transportName: this.transportDetail.name
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è·¯çº¿å¯¼èˆªé¡µé¢'));
  }

  build() {
    Column() {
      TopNavigationBar({
        title: this.isLoading ? 'åŠ è½½ä¸­...' : this.transportDetail.name,
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.HeaderSection()
            this.BasicInfoSection()
            this.RoutesSection()
            this.PaymentMethodsSection()
            this.FeaturesSection()
            this.TipsSection()
          }
        }
        .layoutWeight(1)
      }

      if (!this.isLoading) {
        this.BottomActionSection()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ğŸš‡')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åŠ è½½äº¤é€šä¿¡æ¯...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder HeaderSection() {
    Row() {
      Text(this.transportDetail.icon)
        .fontSize(48)
        .margin({ right: 16 })

      Column() {
        Text(this.transportDetail.name)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .margin({ bottom: 8 })

        Text(this.transportDetail.type)
          .fontSize(16)
          .fontColor('#6366f1')
          .backgroundColor('#eef2ff')
          .padding({ left: 12, right: 12, top: 4, bottom: 4 })
          .borderRadius(12)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(20)
    .margin({ bottom: 12 })
    .borderRadius(12)
  }

  @Builder BasicInfoSection() {
    Column() {
      Text('ğŸ“‹ åŸºæœ¬ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      Text(this.transportDetail.description)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(22)
        .width('100%')
        .margin({ bottom: 16 })

      Column({ space: 12 }) {
        Row() {
          Text('ğŸ’° ç¥¨ä»·:')
            .fontSize(16)
            .fontColor('#6b7280')
            .width(80)
          Text(this.transportDetail.price)
            .fontSize(16)
            .fontColor('#374151')
            .layoutWeight(1)
        }
        .width('100%')

        Row() {
          Text('â° è¿è¥æ—¶é—´:')
            .fontSize(16)
            .fontColor('#6b7280')
            .width(80)
          Text(this.transportDetail.operatingHours)
            .fontSize(16)
            .fontColor('#374151')
            .layoutWeight(1)
        }
        .width('100%')
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder RoutesSection() {
    Column() {
      Text('ğŸš‰ çº¿è·¯ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      // çº¿è·¯é€‰æ‹©æ ‡ç­¾
      Row() {
        ForEach(this.transportDetail.routes ?? [], (route: RouteInfo, index: number) => {
          Text(route.routeName)
            .fontSize(14)
            .fontColor(this.selectedRouteIndex === index ? Color.White : '#6366f1')
            .backgroundColor(this.selectedRouteIndex === index ? '#6366f1' : '#eef2ff')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
            .margin({ right: 8 })
            .onClick(() => {
              this.selectedRouteIndex = index;
              this.selectedRoute = route;
            })
        }, (route: RouteInfo, index: number) => `route-${index}-${route.routeName}`)
      }
      .width('100%')
      .margin({ bottom: 16 })

      // é€‰ä¸­çº¿è·¯è¯¦æƒ…
      if (this.transportDetail.routes.length > 0 && this.selectedRoute) {
        Column() {
          Row() {
            Text('â±ï¸ å…¨ç¨‹æ—¶é—´:')
              .fontSize(14)
              .fontColor('#6b7280')
            Text(this.selectedRoute.duration)
              .fontSize(14)
              .fontColor('#374151')
              .margin({ left: 8 })
          }
          .width('100%')
          .margin({ bottom: 8 })

          Row() {
            Text('ğŸ”„ å‘è½¦é¢‘ç‡:')
              .fontSize(14)
              .fontColor('#6b7280')
            Text(this.selectedRoute.frequency)
              .fontSize(14)
              .fontColor('#374151')
              .margin({ left: 8 })
          }
          .width('100%')
          .margin({ bottom: 12 })

          Text('ä¸»è¦ç«™ç‚¹:')
            .fontSize(14)
            .fontColor('#6b7280')
            .width('100%')
            .margin({ bottom: 8 })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach((this.selectedRoute?.stations ?? []).slice(0, 10), (station: string, idx: number) => {
              Text(station)
                .fontSize(12)
                .fontColor('#374151')
                .backgroundColor('#f3f4f6')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
                .margin({ right: 6, bottom: 6 })
            }, (station: string, idx: number) => `station-chip-${idx}-${station}`)
            
            if ((this.selectedRoute?.stations ?? []).length > 10) {
              Text(`+${(this.selectedRoute?.stations ?? []).length - 10}ä¸ªç«™ç‚¹`)
                .fontSize(12)
                .fontColor('#6b7280')
                .backgroundColor('#f9fafb')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
            }
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder PaymentMethodsSection() {
    Column() {
      Text('ğŸ’³ æ”¯ä»˜æ–¹å¼')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.transportDetail.paymentMethods ?? [], (method: string, index: number) => {
          Row() {
            Text(this.getPaymentIcon(method))
              .fontSize(16)
              .margin({ right: 6 })
            Text(method)
              .fontSize(14)
              .fontColor('#374151')
          }
          .backgroundColor('#f0fdf4')
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ right: 8, bottom: 8 })
        }, (method: string, index: number) => `pay-${index}-${method}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder FeaturesSection() {
    Column() {
      Text('âœ¨ æœåŠ¡ç‰¹è‰²')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      Column({ space: 8 }) {
        ForEach(this.transportDetail.features ?? [], (feature: string, index: number) => {
          Row() {
            Text('âœ…')
              .fontSize(16)
              .margin({ right: 8 })
            Text(feature)
              .fontSize(14)
              .fontColor('#374151')
              .layoutWeight(1)
          }
          .width('100%')
        }, (feature: string, index: number) => `feat-${index}-${feature}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder TipsSection() {
    Column() {
      Text('ğŸ’¡ å‡ºè¡Œæç¤º')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      Column({ space: 8 }) {
        ForEach(this.transportDetail.tips ?? [], (tip: string, index: number) => {
          Row() {
            Text('â€¢')
              .fontSize(16)
              .fontColor('#f59e0b')
              .margin({ right: 8 })
            Text(tip)
              .fontSize(14)
              .fontColor('#6b7280')
              .layoutWeight(1)
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
        }, (tip: string, index: number) => `tip-${index}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder BottomActionSection() {
    Row({ space: 12 }) {
      Button('è·¯çº¿æŸ¥è¯¢')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          this.navigateToRoute();
        })

      Button('å®æ—¶ä¿¡æ¯')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          ErrorHandler.showToast('å®æ—¶ä¿¡æ¯åŠŸèƒ½å¼€å‘ä¸­...');
        })

      Button('æ”¶è—')
        .backgroundColor('#f59e0b')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          ErrorHandler.showToast('å·²æ”¶è—åˆ°æˆ‘çš„äº¤é€š');
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#e5e7eb' })
  }

  private getPaymentIcon(method: string): string {
    const iconMap: Record<string, string> = {
      'æ·±åœ³é€š': 'ğŸ’³',
      'å¾®ä¿¡æ”¯ä»˜': 'ğŸ’š',
      'æ”¯ä»˜å®': 'ğŸ”µ',
      'é“¶è”é—ªä»˜': 'ğŸ’',
      'æ•°å­—äººæ°‘å¸': 'ğŸª™'
    };
    return iconMap[method] || 'ğŸ’³';
  }

  private updateSelectedRoute(routes: RouteInfo[]): void {
    if (routes.length === 0) {
      this.selectedRouteIndex = 0;
      this.selectedRoute = null;
      return;
    }
    const safeIndex = Math.min(this.selectedRouteIndex, routes.length - 1);
    this.selectedRouteIndex = safeIndex;
    this.selectedRoute = routes[safeIndex];
  }
}
