import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface StationInfo {
  name: string;
  time: string;
  distance: string;
  isTransfer: boolean;
  transferLines?: string[];
}

interface RouteStep {
  type: 'walk' | 'metro' | 'bus';
  lineName?: string;
  stations: StationInfo[];
  duration: string;
  distance: string;
}

interface NavigationRoute {
  id: string;
  totalDuration: string;
  totalDistance: string;
  steps: RouteStep[];
  price: string;
}

@Entry
@Component
export struct RouteNavigationPage {
  @State transportType: string = '';
  @State transportName: string = '';
  @State isLoading: boolean = true;
  @State selectedRouteIndex: number = 0;
  @State routes: NavigationRoute[] = [];

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.transportType = params['transportType'] as string || 'åœ°é“';
    this.transportName = params['transportName'] as string || 'æ·±åœ³åœ°é“';
    this.loadRoutes();
  }

  private loadRoutes() {
    setTimeout(() => {
      // æ¨¡æ‹Ÿè·¯çº¿æ•°æ®
      this.routes = [
        {
          id: '1',
          totalDuration: '45åˆ†é’Ÿ',
          totalDistance: '12.5å…¬é‡Œ',
          price: '6å…ƒ',
          steps: [
            {
              type: 'walk',
              stations: [
                { name: 'èµ·ç‚¹: æ·±åœ³åŒ—ç«™', time: '0åˆ†é’Ÿ', distance: '0ç±³', isTransfer: false }
              ],
              duration: '5åˆ†é’Ÿ',
              distance: '300ç±³'
            },
            {
              type: 'metro',
              lineName: '4å·çº¿',
              stations: [
                { name: 'æ·±åœ³åŒ—ç«™', time: '0åˆ†é’Ÿ', distance: '0ç±³', isTransfer: false },
                { name: 'çº¢å±±', time: '3åˆ†é’Ÿ', distance: '2.1å…¬é‡Œ', isTransfer: false },
                { name: 'ä¸Šå¡˜', time: '6åˆ†é’Ÿ', distance: '4.2å…¬é‡Œ', isTransfer: false },
                { name: 'é¾™èƒœ', time: '9åˆ†é’Ÿ', distance: '6.5å…¬é‡Œ', isTransfer: false },
                { name: 'é¾™å', time: '12åˆ†é’Ÿ', distance: '8.8å…¬é‡Œ', isTransfer: false },
                { name: 'æ¸…æ¹–', time: '15åˆ†é’Ÿ', distance: '11.2å…¬é‡Œ', isTransfer: false }
              ],
              duration: '35åˆ†é’Ÿ',
              distance: '11.2å…¬é‡Œ'
            },
            {
              type: 'walk',
              stations: [
                { name: 'ç»ˆç‚¹: æ¸…æ¹–ç«™å‡ºå£', time: '45åˆ†é’Ÿ', distance: '12.5å…¬é‡Œ', isTransfer: false }
              ],
              duration: '5åˆ†é’Ÿ',
              distance: '300ç±³'
            }
          ]
        },
        {
          id: '2',
          totalDuration: '52åˆ†é’Ÿ',
          totalDistance: '14.2å…¬é‡Œ',
          price: '7å…ƒ',
          steps: [
            {
              type: 'walk',
              stations: [
                { name: 'èµ·ç‚¹: æ·±åœ³åŒ—ç«™', time: '0åˆ†é’Ÿ', distance: '0ç±³', isTransfer: false }
              ],
              duration: '5åˆ†é’Ÿ',
              distance: '300ç±³'
            },
            {
              type: 'metro',
              lineName: '5å·çº¿',
              stations: [
                { name: 'æ·±åœ³åŒ—ç«™', time: '0åˆ†é’Ÿ', distance: '0ç±³', isTransfer: false },
                { name: 'æ°‘æ²»', time: '4åˆ†é’Ÿ', distance: '2.8å…¬é‡Œ', isTransfer: false },
                { name: 'äº”å’Œ', time: '8åˆ†é’Ÿ', distance: '5.6å…¬é‡Œ', isTransfer: false },
                { name: 'å‚ç”°', time: '12åˆ†é’Ÿ', distance: '8.4å…¬é‡Œ', isTransfer: false },
                { name: 'æ¨ç¾', time: '16åˆ†é’Ÿ', distance: '11.2å…¬é‡Œ', isTransfer: false }
              ],
              duration: '42åˆ†é’Ÿ',
              distance: '13.9å…¬é‡Œ'
            },
            {
              type: 'walk',
              stations: [
                { name: 'ç»ˆç‚¹: æ¨ç¾ç«™å‡ºå£', time: '52åˆ†é’Ÿ', distance: '14.2å…¬é‡Œ', isTransfer: false }
              ],
              duration: '5åˆ†é’Ÿ',
              distance: '300ç±³'
            }
          ]
        }
      ];
      this.isLoading = false;
    }, 800);
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'è·¯çº¿å¯¼èˆª',
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Column() {
          // è·¯çº¿é€‰æ‹©å¡ç‰‡
          this.RouteSelector()

          // è·¯çº¿è¯¦æƒ…
          Scroll() {
            Column() {
              if (this.routes.length > 0 && this.routes[this.selectedRouteIndex]) {
                this.RouteDetail(this.routes[this.selectedRouteIndex])
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 20 })
          }
          .layoutWeight(1)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ğŸ—ºï¸')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨è§„åˆ’è·¯çº¿...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder RouteSelector() {
    Column() {
      Text('æ¨èè·¯çº¿')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 12 })

      Column({ space: 12 }) {
        ForEach(this.routes ?? [], (route: NavigationRoute, index: number) => {
          Row() {
            Column({ space: 4 }) {
              Row() {
                Text(`è·¯çº¿${index + 1}`)
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.selectedRouteIndex === index ? '#6366f1' : '#6b7280')
                
                if (index === 0) {
                  Text('æ¨è')
                    .fontSize(10)
                    .fontColor(Color.White)
                    .backgroundColor('#10b981')
                    .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                    .borderRadius(4)
                    .margin({ left: 8 })
                }
              }
              .width('100%')

              Row({ space: 16 }) {
                Row({ space: 4 }) {
                  Text('â±ï¸')
                    .fontSize(12)
                  Text(route.totalDuration)
                    .fontSize(12)
                    .fontColor('#6b7280')
                }

                Row({ space: 4 }) {
                  Text('ğŸ“')
                    .fontSize(12)
                  Text(route.totalDistance)
                    .fontSize(12)
                    .fontColor('#6b7280')
                }

                Row({ space: 4 }) {
                  Text('ğŸ’°')
                    .fontSize(12)
                  Text(route.price)
                    .fontSize(12)
                    .fontColor('#6b7280')
                }
              }
              .width('100%')
              .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            if (this.selectedRouteIndex === index) {
              Text('âœ“')
                .fontSize(20)
                .fontColor('#6366f1')
            }
          }
          .width('100%')
          .padding(12)
          .backgroundColor(this.selectedRouteIndex === index ? '#eef2ff' : Color.White)
          .borderRadius(8)
          .border({
            width: this.selectedRouteIndex === index ? 2 : 1,
            color: this.selectedRouteIndex === index ? '#6366f1' : '#e5e7eb'
          })
          .onClick(() => {
            this.selectedRouteIndex = index;
          })
        }, (route: NavigationRoute, index: number) => `route-${route.id}-${index}`)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
  }

  @Builder RouteDetail(route: NavigationRoute) {
    Column({ space: 16 }) {
      // è·¯çº¿æ€»è§ˆ
      Column() {
        Row() {
          Text('è·¯çº¿æ€»è§ˆ')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
        }
        .width('100%')
        .margin({ bottom: 12 })

        Row({ space: 24 }) {
          Column({ space: 4 }) {
            Text(route.totalDuration)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#6366f1')
            Text('é¢„è®¡æ—¶é—´')
              .fontSize(12)
              .fontColor('#6b7280')
          }

          Column({ space: 4 }) {
            Text(route.totalDistance)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#10b981')
            Text('æ€»è·ç¦»')
              .fontSize(12)
              .fontColor('#6b7280')
          }

          Column({ space: 4 }) {
            Text(route.price)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#f59e0b')
            Text('ç¥¨ä»·')
              .fontSize(12)
              .fontColor('#6b7280')
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)

      // è¯¦ç»†æ­¥éª¤
      Column() {
        Text('è¯¦ç»†è·¯çº¿')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .margin({ bottom: 16 })

        Column({ space: 16 }) {
          ForEach(route.steps ?? [], (step: RouteStep, stepIndex: number) => {
            this.RouteStep(step, stepIndex, (route.steps ?? []).length)
          }, (step: RouteStep, stepIndex: number) => `step-${stepIndex}-${step.type}-${step.lineName ?? ''}`)
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
  }

  @Builder RouteStep(step: RouteStep, stepIndex: number, totalSteps: number) {
    Column({ space: 12 }) {
      // æ­¥éª¤æ ‡é¢˜
      Row() {
        Text(this.getStepIcon(step.type))
          .fontSize(18)
          .margin({ right: 8 })

        Column({ space: 2 }) {
          Text(this.getStepTitle(step))
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')

          Row({ space: 8 }) {
            Text(step.duration)
              .fontSize(12)
              .fontColor('#6b7280')
            Text('â€¢')
              .fontSize(12)
              .fontColor('#6b7280')
            Text(step.distance)
              .fontSize(12)
              .fontColor('#6b7280')
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')

      // ç«™ç‚¹åˆ—è¡¨
      if ((step.stations ?? []).length > 0) {
        Column({ space: 8 }) {
          ForEach(step.stations ?? [], (station: StationInfo, stationIndex: number) => {
            Row() {
              // è¿æ¥çº¿
              if (stationIndex < (step.stations ?? []).length - 1) {
                Column()
                  .width(2)
                  .height(30)
                  .backgroundColor(step.type === 'metro' ? '#6366f1' : step.type === 'bus' ? '#10b981' : '#9ca3af')
                  .margin({ left: 9, right: 9 })
              } else {
                Column()
                  .width(2)
                  .height(0)
                  .margin({ left: 9, right: 9 })
              }

              Column({ space: 4 }) {
                Row() {
                  // ç«™ç‚¹æ ‡è®°
                  Column()
                    .width(20)
                    .height(20)
                    .borderRadius(10)
                    .backgroundColor(step.type === 'metro' ? '#6366f1' : step.type === 'bus' ? '#10b981' : '#9ca3af')
                    .margin({ right: 8 })

                  Column({ space: 2 }) {
                    Text(station.name)
                      .fontSize(13)
                      .fontColor('#374151')
                      .fontWeight(stationIndex === 0 || stationIndex === step.stations.length - 1 ? FontWeight.Medium : FontWeight.Normal)

                    if (station.isTransfer && (station.transferLines ?? []).length > 0) {
                      Row({ space: 4 }) {
                        Text('æ¢ä¹˜')
                          .fontSize(10)
                          .fontColor('#f59e0b')
                        ForEach(station.transferLines ?? [], (line: string, idx: number) => {
                          Text(line)
                            .fontSize(10)
                            .fontColor('#f59e0b')
                            .backgroundColor('#fef3c7')
                            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                            .borderRadius(2)
                        }, (line: string, idx: number) => `transfer-${stationIndex}-${idx}-${line}`)
                      }
                      .margin({ top: 2 })
                    }
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  Column({ space: 2 }) {
                    Text(station.time)
                      .fontSize(11)
                      .fontColor('#9ca3af')
                    Text(station.distance)
                      .fontSize(11)
                      .fontColor('#9ca3af')
                  }
                  .alignItems(HorizontalAlign.End)
                }
                .width('100%')
              }
              .layoutWeight(1)
            }
            .width('100%')
          }, (station: StationInfo, stationIndex: number) => `station-${stepIndex}-${stationIndex}-${station.name}`)
        }
        .width('100%')
        .margin({ left: 20 })
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#f9fafb')
    .borderRadius(8)
  }

  private getStepIcon(type: string): string {
    const iconMap: Record<string, string> = {
      'walk': 'ğŸš¶',
      'metro': 'ğŸš‡',
      'bus': 'ğŸšŒ'
    };
    return iconMap[type] || 'ğŸ“';
  }

  private getStepTitle(step: RouteStep): string {
    if (step.type === 'walk') {
      return 'æ­¥è¡Œ';
    } else if (step.type === 'metro') {
      return step.lineName ? `${step.lineName}åœ°é“` : 'åœ°é“';
    } else if (step.type === 'bus') {
      return step.lineName ? `${step.lineName}å…¬äº¤` : 'å…¬äº¤';
    }
    return 'æœªçŸ¥';
  }
}

