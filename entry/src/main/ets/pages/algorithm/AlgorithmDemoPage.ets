/**
 * å› æœå¤šæ¨¡æ€ç®—æ³•æ¼”ç¤ºé¡µé¢
 * å±•ç¤ºBART+GCN+å› æœå¯¹æ¯”å­¦ä¹ +ä¸¤çº§ä¼˜åŒ–
 */
import { CausalMultimodalAnalyzer, AspectSentiment } from '../../algorithm/CausalMultimodalFramework';
import { TrainingManager, ModelMetrics } from '../../algorithm/TrainingManager';
import { TopNavigationBar } from '../../components/TopNavigationBar';

@Entry
@Component
export struct AlgorithmDemoPage {
  @State reviewText: string = 'è¿™å®¶é¤å…çš„æµ·é²œå¾ˆæ–°é²œï¼Œç¯å¢ƒä¹Ÿä¸é”™ï¼Œä½†ä»·æ ¼å¤ªè´µ';
  @State analysisResult: AspectSentiment[] = [];
  @State isAnalyzing: boolean = false;
  @State modelMetrics: ModelMetrics | null = null;
  @State showTraining: boolean = false;

  private analyzer = CausalMultimodalAnalyzer.getInstance();
  private trainer = TrainingManager.getInstance();

  build() {
    Column() {
      TopNavigationBar({ title: 'å› æœAIç®—æ³•æ¼”ç¤º', showBack: true })

      Scroll() {
        Column({ space: 16 }) {
          // ç®—æ³•è¯´æ˜
          this.AlgorithmInfo()

          // è¯„è®ºè¾“å…¥
          this.ReviewInput()

          // åˆ†ææŒ‰é’®
          this.AnalyzeButton()

          // åˆ†æç»“æœ
          if (this.analysisResult.length > 0) {
            this.ResultDisplay()
          }

          // è®­ç»ƒç®¡ç†
          this.TrainingSection()

          // æ€§èƒ½æŒ‡æ ‡
          if (this.modelMetrics) {
            this.MetricsDisplay()
          }
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#f9fafb')
    }
    .width('100%')
    .height('100%')
  }

  @Builder AlgorithmInfo() {
    Column({ space: 8 }) {
      Text('ğŸ¤– å› æœå¤šæ¨¡æ€æƒ…æ„Ÿåˆ†æ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')

      Text('æŠ€æœ¯æ ˆï¼š')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#374151')
        .alignSelf(ItemAlign.Start)

      Row({ space: 8 }) {
        this.TechBadge('BART', '#3b82f6')
        this.TechBadge('GCN', '#8b5cf6')
        this.TechBadge('å› æœæ¨æ–­', '#ec4899')
        this.TechBadge('å¯¹æ¯”å­¦ä¹ ', '#10b981')
      }
      .wrap(FlexWrap.Wrap)

      Text('æ”¯æŒæ–¹é¢çº§æƒ…æ„Ÿåˆ†æã€å› æœé“¾æ¨ç†ã€å¤šæ¨¡æ€èåˆ')
        .fontSize(12)
        .fontColor('#6b7280')
        .lineHeight(18)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder TechBadge(text: string, color: string) {
    Text(text)
      .fontSize(11)
      .fontColor(Color.White)
      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
      .backgroundColor(color)
      .borderRadius(12)
  }

  @Builder ReviewInput() {
    Column({ space: 8 }) {
      Text('è¾“å…¥è¯„è®ºæ–‡æœ¬ï¼š')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)

      TextArea({ text: this.reviewText })
        .height(100)
        .backgroundColor('#f3f4f6')
        .borderRadius(8)
        .onChange((value) => {
          this.reviewText = value;
        })

      Text('ğŸ’¡ æç¤ºï¼šè¯„è®ºä¸­åŒ…å«å¤šä¸ªæ–¹é¢è¯ï¼ˆå¦‚æµ·é²œã€ç¯å¢ƒã€ä»·æ ¼ï¼‰æ•ˆæœæ›´å¥½')
        .fontSize(11)
        .fontColor('#9ca3af')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder AnalyzeButton() {
    Button(this.isAnalyzing ? 'åˆ†æä¸­...' : 'ğŸ”¬ å¼€å§‹å› æœåˆ†æ')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .backgroundColor(this.isAnalyzing ? '#9ca3af' : '#0A59F7')
      .borderRadius(12)
      .enabled(!this.isAnalyzing)
      .onClick(async () => {
        await this.performAnalysis();
      })
  }

  @Builder ResultDisplay() {
    Column({ space: 12 }) {
      Text('ğŸ“Š æ–¹é¢çº§æƒ…æ„Ÿåˆ†æç»“æœ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)

      ForEach(this.analysisResult, (item: AspectSentiment) => {
        this.AspectCard(item)
      }, (item) => item.aspect)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder AspectCard(item: AspectSentiment) {
    Column({ space: 8 }) {
      Row() {
        Text(item.aspect)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)

        Row({ space: 4 }) {
          Text(item.sentiment === 'positive' ? 'ğŸ‘' : 
               item.sentiment === 'negative' ? 'ğŸ‘' : 'ğŸ˜')
            .fontSize(20)

          Text(`${(item.score * 100).toFixed(0)}%`)
            .fontSize(14)
            .fontColor('#6b7280')
        }
      }
      .width('100%')

      // æƒ…æ„Ÿæ ‡ç­¾
      Text(item.sentiment === 'positive' ? 'æ­£é¢' : 
           item.sentiment === 'negative' ? 'è´Ÿé¢' : 'ä¸­æ€§')
        .fontSize(12)
        .fontColor(Color.White)
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(item.sentiment === 'positive' ? '#10b981' : 
                         item.sentiment === 'negative' ? '#ef4444' : '#6b7280')
        .borderRadius(12)
        .alignSelf(ItemAlign.Start)

      // å› æœæ¨ç†
      Text('ğŸ”— å› æœæ¨ç†ï¼š')
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor('#374151')
        .alignSelf(ItemAlign.Start)

      Text(item.reasoning)
        .fontSize(12)
        .fontColor('#6b7280')
        .lineHeight(18)
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#f9fafb')
    .borderRadius(8)
  }

  @Builder TrainingSection() {
    Column({ space: 12 }) {
      Text('ğŸ“ æ¨¡å‹è®­ç»ƒ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)

      Text('æ¼”ç¤ºè®­ç»ƒæµç¨‹ï¼šBARTé¢„è®­ç»ƒ â†’ GCNå›¾å­¦ä¹  â†’ å› æœå¯¹æ¯” â†’ ä¸¤çº§ä¼˜åŒ–')
        .fontSize(12)
        .fontColor('#6b7280')
        .lineHeight(18)

      Button('å¼€å§‹è®­ç»ƒæ¼”ç¤º')
        .width('100%')
        .backgroundColor('#8b5cf6')
        .onClick(async () => {
          await this.startTrainingDemo();
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder MetricsDisplay() {
    Column({ space: 12 }) {
      Text('ğŸ“ˆ æ¨¡å‹æ€§èƒ½æŒ‡æ ‡')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)

      this.MetricRow('æ–¹é¢æå–F1', this.modelMetrics!.aspectF1, 0.915)
      this.MetricRow('æƒ…æ„Ÿåˆ†ç±»å‡†ç¡®ç‡', this.modelMetrics!.sentimentAcc, 0.948)
      this.MetricRow('å› æœè¯†åˆ«å‡†ç¡®ç‡', this.modelMetrics!.causalAcc, 0.892)
      this.MetricRow('æ¨ç†æ—¶é—´', this.modelMetrics!.inferenceTime, 200, 'ms')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder MetricRow(name: string, value: number, target: number, unit: string = '') {
    Row() {
      Text(name)
        .fontSize(14)
        .fontColor('#374151')
        .layoutWeight(1)

      Column({ space: 4 }) {
        Row({ space: 4 }) {
          Text(unit === 'ms' ? `${value.toFixed(0)}${unit}` : `${(value * 100).toFixed(1)}%`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(value >= target ? '#10b981' : '#ef4444')

          Text(value >= target ? 'âœ…' : 'âš ï¸')
            .fontSize(14)
        }

        Text(`ç›®æ ‡: ${unit === 'ms' ? `<${target}${unit}` : `>${(target * 100).toFixed(0)}%`}`)
          .fontSize(10)
          .fontColor('#9ca3af')
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
    .borderBottom({ width: 1, color: '#e5e7eb' })
  }

  /**
   * æ‰§è¡Œåˆ†æ
   */
  private async performAnalysis() {
    if (!this.reviewText.trim()) {
      return;
    }

    this.isAnalyzing = true;
    this.analysisResult = [];

    try {
      // è°ƒç”¨å› æœå¤šæ¨¡æ€åˆ†æå™¨
      const result = await this.analyzer.analyze({
        text: this.reviewText
      });

      this.analysisResult = result;
      console.info('[Demo] åˆ†æå®Œæˆ:', JSON.stringify(result));
    } catch (error) {
      console.error('[Demo] åˆ†æå¤±è´¥:', error);
    } finally {
      this.isAnalyzing = false;
    }
  }

  /**
   * è®­ç»ƒæ¼”ç¤º
   */
  private async startTrainingDemo() {
    console.info('[Demo] å¼€å§‹è®­ç»ƒæ¼”ç¤º');
    
    // æ¨¡æ‹Ÿè®­ç»ƒè¿‡ç¨‹
    const config = {
      batchSize: 32,
      learningRate: 0.0001,
      epochs: 10, // æ¼”ç¤ºç”¨å°‘é‡epoch
      device: 'npu' as const,
      optimizer: 'adamw' as const
    };

    // æ˜¾ç¤ºæ¨¡æ‹ŸæŒ‡æ ‡
    this.modelMetrics = {
      aspectF1: 0.915,
      sentimentAcc: 0.948,
      causalAcc: 0.892,
      inferenceTime: 180
    };

    console.info('[Demo] è®­ç»ƒå®Œæˆï¼ŒæŒ‡æ ‡:', this.modelMetrics);
  }
}
