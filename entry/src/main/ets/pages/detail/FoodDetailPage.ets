import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ImageConstants } from '../../constants/ImageConstants';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface FoodDetailInfo {
  id: string;
  name: string;
  image: string;
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  price: string;
  tags: string[];
  description: string;
  openHours: string;
  phone: string;
  address: string;
  specialties: string[];
  reviews: ReviewItem[];
}

interface ReviewItem {
  userName: string;
  rating: number;
  comment: string;
  date: string;
  avatar: string;
}

@Entry
@Component
export struct FoodDetailPage {
  @State foodDetail: FoodDetailInfo = {} as FoodDetailInfo;
  @State isLoading: boolean = true;
  @State currentImageIndex: number = 0;
  
  private foodId: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.foodId = params['id'] as string || '1';
    this.loadFoodDetail();
  }

  private loadFoodDetail() {
    // æ¨¡æ‹ŸåŠ è½½ç¾Žé£Ÿè¯¦æƒ…æ•°æ®
    setTimeout(() => {
      this.foodDetail = {
        id: this.foodId,
        name: 'æ·±åœ³æ¹¾æµ·é²œå¤§æŽ’æ¡£',
        image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/292/400/300', 'restaurant'),
        rating: 4.8,
        reviewCount: 1256,
        location: 'å—å±±åŒºæ·±åœ³æ¹¾',
        distance: '1.2km',
        price: 'äººå‡Â¥120',
        tags: ['æµ·é²œ', 'å¤§æŽ’æ¡£', 'å¤œå®µ', 'èšé¤'],
        description: 'æ–°é²œæµ·é²œï¼ŒçŽ°ç‚¹çŽ°åšï¼ŒçŽ¯å¢ƒä¼˜é›…ï¼Œé€‚åˆèšé¤ã€‚æœ¬åº—ç²¾é€‰ä¼˜è´¨æµ·é²œï¼Œé‡‡ç”¨ä¼ ç»Ÿç²¤èœçƒ¹é¥ªå·¥è‰ºï¼Œä¸ºæ‚¨å‘ˆçŽ°æœ€åœ°é“çš„æµ·é²œç¾Žå‘³ã€‚',
        openHours: '11:00-23:00',
        phone: '0755-12345678',
        address: 'æ·±åœ³å¸‚å—å±±åŒºæ·±åœ³æ¹¾ç§‘æŠ€ç”Ÿæ€å›­',
        specialties: ['ç™½ç¼è™¾', 'è’œè“‰æ‰‡è´', 'æ¤’ç›æ¿‘å°¿è™¾', 'æ¸…è’¸çŸ³æ–‘é±¼', 'å§œè‘±ç‚’èŸ¹'],
        reviews: [
          {
            userName: 'ç¾Žé£Ÿè¾¾äºº',
            rating: 5,
            comment: 'æµ·é²œå¾ˆæ–°é²œï¼Œå‘³é“å¾ˆæ£’ï¼çŽ¯å¢ƒä¹Ÿä¸é”™ï¼ŒæœåŠ¡æ€åº¦å¾ˆå¥½ã€‚',
            date: '2024-11-10',
            avatar: 'ðŸ‘¤'
          },
          {
            userName: 'åƒè´§å°çŽ‹',
            rating: 4,
            comment: 'ä»·æ ¼åˆç†ï¼Œåˆ†é‡è¶³ï¼Œå°±æ˜¯äººæ¯”è¾ƒå¤šéœ€è¦ç­‰ä½ã€‚',
            date: '2024-11-08',
            avatar: 'ðŸ‘¤'
          }
        ]
      };
      this.isLoading = false;
    }, 800);
  }

  build() {
    Column() {
      TopNavigationBar({
        title: this.isLoading ? 'åŠ è½½ä¸­...' : this.foodDetail.name,
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.HeaderImageSection()
            this.BasicInfoSection()
            this.SpecialtiesSection()
            this.ContactInfoSection()
            this.ReviewsSection()
            this.ActionButtonsSection()
          }
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ðŸ½ï¸')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åŠ è½½ç¾Žé£Ÿè¯¦æƒ…...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder HeaderImageSection() {
    Stack() {
      Image(this.foodDetail.image)
        .width('100%')
        .height(250)
        .objectFit(ImageFit.Cover)

      // è¯„åˆ†æ ‡ç­¾
      Row() {
        Text('â­')
          .fontSize(14)
        Text(this.foodDetail.rating.toFixed(1))
          .fontSize(14)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
        Text(`(${this.foodDetail.reviewCount}æ¡è¯„ä»·)`)
          .fontSize(12)
          .fontColor(Color.White)
      }
      .backgroundColor('rgba(0,0,0,0.6)')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ bottom: 16, right: 16 })
    }
    .alignContent(Alignment.BottomEnd)
  }

  @Builder BasicInfoSection() {
    Column() {
      Row() {
        Text(this.foodDetail.name)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Text(this.foodDetail.price)
          .fontSize(20)
          .fontColor('#ef4444')
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .margin({ bottom: 12 })

      Row() {
        Text('ðŸ“')
          .fontSize(14)
          .margin({ right: 4 })
        Text(this.foodDetail.location)
          .fontSize(14)
          .fontColor('#6b7280')
          .layoutWeight(1)
        Text(this.foodDetail.distance)
          .fontSize(14)
          .fontColor('#9ca3af')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.foodDetail?.tags ?? [], (tag: string, index: number) => {
          Text(tag)
            .fontSize(12)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
        }, (tag: string, index: number) => `tag-${index}-${tag}`)
      }
      .width('100%')
      .margin({ bottom: 12 })

      Text(this.foodDetail.description)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(22)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
  }

  @Builder SpecialtiesSection() {
    Column() {
      Text('ðŸ´ æ‹›ç‰Œèœå“')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      Column({ space: 8 }) {
        ForEach(this.foodDetail?.specialties ?? [], (dish: string, index: number) => {
          Row() {
            Text('â€¢')
              .fontSize(16)
              .fontColor('#f59e0b')
              .margin({ right: 8 })
            Text(dish)
              .fontSize(14)
              .fontColor('#374151')
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
        }, (dish: string, index: number) => `dish-${index}-${dish}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ContactInfoSection() {
    Column() {
      Text('ðŸ“ž è”ç³»ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      Row() {
        Text('è¥ä¸šæ—¶é—´ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.foodDetail.openHours)
          .fontSize(14)
          .fontColor('#374151')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text('è”ç³»ç”µè¯ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.foodDetail.phone)
          .fontSize(14)
          .fontColor('#3b82f6')
          .onClick(() => {
            // æ‹¨æ‰“ç”µè¯åŠŸèƒ½
            console.log('æ‹¨æ‰“ç”µè¯:', this.foodDetail.phone);
          })
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text('è¯¦ç»†åœ°å€ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.foodDetail.address)
          .fontSize(14)
          .fontColor('#374151')
          .layoutWeight(1)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ReviewsSection() {
    Column() {
      Row() {
        Text('ðŸ’¬ ç”¨æˆ·è¯„ä»·')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(14)
          .fontColor('#6366f1')
          .onClick(() => {
            // è·³è½¬åˆ°è¯„ä»·é¡µé¢
            console.log('æŸ¥çœ‹å…¨éƒ¨è¯„ä»·');
          })
      }
      .width('100%')
      .margin({ bottom: 12 })

      Column({ space: 12 }) {
        ForEach((this.foodDetail?.reviews ?? []).slice(0, 2), (review: ReviewItem, index: number) => {
          this.ReviewItem(review)
        }, (review: ReviewItem, index: number) => `review-${index}-${review.userName}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ReviewItem(review: ReviewItem) {
    Column() {
      Row() {
        Image(review.avatar)
          .width(32)
          .height(32)
          .borderRadius(16)
          .margin({ right: 8 })
        
        Column() {
          Text(review.userName)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
          
          Row() {
            ForEach(Array.from({length: 5}), (item: undefined, index: number) => {
              Text(index < review.rating ? 'â­' : 'â˜†')
                .fontSize(12)
            }, (_: undefined, index: number) => `star-${review.userName}-${index}`)
            Text(review.date)
              .fontSize(12)
              .fontColor('#9ca3af')
              .margin({ left: 8 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(review.comment)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(20)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtonsSection() {
    Row({ space: 12 }) {
      Button('å¯¼èˆª')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          ErrorHandler.safeExecute(async () => {
            await router.pushUrl({
              url: 'pages/ar/ARNavigationPage',
              params: { 
                destination: this.foodDetail.name,
                address: this.foodDetail.address
              }
            });
          }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ARå¯¼èˆªé¡µé¢'));
        })

      Button('æ”¶è—')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          console.log('æ”¶è—ç¾Žé£Ÿ:', this.foodDetail.name);
        })

      Button('åˆ†äº«')
        .backgroundColor('#f59e0b')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          console.log('åˆ†äº«ç¾Žé£Ÿ:', this.foodDetail.name);
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
  }
}
