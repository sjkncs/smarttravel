import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ImageConstants } from '../../constants/ImageConstants';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface HotelDetailInfo {
  id: string;
  name: string;
  images: string[];
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  price: string;
  originalPrice: string;
  tags: string[];
  description: string;
  facilities: string[];
  checkIn: string;
  checkOut: string;
  phone: string;
  address: string;
  roomTypes: RoomType[];
  reviews: ReviewItem[];
}

interface RoomType {
  name: string;
  price: string;
  originalPrice: string;
  image: string;
  facilities: string[];
  available: boolean;
}

interface ReviewItem {
  userName: string;
  rating: number;
  comment: string;
  date: string;
  avatar: string;
}

@Entry
@Component
export struct HotelDetailPage {
  @State hotelDetail: HotelDetailInfo = {} as HotelDetailInfo;
  @State isLoading: boolean = true;
  @State currentImageIndex: number = 0;
  @State selectedRoomIndex: number = 0;
  
  private hotelId: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.hotelId = params['id'] as string || '1';
    this.loadHotelDetail();
  }

  private loadHotelDetail() {
    // æ¨¡æ‹ŸåŠ è½½é…’åº—è¯¦æƒ…æ•°æ®
    setTimeout(() => {
      this.hotelDetail = {
        id: this.hotelId,
        name: 'æ·±åœ³æ¹¾ä¸‡è±ªé…’åº—',
        images: [
          ImageConstants.getSafeImageUrl('https://picsum.photos/id/301/400/300', 'hotel'),
          ImageConstants.getSafeImageUrl('https://picsum.photos/id/302/400/300', 'hotel'),
          ImageConstants.getSafeImageUrl('https://picsum.photos/id/303/400/300', 'hotel')
        ],
        rating: 4.8,
        reviewCount: 1256,
        location: 'å—å±±åŒºæ·±åœ³æ¹¾',
        distance: '1.2km',
        price: 'Â¥680',
        originalPrice: 'Â¥880',
        tags: ['äº”æ˜Ÿçº§', 'æµ·æ™¯', 'å•†åŠ¡', 'è±ªå'],
        description: 'è±ªåæµ·æ™¯é…’åº—ï¼Œè®¾æ–½å®Œå–„ï¼ŒæœåŠ¡ä¸€æµã€‚é…’åº—ä½äºæ·±åœ³æ¹¾æ ¸å¿ƒåœ°æ®µï¼Œäº«æœ‰æ— æ•Œæµ·æ™¯ï¼Œæ˜¯å•†åŠ¡å‡ºè¡Œå’Œä¼‘é—²åº¦å‡çš„ç†æƒ³é€‰æ‹©ã€‚',
        facilities: ['WiFi', 'åœè½¦åœº', 'å¥èº«æˆ¿', 'æ¸¸æ³³æ± ', 'é¤å…', 'SPA', 'ä¼šè®®å®¤', 'å•†åŠ¡ä¸­å¿ƒ'],
        checkIn: '14:00',
        checkOut: '12:00',
        phone: '0755-88888888',
        address: 'æ·±åœ³å¸‚å—å±±åŒºæ·±åœ³æ¹¾ç§‘æŠ€ç”Ÿæ€å›­AåŒº',
        roomTypes: [
          {
            name: 'è±ªåæµ·æ™¯æˆ¿',
            price: 'Â¥680',
            originalPrice: 'Â¥880',
            image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/304/300/200', 'hotel'),
            facilities: ['æµ·æ™¯', 'å¤§åºŠ', 'æµ´ç¼¸', 'é˜³å°'],
            available: true
          },
          {
            name: 'å•†åŠ¡å¥—æˆ¿',
            price: 'Â¥980',
            originalPrice: 'Â¥1280',
            image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/305/300/200', 'hotel'),
            facilities: ['å®¢å…', 'åŠå…¬åŒº', 'ä¼šè®®æ¡Œ', 'è¿·ä½ å§'],
            available: true
          }
        ],
        reviews: [
          {
            userName: 'å•†åŠ¡è¾¾äºº',
            rating: 5,
            comment: 'é…’åº—ä½ç½®å¾ˆå¥½ï¼Œæˆ¿é—´å®½æ•èˆ’é€‚ï¼ŒæœåŠ¡å¾ˆæ£’ï¼æµ·æ™¯æˆ¿çš„æ™¯è‰²çœŸçš„å¾ˆç¾ã€‚',
            date: '2024-11-10',
            avatar: 'ğŸ‘¤'
          },
          {
            userName: 'åº¦å‡çˆ±å¥½è€…',
            rating: 4,
            comment: 'è®¾æ–½å¾ˆå®Œå–„ï¼Œæ—©é¤ä¸°å¯Œï¼Œå°±æ˜¯ä»·æ ¼ç¨å¾®æœ‰ç‚¹è´µã€‚',
            date: '2024-11-08',
            avatar: 'ğŸ‘¤'
          }
        ]
      };
      this.isLoading = false;
    }, 800);
  }

  build() {
    Column() {
      TopNavigationBar({
        title: this.isLoading ? 'åŠ è½½ä¸­...' : this.hotelDetail.name,
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.HeaderImageSection()
            this.BasicInfoSection()
            this.FacilitiesSection()
            this.RoomTypesSection()
            this.ContactInfoSection()
            this.ReviewsSection()
            this.ActionButtonsSection()
          }
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ğŸ¨')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åŠ è½½é…’åº—è¯¦æƒ…...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder HeaderImageSection() {
    Stack() {
      Swiper() {
        ForEach(this.hotelDetail?.images ?? [], (image: string, index: number) => {
          Image(image)
            .width('100%')
            .height(250)
            .objectFit(ImageFit.Cover)
        }, (image: string, index: number) => `img-${index}-${image}`)
      }
      .width('100%')
      .height(250)
      .indicator(true)
      .loop(true)
      .autoPlay(true)
      .interval(3000)

      // è¯„åˆ†æ ‡ç­¾
      Row() {
        Text('â­')
          .fontSize(14)
        Text(this.hotelDetail.rating.toFixed(1))
          .fontSize(14)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
        Text(`(${this.hotelDetail.reviewCount}æ¡è¯„ä»·)`)
          .fontSize(12)
          .fontColor(Color.White)
      }
      .backgroundColor('rgba(0,0,0,0.6)')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ bottom: 16, right: 16 })
    }
    .alignContent(Alignment.BottomEnd)
  }

  @Builder BasicInfoSection() {
    Column() {
      Row() {
        Text(this.hotelDetail.name)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Column() {
          Row() {
            Text(this.hotelDetail.originalPrice)
              .fontSize(14)
              .fontColor('#9ca3af')
              .decoration({ type: TextDecorationType.LineThrough })
            Text(this.hotelDetail.price)
              .fontSize(20)
              .fontColor('#ef4444')
              .fontWeight(FontWeight.Bold)
              .margin({ left: 8 })
          }
          Text('/æ™š')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .margin({ bottom: 12 })

      Row() {
        Text('ğŸ“')
          .fontSize(14)
          .margin({ right: 4 })
        Text(this.hotelDetail.location)
          .fontSize(14)
          .fontColor('#6b7280')
          .layoutWeight(1)
        Text(this.hotelDetail.distance)
          .fontSize(14)
          .fontColor('#9ca3af')
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.hotelDetail?.tags ?? [], (tag: string, index: number) => {
          Text(tag)
            .fontSize(12)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
        }, (tag: string, index: number) => `tag-${index}-${tag}`)
      }
      .width('100%')
      .margin({ bottom: 12 })

      Text(this.hotelDetail.description)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(22)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
  }

  @Builder FacilitiesSection() {
    Column() {
      Text('ğŸŠ é…’åº—è®¾æ–½')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.hotelDetail?.facilities ?? [], (facility: string, index: number) => {
          Row() {
            Text(this.getFacilityIcon(facility))
              .fontSize(16)
              .margin({ right: 6 })
            Text(facility)
              .fontSize(14)
              .fontColor('#374151')
          }
          .backgroundColor('#f3f4f6')
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ right: 8, bottom: 8 })
        }, (facility: string, index: number) => `facility-${index}-${facility}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder RoomTypesSection() {
    Column() {
      Text('ğŸ›ï¸ æˆ¿å‹é€‰æ‹©')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      Column({ space: 12 }) {
        ForEach(this.hotelDetail?.roomTypes ?? [], (room: RoomType, index: number) => {
          this.RoomTypeItem(room, index)
        }, (room: RoomType, index: number) => `room-${index}-${room.name ?? ''}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder RoomTypeItem(room: RoomType, index: number) {
    Row() {
      Image(room.image)
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .margin({ right: 12 })

      Column() {
        Row() {
          Text(room.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .layoutWeight(1)
          
          Column() {
            Row() {
              Text(room.originalPrice)
                .fontSize(12)
                .fontColor('#9ca3af')
                .decoration({ type: TextDecorationType.LineThrough })
              Text(room.price)
                .fontSize(16)
                .fontColor('#ef4444')
                .fontWeight(FontWeight.Bold)
                .margin({ left: 4 })
            }
            Text('/æ™š')
              .fontSize(10)
              .fontColor('#6b7280')
          }
          .alignItems(HorizontalAlign.End)
        }
        .width('100%')
        .margin({ bottom: 8 })

        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(room.facilities ?? [], (facility: string, index: number) => {
            Text(facility)
              .fontSize(11)
              .fontColor('#059669')
              .backgroundColor('#d1fae5')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(4)
              .margin({ right: 6, bottom: 4 })
          }, (facility: string, index: number) => `room-fac-${index}-${facility}`)
        }

        Row() {
          Text(room.available ? 'âœ… æœ‰æˆ¿' : 'âŒ æ»¡æˆ¿')
            .fontSize(12)
            .fontColor(room.available ? '#059669' : '#dc2626')
            .layoutWeight(1)
          
          if (room.available) {
            Button('é¢„è®¢')
              .backgroundColor('#3b82f6')
              .fontColor(Color.White)
              .fontSize(12)
              .height(28)
              .borderRadius(14)
              .onClick(() => {
                console.log('é¢„è®¢æˆ¿é—´:', room.name);
              })
          }
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(this.selectedRoomIndex === index ? '#f0f9ff' : '#f9fafb')
    .padding(12)
    .borderRadius(8)
    .border({
      width: this.selectedRoomIndex === index ? 2 : 1,
      color: this.selectedRoomIndex === index ? '#3b82f6' : '#e5e7eb'
    })
    .onClick(() => {
      this.selectedRoomIndex = index;
    })
  }

  @Builder ContactInfoSection() {
    Column() {
      Text('ğŸ“ é…’åº—ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      Row() {
        Text('å…¥ä½æ—¶é—´ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.hotelDetail.checkIn)
          .fontSize(14)
          .fontColor('#374151')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text('é€€æˆ¿æ—¶é—´ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.hotelDetail.checkOut)
          .fontSize(14)
          .fontColor('#374151')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text('è”ç³»ç”µè¯ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.hotelDetail.phone)
          .fontSize(14)
          .fontColor('#3b82f6')
          .onClick(() => {
            console.log('æ‹¨æ‰“ç”µè¯:', this.hotelDetail.phone);
          })
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text('è¯¦ç»†åœ°å€ï¼š')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(this.hotelDetail.address)
          .fontSize(14)
          .fontColor('#374151')
          .layoutWeight(1)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ReviewsSection() {
    Column() {
      Row() {
        Text('ğŸ’¬ ä½å®¢è¯„ä»·')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(14)
          .fontColor('#6366f1')
          .onClick(() => {
            console.log('æŸ¥çœ‹å…¨éƒ¨è¯„ä»·');
          })
      }
      .width('100%')
      .margin({ bottom: 12 })

      Column({ space: 12 }) {
        ForEach((this.hotelDetail?.reviews ?? []).slice(0, 2), (review: ReviewItem, index: number) => {
          this.ReviewItem(review)
        }, (review: ReviewItem, index: number) => `review-${index}-${review.userName}`)
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ReviewItem(review: ReviewItem) {
    Column() {
      Row() {
        Image(review.avatar)
          .width(32)
          .height(32)
          .borderRadius(16)
          .margin({ right: 8 })
        
        Column() {
          Text(review.userName)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
          
          Row() {
            ForEach(Array.from({length: 5}), (item: undefined, index: number) => {
              Text(index < review.rating ? 'â­' : 'â˜†')
                .fontSize(12)
            }, (_: undefined, index: number) => `star-${review.userName}-${index}`)
            Text(review.date)
              .fontSize(12)
              .fontColor('#9ca3af')
              .margin({ left: 8 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(review.comment)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(20)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtonsSection() {
    Row({ space: 12 }) {
      Button('å¯¼èˆª')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          ErrorHandler.safeExecute(async () => {
            await router.pushUrl({
              url: 'pages/ar/ARNavigationPage',
              params: { 
                destination: this.hotelDetail.name,
                address: this.hotelDetail.address
              }
            });
          }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ARå¯¼èˆªé¡µé¢'));
        })

      Button('æ”¶è—')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          console.log('æ”¶è—é…’åº—:', this.hotelDetail.name);
        })

      Button('ç«‹å³é¢„è®¢')
        .backgroundColor('#ef4444')
        .fontColor(Color.White)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          console.log('é¢„è®¢é…’åº—:', this.hotelDetail.name);
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
  }

  private getFacilityIcon(facility: string): string {
    const iconMap: Record<string, string> = {
      'WiFi': 'ğŸ“¶',
      'åœè½¦åœº': 'ğŸ…¿ï¸',
      'å¥èº«æˆ¿': 'ğŸ‹ï¸',
      'æ¸¸æ³³æ± ': 'ğŸŠ',
      'é¤å…': 'ğŸ½ï¸',
      'SPA': 'ğŸ’†',
      'ä¼šè®®å®¤': 'ğŸ¢',
      'å•†åŠ¡ä¸­å¿ƒ': 'ğŸ’¼'
    };
    return iconMap[facility] || 'âœ…';
  }
}
