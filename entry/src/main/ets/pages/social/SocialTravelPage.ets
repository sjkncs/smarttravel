import { TopNavigationBar } from '../../components/TopNavigationBar';
import { router } from '@kit.ArkUI';

interface SocialUser {
  userId: string;
  username: string;
  avatar: string;
  location: string;
}

interface TravelShare {
  id: string;
  userId: string;
  content: string;
  images: string[];
  timestamp: number;
}

interface NearbyUser {
  userId: string;
  username: string;
  avatar: string;
  distance: number;
}

interface TravelChallenge {
  id: string;
  title: string;
  description: string;
  icon: string;
  color: string;
  target: number;
  unit: string;
  reward: {
    points: number;
    badge: string;
  };
  startDate: number;
  endDate: number;
  participants: string[];
  isActive: boolean;
}

class SocialTravelService {
  private static instance: SocialTravelService;
  
  static getInstance(): SocialTravelService {
    if (!this.instance) {
      this.instance = new SocialTravelService();
    }
    return this.instance;
  }
  
  async initializeCurrentUser(userId: string): Promise<SocialUser> {
    return {
      userId,
      username: 'æ—…è¡Œè€…',
      avatar: 'ðŸ‘¤',
      location: 'æ·±åœ³'
    };
  }
  
  async getFeed(userId: string, limit: number, offset: number): Promise<TravelShare[]> {
    return [];
  }
  
  async getNearbyUsers(userId: string, radius: number): Promise<NearbyUser[]> {
    return [];
  }
  
  async publishTravelShare(share: any): Promise<TravelShare> {
    return {
      id: Date.now().toString(),
      userId: share.userId,
      content: share.content,
      images: [],
      timestamp: Date.now()
    };
  }
}

/**
 * ç¤¾äº¤æ—…è¡Œé¡µé¢
 * æä¾›ç¤¾äº¤åŒ–æ—…è¡ŒåŠŸèƒ½
 */
@Entry
@Component
export struct SocialTravelPage {
  @State currentTab: number = 0;
  @State currentUser: SocialUser | null = null;
  @State feed: TravelShare[] = [];
  @State nearbyUsers: NearbyUser[] = [];
  @State challenges: TravelChallenge[] = [];
  @State isLoading: boolean = false;
  @State newShareContent: string = '';
  @State showShareDialog: boolean = false;

  private socialService: SocialTravelService = SocialTravelService.getInstance();
  private userId: string = 'user_' + Date.now();

  async aboutToAppear() {
    await this.initializePage();
  }

  // åˆå§‹åŒ–é¡µé¢
  private async initializePage() {
    this.isLoading = true;
    
    try {
      // åˆå§‹åŒ–å½“å‰ç”¨æˆ·
      this.currentUser = await this.socialService.initializeCurrentUser(this.userId);
      
      // åŠ è½½æ•°æ®
      await this.loadFeed();
      await this.loadNearbyUsers();
      await this.loadChallenges();
      
    } catch (error) {
      console.error('åˆå§‹åŒ–é¡µé¢å¤±è´¥:', error);
    }
    
    this.isLoading = false;
  }

  // åŠ è½½åŠ¨æ€æµ
  private async loadFeed() {
    if (!this.currentUser) return;
    
    this.feed = await this.socialService.getFeed(this.currentUser.userId, 20, 0);
  }

  // åŠ è½½é™„è¿‘ç”¨æˆ·
  private async loadNearbyUsers() {
    if (!this.currentUser) return;
    
    this.nearbyUsers = await this.socialService.getNearbyUsers(this.currentUser.userId, 5000);
  }

  // åŠ è½½æŒ‘æˆ˜
  private async loadChallenges() {
    // æ¨¡æ‹ŸæŒ‘æˆ˜æ•°æ®
    this.challenges = [
      {
        id: 'challenge_001',
        title: 'åŸŽå¸‚æŽ¢ç´¢è€…',
        description: 'åœ¨30å¤©å†…æ‰“å¡10ä¸ªä¸åŒçš„æ™¯ç‚¹',
        icon: 'ðŸ™ï¸',
        color: '#1e40af',
        target: 10,
        unit: 'ä¸ªæ™¯ç‚¹',
        reward: {
          points: 500,
          badge: 'åŸŽå¸‚æŽ¢ç´¢è€…'
        },
        startDate: Date.now(),
        endDate: Date.now() + 30 * 24 * 60 * 60 * 1000,
        participants: [],
        isActive: true
      },
      {
        id: 'challenge_002',
        title: 'æ‘„å½±è¾¾äºº',
        description: 'åˆ†äº«20å¼ æ—…è¡Œç…§ç‰‡',
        icon: 'ðŸ“¸',
        color: '#059669',
        target: 20,
        unit: 'å¼ ç…§ç‰‡',
        reward: {
          points: 300,
          badge: 'æ‘„å½±è¾¾äºº'
        },
        startDate: Date.now(),
        endDate: Date.now() + 15 * 24 * 60 * 60 * 1000,
        participants: [],
        isActive: true
      }
    ];
  }

  // å‘å¸ƒåˆ†äº«
  private async publishShare() {
    if (!this.newShareContent.trim() || !this.currentUser) return;
    
    try {
      const share = await this.socialService.publishTravelShare({
        userId: this.currentUser.userId,
        shareType: 'text' as 'text' | 'image' | 'video',
        title: 'æ–°çš„åˆ†äº«',
        content: this.newShareContent,
        images: [],
        tags: ['åˆ†äº«'],
        isPublic: true
      });
      
      this.newShareContent = '';
      this.showShareDialog = false;
      await this.loadFeed();
      
      console.log('åˆ†äº«å‘å¸ƒæˆåŠŸ');
    } catch (error) {
      console.error('å‘å¸ƒåˆ†äº«å¤±è´¥:', error);
    }
  }

  // åˆ‡æ¢æ ‡ç­¾é¡µ
  private switchTab(tabIndex: number) {
    this.currentTab = tabIndex;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'ç¤¾äº¤æ—…è¡Œ',
        showBack: true,
        showSearch: false,
        showNotification: true,
        showProfile: true
      })

      // æ ‡ç­¾é¡µåˆ‡æ¢
      Row() {
        Button() {
          Text('åŠ¨æ€')
            .fontSize(14)
            .fontColor(this.currentTab === 0 ? Color.White : '#6b7280')
        }
        .layoutWeight(1)
        .height(40)
        .backgroundColor(this.currentTab === 0 ? '#1e40af' : '#f1f5f9')
        .borderRadius(20)
        .onClick(() => {
          this.switchTab(0);
        })
        
        Button() {
          Text('é™„è¿‘')
            .fontSize(14)
            .fontColor(this.currentTab === 1 ? Color.White : '#6b7280')
        }
        .layoutWeight(1)
        .height(40)
        .backgroundColor(this.currentTab === 1 ? '#1e40af' : '#f1f5f9')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.switchTab(1);
        })
        
        Button() {
          Text('æŒ‘æˆ˜')
            .fontSize(14)
            .fontColor(this.currentTab === 2 ? Color.White : '#6b7280')
        }
        .layoutWeight(1)
        .height(40)
        .backgroundColor(this.currentTab === 2 ? '#1e40af' : '#f1f5f9')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.switchTab(2);
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#1e40af')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#6b7280')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // åŠ¨æ€æµ
        if (this.currentTab === 0) {
          this.FeedTab()
        }
        // é™„è¿‘ç”¨æˆ·
        else if (this.currentTab === 1) {
          this.NearbyTab()
        }
        // æŒ‘æˆ˜
        else if (this.currentTab === 2) {
          this.ChallengesTab()
        }
      }

      // å‘å¸ƒæŒ‰é’®
      Button() {
        Text('âœï¸')
          .fontSize(20)
          .fontColor(Color.White)
      }
      .width(56)
      .height(56)
      .backgroundColor('#1e40af')
      .borderRadius(28)
      .position({ x: '100%', y: '100%' })
      .translate({ x: -72, y: -72 })
      .shadow({
        radius: 8,
        color: 'rgba(0,0,0,0.2)',
        offsetX: 0,
        offsetY: 4
      })
      .onClick(() => {
        this.showShareDialog = true;
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder FeedTab() {
    Scroll() {
      Column() {
        ForEach(this.feed ?? [], (share: TravelShare, index: number) => {
          TravelShareCard({
            share: share,
            currentUserId: this.userId
          })
        }, (share: TravelShare, index: number) => `feed-${share.id}-${index}`)
      }
      .padding({ left: 16, right: 16, bottom: 80 })
    }
    .scrollBar(BarState.Auto)
    .layoutWeight(1)
  }

  @Builder NearbyTab() {
    Scroll() {
      Column() {
        ForEach(this.nearbyUsers ?? [], (nearbyUser: NearbyUser, index: number) => {
          NearbyUserCard({
            nearbyUser: nearbyUser,
            currentUserId: this.userId
          })
        }, (nearbyUser: NearbyUser, index: number) => `nearby-${nearbyUser.userId}-${index}`)
      }
      .padding({ left: 16, right: 16, bottom: 80 })
    }
    .scrollBar(BarState.Auto)
    .layoutWeight(1)
  }

  @Builder ChallengesTab() {
    Scroll() {
      Column() {
        ForEach(this.challenges ?? [], (challenge: TravelChallenge, index: number) => {
          TravelChallengeCard({
            challenge: challenge,
            currentUserId: this.userId
          })
        }, (challenge: TravelChallenge, index: number) => `challenge-${challenge.id}-${index}`)
      }
      .padding({ left: 16, right: 16, bottom: 80 })
    }
    .scrollBar(BarState.Auto)
    .layoutWeight(1)
  }
}
