/**
 * æ™ºèƒ½äººæœºäº¤äº’æ¼”ç¤ºé¡µé¢
 * å±•ç¤ºAIå¦‚ä½•åœ¨é¸¿è’™åŸç”Ÿå¸ƒå±€ä¸­å®ç°ä¼˜ç§€äº¤äº’
 */
import { router } from '@kit.ArkUI';
import { AIEngineManager, AIInput } from '../../ai/AIEngineManager';
import { CausalMultimodalAnalyzer } from '../../algorithm/CausalMultimodalFramework';
import { TopNavigationBar } from '../../components/TopNavigationBar';

@Entry
@Component
export struct SmartInteractionDemo {
  @State messages: ChatMessage[] = [];
  @State userInput: string = '';
  @State isThinking: boolean = false;
  @State currentMode: 'chat' | 'voice' | 'image' = 'chat';

  private aiEngine = AIEngineManager.getInstance();
  private analyzer = CausalMultimodalAnalyzer.getInstance();
  private scroller: Scroller = new Scroller();

  async aboutToAppear() {
    await this.aiEngine.initialize();
    
    // AIæ¬¢è¿è¯­
    this.addMessage({
      role: 'ai',
      content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹ï¼ŒåŸºäºå› æœæ¨ç†å’Œå¤šæ¨¡æ€åˆ†æã€‚\n\næˆ‘å¯ä»¥å¸®æ‚¨ï¼š\nğŸ¤ è¯­éŸ³å¯¹è¯\nğŸ“· æ‹ç…§è¯†åˆ«\nâœ¨ æ™ºèƒ½æ¨è\nğŸ—ºï¸ è¡Œç¨‹è§„åˆ’',
      timestamp: Date.now()
    });
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      TopNavigationBar({ title: 'AIæ™ºèƒ½åŠ©æ‰‹', showBack: true })

      // å¯¹è¯åŒºåŸŸ
      List({ scroller: this.scroller }) {
        ForEach(this.messages, (msg: ChatMessage) => {
          ListItem() {
            this.MessageBubble(msg)
          }
        }, (msg: ChatMessage) => msg.timestamp.toString())
      }
      .layoutWeight(1)
      .backgroundColor('#f9fafb')
      .padding(16)
      .divider({ strokeWidth: 0 })
      .onScrollIndex((start, end) => {
        // æ»šåŠ¨åˆ°åº•éƒ¨
      })

      // AIæ€è€ƒçŠ¶æ€
      if (this.isThinking) {
        Row() {
          LoadingProgress()
            .width(20)
            .height(20)
            .color('#0A59F7')
          Text('AIæ€è€ƒä¸­...')
            .fontSize(14)
            .fontColor('#6b7280')
            .margin({ left: 8 })
        }
        .padding(12)
        .backgroundColor('#eef2ff')
      }

      // è¾“å…¥åŒºåŸŸ
      this.InputArea()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  @Builder MessageBubble(msg: ChatMessage) {
    Row() {
      if (msg.role === 'user') {
        Blank()
      }

      Column({ space: 4 }) {
        // æ¶ˆæ¯å†…å®¹
        Text(msg.content)
          .fontSize(15)
          .fontColor(msg.role === 'user' ? Color.White : '#1f2937')
          .lineHeight(22)
          .padding(12)
          .backgroundColor(msg.role === 'user' ? '#0A59F7' : Color.White)
          .borderRadius(12)
          .maxWidth('75%')
          .shadow(msg.role === 'ai' ? {
            radius: 4,
            color: 'rgba(0,0,0,0.08)',
            offsetY: 2
          } : {})

        // å› æœæ¨ç†æ˜¾ç¤º
        if (msg.causalChain) {
          Text(`ğŸ”— ${msg.causalChain}`)
            .fontSize(12)
            .fontColor('#6b7280')
            .padding(8)
            .backgroundColor('#f3f4f6')
            .borderRadius(8)
            .maxWidth('75%')
        }

        // æ—¶é—´æˆ³
        Text(this.formatTime(msg.timestamp))
          .fontSize(11)
          .fontColor('#9ca3af')
          .margin({ top: 4 })
      }
      .alignItems(msg.role === 'user' ? HorizontalAlign.End : HorizontalAlign.Start)

      if (msg.role === 'ai') {
        Blank()
      }
    }
    .width('100%')
    .margin({ bottom: 12 })
  }

  @Builder InputArea() {
    Column() {
      // æ¨¡å¼åˆ‡æ¢
      Row({ space: 16 }) {
        this.ModeButton('ğŸ’¬', 'chat', 'æ–‡å­—')
        this.ModeButton('ğŸ¤', 'voice', 'è¯­éŸ³')
        this.ModeButton('ğŸ“·', 'image', 'æ‹ç…§')
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ top: 8, bottom: 8 })

      // è¾“å…¥æ¡†
      Row({ space: 8 }) {
        TextInput({ placeholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜...', text: this.userInput })
          .layoutWeight(1)
          .height(40)
          .backgroundColor('#f3f4f6')
          .borderRadius(20)
          .onChange((value) => {
            this.userInput = value;
          })

        Button('å‘é€')
          .height(40)
          .backgroundColor('#0A59F7')
          .borderRadius(20)
          .onClick(() => {
            this.sendMessage();
          })
      }
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.08)',
      offsetY: -2
    })
  }

  @Builder ModeButton(icon: string, mode: 'chat' | 'voice' | 'image', label: string) {
    Column({ space: 4 }) {
      Text(icon)
        .fontSize(24)
      Text(label)
        .fontSize(11)
        .fontColor(this.currentMode === mode ? '#0A59F7' : '#6b7280')
    }
    .padding(8)
    .borderRadius(8)
    .backgroundColor(this.currentMode === mode ? '#eef2ff' : Color.Transparent)
    .onClick(() => {
      this.currentMode = mode;
      if (mode === 'voice') {
        this.handleVoiceInput();
      } else if (mode === 'image') {
        this.handleImageInput();
      }
    })
  }

  /**
   * å‘é€æ¶ˆæ¯
   */
  private async sendMessage() {
    if (!this.userInput.trim()) return;

    const userMessage = this.userInput;
    this.userInput = '';

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.addMessage({
      role: 'user',
      content: userMessage,
      timestamp: Date.now()
    });

    this.isThinking = true;

    try {
      // AIå¤„ç†
      const result = await this.aiEngine.process({
        type: 'text',
        data: { text: userMessage }
      });

      // ç”ŸæˆAIå›å¤
      const aiResponse = this.generateAIResponse(userMessage, result);
      
      this.addMessage({
        role: 'ai',
        content: aiResponse.content,
        causalChain: aiResponse.causalChain,
        timestamp: Date.now()
      });

      // æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom);
      }, 100);
    } catch (error) {
      this.addMessage({
        role: 'ai',
        content: 'æŠ±æ­‰ï¼ŒAIå¤„ç†å‡ºé”™äº†',
        timestamp: Date.now()
      });
    } finally {
      this.isThinking = false;
    }
  }

  /**
   * ç”ŸæˆAIå›å¤
   */
  private generateAIResponse(userInput: string, aiResult: any): AIResponse {
    const intent = aiResult.data?.intent || 'unknown';

    switch (intent) {
      case 'query_restaurant':
        return {
          content: 'ä¸ºæ‚¨æ¨èä»¥ä¸‹é¤å…ï¼š\n\n' +
            'ğŸ¦ æ·±åœ³æ¹¾æµ·é²œå¤§æ’æ¡£ (åŒ¹é…åº¦95%)\n' +
            '  äººå‡Â¥120ï¼Œè·ç¦»1.2km\n\n' +
            'ğŸŒ¶ï¸ å·å‘³ç«é”…åŸ (åŒ¹é…åº¦88%)\n' +
            '  äººå‡Â¥150ï¼Œè·ç¦»2.5km',
          causalChain: 'å› æœæ¨ç†ï¼šæ‚¨åå¥½æµ·é²œ â†’ æ–°é²œåº¦é‡è¦ â†’ æ¨èé«˜è¯„åˆ†é¤å…'
        };

      case 'plan_trip':
        return {
          content: 'ğŸ—ºï¸ ä¸ºæ‚¨è§„åˆ’å‘¨æœ«è¡Œç¨‹ï¼š\n\n' +
            'ã€Day 1ã€‘\n' +
            '09:00 ä¸œéƒ¨åä¾¨åŸ\n' +
            '12:00 å±±é¡¶é¤å…\n' +
            '14:00 èŒ¶æºªè°·\n' +
            '18:00 æ·±åœ³æ¹¾æ—¥è½\n\n' +
            'é¢„ç®—ï¼šÂ¥850',
          causalChain: 'å› æœé“¾ï¼šæ™´å¤© â†’ æˆ·å¤–æ´»åŠ¨ â†’ è‡ªç„¶é£å…‰ â†’ é«˜æ»¡æ„åº¦'
        };

      case 'query_hotel':
        return {
          content: 'ä¸ºæ‚¨æ¨èé…’åº—ï¼š\n\n' +
            'ğŸ¨ æ·±åœ³æ¹¾ä¸‡è±ªé…’åº— (åŒ¹é…åº¦92%)\n' +
            '  äº”æ˜Ÿçº§ï¼Œæµ·æ™¯æˆ¿Â¥800/æ™š',
          causalChain: 'ä½ç½®ä¼˜è¶Š â†’ äº¤é€šä¾¿åˆ© â†’ å‡ºè¡Œæ–¹ä¾¿ â†’ ä½“éªŒä½³'
        };

      default:
        return {
          content: `æ”¶åˆ°æ‚¨çš„å’¨è¯¢ï¼š"${userInput}"\n\n` +
            'æˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n' +
            'â€¢ æ¨èé¤å…å’Œæ™¯ç‚¹ï¼ˆåŸºäºå› æœåˆ†æï¼‰\n' +
            'â€¢ è§„åˆ’æ—…è¡Œè¡Œç¨‹ï¼ˆå¤šç›®æ ‡ä¼˜åŒ–ï¼‰\n' +
            'â€¢ åˆ†æè¯„è®ºæƒ…æ„Ÿï¼ˆæ–¹é¢çº§+å› æœé“¾ï¼‰',
          causalChain: 'åŸºäºæ‚¨çš„éœ€æ±‚å’Œåå¥½è¿›è¡Œå› æœæ¨ç†'
        };
    }
  }

  /**
   * è¯­éŸ³è¾“å…¥
   */
  private async handleVoiceInput() {
    this.addMessage({
      role: 'user',
      content: 'ğŸ¤ [è¯­éŸ³è¾“å…¥]',
      timestamp: Date.now()
    });

    this.isThinking = true;

    // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
    await new Promise(resolve => setTimeout(resolve, 1000));

    const voiceText = 'æ¨èé™„è¿‘çš„ç¾é£Ÿ';
    
    this.addMessage({
      role: 'ai',
      content: `è¯†åˆ«ï¼š${voiceText}\n\n` +
        'æ ¹æ®æ‚¨çš„ä½ç½®å’Œåå¥½ï¼Œä¸ºæ‚¨æ¨èï¼š\n\n' +
        'ğŸ¦ æ·±åœ³æ¹¾æµ·é²œå¤§æ’æ¡£\n' +
        'è·ç¦»1.2kmï¼Œè¯„åˆ†4.8',
      causalChain: 'è¯­éŸ³è¯†åˆ« â†’ æ„å›¾ç†è§£ â†’ å› æœæ¨è',
      timestamp: Date.now()
    });

    this.isThinking = false;
  }

  /**
   * å›¾åƒè¾“å…¥
   */
  private async handleImageInput() {
    this.addMessage({
      role: 'user',
      content: 'ğŸ“· [æ‹ç…§è¯†åˆ«]',
      timestamp: Date.now()
    });

    this.isThinking = true;

    // æ¨¡æ‹Ÿå›¾åƒè¯†åˆ«
    await new Promise(resolve => setTimeout(resolve, 800));

    this.addMessage({
      role: 'ai',
      content: 'ğŸ“¸ è¯†åˆ«ç»“æœï¼š\n\n' +
        'æ™¯ç‚¹ï¼šæ·±åœ³å¹³å®‰é‡‘èä¸­å¿ƒ\n' +
        'é«˜åº¦ï¼š599ç±³\n' +
        'å»ºè®®ï¼šå‚æ™š18:00-19:00æœ€ä½³æ‹æ‘„',
      causalChain: 'å›¾åƒè¯†åˆ« â†’ ç‰¹å¾æå– â†’ åœºæ™¯ç†è§£ â†’ ä¸ªæ€§åŒ–å»ºè®®',
      timestamp: Date.now()
    });

    this.isThinking = false;
  }

  /**
   * æ·»åŠ æ¶ˆæ¯
   */
  private addMessage(msg: ChatMessage) {
    this.messages.push(msg);
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }
}

interface ChatMessage {
  role: 'user' | 'ai';
  content: string;
  causalChain?: string;
  timestamp: number;
}

interface AIResponse {
  content: string;
  causalChain?: string;
}
