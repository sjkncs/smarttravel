import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { HotelOrderData, OrderStatus } from '../../model/HotelOrderModel';

interface PaymentInfo {
  orderId: string;
  amount: number;
  paymentMethod: string;
  status: 'pending' | 'processing' | 'success' | 'failed';
}

interface PaymentMethod {
  id: string;
  name: string;
  icon: string;
  color: string;
}

@Entry
@Component
export struct PaymentPage {
  @State paymentInfo: PaymentInfo = {} as PaymentInfo;
  @State isProcessing: boolean = false;
  @State paymentStatus: 'pending' | 'processing' | 'success' | 'failed' = 'pending';
  @State countdown: number = 3;
  @State showPaymentOptions: boolean = false;
  @State selectedAuthMethod: 'face' | 'password' = 'face';
  @State selectedPaymentId: string = 'wechat';

  private paymentMethods: PaymentMethod[] = [
    { id: 'wechat', name: 'å¾®ä¿¡æ”¯ä»˜', icon: 'ğŸ’š', color: '#10b981' },
    { id: 'alipay', name: 'æ”¯ä»˜å®', icon: 'ğŸ”µ', color: '#1677FF' },
    { id: 'unionpay', name: 'é“¶è”æ”¯ä»˜', icon: 'ğŸ”´', color: '#E21F27' }
  ];

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    this.initPaymentInfo(params);
  }

  private initPaymentInfo(params: Record<string, Object>) {
    const orderInfo = params['orderInfo'] as Record<string, Object>;
    this.paymentInfo = {
      orderId: (orderInfo?.orderId as string) || '',
      amount: (orderInfo?.totalPrice as number) || 0,
      paymentMethod: 'å¾®ä¿¡æ”¯ä»˜',
      status: 'pending'
    };
    this.selectedPaymentId = 'wechat';
  }

  private processPayment() {
    this.isProcessing = true;
    this.paymentStatus = 'processing';
    // åŒæ­¥æ‰€é€‰æ”¯ä»˜æ–¹å¼åˆ° paymentInfo æ–‡æ¡ˆ
    const selected = this.paymentMethods.find(m => m.id === this.selectedPaymentId);
    if (selected) {
      this.paymentInfo.paymentMethod = selected.name;
    }
    
    // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
    setTimeout(() => {
      // 90%æ¦‚ç‡æˆåŠŸæ”¯ä»˜
      const success = Math.random() > 0.1;
      this.paymentStatus = success ? 'success' : 'failed';
      this.isProcessing = false;
      
      if (success) {
        this.startSuccessCountdown();
      }
    }, 3000);
  }

  private startSuccessCountdown() {
    const timer = setInterval(() => {
      this.countdown--;
      if (this.countdown <= 0) {
        clearInterval(timer);
        this.navigateToOrderList();
      }
    }, 1000);
  }

  private navigateToOrderList() {
    // æˆåŠŸåˆ™å°†è®¢å•çŠ¶æ€ç½®ä¸ºâ€œå¾…å…¥ä½â€
    if (this.paymentStatus === 'success' && this.paymentInfo.orderId) {
      HotelOrderData.updateOrderStatus(this.paymentInfo.orderId, OrderStatus.PENDING_CHECKIN);
    }
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.replaceUrl({
        url: 'pages/order/HotelOrderPage',
        params: { tabIndex: 2 }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è®¢å•åˆ—è¡¨é¡µé¢'));
  }

  private retryPayment() {
    this.paymentStatus = 'pending';
    this.countdown = 3;
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'æ”¯ä»˜',
        showBack: this.paymentStatus !== 'success'
      })

      Column() {
        if (this.paymentStatus === 'pending') {
          this.PendingView()
        } else if (this.paymentStatus === 'processing') {
          this.ProcessingView()
        } else if (this.paymentStatus === 'success') {
          this.SuccessView()
        } else {
          this.FailedView()
        }
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder PendingView() {
    Column() {
      // æ”¯ä»˜é‡‘é¢
      Column() {
        Text('æ”¯ä»˜é‡‘é¢')
          .fontSize(16)
          .fontColor('#6b7280')
          .margin({ bottom: 8 })
        
        Text(`Â¥${this.paymentInfo.amount}`)
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .margin({ bottom: 32 })
      }
      .margin({ bottom: 48 })

      // æ”¯ä»˜æ–¹å¼
      Column() {
        Text('æ”¯ä»˜æ–¹å¼')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .margin({ bottom: 16 })

        ForEach(this.paymentMethods, (method: PaymentMethod) => {
          Row() {
            Text(method.icon)
              .fontSize(28)
              .margin({ right: 12 })

            Column() {
              Text(method.name)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1f2937')
                .width('100%')
              Text(this.selectedPaymentId === method.id ? 'å·²é€‰æ‹©' : 'ç‚¹å‡»é€‰æ‹©')
                .fontSize(12)
                .fontColor('#6b7280')
                .width('100%')
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            if (this.selectedPaymentId === method.id) {
              Text('âœ“')
                .fontSize(16)
                .fontColor(method.color)
            }
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor(Color.White)
          .borderRadius(12)
          .border({ width: 2, color: this.selectedPaymentId === method.id ? method.color : '#e5e7eb' })
          .margin({ bottom: 12 })
          .onClick(() => {
            this.selectedPaymentId = method.id;
            this.paymentInfo.paymentMethod = method.name;
          })
        })
      }
      .width('100%')
      .padding(16)
      .margin({ bottom: 48 })

      // æ”¯ä»˜æŒ‰é’®
      Button('ç¡®è®¤æ”¯ä»˜')
        .width('80%')
        .height(48)
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .borderRadius(24)
        .onClick(() => {
          this.processPayment();
        })
    }
    .width('100%')
    .padding(24)
  }

  @Builder ProcessingView() {
    Column() {
      // åŠ è½½åŠ¨ç”»
      LoadingProgress()
        .width(80)
        .height(80)
        .color('#10b981')
        .margin({ bottom: 32 })

      Text('æ­£åœ¨å¤„ç†æ”¯ä»˜...')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1f2937')
        .margin({ bottom: 16 })

      Text('è¯·ç¨å€™ï¼Œä¸è¦å…³é—­é¡µé¢')
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ bottom: 32 })

      Text(`è®¢å•å·: ${this.paymentInfo.orderId}`)
        .fontSize(14)
        .fontColor('#9ca3af')
    }
    .width('100%')
    .padding(24)
  }

  @Builder SuccessView() {
    Column() {
      // æˆåŠŸå›¾æ ‡
      Text('âœ…')
        .fontSize(80)
        .margin({ bottom: 24 })

      Text('æ”¯ä»˜æˆåŠŸ!')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#10b981')
        .margin({ bottom: 16 })

      Text(`æ”¯ä»˜é‡‘é¢: Â¥${this.paymentInfo.amount}`)
        .fontSize(18)
        .fontColor('#1f2937')
        .margin({ bottom: 8 })

      Text(`è®¢å•å·: ${this.paymentInfo.orderId}`)
        .fontSize(14)
        .fontColor('#6b7280')
        .margin({ bottom: 32 })

      Text(`${this.countdown}ç§’åè‡ªåŠ¨è·³è½¬åˆ°è®¢å•åˆ—è¡¨`)
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ bottom: 24 })

      Row({ space: 16 }) {
        Button('æŸ¥çœ‹è®¢å•')
          .backgroundColor('#f3f4f6')
          .fontColor('#6b7280')
          .fontSize(16)
          .borderRadius(8)
          .layoutWeight(1)
          .onClick(() => {
            this.navigateToOrderList();
          })

        Button('ç»§ç»­è´­ç¥¨')
          .backgroundColor('#10b981')
          .fontColor(Color.White)
          .fontSize(16)
          .borderRadius(8)
          .layoutWeight(1)
          .onClick(() => {
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.replaceUrl({
                url: 'pages/home/HomePage'
              });
            }, (error: Error): void => ErrorHandler.handleRouterError(error, 'é¦–é¡µ'));
          })
      }
      .width('80%')
    }
    .width('100%')
    .padding(24)
  }

  @Builder FailedView() {
    Column() {
      // å¤±è´¥å›¾æ ‡
      Text('âŒ')
        .fontSize(80)
        .margin({ bottom: 24 })

      Text('æ”¯ä»˜å¤±è´¥')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#ef4444')
        .margin({ bottom: 16 })

      Text('æ”¯ä»˜è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•')
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ bottom: 8 })

      Text(`è®¢å•å·: ${this.paymentInfo.orderId}`)
        .fontSize(14)
        .fontColor('#6b7280')
        .margin({ bottom: 32 })

      Row({ space: 16 }) {
        Button('å–æ¶ˆè®¢å•')
          .backgroundColor('#f3f4f6')
          .fontColor('#6b7280')
          .fontSize(16)
          .borderRadius(8)
          .layoutWeight(1)
          .onClick(() => {
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.back();
            }, (error: Error): void => ErrorHandler.handleGenericError(error, 'è¿”å›ä¸Šé¡µ'));
          })

        Button('é‡æ–°æ”¯ä»˜')
          .backgroundColor('#ef4444')
          .fontColor(Color.White)
          .fontSize(16)
          .borderRadius(8)
          .layoutWeight(1)
          .onClick(() => {
            this.retryPayment();
          })
      }
      .width('80%')
    }
    .width('100%')
    .padding(24)
  }
}
