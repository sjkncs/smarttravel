import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { SmartTravelApi } from '../../api/SmartTravelApi';
import { NetworkService } from '../../services/NetworkService';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'HotelBookingPageWithHttp';
const DOMAIN = 0xFF00;

/**
 * é…’åº—é¢„è®¢é¡µé¢ï¼ˆé›†æˆ HTTP è¯·æ±‚ï¼‰
 * æ¼”ç¤ºå¦‚ä½•åœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨ HTTP æœåŠ¡
 */
@Entry
@Component
export struct HotelBookingPageWithHttp {
  // é¡µé¢å‚æ•°
  @State hotelId: string = 'hotel_001';
  @State hotelName: string = '';
  @State roomType: string = '';
  @State checkInDate: string = '';
  @State checkOutDate: string = '';
  @State price: number = 0;
  @State nights: number = 1;
  @State guestName: string = '';
  @State guestPhone: string = '';
  @State totalPrice: number = 0;
  
  // UI çŠ¶æ€
  @State isLoading: boolean = false;
  @State isCheckingAvailability: boolean = false;
  @State isBooking: boolean = false;
  @State showDatePicker: boolean = false;
  @State dateType: 'checkin' | 'checkout' = 'checkin';
  @State isAvailable: boolean = true;
  @State availabilityMessage: string = '';

  // æœåŠ¡å®ä¾‹
  private api: SmartTravelApi = SmartTravelApi.getInstance();
  private networkService: NetworkService = NetworkService.getInstance();

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.hotelId = params['hotelId'] as string || 'hotel_001';
      this.hotelName = params['hotelName'] as string || '';
      this.roomType = params['roomType'] as string || 'è±ªåå¤§åºŠæˆ¿';
      this.price = params['price'] as number || 489;
      this.checkInDate = params['checkInDate'] as string || '';
      this.checkOutDate = params['checkOutDate'] as string || '';
    }

    // åŠ è½½é…’åº—è¯¦æƒ…
    this.loadHotelDetail();
  }

  /**
   * ä»æœåŠ¡å™¨åŠ è½½é…’åº—è¯¦æƒ…
   */
  private async loadHotelDetail(): Promise<void> {
    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    if (!this.networkService.isInternetAvailable()) {
      ErrorHandler.showToast('ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      return;
    }

    this.isLoading = true;
    try {
      hilog.info(DOMAIN, TAG, `Loading hotel detail: ${this.hotelId}`);
      const hotel = await this.api.getHotelDetail(this.hotelId);
      
      // æ›´æ–°é¡µé¢æ•°æ®
      this.hotelName = hotel.name;
      this.price = hotel.price;
      
      hilog.info(DOMAIN, TAG, 'Hotel detail loaded successfully');
      
      // å¦‚æœå·²é€‰æ‹©æ—¥æœŸï¼Œæ£€æŸ¥å¯ç”¨æ€§
      if (this.checkInDate && this.checkOutDate) {
        this.checkAvailability();
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Failed to load hotel: ${JSON.stringify(error)}`);
      ErrorHandler.showToast('åŠ è½½é…’åº—ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
      
      // é™çº§å¤„ç†ï¼šä½¿ç”¨ä¼ å…¥çš„å‚æ•°
      if (!this.hotelName) {
        this.hotelName = 'è±ªåé…’åº—';
      }
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ£€æŸ¥æˆ¿é—´å¯ç”¨æ€§
   */
  private async checkAvailability(): Promise<void> {
    if (!this.checkInDate || !this.checkOutDate) {
      return;
    }

    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    if (!this.networkService.isInternetAvailable()) {
      this.isAvailable = false;
      this.availabilityMessage = 'ç½‘ç»œä¸å¯ç”¨ï¼Œæ— æ³•æ£€æŸ¥å¯ç”¨æ€§';
      return;
    }

    this.isCheckingAvailability = true;
    this.availabilityMessage = 'æ­£åœ¨æ£€æŸ¥å¯ç”¨æ€§...';

    try {
      hilog.info(DOMAIN, TAG, `Checking availability for ${this.hotelId}`);
      
      const result = await this.api.checkHotelAvailability(
        this.hotelId,
        this.checkInDate,
        this.checkOutDate,
        this.roomType
      );

      this.isAvailable = result.available;
      
      if (result.available) {
        this.availabilityMessage = 'âœ… æˆ¿é—´å¯é¢„è®¢';
        hilog.info(DOMAIN, TAG, 'Room is available');
      } else {
        this.availabilityMessage = 'âŒ è¯¥æ—¶æ®µå·²å”®ç½„';
        hilog.warn(DOMAIN, TAG, 'Room is not available');
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Failed to check availability: ${JSON.stringify(error)}`);
      
      // é™çº§å¤„ç†ï¼šå‡è®¾å¯ç”¨
      this.isAvailable = true;
      this.availabilityMessage = 'âš ï¸ æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    } finally {
      this.isCheckingAvailability = false;
    }
  }

  /**
   * è®¡ç®—æ€»ä»·
   */
  private calculateTotal(): void {
    if (this.checkInDate && this.checkOutDate) {
      // ç®€å•è®¡ç®—å¤©æ•°ï¼ˆå®é™…åº”è¯¥ç”¨æ—¥æœŸåº“ï¼‰
      this.nights = 2; // é»˜è®¤2æ™š
      this.totalPrice = this.price * this.nights;
      
      // æ£€æŸ¥å¯ç”¨æ€§
      this.checkAvailability();
    }
  }

  /**
   * ç”Ÿæˆå¯é€‰æ—¥æœŸåˆ—è¡¨
   */
  private generateAvailableDates(): string[] {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 0; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      dates.push(dateStr);
    }
    return dates;
  }

  /**
   * æäº¤é¢„è®¢ï¼ˆå‘é€åˆ°æœåŠ¡å™¨ï¼‰
   */
  private async onBooking(): Promise<void> {
    if (!this.validateForm()) {
      return;
    }

    // æ£€æŸ¥å¯ç”¨æ€§
    if (!this.isAvailable) {
      ErrorHandler.showToast('è¯¥æ—¶æ®µå·²å”®ç½„ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¥æœŸ');
      return;
    }

    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    if (!this.networkService.isInternetAvailable()) {
      ErrorHandler.showToast('ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      return;
    }

    this.isBooking = true;

    try {
      hilog.info(DOMAIN, TAG, 'Creating booking...');

      // å‘é€é¢„è®¢è¯·æ±‚åˆ°æœåŠ¡å™¨
      const result = await this.api.createHotelBooking({
        hotelId: this.hotelId,
        hotelName: this.hotelName,
        roomType: this.roomType,
        checkInDate: this.checkInDate,
        checkOutDate: this.checkOutDate,
        guestName: this.guestName,
        guestPhone: this.guestPhone,
        nights: this.nights,
        totalPrice: this.totalPrice
      });

      hilog.info(DOMAIN, TAG, `Booking created: ${result.orderId}`);
      ErrorHandler.showToast('é¢„è®¢æˆåŠŸï¼');

      // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
      await router.pushUrl({
        url: 'pages/order/OrderDetailPage',
        params: {
          orderId: result.orderId,
          orderNo: result.orderNo
        }
      });
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Booking failed: ${JSON.stringify(error)}`);
      
      const err = error as Error;
      const errorMessage = err.message || 'é¢„è®¢å¤±è´¥';
      
      // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
      if (errorMessage.includes('401')) {
        ErrorHandler.showToast('è¯·å…ˆç™»å½•');
      } else if (errorMessage.includes('timeout')) {
        ErrorHandler.showToast('ç½‘ç»œè¶…æ—¶ï¼Œè¯·é‡è¯•');
      } else if (errorMessage.includes('network')) {
        ErrorHandler.showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      } else {
        ErrorHandler.showToast(`é¢„è®¢å¤±è´¥: ${errorMessage}`);
      }
    } finally {
      this.isBooking = false;
    }
  }

  /**
   * è¡¨å•éªŒè¯
   */
  private validateForm(): boolean {
    if (!this.checkInDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©å…¥ä½æ—¥æœŸ');
      return false;
    }
    if (!this.checkOutDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©é€€æˆ¿æ—¥æœŸ');
      return false;
    }
    if (!this.guestName.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥å®¢äººå§“å');
      return false;
    }
    if (!this.guestPhone.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»ç”µè¯');
      return false;
    }
    if (this.guestPhone.length !== 11) {
      ErrorHandler.showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
      return false;
    }
    return true;
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'é…’åº—é¢„è®¢ï¼ˆHTTPç‰ˆï¼‰',
        showBack: true
      })

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#007AFF')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            // é…’åº—ä¿¡æ¯
            Row() {
              Text('ğŸ¨').fontSize(40).margin({ right: 16 })
              Column() {
                Text(this.hotelName).fontSize(18).fontWeight(FontWeight.Bold)
                Text(this.roomType).fontSize(14).fontColor('#666').margin({ top: 4 })
                Text(`Â¥${this.price}/æ™š`).fontSize(16).fontColor('#FF6B35').margin({ top: 4 })
              }.alignItems(HorizontalAlign.Start).layoutWeight(1)
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })

            // å¯ç”¨æ€§æç¤º
            if (this.availabilityMessage) {
              Row() {
                Text(this.availabilityMessage)
                  .fontSize(14)
                  .fontColor(this.isAvailable ? '#52c41a' : '#f5222d')
                if (this.isCheckingAvailability) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .margin({ left: 8 })
                }
              }
              .width('100%')
              .padding(12)
              .backgroundColor(this.isAvailable ? '#f6ffed' : '#fff1f0')
              .borderRadius(8)
              .margin({ bottom: 16 })
            }

            // æ—¥æœŸé€‰æ‹©
            Column() {
              Text('å…¥ä½ä¿¡æ¯').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })

              Row() {
                Column() {
                  Text('å…¥ä½æ—¥æœŸ')
                    .fontSize(12)
                    .fontColor('#666')
                  Text(this.checkInDate || 'é€‰æ‹©æ—¥æœŸ')
                    .fontSize(14)
                    .fontColor(this.checkInDate ? '#1a1a1a' : '#999')
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
                .onClick(() => {
                  this.dateType = 'checkin';
                  this.showDatePicker = true;
                })

                Text('|')
                  .fontSize(16)
                  .fontColor('#e0e0e0')
                  .margin({ left: 16, right: 16 })

                Column() {
                  Text('é€€æˆ¿æ—¥æœŸ')
                    .fontSize(12)
                    .fontColor('#666')
                  Text(this.checkOutDate || 'é€‰æ‹©æ—¥æœŸ')
                    .fontSize(14)
                    .fontColor(this.checkOutDate ? '#1a1a1a' : '#999')
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
                .onClick(() => {
                  this.dateType = 'checkout';
                  this.showDatePicker = true;
                })
              }
              .width('100%')
              .height(50)
              .padding(12)
              .backgroundColor('#f9f9f9')
              .borderRadius(8)

              if (this.checkInDate && this.checkOutDate) {
                Text(`å…±${this.nights}æ™š`)
                  .fontSize(12)
                  .fontColor('#666')
                  .margin({ top: 8 })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })
            .alignItems(HorizontalAlign.Start)

            // æ—¥æœŸé€‰æ‹©å™¨
            if (this.showDatePicker) {
              Column() {
                Text(this.dateType === 'checkin' ? 'é€‰æ‹©å…¥ä½æ—¥æœŸ' : 'é€‰æ‹©é€€æˆ¿æ—¥æœŸ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 16 })

                Grid() {
                  ForEach(this.generateAvailableDates(), (date: string, index: number) => {
                    GridItem() {
                      Text(date)
                        .fontSize(14)
                        .fontColor('#1a1a1a')
                        .backgroundColor(Color.White)
                        .width(60)
                        .height(40)
                        .textAlign(TextAlign.Center)
                        .borderRadius(8)
                        .border({ width: 1, color: '#e0e0e0' })
                        .onClick(() => {
                          if (this.dateType === 'checkin') {
                            this.checkInDate = date;
                          } else {
                            this.checkOutDate = date;
                          }
                          this.calculateTotal();
                          this.showDatePicker = false;
                        })
                    }
                  }, (date: string, index: number) => `date-${index}-${date}`)
                }
                .columnsTemplate('1fr 1fr 1fr 1fr')
                .rowsGap(8)
                .columnsGap(8)
                .height(200)

                Button('å–æ¶ˆ')
                  .width('100%')
                  .margin({ top: 16 })
                  .onClick(() => {
                    this.showDatePicker = false;
                  })
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .shadow({ radius: 8, color: '#00000020' })
              .margin({ bottom: 16 })
            }

            // å®¢äººä¿¡æ¯
            Column() {
              Text('å®¢äººä¿¡æ¯').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })
              TextInput({ placeholder: 'è¯·è¾“å…¥å®¢äººå§“å' })
                .fontSize(14)
                .height(44)
                .backgroundColor('#f9f9f9')
                .borderRadius(8)
                .onChange((value: string) => {
                  this.guestName = value;
                })
                .margin({ bottom: 12 })
              TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»ç”µè¯' })
                .fontSize(14)
                .height(44)
                .backgroundColor('#f9f9f9')
                .borderRadius(8)
                .type(InputType.PhoneNumber)
                .onChange((value: string) => {
                  this.guestPhone = value;
                })
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .alignItems(HorizontalAlign.Start)

            // ä»·æ ¼æ˜ç»†
            if (this.checkInDate && this.checkOutDate) {
              Column() {
                Text('ä»·æ ¼æ˜ç»†').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })

                Row() {
                  Text(`${this.roomType} Ã— ${this.nights}æ™š`)
                    .fontSize(14)
                    .fontColor('#666')
                    .layoutWeight(1)
                  Text(`Â¥${this.price * this.nights}`)
                    .fontSize(14)
                    .fontColor('#1a1a1a')
                }
                .width('100%')
                .margin({ bottom: 8 })

                Divider()
                  .color('#e0e0e0')
                  .margin({ top: 8, bottom: 8 })

                Row() {
                  Text('æ€»è®¡')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1a1a1a')
                    .layoutWeight(1)
                  Text(`Â¥${this.totalPrice}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#FF6B35')
                }
                .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ top: 16 })
              .alignItems(HorizontalAlign.Start)
            }
          }
          .padding(16)
        }
        .layoutWeight(1)
      }

      // åº•éƒ¨é¢„è®¢æŒ‰é’®
      Row() {
        Column() {
          Text('æ€»è®¡')
            .fontSize(12)
            .fontColor('#666')
          Text(`Â¥${this.totalPrice}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ right: 16 })

        Button(this.isBooking ? 'æäº¤ä¸­...' : 'ç«‹å³é¢„è®¢')
          .layoutWeight(1)
          .height(48)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor(this.isBooking || !this.isAvailable ? '#cccccc' : '#007AFF')
          .borderRadius(24)
          .enabled(!this.isBooking && this.isAvailable)
          .onClick(() => this.onBooking())

        if (this.isBooking) {
          LoadingProgress()
            .width(24)
            .height(24)
            .margin({ left: 8 })
            .color(Color.White)
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .border({ width: { top: 1 }, color: '#e0e0e0' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
