/**
 * æ—¥æœŸé€‰æ‹©é¡µé¢
 * ç”¨äºé…’åº—é¢„è®¢çš„å…¥ä½/é€€æˆ¿æ—¥æœŸé€‰æ‹©
 * å‚è€ƒ: example_code/DateSelection
 * v5.0: ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸“æ³¨äºæ—¥æœŸèŒƒå›´é€‰æ‹©
 */

import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

interface DateInfo {
  year: number;
  month: number;
  day: number;
  date: Date;
}

@Entry
@Component
export struct DateSelectionPage {
  @State checkInDate: DateInfo | null = null;
  @State checkOutDate: DateInfo | null = null;
  @State currentMonth: number = new Date().getMonth();
  @State currentYear: number = new Date().getFullYear();
  @State stayNights: number = 0;
  @State selectedMode: 'checkIn' | 'checkOut' | null = null;

  private weekdays: string[] = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  private monthNames: string[] = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

  aboutToAppear() {
    // åˆå§‹åŒ–é€‰æ‹©æ¨¡å¼ä¸ºå…¥ä½æ—¥æœŸ
    this.selectedMode = 'checkIn';
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()

      Scroll() {
        Column() {
          // æ—¥æœŸèŒƒå›´æ˜¾ç¤º
          this.DateRangeDisplay()

          // æ—¥å†è§†å›¾
          this.CalendarView()

          // æœˆä»½åˆ‡æ¢
          this.MonthNavigation()
        }
      }
      .scrollBar(BarState.Auto)
      .layoutWeight(1)

      // åº•éƒ¨ç¡®è®¤æŒ‰é’®
      this.ConfirmButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder TopBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#1e40af')
        .onClick(() => {
          router.back();
        })

      Text('é€‰æ‹©æ—¥æœŸ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e293b')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('æ¸…ç©º')
        .fontSize(16)
        .fontColor('#1e40af')
        .onClick(() => {
          this.clearDates();
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetY: 2
    })
  }

  @Builder DateRangeDisplay() {
    Row() {
      // å…¥ä½æ—¥æœŸ
      Column() {
        Text('å…¥ä½')
          .fontSize(14)
          .fontColor('#64748b')
          .margin({ bottom: 8 })

        if (this.checkInDate) {
          Column() {
            Text(`${this.checkInDate.month + 1}æœˆ${this.checkInDate.day}æ—¥`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e40af')

            Text(this.getWeekday(this.checkInDate.date))
              .fontSize(12)
              .fontColor('#94a3b8')
              .margin({ top: 4 })
          }
        } else {
          Text('è¯·é€‰æ‹©')
            .fontSize(16)
            .fontColor('#cbd5e1')
        }
      }
      .layoutWeight(1)
      .padding(20)
      .backgroundColor(this.selectedMode === 'checkIn' ? '#e0f2fe' : Color.White)
      .borderRadius(12)
      .onClick(() => {
        this.selectedMode = 'checkIn';
      })

      // åœç•™æ™šæ•°
      Column() {
        Text('ğŸŒ™')
          .fontSize(20)
        Text(`${this.stayNights}æ™š`)
          .fontSize(12)
          .fontColor('#64748b')
          .margin({ top: 4 })
      }
      .width(60)
      .justifyContent(FlexAlign.Center)

      // é€€æˆ¿æ—¥æœŸ
      Column() {
        Text('é€€æˆ¿')
          .fontSize(14)
          .fontColor('#64748b')
          .margin({ bottom: 8 })

        if (this.checkOutDate) {
          Column() {
            Text(`${this.checkOutDate.month + 1}æœˆ${this.checkOutDate.day}æ—¥`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e40af')

            Text(this.getWeekday(this.checkOutDate.date))
              .fontSize(12)
              .fontColor('#94a3b8')
              .margin({ top: 4 })
          }
        } else {
          Text('è¯·é€‰æ‹©')
            .fontSize(16)
            .fontColor('#cbd5e1')
        }
      }
      .layoutWeight(1)
      .padding(20)
      .backgroundColor(this.selectedMode === 'checkOut' ? '#e0f2fe' : Color.White)
      .borderRadius(12)
      .onClick(() => {
        if (this.checkInDate) {
          this.selectedMode = 'checkOut';
        } else {
          promptAction.showToast({
            message: 'è¯·å…ˆé€‰æ‹©å…¥ä½æ—¥æœŸ',
            duration: 2000
          });
        }
      })
    }
    .width('100%')
    .padding(16)
    .margin({ bottom: 12 })
  }

  @Builder CalendarView() {
    Column() {
      // æœˆä»½æ ‡é¢˜
      Text(`${this.currentYear}å¹´ ${this.monthNames[this.currentMonth]}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e293b')
        .margin({ bottom: 16 })

      // æ˜ŸæœŸæ ‡é¢˜
      Row() {
        ForEach(this.weekdays ?? [], (day: string, index: number) => {
          Text(day)
            .fontSize(14)
            .fontColor('#64748b')
            .width('14.28%')
            .textAlign(TextAlign.Center)
        }, (day: string, index: number) => `wd-${index}-${day}`)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ—¥æœŸç½‘æ ¼
      Grid() {
        ForEach(this.getMonthDays() ?? [], (dayInfo: DateInfo | null, index: number) => {
          GridItem() {
            if (dayInfo) {
              this.DayCell(dayInfo)
            } else {
              Text('')
                .width(40)
                .height(40)
            }
          }
        }, (dayInfo: DateInfo | null, index: number) => `d-${index}-${dayInfo ? dayInfo.day : 'empty'}`)
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr')
      .rowsGap(8)
      .columnsGap(8)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder DayCell(dayInfo: DateInfo) {
    Text(`${dayInfo.day}`)
      .fontSize(16)
      .fontColor(this.getDayTextColor(dayInfo))
      .fontWeight(this.isDaySelected(dayInfo) ? FontWeight.Bold : FontWeight.Normal)
      .width(40)
      .height(40)
      .textAlign(TextAlign.Center)
      .backgroundColor(this.getDayBackground(dayInfo))
      .borderRadius(20)
      .onClick(() => {
        this.selectDate(dayInfo);
      })
  }

  @Builder MonthNavigation() {
    Row() {
      Button('ä¸Šä¸ªæœˆ')
        .fontSize(14)
        .fontColor('#1e40af')
        .backgroundColor('#e0f2fe')
        .borderRadius(8)
        .height(36)
        .onClick(() => {
          this.previousMonth();
        })

      Text(`${this.currentYear}å¹´${this.currentMonth + 1}æœˆ`)
        .fontSize(14)
        .fontColor('#64748b')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button('ä¸‹ä¸ªæœˆ')
        .fontSize(14)
        .fontColor('#1e40af')
        .backgroundColor('#e0f2fe')
        .borderRadius(8)
        .height(36)
        .onClick(() => {
          this.nextMonth();
        })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 12 })
  }

  @Builder ConfirmButton() {
    Button('ç¡®è®¤æ—¥æœŸ')
      .width('90%')
      .height(48)
      .margin({ top: 16, bottom: 16 })
      .backgroundColor(this.checkInDate && this.checkOutDate ? '#1e40af' : '#cbd5e1')
      .fontSize(16)
      .fontColor(Color.White)
      .enabled(this.checkInDate !== null && this.checkOutDate !== null)
      .onClick(() => {
        this.confirmDates();
      })
  }

  // è·å–å½“æœˆçš„æ‰€æœ‰æ—¥æœŸ
  private getMonthDays(): (DateInfo | null)[] {
    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
    const startWeekday = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const days: (DateInfo | null)[] = [];

    // å¡«å……å‰é¢çš„ç©ºç™½
    for (let i = 0; i < startWeekday; i++) {
      days.push(null);
    }

    // å¡«å……æ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(this.currentYear, this.currentMonth, day);
      days.push({
        year: this.currentYear,
        month: this.currentMonth,
        day: day,
        date: date
      });
    }

    return days;
  }

  // é€‰æ‹©æ—¥æœŸ
  private selectDate(dayInfo: DateInfo) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (dayInfo.date < today) {
      promptAction.showToast({
        message: 'ä¸èƒ½é€‰æ‹©è¿‡å»çš„æ—¥æœŸ',
        duration: 2000
      });
      return;
    }

    if (this.selectedMode === 'checkIn') {
      this.checkInDate = dayInfo;
      // å¦‚æœé€€æˆ¿æ—¥æœŸæ—©äºå…¥ä½æ—¥æœŸï¼Œæ¸…ç©ºé€€æˆ¿æ—¥æœŸ
      if (this.checkOutDate && this.checkOutDate.date <= dayInfo.date) {
        this.checkOutDate = null;
      }
      this.selectedMode = 'checkOut';
      this.calculateStayNights();
    } else if (this.selectedMode === 'checkOut') {
      if (this.checkInDate && dayInfo.date > this.checkInDate.date) {
        this.checkOutDate = dayInfo;
        this.calculateStayNights();
      } else {
        promptAction.showToast({
          message: 'é€€æˆ¿æ—¥æœŸå¿…é¡»æ™šäºå…¥ä½æ—¥æœŸ',
          duration: 2000
        });
      }
    }
  }

  // è®¡ç®—åœç•™æ™šæ•°
  private calculateStayNights() {
    if (this.checkInDate && this.checkOutDate) {
      const diffTime = this.checkOutDate.date.getTime() - this.checkInDate.date.getTime();
      this.stayNights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    } else {
      this.stayNights = 0;
    }
  }

  // åˆ¤æ–­æ—¥æœŸæ˜¯å¦è¢«é€‰ä¸­
  private isDaySelected(dayInfo: DateInfo): boolean {
    if (this.checkInDate &&
      dayInfo.year === this.checkInDate.year &&
      dayInfo.month === this.checkInDate.month &&
      dayInfo.day === this.checkInDate.day) {
      return true;
    }

    if (this.checkOutDate &&
      dayInfo.year === this.checkOutDate.year &&
      dayInfo.month === this.checkOutDate.month &&
      dayInfo.day === this.checkOutDate.day) {
      return true;
    }

    return false;
  }

  // åˆ¤æ–­æ—¥æœŸæ˜¯å¦åœ¨èŒƒå›´å†…
  private isDayInRange(dayInfo: DateInfo): boolean {
    if (!this.checkInDate || !this.checkOutDate) {
      return false;
    }

    return dayInfo.date > this.checkInDate.date && dayInfo.date < this.checkOutDate.date;
  }

  // è·å–æ—¥æœŸèƒŒæ™¯è‰²
  private getDayBackground(dayInfo: DateInfo): string | Color {
    if (this.isDaySelected(dayInfo)) {
      return '#1e40af';
    }

    if (this.isDayInRange(dayInfo)) {
      return '#e0f2fe';
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (dayInfo.date < today) {
      return '#f1f5f9';
    }

    return Color.Transparent;
  }

  // è·å–æ—¥æœŸæ–‡å­—é¢œè‰²
  private getDayTextColor(dayInfo: DateInfo): string {
    if (this.isDaySelected(dayInfo)) {
      return '#ffffff';
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (dayInfo.date < today) {
      return '#cbd5e1';
    }

    if (this.isDayInRange(dayInfo)) {
      return '#1e40af';
    }

    return '#1e293b';
  }

  // è·å–æ˜ŸæœŸå‡ 
  private getWeekday(date: Date): string {
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    return weekdays[date.getDay()];
  }

  // ä¸Šä¸ªæœˆ
  private previousMonth() {
    if (this.currentMonth === 0) {
      this.currentMonth = 11;
      this.currentYear--;
    } else {
      this.currentMonth--;
    }
  }

  // ä¸‹ä¸ªæœˆ
  private nextMonth() {
    if (this.currentMonth === 11) {
      this.currentMonth = 0;
      this.currentYear++;
    } else {
      this.currentMonth++;
    }
  }

  // æ¸…ç©ºæ—¥æœŸ
  private clearDates() {
    this.checkInDate = null;
    this.checkOutDate = null;
    this.stayNights = 0;
    this.selectedMode = 'checkIn';
  }

  // ç¡®è®¤æ—¥æœŸ
  private confirmDates() {
    if (!this.checkInDate || !this.checkOutDate) {
      return;
    }

    // è¿”å›é€‰æ‹©çš„æ—¥æœŸ
    router.back();

    // TODO: ä¼ é€’æ—¥æœŸå‚æ•°ç»™ä¸Šä¸€é¡µ
    promptAction.showToast({
      message: `å·²é€‰æ‹© ${this.checkInDate.month + 1}/${this.checkInDate.day} - ${this.checkOutDate.month + 1}/${this.checkOutDate.day}ï¼Œå…±${this.stayNights}æ™š`,
      duration: 2000
    });
  }
}
