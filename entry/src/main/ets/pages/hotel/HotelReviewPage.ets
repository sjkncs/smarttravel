/**
 * é…’åº—å…¥ä½è¯„ä»·é¡µé¢
 * å‚è€ƒç¤ºä¾‹: example_code/UserReview
 */

import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

interface QuickDescItem {
  text: string;
  isSelected: boolean;
}

interface ReviewScore {
  dim: string;
  label: string;
  score: number;
}

@Entry
@Component
export struct HotelReviewPage {
  @State reviewText: string = '';
  @State uploadedImages: string[] = [];
  @State selectedImageUris: string[] = [];
  @State comment: string = '';
  
  // è¯„åˆ†æ•°æ®
  @State reviewScores: ReviewScore[] = [
    { dim: 'overall', label: 'ç»¼åˆè¯„åˆ†', score: 5 },
    { dim: 'facility', label: 'é…’åº—è®¾æ–½', score: 5 },
    { dim: 'service', label: 'æœåŠ¡æ€åº¦', score: 5 },
    { dim: 'environment', label: 'é…’åº—ç¯å¢ƒ', score: 5 },
  ];
  
  // å¿«æ·æè¿°é€‰é¡¹
  @State quickItems: QuickDescItem[] = [
    { text: 'äº¤é€šä¾¿åˆ©', isSelected: false },
    { text: 'è®¾æ–½å®Œå–„', isSelected: false },
    { text: 'å¹²å‡€å«ç”Ÿ', isSelected: false },
    { text: 'å®‰é™èˆ’é€‚', isSelected: false },
    { text: 'æœåŠ¡å‘¨åˆ°', isSelected: false },
    { text: 'æ€§ä»·æ¯”é«˜', isSelected: false }
  ];
  
  private starIcon = 'â˜…';
  private scoreDescriptions = ['ç³Ÿç³•', 'è¾ƒå·®', 'ä¸€èˆ¬', 'æ»¡æ„', 'å¾ˆæ£’'];
  private hotelId: string = '';
  private orderId: string = '';

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, string>;
    if (params) {
      this.hotelId = params.hotelId || '';
      this.orderId = params.orderId || '';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()
      
      Scroll() {
        Column() {
          // è¯„åˆ†æ¨¡å—
          this.RatingSection()
          
          // è¾“å…¥å’Œå›¾ç‰‡ä¸Šä¼ æ¨¡å—
          this.CommentSection()
        }
      }
      .scrollBar(BarState.Auto)
      .layoutWeight(1)
      
      // åº•éƒ¨æäº¤æŒ‰é’®
      this.SubmitButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  // é¡¶éƒ¨å¯¼èˆªæ 
  @Builder TopBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text('é…’åº—ç‚¹è¯„')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Text('    ')
        .fontSize(24)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
  }

  // è¯„åˆ†æ¨¡å—
  @Builder RatingSection() {
    Column({ space: 12 }) {
      ForEach(this.reviewScores ?? [], (reviewScore: ReviewScore, index: number) => {
        this.buildRatingItem(reviewScore)
      }, (reviewScore: ReviewScore, index: number) => `score-${reviewScore.dim}-${index}`)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 12 })
    .backgroundColor('#ffffff')
    .borderRadius(16)
  }

  @Builder buildRatingItem(reviewScore: ReviewScore) {
    Row() {
      Row() {
        Text(reviewScore.label + 'ï¼š')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        // æ˜Ÿæ˜Ÿè¯„åˆ†
        Row({ space: 4 }) {
          ForEach([1, 2, 3, 4, 5], (selectedScore: number, idx: number) => {
            Text(this.starIcon)
              .fontSize(24)
              .fontColor(selectedScore <= reviewScore.score ? '#FFD700' : '#CCCCCC')
              .onClick(() => {
                reviewScore.score = selectedScore;
                this.reviewScores = [...this.reviewScores];
              })
          }, (selectedScore: number, idx: number) => `star-${reviewScore.dim}-${idx}`)
        }
        .margin({ left: 8 })
      }

      // è¯„åˆ†æè¿°
      Text(this.getScoreDescription(reviewScore.score))
        .fontSize(14)
        .fontColor('#ff9900')
    }
    .justifyContent(FlexAlign.SpaceBetween)
    .width('100%')
  }

  // è¯„è®ºå’Œå›¾ç‰‡æ¨¡å—
  @Builder CommentSection() {
    Column({ space: 16 }) {
      // è¯„è®ºè¾“å…¥æ¡†
      TextArea({
        text: $$this.comment,
        placeholder: 'è¯·è¾“å…¥æ‚¨çœŸå®çš„å…¥ä½æ„Ÿå—ï¼ˆé€‰å¡«ï¼‰'
      })
        .width('100%')
        .height(160)
        .fontSize(14)
        .placeholderFont({ size: 14 })
        .placeholderColor('#999999')
        .lineHeight(22)
        .borderRadius(8)
        .maxLength(200)
        .showCounter(true)
        .backgroundColor('#f5f5f5')

      // å¿«æ·æè¿°
      Column({ space: 8 }) {
        Text('å¿«æ·æè¿°ï¼š')
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .textAlign(TextAlign.Start)
        
        Grid() {
          ForEach(this.quickItems ?? [], (item: QuickDescItem, index: number) => {
            GridItem() {
              Text(item.text)
                .fontSize(14)
                .fontColor(item.isSelected ? '#0086f6' : '#666666')
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .backgroundColor(item.isSelected ? '#e6f4ff' : '#f5f5f5')
                .borderRadius(16)
                .onClick(() => {
                  item.isSelected = !item.isSelected;
                  this.quickItems = [...this.quickItems];
                })
            }
          }, (item: QuickDescItem, index: number) => `qdesc-${index}-${item.text}`)
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(10)
        .rowsGap(10)
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')

      // å›¾ç‰‡ä¸Šä¼ ï¼ˆå ä½ç¬¦ï¼‰
      Column({ space: 8 }) {
        Text('ä¸Šä¼ å›¾ç‰‡ï¼š')
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .textAlign(TextAlign.Start)
        
        Row() {
          // ä¸Šä¼ å›¾ç‰‡æŒ‰é’®
          Column() {
            Text('ğŸ“·')
              .fontSize(24)
            Text('ä¸Šä¼ å›¾ç‰‡')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          .justifyContent(FlexAlign.Center)
          .width(90)
          .height(90)
          .backgroundColor('#f5f5f5')
          .borderRadius(8)
          .onClick(() => {
            promptAction.showToast({
              message: 'å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...',
              duration: 2000
            });
          })
        }
      }
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 10 })
    .backgroundColor('#ffffff')
    .borderRadius(16)
  }

  // æäº¤æŒ‰é’®
  @Builder SubmitButton() {
    Button('å‘è¡¨è¯„ä»·')
      .width('90%')
      .height(44)
      .margin({ top: 16, bottom: 16 })
      .backgroundColor('#0086f6')
      .fontSize(16)
      .fontColor('#ffffff')
      .onClick(() => {
        this.submitReview();
      })
  }

  // è·å–è¯„åˆ†æè¿°
  private getScoreDescription(score: number): string {
    if (score >= 1 && score <= this.scoreDescriptions.length) {
      return this.scoreDescriptions[score - 1];
    }
    return '';
  }

  // æäº¤è¯„ä»·
  private submitReview() {
    // è·å–é€‰ä¸­çš„å¿«æ·æè¿°
    const selectedQuickDesc = this.quickItems
      .filter(item => item.isSelected)
      .map(item => item.text)
      .join(', ');

    console.log('æäº¤è¯„ä»·:', {
      hotelId: this.hotelId,
      orderId: this.orderId,
      scores: this.reviewScores,
      comment: this.comment,
      quickDesc: selectedQuickDesc,
      images: this.selectedImageUris
    });

    // æ˜¾ç¤ºæäº¤æˆåŠŸæç¤º
    promptAction.showToast({
      message: 'æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼',
      duration: 2000
    });

    // è¿”å›ä¸Šä¸€é¡µ
    setTimeout(() => {
      router.back();
    }, 1000);
  }
}
