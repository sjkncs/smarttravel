/**
 * é…’åº—åˆ—è¡¨é¡µé¢
 * å±•ç¤ºæ·±åœ³é…’åº—ï¼Œå·²å…¥ä½çš„å¯ä»¥è¯„ä»·
 */

import { router } from '@kit.ArkUI';
import { shenzhenHotels, HotelData } from '../../viewmodel/ShenzhenData';

@Entry
@Component
export struct HotelListPage {
  @State hotels: HotelData[] = [];

  aboutToAppear() {
    console.log('[HotelListPage] aboutToAppear - é¡µé¢åˆå§‹åŒ–');
    try {
      this.hotels = [...shenzhenHotels];
      console.log('[HotelListPage] é…’åº—æ•°æ®åŠ è½½å®Œæˆ:', this.hotels.length);
    } catch (error) {
      console.error('[HotelListPage] åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()
      
      // é…’åº—åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.hotels, (hotel: HotelData) => {
            this.HotelCard(hotel)
          }, (hotel: HotelData) => hotel.id) // æ·»åŠ keyGenerator
        }
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  // é¡¶éƒ¨å¯¼èˆªæ 
  @Builder TopBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text('æ·±åœ³é…’åº—')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Text('ðŸ”')
        .fontSize(20)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
  }

  // é…’åº—å¡ç‰‡
  @Builder HotelCard(hotel: HotelData) {
    Column() {
      Row({ space: 12 }) {
        // é…’åº—å›¾ç‰‡
        Image(hotel.image)
          .width(120)
          .height(90)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
        
        // é…’åº—ä¿¡æ¯
        Column() {
          Text(hotel.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Text(hotel.subtitle)
            .fontSize(13)
            .fontColor('#666666')
            .margin({ top: 4 })
          
          Row() {
            Text(`â­${hotel.rating}`)
              .fontSize(12)
              .fontColor('#ff9900')
            Text(`  ${hotel.category}`)
              .fontSize(12)
              .fontColor('#999999')
          }
          .margin({ top: 4 })
          
          Text(hotel.price)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ff6b6b')
            .margin({ top: 6 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      
      // ç‰¹è‰²æ ‡ç­¾
      Row({ space: 6 }) {
        ForEach((hotel.features ?? []).slice(0, 3), (feature: string, index: number) => {
          Text(feature)
            .fontSize(11)
            .fontColor('#666666')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#f5f5f5')
            .borderRadius(4)
        }, (feature: string, index: number) => `feat-${hotel.id}-${index}-${feature}`)
      }
      .width('100%')
      .margin({ top: 12 })
      
      // æ“ä½œæŒ‰é’®
      if (hotel.hasOrder) {
        Row({ space: 10 }) {
          Text('å·²å…¥ä½')
            .fontSize(12)
            .fontColor('#52c41a')
          
          if (hotel.canReview) {
            Button('ç«‹å³è¯„ä»·')
              .fontSize(14)
              .height(32)
              .backgroundColor('#0086f6')
              .onClick(() => {
                // è·³è½¬åˆ°è¯„ä»·é¡µé¢
                router.pushUrl({
                  url: 'pages/hotel/HotelReviewPage',
                  params: {
                    hotelId: hotel.id,
                    orderId: `order_${hotel.id}_${Date.now()}`
                  }
                });
              })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.End)
        .margin({ top: 12 })
      } else {
        Row() {
          Button('æŸ¥çœ‹è¯¦æƒ…')
            .fontSize(14)
            .height(32)
            .backgroundColor('#0086f6')
            .onClick(() => {
              console.log('æŸ¥çœ‹é…’åº—è¯¦æƒ…:', hotel.name);
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.End)
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
  }
}
