import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { HotelOrder, OrderStatus, HotelOrderData } from '../../model/HotelOrderModel';

@Entry
@Component
export struct HotelBookingPage {
  @State hotelName: string = 'è±ªåé…’åº—';
  @State roomType: string = 'è±ªåå¤§åºŠæˆ¿';
  @State checkInDate: string = '';
  @State checkOutDate: string = '';
  @State price: number = 489;
  @State nights: number = 1;
  @State guestName: string = '';
  @State guestPhone: string = '';
  @State totalPrice: number = 489;
  @State showDatePicker: boolean = false;
  @State dateType: 'checkin' | 'checkout' = 'checkin';

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.hotelName = params['hotelName'] as string || 'è±ªåé…’åº—';
      this.price = params['price'] as number || 489;
      this.checkInDate = params['checkInDate'] as string || '';
      this.checkOutDate = params['checkOutDate'] as string || '';
      this.calculateTotal();
    }
  }

  private calculateTotal() {
    if (this.checkInDate && this.checkOutDate) {
      // ç®€å•è®¡ç®—å¤©æ•°ï¼ˆå®é™…åº”è¯¥ç”¨æ—¥æœŸåº“ï¼‰
      this.nights = 2; // é»˜è®¤2æ™š
      this.totalPrice = this.price * this.nights;
    }
  }

  private generateAvailableDates(): string[] {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 0; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      dates.push(dateStr);
    }
    return dates;
  }

  private onBooking() {
    if (!this.validateForm()) {
      return;
    }

    // åˆ›å»ºè®¢å•å¹¶è·³è½¬åˆ°è®¢å•é¡µé¢
    const order = new HotelOrder(
      'HT' + Date.now().toString(),
      this.hotelName,
      'ğŸ¨',
      this.roomType,
      this.checkInDate,
      this.checkOutDate,
      this.totalPrice,
      OrderStatus.PENDING_PAYMENT,
      new Date().toLocaleString(),
      this.guestName,
      this.guestPhone,
      1,
      this.nights
    );

    // å†™å…¥å…¨å±€è®¢å•å¹¶è·³è½¬åˆ°æ”¯ä»˜é¡µ
    HotelOrderData.addOrder(order);

    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/payment/PaymentPage',
        params: {
          orderInfo: {
            orderId: order.id,
            totalPrice: order.totalPrice,
            paymentMethod: 'wechat'
          }
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ”¯ä»˜é¡µé¢'));
  }

  private validateForm(): boolean {
    if (!this.checkInDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©å…¥ä½æ—¥æœŸ');
      return false;
    }
    if (!this.checkOutDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©é€€æˆ¿æ—¥æœŸ');
      return false;
    }
    if (!this.guestName.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥å®¢äººå§“å');
      return false;
    }
    if (!this.guestPhone.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»ç”µè¯');
      return false;
    }
    return true;
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'é…’åº—é¢„è®¢',
        showBack: true
      })

      Scroll() {
        Column() {
          // é…’åº—ä¿¡æ¯
          Row() {
            Text('ğŸ¨').fontSize(40).margin({ right: 16 })
            Column() {
              Text(this.hotelName).fontSize(18).fontWeight(FontWeight.Bold)
              Text(this.roomType).fontSize(14).fontColor('#666').margin({ top: 4 })
              Text(`Â¥${this.price}/æ™š`).fontSize(16).fontColor('#FF6B35').margin({ top: 4 })
            }.alignItems(HorizontalAlign.Start).layoutWeight(1)
          }.width('100%').padding(16).backgroundColor(Color.White).borderRadius(12).margin({ bottom: 16 })

          // æ—¥æœŸé€‰æ‹©
          Column() {
            Text('å…¥ä½ä¿¡æ¯').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })
            
            Row() {
              Column() {
                Text('å…¥ä½æ—¥æœŸ')
                  .fontSize(12)
                  .fontColor('#666')
                Text(this.checkInDate || 'é€‰æ‹©æ—¥æœŸ')
                  .fontSize(14)
                  .fontColor(this.checkInDate ? '#1a1a1a' : '#999')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .onClick(() => {
                this.dateType = 'checkin';
                this.showDatePicker = true;
              })

              Text('|')
                .fontSize(16)
                .fontColor('#e0e0e0')
                .margin({ left: 16, right: 16 })

              Column() {
                Text('é€€æˆ¿æ—¥æœŸ')
                  .fontSize(12)
                  .fontColor('#666')
                Text(this.checkOutDate || 'é€‰æ‹©æ—¥æœŸ')
                  .fontSize(14)
                  .fontColor(this.checkOutDate ? '#1a1a1a' : '#999')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .onClick(() => {
                this.dateType = 'checkout';
                this.showDatePicker = true;
              })
            }
            .width('100%')
            .height(50)
            .padding(12)
            .backgroundColor('#f9f9f9')
            .borderRadius(8)

            if (this.checkInDate && this.checkOutDate) {
              Text(`å…±${this.nights}æ™š`)
                .fontSize(12)
                .fontColor('#666')
                .margin({ top: 8 })
            }
          }.width('100%').padding(16).backgroundColor(Color.White).borderRadius(12).margin({ bottom: 16 }).alignItems(HorizontalAlign.Start)

          // æ—¥æœŸé€‰æ‹©å™¨
          if (this.showDatePicker) {
            Column() {
              Text(this.dateType === 'checkin' ? 'é€‰æ‹©å…¥ä½æ—¥æœŸ' : 'é€‰æ‹©é€€æˆ¿æ—¥æœŸ')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 16 })

              Grid() {
                ForEach(this.generateAvailableDates() ?? [], (date: string, index: number) => {
                  GridItem() {
                    Text(date)
                      .fontSize(14)
                      .fontColor('#1a1a1a')
                      .backgroundColor(Color.White)
                      .width(60)
                      .height(40)
                      .textAlign(TextAlign.Center)
                      .borderRadius(8)
                      .border({ width: 1, color: '#e0e0e0' })
                      .onClick(() => {
                        if (this.dateType === 'checkin') {
                          this.checkInDate = date;
                        } else {
                          this.checkOutDate = date;
                        }
                        this.calculateTotal();
                        this.showDatePicker = false;
                      })
                  }
                }, (date: string, index: number) => `date-${index}-${date}`)
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .rowsGap(8)
              .columnsGap(8)
              .height(200)

              Button('å–æ¶ˆ')
                .width('100%')
                .margin({ top: 16 })
                .onClick(() => {
                  this.showDatePicker = false;
                })
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .shadow({ radius: 8, color: '#00000020' })
            .margin({ bottom: 16 })
          }

          // å®¢äººä¿¡æ¯
          Column() {
            Text('å®¢äººä¿¡æ¯').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥å®¢äººå§“å' })
              .fontSize(14)
              .height(44)
              .backgroundColor('#f9f9f9')
              .borderRadius(8)
              .onChange((value: string) => { this.guestName = value; })
              .margin({ bottom: 12 })
            TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»ç”µè¯' })
              .fontSize(14)
              .height(44)
              .backgroundColor('#f9f9f9')
              .borderRadius(8)
              .type(InputType.PhoneNumber)
              .onChange((value: string) => { this.guestPhone = value; })
          }.width('100%').padding(16).backgroundColor(Color.White).borderRadius(12).alignItems(HorizontalAlign.Start)

          // ä»·æ ¼æ˜ç»†
          if (this.checkInDate && this.checkOutDate) {
            Column() {
              Text('ä»·æ ¼æ˜ç»†').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 12 })
              
              Row() {
                Text(`${this.roomType} Ã— ${this.nights}æ™š`)
                  .fontSize(14)
                  .fontColor('#666')
                  .layoutWeight(1)
                Text(`Â¥${this.price * this.nights}`)
                  .fontSize(14)
                  .fontColor('#1a1a1a')
              }
              .width('100%')
              .margin({ bottom: 8 })

              Divider()
                .color('#e0e0e0')
                .margin({ top: 8, bottom: 8 })

              Row() {
                Text('æ€»è®¡')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#1a1a1a')
                  .layoutWeight(1)
                Text(`Â¥${this.totalPrice}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF6B35')
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ top: 16 })
            .alignItems(HorizontalAlign.Start)
          }
        }.padding(16)
      }.layoutWeight(1)

      // åº•éƒ¨é¢„è®¢æŒ‰é’®
      Row() {
        Column() {
          Text('æ€»è®¡')
            .fontSize(12)
            .fontColor('#666')
          Text(`Â¥${this.totalPrice}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ right: 16 })

        Button('ç«‹å³é¢„è®¢')
          .layoutWeight(1)
          .height(48)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#007AFF')
          .borderRadius(24)
          .onClick(() => this.onBooking())
      }.width('100%').padding(16).backgroundColor(Color.White).border({ width: { top: 1 }, color: '#e0e0e0' })
    }.width('100%').height('100%').backgroundColor('#f5f5f5')
  }
}
