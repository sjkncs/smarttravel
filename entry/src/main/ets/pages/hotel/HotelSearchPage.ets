import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { HotelOrder, OrderStatus, HotelOrderData } from '../../model/HotelOrderModel';

interface Hotel {
  id: string;
  name: string;
  image: string;
  rating: number;
  price: number;
  originalPrice?: number;
  address: string;
  distance: string;
  facilities: string[];
  reviews: number;
}

@Entry
@Component
export struct HotelSearchPage {
  @State searchText: string = '';
  @State hotels: Hotel[] = [
    {
      id: '1',
      name: 'è±ªåé…’åº—',
      image: 'ğŸ¨',
      rating: 4.8,
      price: 489,
      originalPrice: 599,
      address: 'æ·±åœ³å¸‚å—å±±åŒºæ·±å—å¤§é“',
      distance: 'è·ç¦»å¸‚ä¸­å¿ƒ2.1km',
      facilities: ['WiFi', 'åœè½¦åœº', 'å¥èº«æˆ¿', 'æ¸¸æ³³æ± '],
      reviews: 1234
    },
    {
      id: '2',
      name: 'æµ·æ™¯åº¦å‡æ‘',
      image: 'ğŸ–ï¸',
      rating: 4.6,
      price: 1299,
      address: 'æ·±åœ³å¸‚ç›ç”°åŒºæµ·æ»¨è·¯',
      distance: 'è·ç¦»æµ·è¾¹0.2km',
      facilities: ['æµ·æ™¯æˆ¿', 'ç§äººæµ·æ»©', 'SPA', 'é¤å…'],
      reviews: 856
    },
    {
      id: '3',
      name: 'å•†åŠ¡é…’åº—',
      image: 'ğŸ¢',
      rating: 4.5,
      price: 356,
      originalPrice: 420,
      address: 'æ·±åœ³å¸‚ç¦ç”°åŒºä¸­å¿ƒåŒº',
      distance: 'è·ç¦»åœ°é“ç«™0.5km',
      facilities: ['ä¼šè®®å®¤', 'å•†åŠ¡ä¸­å¿ƒ', '24å°æ—¶å‰å°'],
      reviews: 2341
    }
  ];
  @State isLoading: boolean = false;
  @State checkInDate: string = '';
  @State checkOutDate: string = '';
  @State showDatePicker: boolean = false;
  @State dateType: 'checkin' | 'checkout' = 'checkin';

  aboutToAppear() {
    this.loadHotels();
  }

  private loadHotels() {
    this.isLoading = true;
    setTimeout(() => {
      this.hotels = [
        {
          id: '1',
          name: 'è±ªåé…’åº—',
          image: 'ğŸ¨',
          rating: 4.8,
          price: 489,
          originalPrice: 599,
          address: 'æ·±åœ³å¸‚å—å±±åŒºæ·±å—å¤§é“',
          distance: 'è·ç¦»å¸‚ä¸­å¿ƒ2.1km',
          facilities: ['WiFi', 'åœè½¦åœº', 'å¥èº«æˆ¿', 'æ¸¸æ³³æ± '],
          reviews: 1234
        },
        {
          id: '2',
          name: 'æµ·æ™¯åº¦å‡æ‘',
          image: 'ğŸ–ï¸',
          rating: 4.6,
          price: 1299,
          address: 'æ·±åœ³å¸‚ç›ç”°åŒºæµ·æ»¨è·¯',
          distance: 'è·ç¦»æµ·è¾¹0.2km',
          facilities: ['æµ·æ™¯æˆ¿', 'ç§äººæµ·æ»©', 'SPA', 'é¤å…'],
          reviews: 856
        },
        {
          id: '3',
          name: 'å•†åŠ¡é…’åº—',
          image: 'ğŸ¢',
          rating: 4.5,
          price: 356,
          originalPrice: 420,
          address: 'æ·±åœ³å¸‚ç¦ç”°åŒºä¸­å¿ƒåŒº',
          distance: 'è·ç¦»åœ°é“ç«™0.5km',
          facilities: ['ä¼šè®®å®¤', 'å•†åŠ¡ä¸­å¿ƒ', '24å°æ—¶å‰å°'],
          reviews: 2341
        }
      ];
      this.isLoading = false;
    }, 500);
  }

  private onHotelClick(hotel: Hotel) {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/hotel/HotelBookingPage',
        params: {
          hotelId: hotel.id,
          hotelName: hotel.name,
          price: hotel.price,
          checkInDate: this.checkInDate,
          checkOutDate: this.checkOutDate
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'é…’åº—é¢„è®¢é¡µé¢'));
  }

  private createPendingOrderAndGo(hotel: Hotel) {
    // æ„é€ è®¢å•åŸºç¡€ä¿¡æ¯
    const id = `H${Date.now()}`;
    const now = new Date();
    const orderTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

    // å…¥ç¦»åº—æ—¥æœŸï¼šè‹¥æœªé€‰ï¼Œåˆ™é»˜è®¤ä»Šå¤©/æ˜å¤©
    const checkIn = this.checkInDate || `${now.getMonth() + 1}/${now.getDate()}`;
    const checkOutDateObj = new Date(now);
    checkOutDateObj.setDate(now.getDate() + 1);
    const checkOut = this.checkOutDate || `${checkOutDateObj.getMonth() + 1}/${checkOutDateObj.getDate()}`;

    const order = new HotelOrder(
      id,
      hotel.name,
      hotel.image,
      'æ ‡å‡†é—´',
      checkIn,
      checkOut,
      hotel.price,
      OrderStatus.PENDING_PAYMENT,
      orderTime,
      'æ¸¸å®¢',
      '13800000000',
      1,
      1
    );

    HotelOrderData.addOrder(order);

    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/order/HotelOrderPage',
        params: { tabIndex: 1 }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'é…’åº—è®¢å•'));
  }

  private generateAvailableDates(): string[] {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 0; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      dates.push(dateStr);
    }
    return dates;
  }

  private gotoOrders() {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/order/HotelOrderPage',
        params: { tabIndex: 0 }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'é…’åº—è®¢å•é¡µé¢'));
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'ä½å®¿',
        showBack: true
      })

      // è®¢å•å…¥å£
      Row() {
        Button('æŸ¥çœ‹è®¢å•')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#007AFF')
          .borderRadius(16)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .onClick(() => this.gotoOrders())
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
      .padding({ left: 16, right: 16, top: 8 })

      Column() {
        // æœç´¢æ¡†
        TextInput({ placeholder: 'æœç´¢é…’åº—...', text: this.searchText })
          .fontSize(16)
          .height(44)
          .backgroundColor('#f0f0f0')
          .borderRadius(22)
          .padding({ left: 16, right: 16 })
          .margin({ left: 16, right: 16, top: 12, bottom: 12 })
          .onChange((value: string) => {
            this.searchText = value;
          })

        // æ—¥æœŸé€‰æ‹©
        Row() {
          Column() {
            Text('å…¥ä½')
              .fontSize(12)
              .fontColor('#666')
            Text(this.checkInDate || 'é€‰æ‹©æ—¥æœŸ')
              .fontSize(14)
              .fontColor(this.checkInDate ? '#1a1a1a' : '#999')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .onClick(() => {
            this.dateType = 'checkin';
            this.showDatePicker = true;
          })

          Text('|')
            .fontSize(16)
            .fontColor('#e0e0e0')
            .margin({ left: 16, right: 16 })

          Column() {
            Text('ç¦»åº—')
              .fontSize(12)
              .fontColor('#666')
            Text(this.checkOutDate || 'é€‰æ‹©æ—¥æœŸ')
              .fontSize(14)
              .fontColor(this.checkOutDate ? '#1a1a1a' : '#999')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          .onClick(() => {
            this.dateType = 'checkout';
            this.showDatePicker = true;
          })
        }
        .width('100%')
        .height(60)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)
        .margin({ left: 16, right: 16, bottom: 16 })
        .borderRadius(8)

        // æ—¥æœŸé€‰æ‹©å™¨
        if (this.showDatePicker) {
          Column() {
            Text(this.dateType === 'checkin' ? 'é€‰æ‹©å…¥ä½æ—¥æœŸ' : 'é€‰æ‹©ç¦»åº—æ—¥æœŸ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 16 })

            Grid() {
              ForEach(this.generateAvailableDates() ?? [], (date: string, index: number) => {
                GridItem() {
                  Text(date)
                    .fontSize(14)
                    .fontColor('#1a1a1a')
                    .backgroundColor(Color.White)
                    .width(60)
                    .height(40)
                    .textAlign(TextAlign.Center)
                    .borderRadius(8)
                    .border({ width: 1, color: '#e0e0e0' })
                    .onClick(() => {
                      if (this.dateType === 'checkin') {
                        this.checkInDate = date;
                      } else {
                        this.checkOutDate = date;
                      }
                      this.showDatePicker = false;
                    })
                }
              }, (date: string, index: number) => `date-${index}-${date}`)
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .rowsGap(8)
            .columnsGap(8)
            .height(200)

            Button('å–æ¶ˆ')
              .width('100%')
              .margin({ top: 16 })
              .onClick(() => {
                this.showDatePicker = false;
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 8, color: '#00000020' })
          .margin({ left: 16, right: 16, bottom: 16 })
        }

        // é…’åº—åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#999')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        } else {
          List() {
            ForEach(this.hotels ?? [], (hotel: Hotel, index: number) => {
              ListItem() {
                this.HotelCard(hotel)
              }
              .margin({ left: 16, right: 16, top: 8, bottom: 8 })
            }, (hotel: Hotel, index: number) => `hotel-${hotel.id}-${index}`)
          }
          .layoutWeight(1)
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder HotelCard(hotel: Hotel) {
    Column() {
      Row() {
        // é…’åº—å›¾ç‰‡
        Text(hotel.image)
          .fontSize(40)
          .width(80)
          .height(80)
          .textAlign(TextAlign.Center)
          .backgroundColor('#f0f0f0')
          .borderRadius(8)
          .margin({ right: 12 })

        Column() {
          // é…’åº—åç§°å’Œè¯„åˆ†
          Row() {
            Text(hotel.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1a1a1a')
              .layoutWeight(1)

            Row() {
              Text('â­')
                .fontSize(12)
              Text(hotel.rating.toString())
                .fontSize(12)
                .fontColor('#ff6b35')
                .margin({ left: 2 })
            }
          }
          .width('100%')
          .margin({ bottom: 4 })

          // åœ°å€å’Œè·ç¦»
          Text(hotel.address)
            .fontSize(12)
            .fontColor('#666')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 2 })

          Text(hotel.distance)
            .fontSize(12)
            .fontColor('#999')
            .margin({ bottom: 8 })

          // è®¾æ–½
          Row() {
            ForEach((hotel.facilities ?? []).slice(0, 3), (facility: string, index: number) => {
              Text(facility)
                .fontSize(10)
                .fontColor('#666')
                .backgroundColor('#f0f0f0')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
                .margin({ right: 4 })
            }, (facility: string, index: number) => `fac-${hotel.id}-${index}-${facility}`)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 12 })

      // ä»·æ ¼å’Œé¢„è®¢æŒ‰é’®
      Row() {
        Column() {
          if (hotel.originalPrice && hotel.originalPrice > hotel.price) {
            Text(`Â¥${hotel.originalPrice}`)
              .fontSize(12)
              .fontColor('#999')
              .decoration({ type: TextDecorationType.LineThrough })
          }
          
          Row() {
            Text(`Â¥${hotel.price}`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ff6b35')
            Text('/æ™š')
              .fontSize(12)
              .fontColor('#666')
              .margin({ left: 2 })
          }

          Text(`${hotel.reviews}æ¡è¯„ä»·`)
            .fontSize(10)
            .fontColor('#999')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Button('é¢„è®¢')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#007AFF')
          .borderRadius(6)
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .onClick(() => this.createPendingOrderAndGo(hotel))
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => this.onHotelClick(hotel))
  }
}
