import { router, promptAction } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { HotelOrder, OrderStatus, HotelOrderData } from '../../model/HotelOrderModel';
import { DateUtils } from '../../utils/DateUtils';

interface HotelParams {
  hotelId?: string;
  hotelName?: string;
  price?: number;
}

interface DateParams {
  startDate?: string;
  endDate?: string;
  nights?: number;
}

/**
 * é…’åº—è¯¦æƒ…å’Œé¢„è®¢é¡µé¢
 * é›†æˆæ—¥æœŸé€‰æ‹©å’Œæˆ¿å‹é€‰æ‹©åŠŸèƒ½
 */
@Entry
@Component
export struct HotelDetailPage {
  @State hotelId: string = '';
  @State hotelName: string = '';
  @State hotelImage: string = 'ğŸ¨';
  @State rating: number = 4.8;
  @State reviews: number = 1234;
  @State address: string = '';
  @State facilities: string[] = [];
  
  // æ—¥æœŸé€‰æ‹©
  @State checkInDate: string = '';
  @State checkOutDate: string = '';
  @State nights: number = 0;
  
  // æˆ¿å‹é€‰æ‹©
  @State selectedRoomType: string = '';
  @State roomPrice: number = 0;
  @State roomCount: number = 1;
  
  // æˆ¿å‹åˆ—è¡¨
  @State roomTypes: RoomType[] = [];
  
  // å®¢äººä¿¡æ¯
  @State guestName: string = '';
  @State guestPhone: string = '';

  aboutToAppear() {
    const params = router.getParams() as HotelParams;
    
    if (params) {
      this.hotelId = params.hotelId || '1';
      this.hotelName = params.hotelName || 'è±ªåé…’åº—';
      this.roomPrice = params.price || 489;
    }
    
    // åˆå§‹åŒ–æˆ¿å‹æ•°æ®
    this.initializeRoomTypes();
    
    // åˆå§‹åŒ–é»˜è®¤æ—¥æœŸï¼ˆæ˜å¤©å…¥ä½ï¼Œåå¤©ç¦»åº—ï¼‰
    const tomorrow = DateUtils.addDays(new Date(), 1);
    const dayAfter = DateUtils.addDays(new Date(), 2);
    this.checkInDate = DateUtils.getDateString(tomorrow);
    this.checkOutDate = DateUtils.getDateString(dayAfter);
    this.nights = 1;
  }

  private initializeRoomTypes() {
    this.roomTypes = [
      {
        id: '1',
        name: 'è±ªåå¤§åºŠæˆ¿',
        price: 489,
        originalPrice: 599,
        size: '35ã¡',
        bedType: 'å¤§åºŠ 2.0m',
        maxGuests: 2,
        features: ['å¯ä½2äºº', 'æœ‰çª—', 'å…è´¹WiFi', 'å…è´¹å–æ¶ˆ'],
        image: 'ğŸ›ï¸',
        available: 5
      },
      {
        id: '2',
        name: 'è¡Œæ”¿å¥—æˆ¿',
        price: 899,
        originalPrice: 1099,
        size: '55ã¡',
        bedType: 'å¤§åºŠ 2.0m + æ²™å‘åºŠ',
        maxGuests: 3,
        features: ['å¯ä½3äºº', 'å®¢å…+å§å®¤', 'è¡Œæ”¿é…’å»Š', 'å…è´¹æ—©é¤', 'å»¶è¿Ÿé€€æˆ¿'],
        image: 'ğŸ¨',
        available: 3
      },
      {
        id: '3',
        name: 'æ ‡å‡†åŒåºŠæˆ¿',
        price: 356,
        originalPrice: 420,
        size: '30ã¡',
        bedType: '2å¼ å•äººåºŠ',
        maxGuests: 2,
        features: ['å¯ä½2äºº', 'æœ‰çª—', 'å…è´¹WiFi'],
        image: 'ğŸ›ï¸',
        available: 8
      },
      {
        id: '4',
        name: 'è±ªåæµ·æ™¯æˆ¿',
        price: 1299,
        size: '45ã¡',
        bedType: 'å¤§åºŠ 2.0m',
        maxGuests: 2,
        features: ['å¯ä½2äºº', 'æµ·æ™¯é˜³å°', 'å…è´¹æ—©é¤', 'è¿å®¾æ°´æœ', 'å…è´¹å‡çº§'],
        image: 'ğŸŒŠ',
        available: 2
      }
    ];
    
    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæˆ¿å‹
    if (this.roomTypes.length > 0) {
      this.selectedRoomType = this.roomTypes[0].id;
      this.roomPrice = this.roomTypes[0].price;
    }
  }

  build() {
    Column() {
      TopNavigationBar({
        title: this.hotelName,
        showBack: true
      })

      Scroll() {
        Column() {
          // é…’åº—ä¿¡æ¯å¡ç‰‡
          this.HotelInfoCard()
          
          // æ—¥æœŸé€‰æ‹©å¡ç‰‡
          this.DateSelectionCard()
          
          // æˆ¿å‹é€‰æ‹©
          this.RoomTypeSelection()
          
          // å®¢äººä¿¡æ¯
          this.GuestInfoCard()
        }
        .width('100%')
      }
      .layoutWeight(1)
      .backgroundColor('#f8fafc')
      
      // åº•éƒ¨é¢„è®¢æŒ‰é’®
      this.BottomBookButton()
    }
    .width('100%')
    .height('100%')
  }

  @Builder HotelInfoCard() {
    Column() {
      Row() {
        Text(this.hotelImage)
          .fontSize(60)
          .width(80)
          .height(80)
          .textAlign(TextAlign.Center)
          .backgroundColor('#f0f0f0')
          .borderRadius(8)
        
        Column({ space: 8 }) {
          Text(this.hotelName)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
          
          Row({ space: 8 }) {
            Text('â­')
              .fontSize(14)
            Text(this.rating.toFixed(1))
              .fontSize(14)
              .fontColor('#f59e0b')
            Text(`${this.reviews}æ¡è¯„ä»·`)
              .fontSize(12)
              .fontColor('#999')
          }
          
          if ((this.facilities ?? []).length > 0) {
            Row({ space: 6 }) {
              ForEach((this.facilities ?? []).slice(0, 3), (facility: string, index: number) => {
                Text(facility)
                  .fontSize(11)
                  .fontColor('#666')
                  .padding({ left: 6, right: 6, top: 3, bottom: 3 })
                  .backgroundColor('#f0f0f0')
                  .borderRadius(4)
              }, (facility: string, index: number) => `fac-${index}-${facility}`)
            }
          }
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
  }

  @Builder DateSelectionCard() {
    Column() {
      Row() {
        Text('å…¥ä½æ—¥æœŸ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
        
        Text('ä¿®æ”¹')
          .fontSize(14)
          .fontColor('#007AFF')
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Row() {
        // å…¥ä½æ—¥æœŸ
        Column() {
          Text('å…¥ä½')
            .fontSize(12)
            .fontColor('#999')
            .margin({ bottom: 4 })
          Text(this.formatDateDisplay(this.checkInDate))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        
        // é—´éš”
        Column() {
          Text(`${this.nights}æ™š`)
            .fontSize(14)
            .fontColor('#666')
        }
        .width(60)
        .justifyContent(FlexAlign.Center)
        
        // ç¦»åº—æ—¥æœŸ
        Column() {
          Text('ç¦»åº—')
            .fontSize(12)
            .fontColor('#999')
            .margin({ bottom: 4 })
          Text(this.formatDateDisplay(this.checkOutDate))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
      }
      .width('100%')
      .onClick(() => {
        this.openDatePicker();
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }

  @Builder RoomTypeSelection() {
    Column() {
      Text('é€‰æ‹©æˆ¿å‹')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .margin({ bottom: 12 })
      
      ForEach(this.roomTypes ?? [], (room: RoomType, index: number) => {
        this.RoomTypeCard(room)
      }, (room: RoomType, index: number) => `room-${room.id}-${index}`)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }

  @Builder RoomTypeCard(room: RoomType) {
    Column() {
      Row() {
        Text(room.image)
          .fontSize(40)
          .width(60)
          .height(60)
          .textAlign(TextAlign.Center)
          .backgroundColor('#f8fafc')
          .borderRadius(8)
        
        Column({ space: 6 }) {
          Row() {
            Text(room.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .layoutWeight(1)
            
            Column() {
              if (room.originalPrice) {
                Text(`Â¥${room.originalPrice}`)
                  .fontSize(12)
                  .fontColor('#999')
                  .decoration({ type: TextDecorationType.LineThrough })
              }
              Text(`Â¥${room.price}`)
                .fontSize(18)
                .fontColor('#FF6B35')
                .fontWeight(FontWeight.Bold)
            }
            .alignItems(HorizontalAlign.End)
          }
          .width('100%')
          
          Text(`${room.size} Â· ${room.bedType}`)
            .fontSize(12)
            .fontColor('#666')
          
          Row({ space: 6 }) {
            ForEach((room.features ?? []).slice(0, 3), (feature: string, index: number) => {
              Text(feature)
                .fontSize(11)
                .fontColor('#007AFF')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .backgroundColor('#f0f9ff')
                .borderRadius(4)
            }, (feature: string, index: number) => `rfeat-${room.id}-${index}-${feature}`)
          }
          
          if (room.available < 5) {
            Text(`ä»…å‰©${room.available}é—´`)
              .fontSize(11)
              .fontColor('#FF6B35')
          }
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }
      
      // é€‰æ‹©æŒ‰é’®
      Row() {
        Text('é€‰æ‹©')
          .fontSize(14)
          .fontColor(this.selectedRoomType === room.id ? Color.White : '#007AFF')
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .backgroundColor(this.selectedRoomType === room.id ? '#007AFF' : Color.Transparent)
          .border({
            width: 1,
            color: '#007AFF',
            radius: 16
          })
          .onClick(() => {
            this.selectedRoomType = room.id;
            this.roomPrice = room.price;
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.selectedRoomType === room.id ? '#f0f9ff' : '#f8fafc')
    .borderRadius(8)
    .margin({ bottom: 12 })
    .border({
      width: this.selectedRoomType === room.id ? 2 : 1,
      color: this.selectedRoomType === room.id ? '#007AFF' : '#e5e7eb',
      radius: 8
    })
  }

  @Builder GuestInfoCard() {
    Column() {
      Text('å®¢äººä¿¡æ¯')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .margin({ bottom: 12 })
      
      TextInput({ placeholder: 'å…¥ä½äººå§“å' })
        .height(48)
        .margin({ bottom: 12 })
        .onChange((value: string) => {
          this.guestName = value;
        })
      
      TextInput({ placeholder: 'æ‰‹æœºå·ç ' })
        .height(48)
        .type(InputType.PhoneNumber)
        .maxLength(11)
        .onChange((value: string) => {
          this.guestPhone = value;
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12, bottom: 16 })
  }

  @Builder BottomBookButton() {
    Row() {
      Column({ space: 4 }) {
        Text('æ€»ä»·')
          .fontSize(12)
          .fontColor('#666')
        Text(`Â¥${this.calculateTotalPrice()}`)
          .fontSize(20)
          .fontColor('#FF6B35')
          .fontWeight(FontWeight.Bold)
      }
      .alignItems(HorizontalAlign.Start)
      
      Button('ç«‹å³é¢„è®¢')
        .width(140)
        .height(44)
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor('#007AFF')
        .borderRadius(22)
        .margin({ left: 16 })
        .onClick(() => {
          this.submitBooking();
        })
    }
    .width('100%')
    .height(72)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetY: -2
    })
  }

  // æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
  private openDatePicker() {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/calendar/CalendarPage',
        params: {
          title: 'é€‰æ‹©å…¥ä½æ—¥æœŸ',
          selectRange: true
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ—¥å†é¡µé¢'));
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  private formatDateDisplay(dateString: string): string {
    if (!dateString) return 'è¯·é€‰æ‹©';
    const parts = dateString.split('-');
    if (parts.length !== 3) return dateString;
    return `${parts[1]}æœˆ${parts[2]}æ—¥`;
  }

  // è®¡ç®—æ€»ä»·
  private calculateTotalPrice(): number {
    return this.roomPrice * this.nights * this.roomCount;
  }

  // æäº¤é¢„è®¢
  private submitBooking() {
    // éªŒè¯è¾“å…¥
    if (!this.guestName) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å…¥ä½äººå§“å' });
      return;
    }
    if (!this.guestPhone || this.guestPhone.length !== 11) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ' });
      return;
    }
    if (!this.checkInDate || !this.checkOutDate) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©å…¥ä½æ—¥æœŸ' });
      return;
    }
    
    // åˆ›å»ºè®¢å•
    const selectedRoom = this.roomTypes.find(r => r.id === this.selectedRoomType);
    const order = new HotelOrder(
      Date.now().toString(),
      this.hotelName,
      this.hotelImage,
      selectedRoom?.name || 'æ ‡å‡†æˆ¿',
      this.checkInDate.replace(/-/g, '/'),
      this.checkOutDate.replace(/-/g, '/'),
      this.calculateTotalPrice(),
      OrderStatus.PENDING_PAYMENT,
      DateUtils.getDateString(new Date()),
      this.guestName,
      this.guestPhone,
      this.roomCount,
      this.nights
    );
    
    // æ·»åŠ åˆ°è®¢å•åˆ—è¡¨
    HotelOrderData.addOrder(order);
    
    // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.replaceUrl({
        url: 'pages/order/HotelOrderDetailPage',
        params: { orderId: order.id }
      });
      promptAction.showToast({ message: 'é¢„è®¢æˆåŠŸ' });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è®¢å•è¯¦æƒ…é¡µé¢'));
  }

  // é¡µé¢è¿”å›æ—¶å¤„ç†æ—¥æœŸé€‰æ‹©ç»“æœ
  onPageShow() {
    const params = router.getParams() as DateParams;
    
    if (params && params.startDate && params.endDate) {
      this.checkInDate = params.startDate.replace(/\//g, '-');
      this.checkOutDate = params.endDate.replace(/\//g, '-');
      this.nights = params.nights || 1;
    }
  }
}

// æˆ¿å‹æ¥å£
interface RoomType {
  id: string;
  name: string;
  price: number;
  originalPrice?: number;
  size: string;
  bedType: string;
  maxGuests: number;
  features: string[];
  image: string;
  available: number;
}
