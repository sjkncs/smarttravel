import { router } from '@kit.ArkUI';
import { map, MapComponent } from '@kit.MapKit';
import { LocationInfo, MapMarker, CollectItem, CollectedMarker } from '../../model/LocationModel';
import { CollectListDialog } from '../../components/CollectListDialog';
import { ARNavigationService } from '../../service/ARNavigationService';
import { MapViewModel } from '../../viewmodel/MapViewModel';
import { LiveViewUtil } from '../../utils/LiveViewUtil';
import { BackgroundTaskService } from '../../services/BackgroundTaskService';
import { LiveViewUpdateService, TravelLiveViewData } from '../../services/LiveViewUpdateService';
import { DataChangeDetector, SmartUpdateStrategy, PowerOptimizer } from '../../utils/LiveViewOptimizer';
// import { AgentIconComponent } from '../../agent/SmartTravelAgent'; // æ¨¡æ‹Ÿå™¨ä¸æ”¯æŒAgent Framework
import { common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Entry
@Component
export struct MapPage {
  // ViewModelå®ä¾‹
  private viewModel: MapViewModel = new MapViewModel();
  
  // UIçŠ¶æ€ - ä»ViewModelåŒæ­¥
  @State currentLocation: LocationInfo | null = null;
  @State markers: MapMarker[] = [];
  @State showLocationBubble: boolean = false;
  @State locationPermissionGranted: boolean = false;
  @State isLoading: boolean = false;
  @State departureAddress: string = '';
  @State destinationAddress: string = '';
  @State isAnimating: boolean = false;
  @State showCollectDialog: boolean = false;
  @State favoriteLocations: CollectItem[] = [];
  @State showARButton: boolean = true;
  @State selectedMarkerId: string | null = null;
  @State selectedMarker: MapMarker | null = null;
  
  // å®å†µçª—ç›¸å…³çŠ¶æ€
  @State isNavigating: boolean = false;
  @State navigationDistance: string = '2.5km'; // åˆå§‹è·ç¦»
  @State navigationEta: string = 'é¢„è®¡åˆ°è¾¾';
  @State batteryLevel: number = 100;
  @State updateIntervalValue: number = 5000; // å½“å‰æ›´æ–°é—´éš”
  private updateInterval?: number;
  private context: common.UIAbilityContext | null = null;
  private readonly TAG = '[MapPage]';
  private readonly DOMAIN = 0x0000;
  
  // ä¼˜åŒ–å·¥å…·å®ä¾‹
  private dataChangeDetector: DataChangeDetector = new DataChangeDetector();
  private smartUpdateStrategy: SmartUpdateStrategy = new SmartUpdateStrategy();
  private liveViewUtil: LiveViewUtil = new LiveViewUtil();

  private arNavigationService: ARNavigationService = ARNavigationService.getInstance();

  async aboutToAppear() {
    this.context = getContext(this) as common.UIAbilityContext;
    this.viewModel.setMarkerSelectionListener(this.onMarkerSelectedFromMap);
    await this.viewModel.initialize();
    this.syncStateFromViewModel();
  }

  aboutToDisappear() {
    this.viewModel.setMarkerSelectionListener();
    this.stopNavigation();
  }

  // ä»ViewModelåŒæ­¥çŠ¶æ€åˆ°View
  private syncStateFromViewModel(): void {
    this.currentLocation = this.viewModel.currentLocation;
    this.markers = this.viewModel.markers;
    this.showLocationBubble = this.viewModel.showLocationBubble;
    this.locationPermissionGranted = this.viewModel.locationPermissionGranted;
    this.isLoading = this.viewModel.isLoading;
    this.departureAddress = this.viewModel.departureAddress;
    this.destinationAddress = this.viewModel.destinationAddress;
    this.isAnimating = this.viewModel.isAnimating;
    this.favoriteLocations = this.viewModel.favoriteLocations;
    this.selectedMarkerId = this.viewModel.selectedMarkerId;
    this.selectedMarker = this.viewModel.getMarkerById(this.selectedMarkerId ?? undefined) ?? null;
  }

  private onMarkerSelectedFromMap = (markerId: string | null, markerData?: MapMarker) => {
    this.selectedMarkerId = markerId;
    this.selectedMarker = markerData ?? (markerId ? this.viewModel.getMarkerById(markerId) ?? null : null);
  }

  // è¯·æ±‚å®šä½æƒé™
  private async requestLocationPermission() {
    const success = await this.viewModel.requestLocationPermission();
      if (success) {
      this.syncStateFromViewModel();
    }
  }

  // è·å–å½“å‰ä½ç½®
  private async getCurrentLocation() {
    await this.viewModel.getCurrentLocation();
    this.syncStateFromViewModel();
  }

  // åˆ‡æ¢æ”¶è—çŠ¶æ€
  private toggleFavorite(markerId: string) {
    this.viewModel.toggleFavorite(markerId);
    this.syncStateFromViewModel();
  }

  private async focusMarker(marker: MapMarker) {
    await this.viewModel.focusMarker(marker.id);
    this.selectedMarkerId = marker.id;
    this.selectedMarker = marker;
  }
 
  // åœ°å€äº¤æ¢åŠ¨ç”»
  private async swapAddresses() {
    await this.viewModel.swapAddresses(this.getUIContext());
    this.syncStateFromViewModel();
  }

  // æ·»åŠ æ–°æ ‡è®°
  private async addMarker() {
    const newMarker = await this.viewModel.addMarker();
    if (newMarker) {
      this.syncStateFromViewModel();
    }
  }

  // æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
  private showCollectList() {
    this.showCollectDialog = true;
  }

  // éšè—æ”¶è—åˆ—è¡¨
  private hideCollectList() {
    this.showCollectDialog = false;
  }

  // å¯åŠ¨ARå¯¼èˆªï¼ˆå·²é›†æˆå®å†µçª—ï¼‰
  private async startARNavigation() {
    try {
      // æ£€æŸ¥æ˜¯å¦æœ‰èµ·ç‚¹å’Œç»ˆç‚¹
      if (!this.departureAddress || !this.destinationAddress) {
        hilog.warn(this.DOMAIN, this.TAG, 'è¯·å…ˆè®¾ç½®èµ·ç‚¹å’Œç»ˆç‚¹');
        return;
      }

      if (!this.context || this.isNavigating) return;
      
      hilog.info(this.DOMAIN, this.TAG, 'Starting navigation with live view...');
      
      // 1. åˆ›å»ºå®å†µçª—
      await this.liveViewUtil.createLiveView(
        'æ—…æ¸¸å¯¼èˆª',
        this.navigationDistance,
        'ic_public_location.png',
        this.context
      );
      
      // 2. å¼€å¯åå°ä»»åŠ¡
      await BackgroundTaskService.startBackgroundTask(this.context);
      
      // 3. å¼€å¯å®šæ—¶æ›´æ–°
      this.startPeriodicUpdate();
      
      this.isNavigating = true;
      hilog.info(this.DOMAIN, this.TAG, 'Navigation and live view started successfully');
      
      // 4. è·³è½¬åˆ°ARå¯¼èˆªé¡µé¢
      router.pushUrl({
        url: 'pages/ar/ARNavigationPage'
      }).catch((error: Error) => {
        hilog.error(this.DOMAIN, this.TAG, `è·³è½¬åˆ°ARå¯¼èˆªé¡µé¢å¤±è´¥: ${error.message}`);
      });
    } catch (error) {
      hilog.error(this.DOMAIN, this.TAG, `å¯åŠ¨ARå¯¼èˆªå¤±è´¥: ${error}`);
    }
  }
  
  // åœæ­¢å¯¼èˆªå’Œå®å†µçª—
  private async stopNavigation() {
    if (!this.context || !this.isNavigating) return;
    
    try {
      hilog.info(this.DOMAIN, this.TAG, 'Stopping navigation...');
      
      // 1. æ¸…é™¤å®šæ—¶å™¨
      if (this.updateInterval) {
        clearInterval(this.updateInterval);
        this.updateInterval = undefined;
      }
      
      // 2. åœæ­¢å®å†µçª—
      await this.liveViewUtil.stopLiveView(this.context);
      
      // 3. åœæ­¢åå°ä»»åŠ¡
      await BackgroundTaskService.stopBackgroundTask(this.context);
      
      // 4. é‡ç½®ä¼˜åŒ–å™¨çŠ¶æ€
      this.dataChangeDetector.reset();
      this.smartUpdateStrategy.reset();
      
      // 5. é‡ç½®å¯¼èˆªæ•°æ®
      this.navigationDistance = '2.5km';
      this.navigationEta = 'é¢„è®¡åˆ°è¾¾';
      
      this.isNavigating = false;
      hilog.info(this.DOMAIN, this.TAG, 'âœ… Navigation stopped and resources cleaned');
    } catch (error) {
      hilog.error(this.DOMAIN, this.TAG, `âŒ åœæ­¢å¯¼èˆªå¤±è´¥: ${error}`);
    }
  }
  
  // å¼€å¯å®šæ—¶æ›´æ–°ï¼ˆå¸¦æ™ºèƒ½ä¼˜åŒ–ï¼‰
  private async startPeriodicUpdate() {
    // è·å–å½“å‰ç”µé‡
    this.batteryLevel = await this.smartUpdateStrategy.getBatteryLevel();
    
    // æ ¹æ®ç”µé‡è°ƒæ•´æ›´æ–°é—´éš”
    this.updateIntervalValue = this.smartUpdateStrategy.getUpdateInterval(this.batteryLevel);
    
    hilog.info(this.DOMAIN, this.TAG, `Starting updates with interval: ${this.updateIntervalValue}ms`);
    
    this.updateInterval = setInterval(() => {
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ›´æ–°
      if (!this.smartUpdateStrategy.shouldUpdate()) {
        return;
      }
      
      // æ¨¡æ‹Ÿæ•°æ®æ›´æ–°
      this.updateNavigationData();
      
      // å‡†å¤‡æ›´æ–°æ•°æ®
      const updateData: TravelLiveViewData = {
        title: 'æ—…æ¸¸å¯¼èˆª',
        distance: this.navigationDistance,
        destination: this.destinationAddress,
        eta: this.navigationEta
      };
      
      // æ£€æŸ¥æ•°æ®æ˜¯å¦å˜åŒ–
      if (this.dataChangeDetector.hasChanged(updateData)) {
        // å‘å¸ƒå…¬å…±äº‹ä»¶
        LiveViewUpdateService.publishUpdate(updateData);
        hilog.info(this.DOMAIN, this.TAG, `âœ… Updated: ${this.navigationDistance}`);
      } else {
        hilog.info(this.DOMAIN, this.TAG, `â­ï¸ Skip update: Data unchanged`);
      }
    }, this.updateIntervalValue);
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç”µé‡å¹¶è°ƒæ•´æ›´æ–°é¢‘ç‡
    this.adjustUpdateFrequency();
  }
  
  // åŠ¨æ€è°ƒæ•´æ›´æ–°é¢‘ç‡
  private adjustUpdateFrequency() {
    setInterval(async () => {
      const newBatteryLevel = await this.smartUpdateStrategy.getBatteryLevel();
      const newInterval = this.smartUpdateStrategy.getUpdateInterval(newBatteryLevel);
      
      if (newInterval !== this.updateIntervalValue) {
        hilog.info(this.DOMAIN, this.TAG, 
          `ğŸ”‹ Battery changed: ${this.batteryLevel}% -> ${newBatteryLevel}%`);
        hilog.info(this.DOMAIN, this.TAG, 
          `â±ï¸ Adjusting interval: ${this.updateIntervalValue}ms -> ${newInterval}ms`);
        
        this.batteryLevel = newBatteryLevel;
        this.updateIntervalValue = newInterval;
        
        // é‡å¯å®šæ—¶å™¨ä»¥åº”ç”¨æ–°é—´éš”
        if (this.updateInterval && this.isNavigating) {
          clearInterval(this.updateInterval);
          this.startPeriodicUpdate();
        }
      }
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
  }
  
  // æ›´æ–°å¯¼èˆªæ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
  private updateNavigationData() {
    const currentDist = parseFloat(this.navigationDistance);
    if (currentDist > 0) {
      this.navigationDistance = `${(currentDist - 0.1).toFixed(1)}km`;
    }
    
    const minutes = Math.ceil(currentDist / 0.25);
    this.navigationEta = `é¢„è®¡${minutes}åˆ†é’Ÿåˆ°è¾¾`;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        this.HeaderSection()
        
        // åœ°å€è¾“å…¥åŒºåŸŸ
        this.AddressInputSection()
        
        // åœ°å›¾åŒºåŸŸ
        this.MapSection()
        
        // æ ‡è®°ç‚¹åˆ—è¡¨
        this.MarkersList()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f8fafc')
      
      // æ”¶è—åˆ—è¡¨å¯¹è¯æ¡†
      if (this.showCollectDialog) {
        CollectListDialog({
          visible: $showCollectDialog,
          favorites: this.convertToCollectedMarkers(this.favoriteLocations)
        })
      }
      
      // ä½ç½®æ°”æ³¡
      if (this.showLocationBubble) {
        this.LocationBubble()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder HeaderSection() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      Row() {
        Text('åœ°å›¾å¯¼èˆª')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e40af')
        
        Blank()
        
        // AIæ™ºèƒ½åŠ©æ‰‹ (æ¨¡æ‹Ÿå™¨æš‚ä¸æ”¯æŒAgent Framework)
        // AgentIconComponent()
        //   .width(40)
        //   .height(40)
        //   .margin({ right: 8 })
        
        // æ”¶è—åˆ—è¡¨æŒ‰é’®
        Button() {
          Text('â¤ï¸')
            .fontSize(20)
            .fontColor('#64748b')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .borderRadius(20)
        .margin({ right: 8 })
        .onClick(() => {
          this.showCollectList();
        })
        
        // ARå¯¼èˆª/åœæ­¢æŒ‰é’®
        if (this.showARButton) {
          Button() {
            Row() {
              Text(this.isNavigating ? 'â¹ï¸' : 'ğŸ¥½')
                .fontSize(16)
              Text(this.isNavigating ? 'åœæ­¢' : 'å¯¼èˆª')
                .fontSize(14)
                .fontColor(this.isNavigating ? '#ef4444' : '#1e40af')
                .margin({ left: 4 })
            }
          }
          .height(40)
          .backgroundColor(this.isNavigating ? '#fee2e2' : '#dbeafe')
          .borderRadius(20)
          .padding({ left: 12, right: 12 })
          .margin({ right: 8 })
          .onClick(() => {
            if (this.isNavigating) {
              this.stopNavigation();
            } else {
              this.startARNavigation();
            }
          })
        }
        
        // æ·»åŠ æ ‡è®°æŒ‰é’®
        Button() {
          Text('ğŸ“')
            .fontSize(20)
            .fontColor('#64748b')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .borderRadius(20)
        .onClick(() => {
          this.addMarker();
        })
      }
      .width('100%')
      .height(60)
      .padding({ left: 20, right: 20, top: 10, bottom: 10 })
      
      // å¯¼èˆªçŠ¶æ€é¢æ¿ï¼ˆä»…åœ¨å¯¼èˆªæ—¶æ˜¾ç¤ºï¼‰
      if (this.isNavigating) {
        this.NavigationStatusPanel()
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }
  
  @Builder NavigationStatusPanel() {
    Row() {
      // å®æ—¶è·ç¦»
      Column() {
        Text('ğŸ“ è·ç¦»')
          .fontSize(12)
          .fontColor('#64748b')
        Text(this.navigationDistance)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e40af')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      
      Blank()
      
      // é¢„è®¡åˆ°è¾¾
      Column() {
        Text('ğŸ• åˆ°è¾¾æ—¶é—´')
          .fontSize(12)
          .fontColor('#64748b')
        Text(this.navigationEta)
          .fontSize(14)
          .fontColor('#059669')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
    .backgroundColor('#f0f9ff')
    .borderRadius(8)
    .margin({ left: 20, right: 20, bottom: 10 })
  }

  @Builder AddressInputSection() {
    Column() {
      // å‡ºå‘åœ°
      Row() {
        Text('å‡ºå‘åœ°:')
          .fontSize(16)
          .fontColor('#64748b')
          .width(60)
        
        TextInput({ placeholder: 'è¯·è¾“å…¥å‡ºå‘åœ°', text: this.departureAddress })
          .layoutWeight(1)
          .fontSize(16)
          .fontColor('#1e293b')
          .backgroundColor('#f8fafc')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onChange((value: string) => {
            this.viewModel.setDepartureAddress(value);
            this.departureAddress = value;
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // ç›®çš„åœ°
      Row() {
        Text('ç›®çš„åœ°:')
          .fontSize(16)
          .fontColor('#64748b')
          .width(60)
        
        TextInput({ placeholder: 'è¯·è¾“å…¥ç›®çš„åœ°', text: this.destinationAddress })
          .layoutWeight(1)
          .fontSize(16)
          .fontColor('#1e293b')
          .backgroundColor('#f8fafc')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onChange((value: string) => {
            this.viewModel.setDestinationAddress(value);
            this.destinationAddress = value;
          })
        
        // åœ°å€äº¤æ¢æŒ‰é’®
        Button() {
          Text('ğŸ”„')
            .fontSize(16)
            .fontColor('#1e40af')
        }
        .width(40)
        .height(40)
        .backgroundColor('#f0f8ff')
        .borderRadius(20)
        .margin({ left: 8 })
        .onClick(() => {
          this.swapAddresses();
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  @Builder MapSection() {
    Column() {
      Stack({ alignContent: Alignment.Bottom }) {
        MapComponent({
          mapOptions: this.viewModel.mapOptions,
          mapCallback: this.viewModel.mapCallback,
          customInfoWindow: this.customInfoWindow
        })
          .width('100%')
          .height('100%')

        if (this.currentLocation) {
          Stack() {
            this.CurrentLocationChip(this.currentLocation)
          }
          .position({ x: 16, y: 16 })
        }

        Button() {
          Text('ğŸ“')
            .fontSize(20)
            .fontColor('#1e40af')
        }
        .width(50)
        .height(50)
        .backgroundColor(Color.White)
        .borderRadius(25)
        .shadow({
          radius: 8,
          color: 'rgba(0,0,0,0.15)',
          offsetX: 0,
          offsetY: 4
        })
        .position({ x: 30, y: 220 })
        .onClick(async () => {
          await this.getCurrentLocation();
        })

        if (this.selectedMarker) {
          this.SelectedMarkerCard(this.selectedMarker)
        }

        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(30)
              .height(30)
              .color('#1e40af')

            Text('å®šä½ä¸­...')
              .fontSize(12)
              .fontColor('#64748b')
              .margin({ top: 8 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('rgba(248, 250, 252, 0.8)')
        }
      }
      .width('100%')
      .height(300)
      .borderRadius(12)
      .clip(true)
      .backgroundColor('#f1f5f9')
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
    .margin({ bottom: 8 })
  }

  @Builder MarkersList() {
    Column() {
      Row() {
        Text('æ ‡è®°ç‚¹åˆ—è¡¨')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')
        
        Blank()
        
        Text(`å…± ${this.markers.length} ä¸ª`)
          .fontSize(14)
          .fontColor('#64748b')
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 12 })
      
      Scroll() {
        Column() {
          ForEach(this.markers ?? [], (marker: MapMarker, index: number) => {
            this.MarkerItem(marker, index)
          }, (marker: MapMarker, index: number) => `marker-${marker.id ?? index}`)
        }
        .padding({ left: 20, right: 20, bottom: 20 })
      }
      .scrollBar(BarState.Auto)
      .layoutWeight(1)
    }
    .layoutWeight(1)
  }

  @Builder MarkerItem(marker: MapMarker, index: number) {
    Row() {
      // æ ‡è®°ç‚¹å›¾æ ‡
      Column() {
        Text('ğŸ“')
          .fontSize(24)
          .fontColor(marker.isFavorite ? '#ff6b6b' : (this.selectedMarkerId === marker.id ? '#1e40af' : '#64748b'))
      }
      .width(50)
      .height(50)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      
      // æ ‡è®°ç‚¹ä¿¡æ¯
      Column() {
        Text(marker.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.selectedMarkerId === marker.id ? '#1e40af' : '#1e293b')
          .alignSelf(ItemAlign.Start)
        
        Text(marker.description)
          .fontSize(14)
          .fontColor('#64748b')
          .alignSelf(ItemAlign.Start)
          .margin({ top: 4 })
        
        Text(`åæ ‡: ${marker.latitude.toFixed(4)}, ${marker.longitude.toFixed(4)}`)
          .fontSize(12)
          .fontColor('#94a3b8')
          .alignSelf(ItemAlign.Start)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      
      // æ”¶è—æŒ‰é’®
      Button() {
        Text(marker.isFavorite ? 'â¤ï¸' : 'ğŸ¤')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .borderRadius(20)
      .onClick(() => {
        this.toggleFavorite(marker.id);
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.selectedMarkerId === marker.id ? '#e0f2fe' : Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 12 })
    .onClick(async () => {
      await this.focusMarker(marker);
    })
  }

  @Builder LocationBubble() {
    Stack() {
      // èƒŒæ™¯é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.3)')
        .onClick(() => {
          this.viewModel.hideLocationBubble();
          this.showLocationBubble = false;
        })
      
      // æ°”æ³¡å†…å®¹
      Column() {
        // æ°”æ³¡å¤´éƒ¨
        Row() {
          Text('ğŸ“')
            .fontSize(24)
            .fontColor('#1e40af')
          
          Text('å®šä½æœåŠ¡')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
            .margin({ left: 8 })
          
          Blank()
          
          Button() {
            Text('âœ•')
              .fontSize(16)
              .fontColor('#64748b')
          }
          .width(30)
          .height(30)
          .backgroundColor(Color.Transparent)
          .borderRadius(15)
          .onClick(() => {
            this.viewModel.hideLocationBubble();
            this.showLocationBubble = false;
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        
        // æ°”æ³¡å†…å®¹
        Column() {
          Text('éœ€è¦å¼€å¯å®šä½æƒé™ä»¥è·å–å‘¨è¾¹æ™¯ç‚¹æ¨è')
            .fontSize(16)
            .fontColor('#475569')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 20 })
          
          // æ“ä½œæŒ‰é’®
          Row() {
            Button() {
              Text('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#64748b')
            }
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#f1f5f9')
            .borderRadius(22)
            .margin({ right: 8 })
            .onClick(() => {
              this.viewModel.hideLocationBubble();
              this.showLocationBubble = false;
            })
            
            Button() {
              Text('å¼€å¯å®šä½')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.White)
            }
            .layoutWeight(1)
            .height(44)
            .backgroundColor('#1e40af')
            .borderRadius(22)
            .margin({ left: 8 })
            .onClick(() => {
              this.requestLocationPermission();
            })
          }
          .width('100%')
        }
        .padding({ left: 20, right: 20, bottom: 20 })
      }
      .width(320)
      .backgroundColor(Color.White)
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: 'rgba(0,0,0,0.15)',
        offsetX: 0,
        offsetY: 8
      })
      .position({ x: '50%', y: '50%' })
      .translate({ x: -160, y: -100 })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  @Builder CurrentLocationChip(location: LocationInfo) {
    Row({ space: 8 }) {
      Text('ğŸ“')
        .fontSize(16)
        .fontColor('#1e40af')

      Column() {
        Text('å½“å‰ä½ç½®')
          .fontSize(12)
          .fontColor('#1e293b')
          .fontWeight(FontWeight.Medium)

        Text(location.address ?? `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`)
          .fontSize(10)
          .fontColor('#475569')
      }
    }
    .padding({ left: 14, right: 14, top: 10, bottom: 10 })
    .backgroundColor('rgba(255,255,255,0.92)')
    .borderRadius(24)
    .shadow({
      radius: 8,
      color: 'rgba(15,23,42,0.12)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder SelectedMarkerCard(marker: MapMarker) {
    Column({ space: 12 }) {
      Row() {
        Column() {
          Text(marker.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#0f172a')

          Text(marker.description)
            .fontSize(13)
            .fontColor('#475569')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Button() {
          Text(marker.isFavorite ? 'â¤ï¸' : 'ğŸ¤')
            .fontSize(18)
        }
        .width(44)
        .height(44)
        .backgroundColor('#eff6ff')
        .borderRadius(22)
        .onClick(() => {
          this.toggleFavorite(marker.id);
        })
      }

      Row() {
        Text(`åæ ‡: ${marker.latitude.toFixed(4)}, ${marker.longitude.toFixed(4)}`)
          .fontSize(12)
          .fontColor('#64748b')
        
        Blank()

        Button('èšç„¦')
          .type(ButtonType.Capsule)
          .height(32)
          .onClick(async () => {
            await this.focusMarker(marker);
          })
      }

      Row({ space: 12 }) {
        Button('è®¾ä¸ºç›®çš„åœ°')
          .layoutWeight(1)
          .height(36)
          .type(ButtonType.Normal)
          .onClick(() => {
            this.viewModel.setDestinationAddress(marker.title);
            this.destinationAddress = marker.title;
          })

        Button('è®¾ä¸ºå‡ºå‘åœ°')
          .layoutWeight(1)
          .height(36)
          .backgroundColor(Color.Transparent)
          .borderWidth(1)
          .borderColor('#007AFF')
          .onClick(() => {
            this.viewModel.setDepartureAddress(marker.title);
            this.departureAddress = marker.title;
          })
      }
    }
    .width('90%')
    .padding({ left: 18, right: 18, top: 18, bottom: 18 })
    .backgroundColor(Color.White)
    .borderRadius(18)
    .shadow({
      radius: 16,
      color: 'rgba(15,23,42,0.14)',
      offsetX: 0,
      offsetY: 8
    })
    .align(Alignment.Bottom)
    .margin({ bottom: 16 })
  }

  @Builder customInfoWindowBuilder($$: map.MarkerDelegate) {
    Column({ space: 4 }) {
      Text(this.getMarkerTitle($$))
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(Color.White)

      Text(this.getMarkerDescription($$))
        .fontSize(11)
        .fontColor('rgba(255,255,255,0.85)')
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .padding({ left: 14, right: 14, top: 12, bottom: 12 })
    .backgroundColor('rgba(15,23,42,0.92)')
    .borderRadius(12)
    .visibility(this.getMarkerData($$.marker) ? Visibility.Visible : Visibility.None)
  }

  customInfoWindow: ($$: map.MarkerDelegate) => void = this.customInfoWindowBuilder.bind(this);

  // è·å–æ ‡è®°æ•°æ®çš„è¾…åŠ©æ–¹æ³•
  private getMarkerData(marker: map.Marker): MapMarker | null {
    const markerId: string = marker.getTitle();
    return this.viewModel.getMarkerById(markerId ?? undefined) || null;
  }

  // è·å–æ ‡è®°æ ‡é¢˜
  private getMarkerTitle($$: map.MarkerDelegate): string {
    if (!$$.marker) return '';
    const markerData = this.getMarkerData($$.marker);
    return markerData?.title || '';
  }

  // è·å–æ ‡è®°æè¿°
  private getMarkerDescription($$: map.MarkerDelegate): string {
    if (!$$.marker) return '';
    const markerData = this.getMarkerData($$.marker);
    return markerData?.description || '';
  }

  // è½¬æ¢CollectItem[]åˆ°CollectedMarker[]
  private convertToCollectedMarkers(items: CollectItem[]): CollectedMarker[] {
    return items.map((item): CollectedMarker => ({
      id: item.id || '',
      latitude: item.latitude || 0,
      longitude: item.longitude || 0,
      simpleAddress: item.title || 'æœªå‘½ååœ°å€',
      detailAddress: item.description || 'æœªæä¾›è¯¦ç»†åœ°å€',
      createdAt: Date.now()
    }));
  }
}
