import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface NoticeItem {
  id: string;
  title: string;
  content: string;
  time: string;
  type: 'system' | 'activity' | 'promotion';
  isRead: boolean;
  icon: string;
}

@Entry
@Component
export struct NoticeListPage {
  @State notices: NoticeItem[] = [];
  @State isLoading: boolean = true;
  @State selectedType: string = 'å…¨éƒ¨';

  private noticeTypes: string[] = ['å…¨éƒ¨', 'ç³»ç»Ÿé€šçŸ¥', 'æ´»åŠ¨é€šçŸ¥', 'ä¼˜æƒ é€šçŸ¥'];

  aboutToAppear() {
    this.loadNotices();
  }

  private loadNotices() {
    setTimeout(() => {
      this.notices = [
        {
          id: '1',
          title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥',
          content: 'ç³»ç»Ÿå°†äºŽ2025å¹´11æœˆ15æ—¥ 00:00-06:00è¿›è¡Œç»´æŠ¤å‡çº§ï¼ŒæœŸé—´å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½ï¼Œç»™æ‚¨å¸¦æ¥ä¸ä¾¿æ•¬è¯·è°…è§£ã€‚',
          time: '2025-11-14 10:30',
          type: 'system',
          isRead: false,
          icon: 'ðŸ””'
        },
        {
          id: '2',
          title: 'ä¸–ç•Œä¹‹çª—æ–‡åŒ–èŠ‚å³å°†å¼€å§‹',
          content: 'ä¸–ç•Œä¹‹çª—å›½é™…æ–‡åŒ–èŠ‚å°†äºŽ11æœˆ20æ—¥æ­£å¼å¼€å¹•ï¼Œæå‰è´­ç¥¨äº«å—8æŠ˜ä¼˜æƒ ï¼Œå¿«æ¥ä½“éªŒå¤šå…ƒæ–‡åŒ–é­…åŠ›å§ï¼',
          time: '2025-11-14 09:15',
          type: 'activity',
          isRead: false,
          icon: 'ðŸŽ‰'
        },
        {
          id: '3',
          title: 'é™æ—¶ä¼˜æƒ ï¼šé…’åº—é¢„è®¢8æŠ˜',
          content: 'å³æ—¥èµ·è‡³11æœˆ30æ—¥ï¼Œé¢„è®¢æŒ‡å®šé…’åº—äº«å—8æŠ˜ä¼˜æƒ ï¼Œè¿˜æœ‰å…è´¹æ—©é¤å’Œå»¶è¿Ÿé€€æˆ¿æœåŠ¡ï¼Œæ•°é‡æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—ï¼',
          time: '2025-11-13 16:45',
          type: 'promotion',
          isRead: true,
          icon: 'ðŸ’°'
        },
        {
          id: '4',
          title: 'æ–°åŠŸèƒ½ä¸Šçº¿ï¼šæ™ºèƒ½è·¯çº¿æŽ¨è',
          content: 'æˆ‘ä»¬æŽ¨å‡ºäº†å…¨æ–°çš„æ™ºèƒ½è·¯çº¿æŽ¨èåŠŸèƒ½ï¼Œæ ¹æ®æ‚¨çš„å–œå¥½å’Œä½ç½®ï¼Œä¸ºæ‚¨æŽ¨èæœ€é€‚åˆçš„æ—…æ¸¸è·¯çº¿ï¼Œå¿«æ¥ä½“éªŒå§ï¼',
          time: '2025-11-12 14:20',
          type: 'system',
          isRead: true,
          icon: 'âœ¨'
        },
        {
          id: '5',
          title: 'æ¬¢ä¹è°·ä¸‡åœ£èŠ‚æ´»åŠ¨å¼€å§‹æŠ¥å',
          content: 'æ¬¢ä¹è°·ä¸‡åœ£èŠ‚ç‹‚æ¬¢å¤œæ´»åŠ¨å¼€å§‹æŠ¥åå•¦ï¼å‚ä¸Žæ´»åŠ¨è¿˜æœ‰æœºä¼šèŽ·å¾—ç²¾ç¾Žç¤¼å“ï¼Œå¿«æ¥æŠ¥åå‚åŠ å§ï¼',
          time: '2025-11-11 11:00',
          type: 'activity',
          isRead: true,
          icon: 'ðŸŽƒ'
        }
      ];
      this.isLoading = false;
    }, 600);
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'é€šçŸ¥ä¸­å¿ƒ',
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Column() {
          // åˆ†ç±»ç­›é€‰
          this.TypeFilter()

          // é€šçŸ¥åˆ—è¡¨
          Scroll() {
            Column({ space: 12 }) {
              if (this.filteredNotices.length === 0) {
                this.EmptyView()
              } else {
                ForEach(this.filteredNotices ?? [], (notice: NoticeItem, index: number) => {
                  this.NoticeCard(notice)
                }, (notice: NoticeItem, index: number) => `notice-${notice.id}-${index}`)
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 20 })
          }
          .layoutWeight(1)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ðŸ“¬')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åŠ è½½é€šçŸ¥...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder EmptyView() {
    Column() {
      Text('ðŸ“­')
        .fontSize(64)
        .margin({ bottom: 16 })
      
      Text('æš‚æ— é€šçŸ¥')
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ bottom: 8 })
      
      Text('æ‚¨è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•é€šçŸ¥')
        .fontSize(14)
        .fontColor('#9ca3af')
    }
    .width('100%')
    .padding(40)
    .justifyContent(FlexAlign.Center)
  }

  @Builder TypeFilter() {
    Scroll() {
      Row({ space: 12 }) {
        ForEach(this.noticeTypes ?? [], (type: string, index: number) => {
          Text(type)
            .fontSize(14)
            .fontColor(this.selectedType === type ? Color.White : '#6b7280')
            .backgroundColor(this.selectedType === type ? '#6366f1' : '#f3f4f6')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .borderRadius(20)
            .onClick(() => {
              this.selectedType = type;
            })
        }, (type: string, index: number) => `ntype-${index}-${type}`)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
  }

  @Builder NoticeCard(notice: NoticeItem) {
    Row() {
      // å›¾æ ‡
      Text(notice.icon)
        .fontSize(32)
        .margin({ right: 12 })

      Column({ space: 6 }) {
        Row() {
          Text(notice.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          if (!notice.isRead) {
            Column()
              .width(8)
              .height(8)
              .borderRadius(4)
              .backgroundColor('#ef4444')
          }

          Text(this.getTypeLabel(notice.type))
            .fontSize(10)
            .fontColor(this.getTypeColor(notice.type))
            .backgroundColor(this.getTypeBgColor(notice.type))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
            .margin({ left: 8 })
        }
        .width('100%')

        Text(notice.content)
          .fontSize(13)
          .fontColor('#6b7280')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(18)

        Text(notice.time)
          .fontSize(11)
          .fontColor('#9ca3af')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(notice.isRead ? Color.White : '#f0f9ff')
    .borderRadius(12)
    .border({
      width: notice.isRead ? 0 : 1,
      color: '#dbeafe'
    })
    .onClick(() => {
      this.markAsRead(notice.id);
    })
  }

  get filteredNotices(): NoticeItem[] {
    if (this.selectedType === 'å…¨éƒ¨') {
      return this.notices;
    }
    const typeMap: Record<string, string> = {
      'ç³»ç»Ÿé€šçŸ¥': 'system',
      'æ´»åŠ¨é€šçŸ¥': 'activity',
      'ä¼˜æƒ é€šçŸ¥': 'promotion'
    };
    return this.notices.filter(notice => notice.type === typeMap[this.selectedType]);
  }

  private getTypeLabel(type: string): string {
    const labelMap: Record<string, string> = {
      'system': 'ç³»ç»Ÿ',
      'activity': 'æ´»åŠ¨',
      'promotion': 'ä¼˜æƒ '
    };
    return labelMap[type] || 'é€šçŸ¥';
  }

  private getTypeColor(type: string): string {
    const colorMap: Record<string, string> = {
      'system': '#6366f1',
      'activity': '#10b981',
      'promotion': '#f59e0b'
    };
    return colorMap[type] || '#6b7280';
  }

  private getTypeBgColor(type: string): string {
    const bgMap: Record<string, string> = {
      'system': '#eef2ff',
      'activity': '#d1fae5',
      'promotion': '#fef3c7'
    };
    return bgMap[type] || '#f3f4f6';
  }

  private markAsRead(id: string): void {
    const notice = this.notices.find(n => n.id === id);
    if (notice) {
      notice.isRead = true;
      this.notices = [...this.notices];
    }
  }
}

