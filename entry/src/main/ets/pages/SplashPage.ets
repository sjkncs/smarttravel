import { router } from '@kit.ArkUI';

@Entry
@Component
export struct SplashPage {
  @State private animationProgress: number = 0;
  @State private textOpacity: number = 0;
  @State private scaleValue: number = 0.8;
  @State private rotationAngle: number = 0;
  @State private showContent: boolean = false;
  @State private currentText: string = 'ç²¾å½©å³å°†å‘ˆç°';
  
  private textList: string[] = [
    'ç²¾å½©å³å°†å‘ˆç°',
    'æ™ºæ…§å‡ºè¡Œ',
    'æ¢ç´¢ä¸–ç•Œ',
    'å¼€å¯æ—…ç¨‹'
  ];
  private currentIndex: number = 0;

  aboutToAppear() {
    this.startSplashAnimation();
  }

  private async startSplashAnimation() {
    // å»¶è¿Ÿæ˜¾ç¤ºå†…å®¹
    setTimeout(() => {
      this.showContent = true;
    }, 500);

    // å¯åŠ¨åŠ¨ç”»åºåˆ—
    await this.playAnimationSequence();
    
    // åŠ¨ç”»å®Œæˆåè·³è½¬åˆ°ä¸»é¡µ
    setTimeout(() => {
      router.replaceUrl({ url: 'pages/Index' });
    }, 1500);
  }

  private async playAnimationSequence() {
    // ç¬¬ä¸€é˜¶æ®µï¼šç¼©æ”¾å’Œæ—‹è½¬åŠ¨ç”»
    await this.animateScaleAndRotation();
    
    // ç¬¬äºŒé˜¶æ®µï¼šæ–‡å­—æ·¡å…¥åŠ¨ç”»
    await this.animateTextFadeIn();
    
    // ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡å­—åˆ‡æ¢åŠ¨ç”»
    await this.animateTextSwitch();
    
    // ç¬¬å››é˜¶æ®µï¼šè¿›åº¦æ¡åŠ¨ç”»
    await this.animateProgress();
  }

  private async animateScaleAndRotation(): Promise<void> {
    return new Promise((resolve) => {
      // ç¼©æ”¾åŠ¨ç”»
      animateTo({
        duration: 800,
        curve: Curve.EaseOut,
        onFinish: () => {
          resolve();
        }
      }, () => {
        this.scaleValue = 1.0;
      });

      // æ—‹è½¬åŠ¨ç”»
      animateTo({
        duration: 1200,
        curve: Curve.EaseInOut,
        onFinish: () => {}
      }, () => {
        this.rotationAngle = 360;
      });
    });
  }

  private async animateTextFadeIn(): Promise<void> {
    return new Promise((resolve) => {
      setTimeout(() => {
        animateTo({
          duration: 600,
          curve: Curve.EaseOut,
          onFinish: () => {
            resolve();
          }
        }, () => {
          this.textOpacity = 1.0;
        });
      }, 200);
    });
  }

  private async animateTextSwitch(): Promise<void> {
    return new Promise((resolve) => {
      const switchText = () => {
        if (this.currentIndex < this.textList.length - 1) {
          setTimeout(() => {
            // æ·¡å‡ºå½“å‰æ–‡å­—
            animateTo({
              duration: 300,
              curve: Curve.EaseInOut,
              onFinish: () => {
                this.currentIndex++;
                this.currentText = this.textList[this.currentIndex];
                
                // æ·¡å…¥æ–°æ–‡å­—
                animateTo({
                  duration: 300,
                  curve: Curve.EaseInOut,
                  onFinish: () => {
                    switchText();
                  }
                }, () => {
                  this.textOpacity = 1.0;
                });
              }
            }, () => {
              this.textOpacity = 0;
            });
          }, 800);
        } else {
          resolve();
        }
      };
      
      switchText();
    });
  }

  private async animateProgress(): Promise<void> {
    return new Promise((resolve) => {
      setTimeout(() => {
        animateTo({
          duration: 1000,
          curve: Curve.EaseInOut,
          onFinish: () => {
            resolve();
          }
        }, () => {
          this.animationProgress = 1.0;
        });
      }, 500);
    });
  }

  build() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#667eea', 0.0],
            ['#764ba2', 0.5],
            ['#f093fb', 1.0]
          ]
        })

      // ä¸»è¦å†…å®¹
      if (this.showContent) {
        Column() {
          // Logo åŒºåŸŸ
          Column() {
            // ä¸»å›¾æ ‡
            Stack() {
              // èƒŒæ™¯åœ†å½¢
              Circle()
                .width(120)
                .height(120)
                .fill('#ffffff')
                .opacity(0.2)
                .shadow({
                  radius: 20,
                  color: 'rgba(255,255,255,0.3)',
                  offsetX: 0,
                  offsetY: 10
                })
              
              // æ—‹è½¬çš„è£…é¥°å…ƒç´ 
              Column() {
                ForEach([0, 1, 2, 3], (index: number) => {
                  Circle()
                    .width(8)
                    .height(8)
                    .fill('#ffffff')
                    .opacity(0.6)
                    .position({
                      x: Math.cos(index * Math.PI / 2) * 40,
                      y: Math.sin(index * Math.PI / 2) * 40
                    })
                })
              }
              .width(120)
              .height(120)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .rotate({ angle: this.rotationAngle })
              
              // ä¸­å¿ƒå›¾æ ‡
              Text('ğŸš€')
                .fontSize(48)
                .fontColor('#ffffff')
                .scale({ x: this.scaleValue, y: this.scaleValue })
            }
            .width(120)
            .height(120)
            .alignContent(Alignment.Center)
          }
          .margin({ bottom: 40 })

          // æ–‡å­—åŒºåŸŸ
          Column() {
            Text(this.currentText)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })

            // å‰¯æ ‡é¢˜
            Text('Smart Travel')
              .fontSize(16)
              .fontColor('#ffffff')
              .opacity(0.8)
              .textAlign(TextAlign.Center)
              .margin({ bottom: 40 })
          }

          // è¿›åº¦æ¡
          Column() {
            // è¿›åº¦æ¡èƒŒæ™¯
            Row() {
              Row()
                .width(`${this.animationProgress * 100}%`)
                .height(4)
                .backgroundColor('#ffffff')
                .borderRadius(2)
                .animation({
                  duration: 1000,
                  curve: Curve.EaseInOut
                })
            }
            .width(200)
            .height(4)
            .backgroundColor('rgba(255,255,255,0.3)')
            .borderRadius(2)
            .margin({ bottom: 8 })

            // è¿›åº¦æ–‡å­—
            Text(`${Math.round(this.animationProgress * 100)}%`)
              .fontSize(12)
              .fontColor('#ffffff')
              .opacity(0.7)
          }
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }

      // è£…é¥°æ€§ç²’å­æ•ˆæœ
      Stack() {
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Circle()
            .width(4)
            .height(4)
            .fill('#ffffff')
            .opacity(0.6)
            .position({
              x: Math.random() * 100 + '%',
              y: Math.random() * 100 + '%'
            })
            .animation({
              duration: 2000 + index * 200,
              iterations: -1,
              curve: Curve.EaseInOut
            })
            .scale({
              x: this.animationProgress * 0.5 + 0.5,
              y: this.animationProgress * 0.5 + 0.5
            })
        })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }
}
