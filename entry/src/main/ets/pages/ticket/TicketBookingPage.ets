import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface TicketInfo {
  id: string;
  name: string;
  image: string;
  price: number;
  originalPrice: number;
  description: string;
  validDate: string;
  location: string;
  features: string[];
  notices: string[];
}

interface BookingInfo {
  ticketCount: number;
  selectedDate: string;
  contactName: string;
  contactPhone: string;
  totalPrice: number;
}

@Entry
@Component
export struct TicketBookingPage {
  @State ticketInfo: TicketInfo = {} as TicketInfo;
  @State bookingInfo: BookingInfo = {
    ticketCount: 1,
    selectedDate: '',
    contactName: '',
    contactPhone: '',
    totalPrice: 0
  };
  @State isLoading: boolean = true;
  @State showDatePicker: boolean = false;
  @State availableDates: string[] = [];

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    const ticketId = params['id'] as string || '1';
    this.loadTicketInfo(ticketId);
    this.generateAvailableDates();
  }

  private loadTicketInfo(ticketId: string) {
    // æ¨¡æ‹ŸåŠ è½½é—¨ç¥¨ä¿¡æ¯
    setTimeout(() => {
      this.ticketInfo = {
        id: ticketId,
        name: 'æ·±åœ³æ¬¢ä¹è°·é—¨ç¥¨',
        image: 'https://picsum.photos/id/400/400/300',
        price: 230,
        originalPrice: 280,
        description: 'æ·±åœ³æ¬¢ä¹è°·æ˜¯åä¾¨åŸé›†å›¢æ–°ä¸€ä»£å¤§å‹ä¸»é¢˜ä¹å›­ï¼Œé¦–æ‰¹å›½å®¶AAAAAçº§æ—…æ¸¸æ™¯åŒº',
        validDate: 'è´­ä¹°å30å¤©å†…æœ‰æ•ˆ',
        location: 'æ·±åœ³å¸‚å—å±±åŒºä¾¨åŸè¥¿è¡—18å·',
        features: ['åˆºæ¿€æ¸¸ä¹è®¾æ–½', 'ç²¾å½©æ¼”å‡º', 'ä¸»é¢˜é¤å…', 'çºªå¿µå“å•†åº—'],
        notices: [
          'é—¨ç¥¨å½“æ—¥æœ‰æ•ˆï¼Œè¿‡æœŸä½œåºŸ',
          '1.2ç±³ä»¥ä¸‹å„¿ç«¥å…ç¥¨',
          '1.2-1.5ç±³å„¿ç«¥åŠä»·',
          'è¯·æºå¸¦æœ‰æ•ˆèº«ä»½è¯ä»¶',
          'ç¦æ­¢æºå¸¦é£Ÿç‰©å’Œé¥®æ–™å…¥å›­'
        ]
      };
      this.bookingInfo.totalPrice = this.ticketInfo.price * this.bookingInfo.ticketCount;
      this.isLoading = false;
    }, 800);
  }

  private generateAvailableDates() {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 0; i < 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = date.toISOString().split('T')[0];
      dates.push(dateStr);
    }
    this.availableDates = dates;
    this.bookingInfo.selectedDate = dates[0];
  }

  private updateTicketCount(count: number) {
    if (count < 1) count = 1;
    if (count > 10) count = 10;
    this.bookingInfo.ticketCount = count;
    this.bookingInfo.totalPrice = this.ticketInfo.price * count;
  }

  private submitBooking() {
    if (!this.bookingInfo.contactName.trim()) {
      ErrorHandler.showToast('è¯·å¡«å†™è”ç³»äººå§“å');
      return;
    }
    if (!this.bookingInfo.contactPhone.trim()) {
      ErrorHandler.showToast('è¯·å¡«å†™è”ç³»ç”µè¯');
      return;
    }
    if (!/^1[3-9]\d{9}$/.test(this.bookingInfo.contactPhone)) {
      ErrorHandler.showToast('è¯·å¡«å†™æ­£ç¡®çš„æ‰‹æœºå·ç ');
      return;
    }

    ErrorHandler.safeExecute(async (): Promise<void> => {
      // æ¨¡æ‹Ÿæäº¤è®¢å•
      ErrorHandler.showToast('æ­£åœ¨æäº¤è®¢å•...');
      
      setTimeout(async () => {
        await router.pushUrl({
          url: 'pages/order/OrderConfirmPage',
          params: {
            ticketInfo: this.ticketInfo,
            bookingInfo: this.bookingInfo
          }
        });
      }, 1500);
    }, (error: Error): void => ErrorHandler.handleGenericError(error, 'æäº¤è®¢å•'));
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'é—¨ç¥¨é¢„è®¢',
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.TicketInfoSection()
            this.BookingFormSection()
            this.PriceSection()
            this.NoticesSection()
          }
        }
        .layoutWeight(1)

        this.BottomActionSection()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder LoadingView() {
    Column() {
      Text('ğŸ«')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨åŠ è½½é—¨ç¥¨ä¿¡æ¯...')
        .fontSize(16)
        .fontColor('#6b7280')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder TicketInfoSection() {
    Column() {
      Row() {
        Image(this.ticketInfo.image)
          .width(100)
          .height(100)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)

        Column() {
          Text(this.ticketInfo.name)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .margin({ bottom: 8 })

          Text(this.ticketInfo.description)
            .fontSize(14)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          Row() {
            Text(`Â¥${this.ticketInfo.originalPrice}`)
              .fontSize(14)
              .fontColor('#9ca3af')
              .decoration({ type: TextDecorationType.LineThrough })
            Text(`Â¥${this.ticketInfo.price}`)
              .fontSize(20)
              .fontColor('#ef4444')
              .fontWeight(FontWeight.Bold)
              .margin({ left: 8 })
          }
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }

      Text(`ğŸ“ ${this.ticketInfo.location}`)
        .fontSize(14)
        .fontColor('#6b7280')
        .width('100%')
        .margin({ top: 12 })

      Text(`â° ${this.ticketInfo.validDate}`)
        .fontSize(14)
        .fontColor('#6b7280')
        .width('100%')
        .margin({ top: 4 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
  }

  @Builder BookingFormSection() {
    Column() {
      Text('ğŸ“ é¢„è®¢ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      // æ¸¸ç©æ—¥æœŸ
      Row() {
        Text('æ¸¸ç©æ—¥æœŸ')
          .fontSize(16)
          .fontColor('#374151')
          .layoutWeight(1)

        Text(this.bookingInfo.selectedDate)
          .fontSize(16)
          .fontColor('#3b82f6')
          .onClick(() => {
            this.showDatePicker = true;
          })
      }
      .width('100%')
      .height(48)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#f9fafb')
      .borderRadius(8)
      .margin({ bottom: 12 })

      // é—¨ç¥¨æ•°é‡
      Row() {
        Text('é—¨ç¥¨æ•°é‡')
          .fontSize(16)
          .fontColor('#374151')
          .layoutWeight(1)

        Row() {
          Button('-')
            .width(32)
            .height(32)
            .backgroundColor('#f3f4f6')
            .fontColor('#374151')
            .fontSize(18)
            .onClick(() => {
              this.updateTicketCount(this.bookingInfo.ticketCount - 1);
            })

          Text(this.bookingInfo.ticketCount.toString())
            .fontSize(16)
            .fontColor('#374151')
            .width(40)
            .textAlign(TextAlign.Center)

          Button('+')
            .width(32)
            .height(32)
            .backgroundColor('#f3f4f6')
            .fontColor('#374151')
            .fontSize(18)
            .onClick(() => {
              this.updateTicketCount(this.bookingInfo.ticketCount + 1);
            })
        }
      }
      .width('100%')
      .height(48)
      .padding({ left: 12, right: 12 })
      .backgroundColor('#f9fafb')
      .borderRadius(8)
      .margin({ bottom: 12 })

      // è”ç³»äººå§“å
      TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»äººå§“å' })
        .width('100%')
        .height(48)
        .backgroundColor('#f9fafb')
        .borderRadius(8)
        .padding({ left: 12, right: 12 })
        .fontSize(16)
        .margin({ bottom: 12 })
        .onChange((value: string) => {
          this.bookingInfo.contactName = value;
        })

      // è”ç³»ç”µè¯
      TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»ç”µè¯' })
        .width('100%')
        .height(48)
        .backgroundColor('#f9fafb')
        .borderRadius(8)
        .padding({ left: 12, right: 12 })
        .fontSize(16)
        .type(InputType.PhoneNumber)
        .onChange((value: string) => {
          this.bookingInfo.contactPhone = value;
        })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder PriceSection() {
    Column() {
      Text('ğŸ’° è´¹ç”¨æ˜ç»†')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 16 })

      Row() {
        Text(`é—¨ç¥¨ x ${this.bookingInfo.ticketCount}`)
          .fontSize(16)
          .fontColor('#374151')
          .layoutWeight(1)
        Text(`Â¥${this.ticketInfo.price * this.bookingInfo.ticketCount}`)
          .fontSize(16)
          .fontColor('#374151')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Divider()
        .color('#e5e7eb')
        .margin({ top: 8, bottom: 8 })

      Row() {
        Text('æ€»è®¡')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        Text(`Â¥${this.bookingInfo.totalPrice}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ef4444')
      }
      .width('100%')
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder NoticesSection() {
    Column() {
      Text('âš ï¸ è´­ç¥¨é¡»çŸ¥')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .width('100%')
        .margin({ bottom: 12 })

      Column({ space: 8 }) {
        ForEach(this.ticketInfo.notices, (notice: string) => {
          Row() {
            Text('â€¢')
              .fontSize(16)
              .fontColor('#f59e0b')
              .margin({ right: 8 })
            Text(notice)
              .fontSize(14)
              .fontColor('#6b7280')
              .layoutWeight(1)
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
        })
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(16)
    .margin({ bottom: 12 })
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder BottomActionSection() {
    Row() {
      Column() {
        Text('æ€»è®¡')
          .fontSize(14)
          .fontColor('#6b7280')
        Text(`Â¥${this.bookingInfo.totalPrice}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ef4444')
      }
      .alignItems(HorizontalAlign.Start)

      Button('ç«‹å³é¢„è®¢')
        .backgroundColor('#ef4444')
        .fontColor(Color.White)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .borderRadius(8)
        .layoutWeight(1)
        .margin({ left: 16 })
        .onClick(() => {
          this.submitBooking();
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#e5e7eb' })
  }
}
