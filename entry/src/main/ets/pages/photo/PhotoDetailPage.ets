import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface PhotoComment {
  id: string;
  userName: string;
  avatar: string;
  content: string;
  time: string;
  likes: number;
}

interface PhotoData {
  title: string;
  location: string;
  date: string;
  likes: number;
  comments: number;
  tags: string[];
  url: string;
  description: string;
  commentList: PhotoComment[];
}

@Entry
@Component
export struct PhotoDetailPage {
  @State photoId: string = '';
  @State photoUrl: string = 'https://picsum.photos/400/600?random=1';
  @State photoTitle: string = 'æ·±åœ³æ¹¾æ—¥å‡º';
  @State photoLocation: string = 'æ·±åœ³æ¹¾å…¬å›­';
  @State photoDate: string = '2024-06-01';
  @State photoDescription: string = 'æ¸…æ™¨çš„æ·±åœ³æ¹¾ï¼Œæœéœæ»¡å¤©ï¼Œæµ·é¢æ³¢å…‰ç²¼ç²¼ï¼Œæ˜¯æ·±åœ³æœ€ç¾çš„æ—¥å‡ºè§‚èµåœ°ä¹‹ä¸€ã€‚';
  @State photoTags: string[] = ['æ—¥å‡º', 'æ·±åœ³æ¹¾', 'è‡ªç„¶é£å…‰', 'æ—©æ™¨'];
  @State likes: number = 128;
  @State comments: number = 23;
  @State isLiked: boolean = false;
  @State isFavorite: boolean = false;
  
  @State commentList: PhotoComment[] = [];
  @State newComment: string = '';

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å–ç…§ç‰‡ID
    const params = router.getParams() as Record<string, string>;
    if (params && params.id) {
      this.photoId = params.id;
      this.loadPhotoData(params.id);
    }
  }

  private loadPhotoData(id: string): void {
    // æ ¹æ®IDåŠ è½½å¯¹åº”çš„ç…§ç‰‡æ•°æ®
    const photoData = this.getPhotoById(id);
    if (photoData) {
      this.photoTitle = photoData.title;
      this.photoLocation = photoData.location;
      this.photoDate = photoData.date;
      this.likes = photoData.likes;
      this.comments = photoData.comments;
      this.photoTags = photoData.tags;
      this.photoUrl = photoData.url;
      this.photoDescription = photoData.description;
      this.commentList = photoData.commentList;
    }
  }

  private getPhotoById(id: string): PhotoData | undefined {
    const photos: Record<string, PhotoData> = {
      '1': {
        title: 'æ·±åœ³æ¹¾æ—¥å‡º',
        location: 'æ·±åœ³æ¹¾å…¬å›­',
        date: '2024-06-01',
        likes: 128,
        comments: 23,
        tags: ['æ—¥å‡º', 'æ·±åœ³æ¹¾'],
        url: 'https://picsum.photos/400/600?random=1',
        description: 'æ¸…æ™¨çš„æ·±åœ³æ¹¾ï¼Œæœéœæ»¡å¤©ï¼Œæµ·é¢æ³¢å…‰ç²¼ç²¼ã€‚',
        commentList: [
          { id: '1', userName: 'æ—…è¡Œè¾¾äºº', avatar: 'ğŸ‘¤', content: 'å¤ªç¾äº†ï¼', time: '2å°æ—¶å‰', likes: 5 } as PhotoComment
        ]
      },
      '2': {
        title: 'è²èŠ±å±±å¤œæ™¯',
        location: 'è²èŠ±å±±å…¬å›­',
        date: '2024-06-02',
        likes: 95,
        comments: 15,
        tags: ['å¤œæ™¯', 'åŸå¸‚'],
        url: 'https://picsum.photos/400/600?random=2',
        description: 'è²èŠ±å±±é¡¶ä¿¯ç°æ·±åœ³å¤œæ™¯ï¼Œä¸‡å®¶ç¯ç«ç’€ç’¨ã€‚',
        commentList: [
          { id: '1', userName: 'æ‘„å½±å¸ˆ', avatar: 'ğŸ“·', content: 'å¤œæ™¯çœŸç¾ï¼', time: '1å°æ—¶å‰', likes: 3 } as PhotoComment
        ]
      },
      '3': {
        title: 'ä¸œæ¹–è·èŠ±',
        location: 'ä¸œæ¹–å…¬å›­',
        date: '2024-06-03',
        likes: 156,
        comments: 31,
        tags: ['è·èŠ±', 'å¤å­£'],
        url: 'https://picsum.photos/400/600?random=3',
        description: 'å¤æ—¥çš„ä¸œæ¹–å…¬å›­ï¼Œè·èŠ±ç››å¼€ï¼Œæ¸…é¦™æ‰‘é¼»ã€‚',
        commentList: [
          { id: '1', userName: 'èŠ±å‰çˆ±å¥½è€…', avatar: 'ğŸŒ¸', content: 'è·èŠ±æ‹å¾—çœŸå¥½', time: '3å°æ—¶å‰', likes: 8 } as PhotoComment
        ]
      },
      '4': {
        title: 'æ°‘ä¿—æ–‡åŒ–èŠ‚',
        location: 'å¸‚æ°‘ä¸­å¿ƒ',
        date: '2024-06-04',
        likes: 89,
        comments: 18,
        tags: ['æ°‘ä¿—', 'æ–‡åŒ–'],
        url: 'https://picsum.photos/400/600?random=4',
        description: 'å¸‚æ°‘ä¸­å¿ƒä¸¾åŠçš„æ°‘ä¿—æ–‡åŒ–èŠ‚ï¼Œç²¾å½©çº·å‘ˆã€‚',
        commentList: [
          { id: '1', userName: 'æ–‡åŒ–çˆ±å¥½è€…', avatar: 'ğŸ­', content: 'å¾ˆæœ‰æ„ä¹‰çš„æ´»åŠ¨', time: '5å°æ—¶å‰', likes: 6 } as PhotoComment
        ]
      }
    };
    return photos[id];
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'ç…§ç‰‡è¯¦æƒ…',
        showBack: true
      })

      Scroll() {
        Column() {
          // ç…§ç‰‡å±•ç¤ºåŒº
          this.PhotoView()

          // ç…§ç‰‡ä¿¡æ¯åŒº
          this.PhotoInfo()

          // æ ‡ç­¾åŒº
          this.TagsSection()

          // äº’åŠ¨æŒ‰é’®åŒº
          this.ActionButtons()

          // è¯„è®ºåˆ—è¡¨
          this.CommentSection()
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder PhotoView() {
    Stack({ alignContent: Alignment.TopEnd }) {
      Image(this.photoUrl)
        .width('100%')
        .height(400)
        .objectFit(ImageFit.Cover)

      // æ”¶è—æŒ‰é’®
      Column() {
        Text(this.isFavorite ? 'â­' : 'â˜†')
          .fontSize(24)
          .fontColor(Color.White)
      }
      .width(48)
      .height(48)
      .backgroundColor('rgba(0,0,0,0.5)')
      .borderRadius(24)
      .justifyContent(FlexAlign.Center)
      .margin({ top: 16, right: 16 })
      .onClick(() => {
        this.isFavorite = !this.isFavorite;
      })
    }
    .width('100%')
  }

  @Builder PhotoInfo() {
    Column() {
      Text(this.photoTitle)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Row({ space: 16 }) {
        Row({ space: 6 }) {
          Text('ğŸ“')
            .fontSize(14)
          Text(this.photoLocation)
            .fontSize(14)
            .fontColor('#6b7280')
        }

        Row({ space: 6 }) {
          Text('ğŸ“…')
            .fontSize(14)
          Text(this.photoDate)
            .fontSize(14)
            .fontColor('#6b7280')
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      Text(this.photoDescription)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(22)
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder TagsSection() {
    Column() {
      Text('æ ‡ç­¾')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.photoTags ?? [], (tag: string, index: number) => {
          Text(`#${tag}`)
            .fontSize(13)
            .fontColor('#3b82f6')
            .backgroundColor('#dbeafe')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              console.log('ç‚¹å‡»æ ‡ç­¾:', tag);
              // å¯ä»¥è·³è½¬åˆ°æ ‡ç­¾æœç´¢é¡µé¢
            })
        }, (tag: string, index: number) => `ptag-${index}-${tag}`)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtons() {
    Row() {
      // ç‚¹èµæŒ‰é’®
      Column() {
        Text(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
          .fontSize(24)
          .onClick(() => {
            this.isLiked = !this.isLiked;
            this.likes += this.isLiked ? 1 : -1;
          })

        Text(this.likes.toString())
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Divider()
        .vertical(true)
        .height(40)
        .color('#e5e7eb')

      // è¯„è®ºæŒ‰é’®
      Column() {
        Text('ğŸ’¬')
          .fontSize(24)

        Text(this.comments.toString())
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .onClick(() => {
        // æ»šåŠ¨åˆ°è¯„è®ºåŒº
        console.log('æ»šåŠ¨åˆ°è¯„è®ºåŒº');
      })

      Divider()
        .vertical(true)
        .height(40)
        .color('#e5e7eb')

      // åˆ†äº«æŒ‰é’®
      Column() {
        Text('ğŸ“¤')
          .fontSize(24)

        Text('åˆ†äº«')
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .onClick(() => {
        console.log('åˆ†äº«ç…§ç‰‡');
      })
    }
    .width('100%')
    .height(80)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .justifyContent(FlexAlign.SpaceEvenly)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder CommentSection() {
    Column() {
      Row() {
        Text('è¯„è®º')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)

        Text(`${this.commentList.length}æ¡`)
          .fontSize(14)
          .fontColor('#6b7280')
      }
      .width('100%')
      .margin({ bottom: 16 })

      Column({ space: 16 }) {
        ForEach(this.commentList ?? [], (comment: PhotoComment, index: number) => {
          this.CommentItem(comment)
        }, (comment: PhotoComment, index: number) => `cmt-${index}-${comment.id}`)
      }
      .width('100%')

      // è¯„è®ºè¾“å…¥æ¡†
      Row() {
        TextInput({ placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...', text: this.newComment })
          .layoutWeight(1)
          .height(40)
          .borderRadius(20)
          .backgroundColor('#f3f4f6')
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.newComment = value;
          })

        Button('å‘é€')
          .height(40)
          .fontSize(14)
          .backgroundColor('#3b82f6')
          .borderRadius(20)
          .margin({ left: 8 })
          .onClick(() => {
            this.sendComment();
          })
      }
      .width('100%')
      .margin({ top: 16 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder CommentItem(comment: PhotoComment) {
    Row() {
      // å¤´åƒ
      Text(comment.avatar)
        .fontSize(32)
        .width(40)
        .height(40)
        .borderRadius(20)
        .backgroundColor('#f3f4f6')
        .textAlign(TextAlign.Center)
        .margin({ right: 12 })

      Column() {
        // ç”¨æˆ·åå’Œæ—¶é—´
        Row() {
          Text(comment.userName)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Text(comment.time)
            .fontSize(12)
            .fontColor('#9ca3af')
        }
        .width('100%')
        .margin({ bottom: 6 })

        // è¯„è®ºå†…å®¹
        Text(comment.content)
          .fontSize(14)
          .fontColor('#4b5563')
          .lineHeight(20)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        // ç‚¹èµ
        Row({ space: 4 }) {
          Text('ğŸ‘')
            .fontSize(14)
          Text(comment.likes.toString())
            .fontSize(12)
            .fontColor('#6b7280')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }

  private sendComment(): void {
    if (this.newComment.trim() === '') {
      console.log('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
      return;
    }

    // åˆ›å»ºæ–°è¯„è®º
    const newCommentItem: PhotoComment = {
      id: Date.now().toString(),
      userName: 'æˆ‘',
      avatar: 'ğŸ˜Š',
      content: this.newComment,
      time: 'åˆšåˆš',
      likes: 0
    };

    // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨
    this.commentList.unshift(newCommentItem);
    this.comments += 1;

    // æ¸…ç©ºè¾“å…¥æ¡†
    this.newComment = '';

    console.log('è¯„è®ºå‘é€æˆåŠŸ');
  }
}
