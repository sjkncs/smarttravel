import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { SmartTravelApi, GuideData } from '../../api/SmartTravelApi';
import { NetworkService } from '../../services/NetworkService';
import { hilog } from '@kit.PerformanceAnalysisKit';

const TAG = 'GuideListPageWithHttp';
const DOMAIN = 0xFF00;

/**
 * æ”»ç•¥åˆ—è¡¨é¡µé¢ï¼ˆé›†æˆ HTTP è¯·æ±‚ï¼‰
 * æ¼”ç¤ºåˆ†é¡µåŠ è½½ã€ä¸‹æ‹‰åˆ·æ–°ã€æœç´¢ç­‰åŠŸèƒ½
 */
@Entry
@Component
export struct GuideListPageWithHttp {
  @State guides: GuideData[] = [];
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State isLoadingMore: boolean = false;
  @State hasMore: boolean = true;
  @State currentPage: number = 1;
  @State pageSize: number = 10;
  @State searchKeyword: string = '';
  @State showSearch: boolean = false;
  @State errorMessage: string = '';

  private api: SmartTravelApi = SmartTravelApi.getInstance();
  private networkService: NetworkService = NetworkService.getInstance();
  private scroller: Scroller = new Scroller();

  aboutToAppear() {
    this.loadGuides();
  }

  /**
   * åŠ è½½æ”»ç•¥åˆ—è¡¨
   */
  private async loadGuides(page: number = 1): Promise<void> {
    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    if (!this.networkService.isInternetAvailable()) {
      this.errorMessage = 'ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      ErrorHandler.showToast(this.errorMessage);
      return;
    }

    if (page === 1) {
      this.isLoading = true;
      this.errorMessage = '';
    } else {
      this.isLoadingMore = true;
    }

    try {
      hilog.info(DOMAIN, TAG, `Loading guides page ${page}`);

      const newGuides = await this.api.getGuideList(page, this.pageSize);

      if (page === 1) {
        this.guides = newGuides;
      } else {
        this.guides = this.guides.concat(newGuides);
      }

      this.currentPage = page;
      this.hasMore = newGuides.length >= this.pageSize;

      hilog.info(DOMAIN, TAG, `Loaded ${newGuides.length} guides, total: ${this.guides.length}`);
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Failed to load guides: ${JSON.stringify(error)}`);

      const err = error as Error;
      this.errorMessage = err.message || 'åŠ è½½å¤±è´¥';

      // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
      if (this.errorMessage.includes('timeout')) {
        ErrorHandler.showToast('ç½‘ç»œè¶…æ—¶ï¼Œè¯·é‡è¯•');
      } else if (this.errorMessage.includes('network')) {
        ErrorHandler.showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      } else {
        ErrorHandler.showToast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      }

      // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      if (page === 1) {
        this.guides = [];
      }
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
      this.isLoadingMore = false;
    }
  }

  /**
   * ä¸‹æ‹‰åˆ·æ–°
   */
  private async onRefresh(): Promise<void> {
    this.isRefreshing = true;
    await this.loadGuides(1);
  }

  /**
   * åŠ è½½æ›´å¤š
   */
  private async onLoadMore(): Promise<void> {
    if (this.isLoadingMore || !this.hasMore) {
      return;
    }
    await this.loadGuides(this.currentPage + 1);
  }

  /**
   * æœç´¢æ”»ç•¥
   */
  private async searchGuides(): Promise<void> {
    if (!this.searchKeyword.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
      return;
    }

    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    if (!this.networkService.isInternetAvailable()) {
      ErrorHandler.showToast('ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      hilog.info(DOMAIN, TAG, `Searching guides: ${this.searchKeyword}`);

      const results = await this.api.searchGuides(this.searchKeyword);
      this.guides = results;
      this.hasMore = false; // æœç´¢ç»“æœä¸æ”¯æŒåˆ†é¡µ

      hilog.info(DOMAIN, TAG, `Found ${results.length} guides`);

      if (results.length === 0) {
        this.errorMessage = 'æœªæ‰¾åˆ°ç›¸å…³æ”»ç•¥';
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Search failed: ${JSON.stringify(error)}`);
      this.errorMessage = 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•';
      ErrorHandler.showToast(this.errorMessage);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ¸…ç©ºæœç´¢
   */
  private clearSearch(): void {
    this.searchKeyword = '';
    this.showSearch = false;
    this.loadGuides(1);
  }

  /**
   * æŸ¥çœ‹æ”»ç•¥è¯¦æƒ…
   */
  private viewGuideDetail(guide: GuideData): void {
    router.pushUrl({
      url: 'pages/guide/GuideDetailPage',
      params: {
        guideId: guide.id
      }
    });
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'æ—…æ¸¸æ”»ç•¥ï¼ˆHTTPç‰ˆï¼‰',
        showBack: true,
        rightIcon: this.showSearch ? '' : 'ğŸ”',
        onRightClick: () => {
          this.showSearch = !this.showSearch;
        }
      })

      // æœç´¢æ¡†
      if (this.showSearch) {
        Row() {
          TextInput({ placeholder: 'æœç´¢æ”»ç•¥...', text: this.searchKeyword })
            .layoutWeight(1)
            .height(40)
            .fontSize(14)
            .backgroundColor('#f9f9f9')
            .onChange((value: string) => {
              this.searchKeyword = value;
            })
            .onSubmit(() => {
              this.searchGuides();
            })

          Button('æœç´¢')
            .height(40)
            .fontSize(14)
            .margin({ left: 8 })
            .onClick(() => {
              this.searchGuides();
            })

          if (this.searchKeyword) {
            Button('æ¸…ç©º')
              .height(40)
              .fontSize(14)
              .backgroundColor('#f0f0f0')
              .fontColor('#666')
              .margin({ left: 8 })
              .onClick(() => {
                this.clearSearch();
              })
          }
        }
        .width('100%')
        .padding(12)
        .backgroundColor(Color.White)
      }

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading && this.guides.length === 0) {
        // é¦–æ¬¡åŠ è½½
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#007AFF')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.errorMessage && this.guides.length === 0) {
        // åŠ è½½å¤±è´¥
        Column() {
          Text('ğŸ˜¢')
            .fontSize(48)
            .margin({ bottom: 12 })
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 16 })
          Button('é‡æ–°åŠ è½½')
            .onClick(() => {
              this.loadGuides(1);
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.guides.length === 0) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“')
            .fontSize(48)
            .margin({ bottom: 12 })
          Text('æš‚æ— æ”»ç•¥')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // æ”»ç•¥åˆ—è¡¨
        Refresh({ refreshing: this.isRefreshing }) {
          List({ scroller: this.scroller }) {
            ForEach(this.guides, (guide: GuideData) => {
              ListItem() {
                this.GuideItem(guide)
              }
            }, (guide: GuideData) => guide.id)

            // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
            if (this.hasMore) {
              ListItem() {
                Row() {
                  if (this.isLoadingMore) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .margin({ right: 8 })
                    Text('åŠ è½½ä¸­...')
                      .fontSize(14)
                      .fontColor('#666')
                  } else {
                    Text('ä¸Šæ‹‰åŠ è½½æ›´å¤š')
                      .fontSize(14)
                      .fontColor('#999')
                  }
                }
                .width('100%')
                .height(50)
                .justifyContent(FlexAlign.Center)
              }
            } else if (this.guides.length > 0) {
              ListItem() {
                Text('æ²¡æœ‰æ›´å¤šäº†')
                  .fontSize(14)
                  .fontColor('#999')
                  .width('100%')
                  .height(50)
                  .textAlign(TextAlign.Center)
              }
            }
          }
          .width('100%')
          .layoutWeight(1)
          .edgeEffect(EdgeEffect.Spring)
          .onReachEnd(() => {
            this.onLoadMore();
          })
        }
        .onRefreshing(() => {
          this.onRefresh();
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  GuideItem(guide: GuideData) {
    Column() {
      Row() {
        // å°é¢å›¾
        if (guide.images && guide.images.length > 0) {
          Image(guide.images[0])
            .width(80)
            .height(80)
            .borderRadius(8)
            .objectFit(ImageFit.Cover)
            .margin({ right: 12 })
        } else {
          Column() {
            Text('ğŸ“·')
              .fontSize(32)
          }
          .width(80)
          .height(80)
          .borderRadius(8)
          .backgroundColor('#f0f0f0')
          .justifyContent(FlexAlign.Center)
          .margin({ right: 12 })
        }

        // æ”»ç•¥ä¿¡æ¯
        Column() {
          Text(guide.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1a1a1a')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          Text(guide.content)
            .fontSize(13)
            .fontColor('#666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          Row() {
            Text(`ä½œè€…: ${guide.author}`)
              .fontSize(12)
              .fontColor('#999')
              .layoutWeight(1)

            Text(guide.createTime)
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .onClick(() => {
        this.viewGuideDetail(guide);
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12, left: 12, right: 12 })
  }
}
