import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface GuideSection {
  title: string;
  content: string;
  images?: string[];
}

@Entry
@Component
export struct GuideDetailPage {
  @State guideId: string = '';
  @State guideTitle: string = 'æ·±åœ³æ—…æ¸¸å®Œæ•´æ”»ç•¥';
  @State author: string = 'æ—…è¡Œè¾¾äººå°ç‹';
  @State authorAvatar: string = 'ğŸ‘¤';
  @State publishDate: string = '2024-11-20';
  @State views: number = 1256;
  @State likes: number = 328;
  @State isLiked: boolean = false;
  @State isFavorite: boolean = false;
  
  @State sections: GuideSection[] = [
    {
      title: 'ğŸ¯ è¡Œå‰å‡†å¤‡',
      content: '1. è¯ä»¶å‡†å¤‡ï¼šèº«ä»½è¯ã€æ¸¯æ¾³é€šè¡Œè¯ï¼ˆå¦‚éœ€å‰å¾€é¦™æ¸¯ï¼‰\n2. å­£èŠ‚ç©¿æ­ï¼šæ·±åœ³æ°”å€™æ¸©æš–æ¹¿æ¶¦ï¼Œå»ºè®®æºå¸¦è½»ä¾¿è¡£ç‰©\n3. å¿…å¤‡ç‰©å“ï¼šé˜²æ™’éœœã€é›¨ä¼ã€å……ç”µå®ã€èˆ’é€‚çš„é‹å­',
      images: []
    },
    {
      title: 'ğŸš‡ äº¤é€šæŒ‡å—',
      content: 'æ·±åœ³åœ°é“çº¿è·¯å‘è¾¾ï¼Œå»ºè®®ä½¿ç”¨åœ°é“å‡ºè¡Œã€‚å¯ä»¥ä¸‹è½½"æ·±åœ³åœ°é“"APPæˆ–ä½¿ç”¨å¾®ä¿¡ã€æ”¯ä»˜å®æ‰«ç ä¹˜è½¦ã€‚æ‰“è½¦å»ºè®®ä½¿ç”¨æ»´æ»´ã€é«˜å¾·ç­‰ç½‘çº¦è½¦å¹³å°ã€‚',
      images: []
    },
    {
      title: 'ğŸï¸ å¿…æ¸¸æ™¯ç‚¹',
      content: '1. ä¸–ç•Œä¹‹çª— - ä¸€å¤©æ¸¸éä¸–ç•Œ\n2. æ¬¢ä¹è°· - åˆºæ¿€æ¸¸ä¹ä½“éªŒ\n3. æ·±åœ³æ¹¾å…¬å›­ - æµ·æ»¨æ ˆé“æ•£æ­¥\n4. ä¸œéƒ¨åä¾¨åŸ - å±±æµ·åº¦å‡èƒœåœ°\n5. å¤§æ¢…æ²™æµ·æ»¨å…¬å›­ - å…è´¹æµ·æ»©',
      images: []
    },
    {
      title: 'ğŸœ ç¾é£Ÿæ¨è',
      content: '1. ç²¤å¼æ—©èŒ¶ï¼šç‚¹éƒ½å¾·ã€é™¶é™¶å±…\n2. æµ·é²œï¼šå—æ¾³æµ·é²œè¡—ã€è›‡å£æµ·é²œè¡—\n3. ç«é”…ï¼šæµ·åº•æã€æ¹Šæ¹Š\n4. å°åƒï¼šä¸œé—¨æ­¥è¡Œè¡—ã€åå¼ºåŒ—\n5. å¤œå®µï¼šå¤§æ’æ¡£ã€çƒ§çƒ¤',
      images: []
    },
    {
      title: 'ğŸ¨ ä½å®¿å»ºè®®',
      content: 'ç¦ç”°ã€å—å±±åŒºåŸŸäº¤é€šä¾¿åˆ©ï¼Œé€‚åˆå•†åŠ¡å‡ºè¡Œã€‚ç½—æ¹–åŒºæ€§ä»·æ¯”é«˜ã€‚æƒ³è¦åº¦å‡ä½“éªŒå¯é€‰æ‹©å¤§é¹ã€ä¸œéƒ¨åä¾¨åŸé™„è¿‘ã€‚',
      images: []
    },
    {
      title: 'ğŸ’° è´¹ç”¨é¢„ç®—',
      content: 'äººå‡æ¶ˆè´¹ï¼š\nâ€¢ ç»æµå‹ï¼š300-500å…ƒ/å¤©\nâ€¢ èˆ’é€‚å‹ï¼š500-1000å…ƒ/å¤©\nâ€¢ è±ªåå‹ï¼š1000å…ƒä»¥ä¸Š/å¤©\n\nåŒ…æ‹¬ï¼šä½å®¿ã€é¤é¥®ã€äº¤é€šã€é—¨ç¥¨',
      images: []
    }
  ];

  aboutToAppear() {
    // 1. å…ˆæ£€æŸ¥è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, string>;
    if (params && params.id) {
      this.guideId = params.id;
    }
    
    // 2. æ£€æŸ¥æ„å›¾æ¡†æ¶ä¼ é€’çš„å‚æ•°ï¼ˆæ¥è‡ªå°è‰ºAIåŠ©æ‰‹ï¼‰
    const intentGuideId = AppStorage.get<string>('intentGuideId');
    const intentGuideName = AppStorage.get<string>('intentGuideName');
    const intentGuideLocation = AppStorage.get<string>('intentGuideLocation');
    
    if (intentGuideId) {
      this.guideId = intentGuideId;
      // æ¸…é™¤å·²ä½¿ç”¨çš„å‚æ•°
      AppStorage.delete('intentGuideId');
    }
    
    if (intentGuideName) {
      this.guideTitle = intentGuideName;
      // æ¸…é™¤å·²ä½¿ç”¨çš„å‚æ•°
      AppStorage.delete('intentGuideName');
    }
    
    if (intentGuideLocation) {
      // å¯ä»¥æ ¹æ®ä½ç½®ä¿¡æ¯æ›´æ–°å†…å®¹
      // æ¸…é™¤å·²ä½¿ç”¨çš„å‚æ•°
      AppStorage.delete('intentGuideLocation');
    }
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'æ”»ç•¥è¯¦æƒ…',
        showBack: true
      })

      Scroll() {
        Column() {
          this.HeaderSection()
          this.AuthorSection()
          this.ContentSection()
          this.ActionButtons()
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  @Builder HeaderSection() {
    Column() {
      Text(this.guideTitle)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Row({ space: 16 }) {
        Row({ space: 4 }) {
          Text('ğŸ‘ï¸')
            .fontSize(14)
          Text(`${this.views}`)
            .fontSize(13)
            .fontColor('#6b7280')
        }

        Row({ space: 4 }) {
          Text('â¤ï¸')
            .fontSize(14)
          Text(`${this.likes}`)
            .fontSize(13)
            .fontColor('#6b7280')
        }

        Text(this.publishDate)
          .fontSize(13)
          .fontColor('#9ca3af')
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder AuthorSection() {
    Row() {
      Text(this.authorAvatar)
        .fontSize(36)
        .width(48)
        .height(48)
        .borderRadius(24)
        .backgroundColor('#f3f4f6')
        .textAlign(TextAlign.Center)
        .margin({ right: 12 })

      Column() {
        Text(this.author)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1f2937')
          .margin({ bottom: 4 })

        Text('èµ„æ·±æ—…æ¸¸åšä¸»')
          .fontSize(13)
          .fontColor('#6b7280')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Button('å…³æ³¨')
        .fontSize(14)
        .height(32)
        .backgroundColor('#3b82f6')
        .borderRadius(16)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .alignItems(VerticalAlign.Center)
  }

  @Builder ContentSection() {
    Column({ space: 20 }) {
      ForEach(this.sections, (section: GuideSection) => {
        this.SectionItem(section)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder SectionItem(section: GuideSection) {
    Column() {
      Text(section.title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)

      Text(section.content)
        .fontSize(14)
        .fontColor('#4b5563')
        .lineHeight(24)
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtons() {
    Row() {
      Column() {
        Text(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
          .fontSize(24)
          .onClick(() => {
            this.isLiked = !this.isLiked;
            this.likes += this.isLiked ? 1 : -1;
          })

        Text('ç‚¹èµ')
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Divider()
        .vertical(true)
        .height(40)
        .color('#e5e7eb')

      Column() {
        Text(this.isFavorite ? 'â­' : 'â˜†')
          .fontSize(24)
          .onClick(() => {
            this.isFavorite = !this.isFavorite;
          })

        Text('æ”¶è—')
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      Divider()
        .vertical(true)
        .height(40)
        .color('#e5e7eb')

      Column() {
        Text('ğŸ“¤')
          .fontSize(24)

        Text('åˆ†äº«')
          .fontSize(14)
          .fontColor('#6b7280')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height(80)
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceEvenly)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: -2
    })
  }
}
