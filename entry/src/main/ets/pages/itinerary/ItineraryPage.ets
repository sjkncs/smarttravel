import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface ItineraryItem {
  id: string;
  title: string;
  date: string;
  status: 'upcoming' | 'ongoing' | 'completed';
  location: string;
  image: string;
  participants: number;
}

@Entry
@Component
export struct ItineraryPage {
  @State itineraryList: ItineraryItem[] = [
    {
      id: '1',
      title: 'æ·±åœ³ä¸–ç•Œä¹‹çª—ä¸€æ—¥æ¸¸',
      date: '2024-10-15',
      status: 'upcoming',
      location: 'æ·±åœ³å¸‚å—å±±åŒº',
      image: 'https://p3.img.cctvpic.com/photoworkspace/contentimg/2019/05/05/2019050515335593405.jpg',
      participants: 2
    },
    {
      id: '2',
      title: 'æ¬¢ä¹è°·ä¸»é¢˜ä¹å›­',
      date: '2024-10-20',
      status: 'upcoming',
      location: 'æ·±åœ³å¸‚å—å±±åŒº',
      image: 'https://askthescientists.com/wp-content/uploads/2018/07/Outdoors-AdobeStock_203673414-835x418.jpg',
      participants: 1
    },
    {
      id: '3',
      title: 'ä¸œéƒ¨åä¾¨åŸç”Ÿæ€æ¸¸',
      date: '2024-10-25',
      status: 'upcoming',
      location: 'æ·±åœ³å¸‚ç›ç”°åŒº',
      image: 'https://cxfile.advences.com/CFAVOYAGES/photo/shutterstock_638541712.jpg',
      participants: 3
    }
  ];

  @State selectedTab: number = 0;

  build() {
    Column() {
      // ç»Ÿä¸€çš„é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æˆ‘çš„è¡Œç¨‹',
        showSearch: true,
        showNotification: true
      })
      
      // æ ‡ç­¾é¡µ
      this.TabBar()
      
      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }


  @Builder TabBar() {
    Row() {
      ForEach(['å¾…å‡ºè¡Œ', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'], (tab: string, index: number) => {
        Text(tab)
          .fontSize(16)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#64748b')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  @Builder ContentArea() {
    if (this.selectedTab === 0) {
      this.UpcomingTrips()
    } else if (this.selectedTab === 1) {
      this.OngoingTrips()
    } else {
      this.CompletedTrips()
    }
  }

  @Builder UpcomingTrips() {
    Scroll() {
      Column() {
        // çº¿è·¯è§„åˆ’å¡ç‰‡
        this.RoutePlanningCard()
        
        // è¡Œç¨‹åˆ—è¡¨
        ForEach(this.itineraryList, (itinerary: ItineraryItem) => {
          this.ItineraryCard(itinerary)
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder RoutePlanningCard() {
    Column() {
      Row() {
        Text('çº¿è·¯è§„åˆ’')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)

        Text('æˆ‘çš„çº¿è·¯ >')
          .fontSize(14)
          .fontColor('#3b82f6')
          .onClick(() => {
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.pushUrl({
                url: 'pages/category/RoutePage'
              });
            }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è·¯çº¿é¡µé¢'));
          })
      }
      .width('100%')
      .margin({ bottom: 16 })

      // è§„åˆ’å¡ç‰‡å†…å®¹
      Column() {
        Row({ space: 12 }) {
          // æ™¯ç‚¹1
          Column() {
            Text('ğŸ›ï¸')
              .fontSize(24)
              .margin({ bottom: 4 })
            Text('ä¸–ç•Œä¹‹çª—')
              .fontSize(12)
              .fontColor('#374151')
          }
          .padding(12)
          .backgroundColor('#f3f4f6')
          .borderRadius(12)
          .onClick(() => {
            console.log('ç‚¹å‡»äº†ä¸–ç•Œä¹‹çª—æ™¯ç‚¹å¡ç‰‡');
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.pushUrl({
                url: 'pages/activity/ActivityDetailPage',
                params: { id: 'shijiezhichuang', src: 'shijiezhichuang' }
              });
            }, (error: Error): void => {
              console.error('ä¸–ç•Œä¹‹çª—è·³è½¬å¤±è´¥:', error);
              ErrorHandler.handleRouterError(error, 'ä¸–ç•Œä¹‹çª—è¯¦æƒ…');
            });
          })

          // æ™¯ç‚¹2
          Column() {
            Text('ğŸ¢')
              .fontSize(24)
              .margin({ bottom: 4 })
            Text('æ¬¢ä¹è°·')
              .fontSize(12)
              .fontColor('#374151')
          }
          .padding(12)
          .backgroundColor('#f3f4f6')
          .borderRadius(12)
          .onClick(() => {
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.pushUrl({
                url: 'pages/activity/ActivityDetailPage',
                params: { id: 'huanlegu', src: 'huanlegu' }
              });
            }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ¬¢ä¹è°·è¯¦æƒ…'));
          })

          // æ™¯ç‚¹3
          Column() {
            Text('ğŸš‰')
              .fontSize(24)
              .margin({ bottom: 4 })
            Text('æ·±åœ³åŒ—ç«™')
              .fontSize(12)
              .fontColor('#374151')
          }
          .padding(12)
          .backgroundColor('#f3f4f6')
          .borderRadius(12)
          .onClick(() => {
            ErrorHandler.safeExecute(async (): Promise<void> => {
              await router.pushUrl({
                url: 'pages/category/TransportPage'
              });
            }, (error: Error): void => ErrorHandler.handleRouterError(error, 'äº¤é€šé¡µé¢'));
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ bottom: 16 })

        // å¼€å§‹è§„åˆ’æŒ‰é’®
        Button('å¼€å§‹è§„åˆ’')
          .width('100%')
          .height(44)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#3b82f6')
          .borderRadius(22)
          .onClick(() => {
            console.log('ç‚¹å‡»äº†å¼€å§‹è§„åˆ’æŒ‰é’®');
            ErrorHandler.safeExecute(async (): Promise<void> => {
              console.log('å‡†å¤‡è·³è½¬åˆ°åœ°å›¾é¡µé¢');
              await router.pushUrl({
                url: 'pages/map/MapPage'
              });
              console.log('è·³è½¬æˆåŠŸ');
            }, (error: Error): void => {
              console.error('è·³è½¬å¤±è´¥:', error);
              ErrorHandler.handleRouterError(error, 'åœ°å›¾é¡µé¢');
            });
          })

        Text('æ”¯æŒæ™ºèƒ½æ¨èçº¿è·¯')
          .fontSize(12)
          .fontColor('#6b7280')
          .margin({ top: 8 })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#dbeafe')
      .borderRadius(16)
      .margin({ bottom: 16 })
    }
    .width('100%')
  }

  @Builder ItineraryCard(itinerary: ItineraryItem) {
    Row() {
      // å›¾ç‰‡
      Image(itinerary.image)
        .width(80)
        .height(80)
        .borderRadius(12)
        .objectFit(ImageFit.Cover)
        .margin({ right: 12 })

      // å†…å®¹
      Column() {
        Text(itinerary.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1f2937')
          .margin({ bottom: 4 })

        Row() {
          Text('ğŸ“…')
            .fontSize(12)
            .margin({ right: 4 })
          Text(itinerary.date)
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .margin({ bottom: 4 })

        Row() {
          Text('ğŸ“')
            .fontSize(12)
            .margin({ right: 4 })
          Text(itinerary.location)
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .margin({ bottom: 8 })

        Row() {
          Text('ğŸ‘¥')
            .fontSize(12)
            .margin({ right: 4 })
          Text(`${itinerary.participants}äººå‚ä¸`)
            .fontSize(12)
            .fontColor('#6b7280')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // çŠ¶æ€æ ‡ç­¾
      Text(this.getStatusText(itinerary.status))
        .fontSize(12)
        .fontColor(this.getStatusColor(itinerary.status))
        .backgroundColor(this.getStatusBgColor(itinerary.status))
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .borderRadius(12)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      console.log('ç‚¹å‡»äº†è¡Œç¨‹å¡ç‰‡:', itinerary.title);
      ErrorHandler.safeExecute(async (): Promise<void> => {
        console.log('å‡†å¤‡è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µé¢ï¼Œå‚æ•°:', itinerary.id);
        await router.pushUrl({
          url: 'pages/activity/ActivityDetailPage',
          params: { 
            id: itinerary.id,
            src: itinerary.id,
            activityId: itinerary.id
          }
        });
        console.log('è¡Œç¨‹å¡ç‰‡è·³è½¬æˆåŠŸ');
      }, (error: Error): void => {
        console.error('è¡Œç¨‹å¡ç‰‡è·³è½¬å¤±è´¥:', error);
        ErrorHandler.handleRouterError(error, 'æ´»åŠ¨è¯¦æƒ…é¡µé¢');
      });
    })
  }

  @Builder OngoingTrips() {
    Column() {
      Text('æš‚æ— è¿›è¡Œä¸­çš„è¡Œç¨‹')
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ top: 100 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder CompletedTrips() {
    Column() {
      Text('æš‚æ— å·²å®Œæˆçš„è¡Œç¨‹')
        .fontSize(16)
        .fontColor('#6b7280')
        .margin({ top: 100 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'upcoming': return 'å¾…å‡ºè¡Œ';
      case 'ongoing': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return 'æœªçŸ¥';
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'upcoming': return '#3b82f6';
      case 'ongoing': return '#f59e0b';
      case 'completed': return '#10b981';
      default: return '#6b7280';
    }
  }

  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'upcoming': return '#dbeafe';
      case 'ongoing': return '#fef3c7';
      case 'completed': return '#d1fae5';
      default: return '#f3f4f6';
    }
  }
}
