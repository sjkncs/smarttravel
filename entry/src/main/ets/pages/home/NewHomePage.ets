import { router } from '@kit.ArkUI';
import { NavigationUtil } from '../../utils/NavigationUtil';
import {
  shenzhenQuickEntries,
  shenzhenNotices,
  shenzhenAttractions,
  QuickEntryData,
  NoticeData,
  AttractionData
} from '../../viewmodel/ShenzhenData';

@Entry
@Component
struct NewHomePage {
  @State currentCity: string = 'æ·±åœ³å¸‚';
  @State currentBannerIndex: number = 0;
  @State openingTime: string = '10:00-22:00';
  @State notices: NoticeData[] = shenzhenNotices;
  @State quickEntries: QuickEntryData[] = shenzhenQuickEntries;
  @State hotAttractions: AttractionData[] = shenzhenAttractions.slice(0, 4);

  // Bannerå›¾ç‰‡åˆ—è¡¨
  private bannerImages: string[] = [
    'https://picsum.photos/seed/banner1/1200/600',
    'https://picsum.photos/seed/banner2/1200/600',
    'https://picsum.photos/seed/banner3/1200/600'
  ];

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      this.TopBar()
      
      Scroll() {
        Column() {
          // Bannerè½®æ’­
          this.BannerSection()
          
          // å¿«æ·å…¥å£
          this.QuickEntrySection()
          
          // è¥ä¸šæ—¶é—´
          this.OpeningTimeCard()
          
          // å…¬å‘ŠåŒºåŸŸ
          this.NoticeSection()
          
          // æ¨èå†…å®¹ï¼ˆä¿ç•™åŸæœ‰æ¨èåŠŸèƒ½ï¼‰
          this.RecommendSection()
        }
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // é¡¶éƒ¨æ 
  @Builder TopBar() {
    Row() {
      // åŸå¸‚å®šä½
      Row({ space: 4 }) {
        Text(this.currentCity)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        Text('â–¼')
          .fontSize(12)
          .fontColor('#666666')
      }
      .onClick(() => {
        // åŸå¸‚é€‰æ‹©
        console.log('é€‰æ‹©åŸå¸‚');
      })

      // æœç´¢æ¡†
      Row({ space: 8 }) {
        Text('ğŸ”')
          .fontSize(16)
        Text('æœç´¢...')
          .fontSize(14)
          .fontColor('#999999')
      }
      .layoutWeight(1)
      .height(36)
      .backgroundColor('#ffffff')
      .borderRadius(18)
      .padding({ left: 12, right: 12 })
      .margin({ left: 12, right: 12 })
      .onClick(() => {
        NavigationUtil.toSearch();
      })

      // æ¶ˆæ¯ä¸­å¿ƒ
      Stack() {
        Text('ğŸ””')
          .fontSize(24)
        // çº¢ç‚¹æç¤º
        Circle()
          .width(8)
          .height(8)
          .fill('#ff4d4f')
          .position({ x: 16, y: 0 })
      }
      .width(32)
      .height(32)
      .onClick(() => {
        NavigationUtil.toMessage();
      })
    }
    .width('100%')
    .height(56)
    .backgroundColor('#ffffff')
    .padding({ left: 16, right: 16 })
  }

  // Bannerè½®æ’­åŒºåŸŸ
  @Builder BannerSection() {
    Column() {
      // å¤§å›¾Banner
      Stack({ alignContent: Alignment.BottomEnd }) {
        Swiper() {
          ForEach(this.bannerImages ?? [], (image: string, index: number) => {
            Image(image)
              .width('100%')
              .height(220)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          }, (image: string, index: number) => `banner-${index}`)
        }
        .autoPlay(true)
        .interval(3000)
        .indicator(true)
        .loop(true)
        .onChange((index: number) => {
          this.currentBannerIndex = index;
        })

        // ç‚¹å‡»æ”¾å¤§æç¤º
        Row({ space: 4 }) {
          Text('ç‚¹å‡»æ”¾å¤§')
            .fontSize(12)
            .fontColor('#ffffff')
          Text('â†’')
            .fontSize(12)
            .fontColor('#ffffff')
        }
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .backgroundColor('rgba(0, 0, 0, 0.3)')
        .borderRadius(12)
        .margin(12)
      }
      .width('100%')
      .height(220)

      // åœºæ¬¡æ—¶é—´ï¼ˆå¦‚æœæ˜¯æ™¯åŒºï¼‰
      Row({ space: 16 }) {
        Text('åœºæ¬¡æ—¶é—´:')
          .fontSize(13)
          .fontColor('#666666')
        Text('09:30')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#0086f6')
        Text('|')
          .fontSize(13)
          .fontColor('#d9d9d9')
        Text('19:30')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#0086f6')
      }
      .margin({ top: 12 })

      // ç¼©ç•¥å›¾åˆ—è¡¨
      Row({ space: 8 }) {
        ForEach([0, 1, 2, 3, 4], (index: number) => {
          Image(this.bannerImages[index % this.bannerImages.length])
            .width(60)
            .height(40)
            .borderRadius(6)
            .objectFit(ImageFit.Cover)
            .border({
              width: this.currentBannerIndex === index ? 2 : 0,
              color: '#0086f6'
            })
            .onClick(() => {
              this.currentBannerIndex = index;
            })
        }, (index: number) => `thumb-${index}`)
      }
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
  }

  // å¿«æ·å…¥å£åŒºåŸŸï¼ˆ2è¡Œ5åˆ—ï¼‰
  @Builder QuickEntrySection() {
    Column() {
      Grid() {
        ForEach(this.quickEntries ?? [], (item: QuickEntryData, index: number) => {
          GridItem() {
            Column({ space: 8 }) {
              // åœ†å½¢å›¾æ ‡
              Stack() {
                Circle()
                  .width(48)
                  .height(48)
                  .fill(item.color)
                  .opacity(0.1)
                
                Text(item.icon)
                  .fontSize(24)
              }
              
              Text(item.name)
                .fontSize(12)
                .fontColor('#333333')
            }
            .width('100%')
            .onClick(() => {
              router.pushUrl({ url: item.url });
            })
          }
        }, (item: QuickEntryData, index: number) => `qe-${index}-${item.name}`)
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(8)
      .rowsGap(16)
      .height(160)
      .padding({ top: 16, bottom: 16 })
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .margin({ top: 10 })
  }

  // è¥ä¸šæ—¶é—´å¡ç‰‡
  @Builder OpeningTimeCard() {
    Row() {
      Column({ space: 4 }) {
        Text('ä»Šæ—¥å¼€æ”¾æ—¶é—´')
          .fontSize(14)
          .fontColor('#666666')
        Text(this.openingTime)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#0086f6')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // çŠ¶æ€æŒ‡ç¤º
      Row({ space: 4 }) {
        Circle()
          .width(8)
          .height(8)
          .fill('#52c41a')
        Text('è¥ä¸šä¸­')
          .fontSize(12)
          .fontColor('#52c41a')
      }
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .borderRadius(8)
    .padding(16)
    .margin({ left: 16, right: 16, top: 10 })
  }

  // å…¬å‘ŠåŒºåŸŸ
  @Builder NoticeSection() {
    Row() {
      Row({ space: 8 }) {
        Text('ğŸ”Š')
          .fontSize(16)
        Text('ä¹å›­å…¬å‘Š')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
      }
      .layoutWeight(1)

      Row({ space: 4 }) {
        Text(`1/${this.notices.length}æ¡`)
          .fontSize(12)
          .fontColor('#999999')
        Text('â†’')
          .fontSize(12)
          .fontColor('#999999')
      }
      .onClick(() => {
        NavigationUtil.toNotice();
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 8 })
    .backgroundColor('#ffffff')
    .margin({ top: 10 })

    // å…¬å‘Šå†…å®¹
    Row({ space: 8 }) {
      Text(this.notices[0].title)
        .fontSize(14)
        .fontColor('#0086f6')
      Text('â†’')
        .fontSize(12)
        .fontColor('#999999')
    }
    .width('100%')
    .height(40)
    .backgroundColor('#f0f8ff')
    .borderRadius(8)
    .padding({ left: 16, right: 16 })
    .margin({ left: 16, right: 16, bottom: 16 })
    .onClick(() => {
      // æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…
      console.log('æŸ¥çœ‹å…¬å‘Šè¯¦æƒ…');
    })
  }

  // æ¨èå†…å®¹åŒºåŸŸï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
  @Builder RecommendSection() {
    Column() {
      Row() {
        Text('çƒ­é—¨æ¨è')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Text('æŸ¥çœ‹æ›´å¤š â†’')
          .fontSize(13)
          .fontColor('#0086f6')
          .onClick(() => {
            NavigationUtil.toNatureCategory();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })

      // æ¨èåˆ—è¡¨ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
      Scroll() {
        Row({ space: 10 }) {
          ForEach(this.hotAttractions ?? [], (attraction: AttractionData, index: number) => {
            this.RecommendCard(attraction)
          }, (attraction: AttractionData, index: number) => `hot-${index}-${attraction.name}`)
        }
        .padding({ left: 16, right: 16, bottom: 16 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .margin({ top: 10, bottom: 20 })
  }

  // æ¨èå¡ç‰‡
  @Builder RecommendCard(attraction: AttractionData) {
    Column() {
      Image(attraction.image)
        .width(160)
        .height(100)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
      
      Column({ space: 6 }) {
        Text(attraction.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row({ space: 6 }) {
          Text(`â­ ${attraction.rating}`)
            .fontSize(12)
            .fontColor('#ff9900')
          Text(attraction.location.split('æ·±åœ³å¸‚')[1] || attraction.location)
            .fontSize(11)
            .fontColor('#999999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
        }
        .width('100%')
        
        // è¯­éŸ³è®²è§£æ ‡ç­¾
        if (attraction.hasAudio) {
          Row() {
            Text('ğŸµ')
              .fontSize(11)
            Text('è¯­éŸ³è®²è§£')
              .fontSize(11)
              .fontColor('#0086f6')
              .margin({ left: 2 })
          }
          .padding({ left: 6, right: 6, top: 3, bottom: 3 })
          .backgroundColor('#e6f4ff')
          .borderRadius(10)
          .onClick(() => {
            // è·³è½¬åˆ°è¯­éŸ³è®²è§£
            router.pushUrl({
              url: 'pages/attraction/AttractionAudioPage',
              params: {
                audioInfo: {
                  id: attraction.id,
                  title: attraction.name,
                  cover: attraction.image,
                  duration: attraction.audioDuration || '00:00',
                  audioUrl: `audio/${attraction.id}.mp3`
                }
              }
            });
          })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .padding(8)
      .width('100%')
    }
    .width(160)
    .backgroundColor('#fafafa')
    .borderRadius(8)
    .onClick(() => {
      // ç‚¹å‡»å¡ç‰‡è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/activity/ActivityDetailPage',
        params: { 
          src: attraction.id,
          type: 'attraction'
        }
      });
    })
  }
}
