import { App } from "@kit.ArkUI";
import { router } from '@kit.ArkUI';
import { LocationBubble } from '../../components/LocationBubble';
import { SmartRecommendationList } from '../../components/SmartRecommendationComponents';
import { ActivityDetail } from '../../model/ActivityModel';
import { BehaviorType, PreferenceType } from '../../model/UserBehaviorModel';
import { HomeViewModel } from '../../viewmodel/HomeViewModel';
import { ErrorHandler } from '../../utils/ErrorHandler';
import { ImageConstants } from '../../constants/ImageConstants';

interface ListItemInfo {
  image: Resource;
  title: string;
  description: string;
}

// ExplorePage.ets
@Component
export struct HomePage {
  // ViewModelå®ä¾‹
  private viewModel: HomeViewModel = new HomeViewModel();
  
  // UIçŠ¶æ€ - ä»ViewModelåŒæ­¥
  @State swiperIndex: number = 0;
  @State deviceWidth: number = 0;
  @State maxCount: number = 1;
  @State userId: string = '';
  @State availableActivities: ActivityDetail[] = [];
  @State showAIRecommendations: boolean = true;
  @State recommendedImages: string[] = [];
  @State ListInfos: ListItemInfo[] = [];

  async aboutToAppear() {
    console.log('[HomePage] aboutToAppear - å¼€å§‹åˆå§‹åŒ–');
    try {
      await this.viewModel.initialize();
      // ç¡®ä¿æ•°æ®åŒæ­¥åˆ°UI
      this.syncStateFromViewModel();
      console.log('[HomePage] æ•°æ®åŠ è½½å®Œæˆï¼ŒListInfosé•¿åº¦:', this.ListInfos.length);
    } catch (error) {
      console.error('[HomePage] åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  onConfigurationUpdate() {
    this.viewModel.updateWidth();
    this.syncStateFromViewModel();
  }

  // ä»ViewModelåŒæ­¥çŠ¶æ€åˆ°View
  private syncStateFromViewModel(): void {
    this.swiperIndex = this.viewModel.swiperIndex;
    this.deviceWidth = this.viewModel.deviceWidth;
    this.maxCount = this.viewModel.maxCount;
    this.userId = this.viewModel.userId;
    this.availableActivities = this.viewModel.availableActivities;
    this.showAIRecommendations = this.viewModel.showAIRecommendations;
    this.recommendedImages = this.viewModel.getRecommendedImages();
    
    // é‡è¦ï¼šä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºæ–°æ•°ç»„ï¼Œè§¦å‘UIæ›´æ–°
    const listInfos = this.viewModel.getListInfos();
    this.ListInfos = [...listInfos];
    console.log('[HomePage] syncStateFromViewModel - ListInfoså·²æ›´æ–°:', this.ListInfos.length);
  }

  // å¯¼èˆªåˆ°æ´»åŠ¨é¡µé¢
  private async navigateToActivity(category: string) {
    await this.viewModel.navigateToActivity(category);
    
    // è®¾ç½®é€‰ä¸­çš„åˆ†ç±»å’Œåˆ‡æ¢åˆ°æ´»åŠ¨é¡µé¢
    AppStorage.setOrCreate('selectedCategory', category);
    AppStorage.setOrCreate('selectedTab', 2);
  }

  build() {
    Column() {
      // å…³é”®æ”¹è¿›ï¼šå°†æ•´ä¸ªé¡µé¢å†…å®¹åŒ…è£¹åœ¨ Scroll ç»„ä»¶ä¸­ï¼Œç¡®ä¿é¡µé¢åœ¨å†…å®¹æº¢å‡ºæ—¶å¯ä»¥æ»šåŠ¨
      Scroll() {
        Column() {
          // æœç´¢æ 
          this.SearchBar()

        // çƒ­é—¨æ¨è - Swiper è½®æ’­å›¾
        Text('çƒ­é—¨æ¨è')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#334155')
          .alignSelf(ItemAlign.Start)// å·¦å¯¹é½
          .margin({ left: '2.5%', bottom: 10 })// å·¦ä¾§å¤–è¾¹è·å’Œåº•éƒ¨å¤–è¾¹è·
          .padding({ left: 10 }) // å·¦ä¾§å†…è¾¹è·

        Swiper() {
          ForEach(this.recommendedImages ?? [], (item: string, index: number) => {
            Image(item)
              .width('100%')
              .height(200)
              .borderRadius(16)
              .objectFit(ImageFit.Cover) // å›¾ç‰‡è£å‰ªæ¨¡å¼
          }, (item: string, index: number) => `rec-${index}-${item}`)
        }
        .width('95%')
        .height(200)
        .indicator(true) // æ˜¾ç¤ºæŒ‡ç¤ºå™¨ï¼ˆå°åœ†ç‚¹ï¼‰
        .loop(true) // å¾ªç¯æ’­æ”¾
        .autoPlay(true) // è‡ªåŠ¨æ’­æ”¾
        .interval(3000) // æ’­æ”¾é—´éš”3ç§’
        .onChange((index: number) => {
          this.viewModel.updateSwiperIndex(index);
          this.swiperIndex = index; // æ›´æ–°å½“å‰è½®æ’­å›¾ç´¢å¼•
        })
        .borderRadius(10)
        .shadow({
          radius: 8,
          color: 'rgba(0,0,0,0.1)',
          offsetX: 0,
          offsetY: 4
        }) // é˜´å½±
        .margin({ bottom: 20 }) // åº•éƒ¨å¤–è¾¹è·

        // çƒ­é—¨åˆ†ç±» - æºç¨‹é£æ ¼è®¾è®¡
        Text('çƒ­é—¨åˆ†ç±»')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#334155')
          .alignSelf(ItemAlign.Start)
          .margin({ left: '2.5%', bottom: 10 })
          .padding({ left: 10 })

        // ç¬¬ä¸€è¡Œï¼šä¸»è¦åˆ†ç±»
        Row({ space: 8 }) {
          CategoryCard({ 
            icon: 'ğŸï¸', 
            title: 'çƒ­é—¨æ™¯ç‚¹', 
            subtitle: 'ä¸–ç•Œä¹‹çª—Â·æ¬¢ä¹è°·',
            color: '#FF6B35',
            onCardClick: () => {
              console.log('ç‚¹å‡»äº†çƒ­é—¨æ™¯ç‚¹å¡ç‰‡');
              ErrorHandler.safeExecute(async (): Promise<void> => {
                AppStorage.setOrCreate('selectedCategory', 'çƒ­é—¨æ¨è');
                AppStorage.setOrCreate('selectedTab', 2);
                await router.pushUrl({
                  url: 'pages/activity/ActivityPageNew'
                });
              }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç¤¾åŒºæ´»åŠ¨é¡µé¢'));
            }
          })

          CategoryCard({ 
            icon: 'ğŸ‰', 
            title: 'ç²¾å½©æ´»åŠ¨', 
            subtitle: 'æ–‡åŒ–èŠ‚Â·éŸ³ä¹èŠ‚',
            color: '#4ECDC4',
            onCardClick: () => {
              console.log('ç‚¹å‡»äº†ç²¾å½©æ´»åŠ¨å¡ç‰‡');
              ErrorHandler.safeExecute(async (): Promise<void> => {
                AppStorage.setOrCreate('selectedCategory', 'æ–‡åŒ–ä½“éªŒ');
                AppStorage.setOrCreate('selectedTab', 2);
                await router.pushUrl({
                  url: 'pages/activity/ActivityPageNew'
                });
              }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç¤¾åŒºæ´»åŠ¨é¡µé¢'));
            }
          })
        }
        .width('95%')
        .margin({ bottom: 12 })

        // åˆ†ç±»ç½‘æ ¼ - 4x2å¸ƒå±€ï¼Œç¬¦åˆæˆªå›¾è®¾è®¡
        Column() {
          // ç¬¬ä¸€è¡Œ
          Row() {
            CategoryItem({ 
              icon: 'ğŸ”', 
              text: 'ç¾é£Ÿ', 
              color: '#FF9F43',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/FoodPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç¾é£Ÿé¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸ¨', 
              text: 'ä½å®¿', 
              color: '#6C5CE7',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/HotelPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ä½å®¿é¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸ›ï¸', 
              text: 'è´­ç‰©', 
              color: '#A29BFE',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/ShoppingPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è´­ç‰©é¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸšŒ', 
              text: 'äº¤é€š', 
              color: '#74B9FF',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/TransportPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'äº¤é€šé¡µé¢'));
              }
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)
          .margin({ bottom: 12 })

          // ç¬¬äºŒè¡Œ
          Row() {
            CategoryItem({ 
              icon: 'ğŸ—ºï¸', 
              text: 'è·¯çº¿', 
              color: '#00B894',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/RoutePage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è·¯çº¿é¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸ“±', 
              text: 'ç§‘æŠ€', 
              color: '#FDCB6E',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/TechPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç§‘æŠ€é¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸ€', 
              text: 'è‡ªç„¶', 
              color: '#55A3FF',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/NaturePage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è‡ªç„¶é¡µé¢'));
              }
            })
            CategoryItem({ 
              icon: 'ğŸ–ï¸', 
              text: 'æµ·æ™¯', 
              color: '#00CEC9',
              onItemClick: () => {
                ErrorHandler.safeExecute(async (): Promise<void> => {
                  await router.pushUrl({
                    url: 'pages/category/BeachPage'
                  });
                }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æµ·æ™¯é¡µé¢'));
              }
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)
        }
        .width('95%')
        .margin({ bottom: 20 })

        // AIæ™ºèƒ½æ¨èåŒºåŸŸ
        if (this.showAIRecommendations) {
          SmartRecommendationList({
            userId: this.userId,
            availableActivities: this.availableActivities
          })
          .margin({ top: 20 })
        }

        // ç²¾é€‰æ¨è - List (åˆ—è¡¨å±•ç¤º)
        Text('ç²¾é€‰æ¨è')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#334155')
          .alignSelf(ItemAlign.Start)
          .margin({ left: '2.5%', bottom: 10 })
          .padding({ left: 10 })

        GridRow({
          columns: 6,
          gutter: { x: 10, y: 10 }
        }) {
          ForEach(this.ListInfos ?? [], (item: ListItemInfo, index: number) => {
            GridCol({ span: { xs: 6, md: 3, lg: 2 } }) {
              RecommendedItem({
                image: item.image,
                title: item.title,
                description: item.description
              })
            }
          }, (item: ListItemInfo, index: number) => `list-${index}-${item.title}`)
        }
        .margin({ left: '2.5%', right: '2.5%' })

        // List() {
        //   ListItem() {
        //     RecommendedItem({
        //       image: $r('app.string.GreenParkUrl'),
        //       title: 'ç¿ æ¹–å…¬å›­',
        //       description: 'åŸå¸‚ä¸­å¿ƒçš„ç»¿æ´²ï¼Œä¼‘é—²æ•£æ­¥å¥½å»å¤„ã€‚'
        //     })
        //   }
        //
        //   ListItem() {
        //     RecommendedItem({
        //       image: $r('app.string.LampActivityUrl'),
        //       title: 'åŸå¸‚æ–‡åŒ–èŠ‚',
        //       description: 'ä½“éªŒå½“åœ°æ–‡åŒ–ï¼Œæ„Ÿå—åŸå¸‚é­…åŠ›ã€‚'
        //     })
        //   }
        //
        //   ListItem() {
        //     RecommendedItem({
        //       image: $r('app.string.WaterStreetUrl'),
        //       title: 'çœ‰å±±æ°´è¡—',
        //       description: 'å“å°åœ°é“å°åƒï¼Œæ„Ÿå—å·èœ€æµªæ¼«ï¼Œæ»¡è¶³æ‚¨çš„å‘³è•¾ã€‚'
        //     })
        //   }
        //
        //   ListItem() {
        //     RecommendedItem({
        //       image: $r('app.string.BiFengGorgeUrl'),
        //       title: 'ç¢§å³°å³¡',
        //       description: 'é¢†ç•¥å¤§è‡ªç„¶é¬¼æ–§ç¥å·¥ï¼Œè§‚èµç†ŠçŒ«åŸºåœ°çš„ç§€ä¸½'
        //     })
        //   }
        //
        //   ListItem() {
        //     RecommendedItem({
        //       image: $r('app.string.GreenMountainUrl'),
        //       title: 'è’™é¡¶å±±',
        //       description: 'æ‰¬å­æ±Ÿå¿ƒæ°´ï¼Œè’™å±±é¡¶ä¸ŠèŒ¶ã€‚åƒå¹´èŒ¶éƒ½ï¼Œä¸–ç•ŒèŒ¶å›­ï¼Œåƒç§‹è’™é¡¶ï¼Œå€¼å¾—ä¸€èµ'
        //     })
        //   }
        // }
        // .width('95%')
        // // åœ¨ Scroll ç»„ä»¶å†…éƒ¨ï¼ŒList çš„é«˜åº¦ä¼šæ ¹æ®å…¶å†…å®¹è‡ªé€‚åº”ï¼Œé€šå¸¸ä¸éœ€è¦è®¾ç½® layoutWeight(1)
        // // .layoutWeight(1)
        // .listDirection(Axis.Vertical) // å‚ç›´åˆ—è¡¨
        // .divider({ strokeWidth: 0, color: Color.Transparent }) // æ— åˆ†éš”çº¿
        // .scrollBar(BarState.Off) // å…³é—­åˆ—è¡¨è‡ªèº«çš„æ»šåŠ¨æ¡
        }
        .width('100%') // Column å®½åº¦å¡«å…… Scroll
        // åœ¨ Scroll ç»„ä»¶å†…éƒ¨ï¼ŒColumn çš„é«˜åº¦ä¸éœ€è¦å›ºå®šä¸º100%ï¼Œå®ƒä¼šæ ¹æ®å†…å®¹è‡ªé€‚åº”
        // .height('100%')
        .backgroundColor('#f0f4f8') // è½»æŸ”çš„èƒŒæ™¯è‰²
        .padding({ bottom: 20 }) // åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢å†…å®¹è¢«åº•éƒ¨å¯¼èˆªæ é®æŒ¡
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off) // éšè— Scroll ç»„ä»¶çš„æ»šåŠ¨æ¡
      
      // ä½ç½®æ°”æ³¡ç»„ä»¶
      LocationBubble()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }


  @Builder SearchBar() {
    Row() {
      TextInput({ placeholder: 'æœç´¢æ™¯ç‚¹ã€æ´»åŠ¨...' })
        .layoutWeight(1)
        .height(48)
        .borderRadius(24)
        .backgroundColor(Color.White)
        .padding({ left: 20, right: 20 })
        .fontSize(16)
        .fontColor('#1f2937')
        .placeholderColor('#9ca3af')
        .border({ width: 1, color: '#e5e7eb', radius: 24 })
        .shadow({
          radius: 8,
          color: 'rgba(0,0,0,0.1)',
          offsetX: 0,
          offsetY: 2
        })
        .onClick(() => {
          // è·³è½¬åˆ°æœç´¢é¡µé¢
          router.pushUrl({
            url: 'pages/search/SearchPage'
          }).catch((error: Error) => {
            ErrorHandler.handleRouterError(error, 'æœç´¢é¡µé¢');
          });
        })

      // åœ°å›¾æŒ‰é’®
      Column() {
        Text('ğŸ—ºï¸')
          .fontSize(20)
        Text('åœ°å›¾')
          .fontSize(10)
          .fontColor('#6b7280')
          .margin({ top: 2 })
      }
      .margin({ left: 12 })
      .onClick(() => {
        // è·³è½¬åˆ°åœ°å›¾é¡µé¢
        AppStorage.setOrCreate('selectedTab', 1);
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 16 })
  }
}

@Component
struct ListView {
  @State tab_index: number = 0;
  @Prop data: ListItemInfo[];
  @Prop maxCount: number = 3;
  @Prop rowCount: number = Math.ceil(this.data.length / this.maxCount);

  build() {
    // List() {
    //   // éå†æ¯ä¸€â€œè¡Œâ€
    //   ForEach(Array(this.rowCount).fill(0), (rowIndex: number) => {
    //     ListItem() {
    //       Row({ space: 10 }) {
    //         // å½“å‰è¡Œçš„æ‰€æœ‰åˆ—
    //         ForEach(this.data.slice(rowIndex * this.maxCount, (rowIndex + 1) * this.maxCount), (item: ListItemInfo) => {
    //           ListItem() {
    //             RecommendedItem({
    //               image: item.image,
    //               title: item.title,
    //               description: item.description
    //             })
    //           }
    //           .width(`${100 / this.maxCount}%`) // å¹³å‡åˆ†é…å®½åº¦
    //         })
    //       }
    //     }
    //   })
    // }

  }
}

// çƒ­é—¨åˆ†ç±»å¡ç‰‡ç»„ä»¶ï¼ˆæºç¨‹é£æ ¼ï¼‰
@Component
struct CategoryCard {
  private icon: string = '';
  private title: string = '';
  private subtitle: string = '';
  private color: string = '#FF6B35';
  private onCardClick?: () => void;

  build() {
    Column() {
      Text(this.icon)
        .fontSize(48)
        .margin({ bottom: 8 })

      Text(this.title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 4 })

      Text(this.subtitle)
        .fontSize(12)
        .fontColor('#666666')
    }
    .width(160)
    .height(120)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: this.color + '15',
      offsetX: 0,
      offsetY: 4
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      console.log('ç‚¹å‡»äº†åˆ†ç±»å¡ç‰‡:', this.title);
      if (this.onCardClick) {
        this.onCardClick();
      }
    })
  }
}

// çƒ­é—¨åˆ†ç±»é¡¹ç»„ä»¶
@Component
struct CategoryItem {
  private icon: string = '';
  private text: string = '';
  private color: string = '#FF6B35';
  private onItemClick?: () => void;

  build() {
    Column() {
      Text(this.icon)
        .fontSize(24)
        .margin({ bottom: 6 })

      Text(this.text)
        .fontSize(11)
        .fontColor('#333333')
        .fontWeight(FontWeight.Medium)
    }
    .width(70)
    .height(70)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: this.color + '20',
      offsetX: 0,
      offsetY: 2
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      console.log('ç‚¹å‡»äº†åˆ†ç±»:', this.text);
      try {
        if (this.onItemClick) {
          this.onItemClick();
        } else {
          console.error('onItemClickå›è°ƒå‡½æ•°æœªå®šä¹‰');
        }
      } catch (error) {
        console.error('åˆ†ç±»ç‚¹å‡»äº‹ä»¶æ‰§è¡Œå¤±è´¥:', error);
      }
    })
  }
}

// ç²¾é€‰æ¨èé¡¹ç»„ä»¶
@Component
struct RecommendedItem {
  private image: Resource = $r('app.string.module_desc');
  private title: string = '';
  private description: string = '';

  build() {
    Row() {
      Image(this.image)
        .width(80)
        .height(80)
        .borderRadius(6)
        .objectFit(ImageFit.Cover)
        .margin({ right: 15 })

      Column() {
        Text(this.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)// å·¦å¯¹é½
          .margin({ bottom: 5 })
        Text(this.description)
          .fontSize(14)
          .fontColor('#4b5563')
          .alignSelf(ItemAlign.Start) // å·¦å¯¹é½
      }
      .alignItems(HorizontalAlign.Start) // å­ç»„ä»¶æ°´å¹³å·¦å¯¹é½
      .layoutWeight(1) // å…è®¸å†…å®¹å¡«å……å‰©ä½™ç©ºé—´
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(10)
    .shadow({
      radius: 5,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    }) // é˜´å½±
    .margin({ bottom: 10 }) // åº•éƒ¨å¤–è¾¹è·
    .onClick(() => {
      // è·³è½¬åˆ°æ´»åŠ¨è¯¦æƒ…é¡µé¢
      router.pushUrl({
        url: 'pages/activity/ActivityDetailPage',
        params: { id: this.title }
      }).catch((error: Error) => {
        console.error('è·³è½¬å¤±è´¥:', error.message);
      });
    })
  }
}
