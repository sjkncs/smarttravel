import { router } from '@kit.ArkUI';
import {
  shenzhenAttractions,
  shenzhenRoutes,
  AttractionData,
  TourRouteData
} from '../../viewmodel/ShenzhenData';

@Entry
@Component
struct ParkVisitingPage {
  @State currentShowIndex: number = 0;
  @State showTimes: string[] = ['09:30', '13:30', '16:00', '19:30'];
  @State attractions: AttractionData[] = shenzhenAttractions;
  @State routes: TourRouteData[] = shenzhenRoutes;
  
  // æ¼”å‡º/æ´»åŠ¨æµ·æŠ¥å›¾ç‰‡
  private showImages: string[] = [
    'https://picsum.photos/seed/show1/1200/600',
    'https://picsum.photos/seed/show2/1200/600',
    'https://picsum.photos/seed/show3/1200/600'
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå¯é€‰ï¼‰
      this.TopBar()
      
      Scroll() {
        Column() {
          // æ¼”å‡º/æ´»åŠ¨æµ·æŠ¥åŒºåŸŸ
          this.ShowSection()
          
          // ç©ä¹é¡¹ç›®åŒºåŸŸ
          this.AttractionsSection()
          
          // è·¯çº¿æ¨èï¼ˆæ•´åˆç°æœ‰è·¯çº¿åŠŸèƒ½ï¼‰
          this.RouteSection()
          
          // æ—…æ¸¸æ”»ç•¥
          this.TipsSection()
        }
      }
      .scrollBar(BarState.Off)
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // é¡¶éƒ¨å¯¼èˆªæ 
  @Builder TopBar() {
    Row() {
      Text('â† ')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text('æ¸¸å›­')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
      
      Text('ğŸ”')
        .fontSize(20)
        .onClick(() => {
          router.pushUrl({ url: 'pages/search/SearchPage' });
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
  }

  // æ¼”å‡º/æ´»åŠ¨æµ·æŠ¥åŒºåŸŸ
  @Builder ShowSection() {
    Column() {
      // å¤§å›¾æµ·æŠ¥
      Stack({ alignContent: Alignment.Bottom }) {
        Swiper() {
          ForEach(this.showImages ?? [], (image: string, index: number) => {
            Image(image)
              .width('100%')
              .height(200)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)
          }, (image: string, index: number) => `show-${index}`)
        }
        .autoPlay(true)
        .interval(3000)
        .indicator(true)
        .loop(true)
        .onChange((index: number) => {
          this.currentShowIndex = index;
        })

        // æ¼”å‡ºä¿¡æ¯è¦†ç›–å±‚
        Column() {
          Text('æ·±åœ³æ¬¢ä¹è°·ç²¾å½©æ¼”å‡º')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff')
            .margin({ bottom: 6 })
          
          Row({ space: 8 }) {
            Text('åœºæ¬¡æ—¶é—´:')
              .fontSize(13)
              .fontColor('#ffffff')
            Text(this.showTimes.join(' | '))
              .fontSize(13)
              .fontColor('#ffffff')
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('rgba(0, 0, 0, 0.4)')
        .borderRadius({ bottomLeft: 12, bottomRight: 12 })
      }
      .width('100%')
      .height(200)

      // ç¼©ç•¥å›¾åˆ—è¡¨
      Row({ space: 8 }) {
        ForEach([0, 1, 2, 3, 4], (index: number) => {
          Image(this.showImages[index % this.showImages.length])
            .width(64)
            .height(48)
            .borderRadius(6)
            .objectFit(ImageFit.Cover)
            .border({
              width: this.currentShowIndex === index ? 3 : 0,
              color: '#0086f6'
            })
            .onClick(() => {
              this.currentShowIndex = index;
            })
        }, (index: number) => `thumb-${index}`)
      }
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
  }

  // ç©ä¹é¡¹ç›®åŒºåŸŸ
  @Builder AttractionsSection() {
    Column() {
      // æ ‡é¢˜è¡Œ
      Row() {
        Text('ç©ä¹é¡¹ç›®')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Row({ space: 4 }) {
          Text('å…¨éƒ¨')
            .fontSize(13)
            .fontColor('#0086f6')
          Text('â†’')
            .fontSize(12)
            .fontColor('#0086f6')
        }
        .onClick(() => {
          // æŸ¥çœ‹å…¨éƒ¨é¡¹ç›®
        })
      }
      .width('100%')
      .margin({ bottom: 16 })

      // é¡¹ç›®ç½‘æ ¼ï¼ˆ2åˆ—ï¼‰
      Grid() {
        ForEach((this.attractions ?? []).slice(0, 6), (item: AttractionData, index: number) => {
          GridItem() {
            this.AttractionCard(item)
          }
        }, (item: AttractionData, index: number) => `attraction-${item.id ?? index}`)
      }
      .columnsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .height(640)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .margin({ top: 10 })
  }

  // ç©ä¹é¡¹ç›®å¡ç‰‡
  @Builder AttractionCard(item: AttractionData) {
    Column() {
      Image(item.image)
        .width('100%')
        .height(140)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
      
      Column({ space: 6 }) {
        Text(item.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row() {
          Text(item.subtitle)
            .fontSize(12)
            .fontColor('#999999')
            .layoutWeight(1)
          
          Text(`â­${item.rating}`)
            .fontSize(12)
            .fontColor('#ff9900')
        }
        .width('100%')
        
        // è¯­éŸ³è®²è§£æŒ‰é’®
        if (item.hasAudio) {
          Row() {
            Text('ğŸµ')
              .fontSize(12)
            Text('è¯­éŸ³è®²è§£')
              .fontSize(12)
              .fontColor('#0086f6')
              .margin({ left: 4 })
            Text(`${item.audioDuration}`)
              .fontSize(11)
              .fontColor('#999999')
              .margin({ left: 4 })
          }
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#e6f4ff')
          .borderRadius(12)
          .onClick(() => {
            // è·³è½¬åˆ°è¯­éŸ³è®²è§£é¡µé¢
            router.pushUrl({
              url: 'pages/attraction/AttractionAudioPage',
              params: {
                audioInfo: {
                  id: item.id,
                  title: item.name,
                  cover: item.image,
                  duration: item.audioDuration || '00:00',
                  audioUrl: `audio/${item.id}.mp3`
                }
              }
            });
          })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .padding(8)
      .width('100%')
    }
    .backgroundColor('#fafafa')
    .borderRadius(8)
  }

  // è·¯çº¿æ¨èåŒºåŸŸï¼ˆæ•´åˆç°æœ‰è·¯çº¿åŠŸèƒ½ï¼‰
  @Builder RouteSection() {
    Column() {
      Row() {
        Text('ğŸ—ºï¸ æ¨èè·¯çº¿')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Text('æŸ¥çœ‹æ›´å¤š â†’')
          .fontSize(13)
          .fontColor('#0086f6')
          .onClick(() => {
            router.pushUrl({ url: 'pages/category/RoutePage' });
          })
      }
      .width('100%')
      .margin({ bottom: 12 })

      Scroll() {
        Row({ space: 10 }) {
          ForEach(this.routes ?? [], (route: TourRouteData, index: number) => {
            this.RouteCard(route)
          }, (route: TourRouteData, index: number) => `route-${route.id ?? index}`)
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .margin({ top: 10 })
  }

  // è·¯çº¿å¡ç‰‡
  @Builder RouteCard(route: TourRouteData) {
    Column() {
      Image(route.image)
        .width(180)
        .height(100)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
      
      Column() {
        Text(route.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })
        
        Row({ space: 6 }) {
          Text(`â±ï¸ ${route.duration}`)
            .fontSize(12)
            .fontColor('#999999')
          Text('|')
            .fontSize(12)
            .fontColor('#d9d9d9')
          Text(`ğŸ“ ${route.spots.length}ä¸ªæ™¯ç‚¹`)
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .alignItems(HorizontalAlign.Start)
      .padding(8)
    }
    .width(180)
    .backgroundColor('#fafafa')
    .borderRadius(8)
    .onClick(() => {
      console.log('è·¯çº¿è¯¦æƒ…:', route.name);
    })
  }

  // æ—…æ¸¸æ”»ç•¥åŒºåŸŸ
  @Builder TipsSection() {
    Column() {
      Row() {
        Text('ğŸ“– æ—…æ¸¸æ”»ç•¥')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Text('æ›´å¤š â†’')
          .fontSize(13)
          .fontColor('#0086f6')
      }
      .width('100%')
      .margin({ bottom: 12 })

      Column({ space: 12 }) {
        ForEach([1, 2, 3], (index: number) => {
          this.TipItem()
        }, (index: number) => `tip-${index}`)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .margin({ top: 10, bottom: 20 })
  }

  // æ”»ç•¥æ¡ç›®
  @Builder TipItem() {
    Row() {
      Image('https://picsum.photos/seed/tip1/400/400')
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
      
      Column() {
        Text('æ¸¸å›­å¿…å¤‡æ”»ç•¥æŒ‡å—')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8 })
        
        Row({ space: 8 }) {
          Text('ğŸ‘ï¸ 1.2ä¸‡')
            .fontSize(12)
            .fontColor('#999999')
          Text('ğŸ’¬ 156')
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(8)
  }
}
