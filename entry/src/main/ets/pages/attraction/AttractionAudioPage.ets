/**
 * æ™¯ç‚¹è¯­éŸ³è®²è§£é¡µé¢
 * å‚è€ƒç¤ºä¾‹: example_code/AttractionTalkSample
 * v5.0: é›†æˆMediaPlayerUtilå®ç°çœŸå®éŸ³é¢‘æ’­æ”¾
 */

import { router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { MediaPlayerUtil } from '../../utils/MediaPlayerUtil';
import Logger from '../../utils/Logger';

interface AudioInfo {
  id: string;
  title: string;
  cover: string;
  duration: string;
  audioUrl: string;
}

@Entry
@Component
export struct AttractionAudioPage {
  @State isPlaying: boolean = false;
  @State currentTime: string = '00:00';
  @State totalTime: string = '00:00';
  @State progress: number = 0;
  @State isLoading: boolean = false;
  @State playerState: string = 'idle';
  @State isFavorite: boolean = false;
  
  private audioInfo: AudioInfo = {
    id: '',
    title: 'æ™¯ç‚¹ä»‹ç»',
    cover: 'https://picsum.photos/seed/banner1/800/600',
    duration: '05:30',
    audioUrl: 'audio/sample.mp3' // é»˜è®¤éŸ³é¢‘æ–‡ä»¶
  };
  
  private mediaPlayer: MediaPlayerUtil | null = null;
  private context: common.UIAbilityContext | null = null;
  private updateTimer: number = -1;

  async aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params && params.audioInfo) {
      this.audioInfo = params.audioInfo as AudioInfo;
      this.totalTime = this.audioInfo.duration;
    }
    
    // è·å–Context
    try {
      this.context = getContext(this) as common.UIAbilityContext;
      await this.initializePlayer();
    } catch (error) {
      Logger.error('Failed to get context:', (error as Error).message);
      promptAction.showToast({
        message: 'åˆå§‹åŒ–å¤±è´¥',
        duration: 2000
      });
    }
  }
  
  aboutToDisappear() {
    // æ¸…ç†èµ„æº
    this.cleanupPlayer();
  }
  
  // åˆå§‹åŒ–æ’­æ”¾å™¨
  private async initializePlayer() {
    try {
      this.isLoading = true;
      this.mediaPlayer = MediaPlayerUtil.getInstance();
      
      if (!this.context) {
        throw new Error('Context not available');
      }
      
      await this.mediaPlayer.initialize(this.context);
      
      // è®¾ç½®å›è°ƒ
      this.mediaPlayer.onStateChange = (state: string) => {
        this.playerState = state;
        Logger.info(`Player state changed: ${state}`);
        
        if (state === 'playing') {
          this.isPlaying = true;
          this.startProgressUpdate();
        } else if (state === 'paused' || state === 'stopped' || state === 'completed') {
          this.isPlaying = false;
          this.stopProgressUpdate();
        }
      };
      
      this.mediaPlayer.onTimeUpdate = (time: number) => {
        this.currentTime = MediaPlayerUtil.formatTime(time);
        if (this.mediaPlayer && this.mediaPlayer.duration > 0) {
          this.progress = (time / this.mediaPlayer.duration) * 100;
        }
      };
      
      this.mediaPlayer.onDurationUpdate = (duration: number) => {
        this.totalTime = MediaPlayerUtil.formatTime(duration);
      };
      
      this.mediaPlayer.onError = (error) => {
        Logger.error('Media player error:', error.message);
        promptAction.showToast({
          message: 'æ’­æ”¾å‡ºé”™',
          duration: 2000
        });
        this.isPlaying = false;
      };
      
      // åŠ è½½éŸ³é¢‘
      if (this.audioInfo.audioUrl) {
        await this.mediaPlayer.loadAudioFromRaw(this.context, this.audioInfo.audioUrl);
        Logger.info('Audio loaded successfully');
      }
      
      this.isLoading = false;
    } catch (error) {
      Logger.error('Initialize player failed:', (error as Error).message);
      this.isLoading = false;
      promptAction.showToast({
        message: 'éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ’­æ”¾',
        duration: 2000
      });
    }
  }
  
  // æ¸…ç†æ’­æ”¾å™¨
  private cleanupPlayer() {
    this.stopProgressUpdate();
    if (this.mediaPlayer) {
      this.mediaPlayer.release();
      this.mediaPlayer = null;
    }
  }
  
  // å¼€å§‹è¿›åº¦æ›´æ–°
  private startProgressUpdate() {
    this.stopProgressUpdate();
    // å®šæ—¶åˆ·æ–°UI
    this.updateTimer = setInterval(() => {
      // è§¦å‘UIæ›´æ–°
    }, 100);
  }
  
  // åœæ­¢è¿›åº¦æ›´æ–°
  private stopProgressUpdate() {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
      this.updateTimer = -1;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()
      
      Column() {
        // å›¾ç‰‡å±•ç¤ºåŒº
        Image(this.audioInfo.cover)
          .width('100%')
          .aspectRatio(1)
          .borderRadius(16)
          .objectFit(ImageFit.Cover)
          .margin({ top: 20 })

        // æ’­æ”¾æ§åˆ¶åŒº
        this.PlayerControlSection()

        // è¯¦æƒ…ä»‹ç»åŒº
        this.DetailSection()
      }
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F1F3F5')
  }

  // é¡¶éƒ¨å¯¼èˆªæ 
  @Builder TopBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text(this.audioInfo.title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ left: 8 })
        .layoutWeight(1)
      
      Text('ğŸ”—')
        .fontSize(20)
        .onClick(() => {
          // åˆ†äº«åŠŸèƒ½
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#ffffff')
  }

  // æ’­æ”¾æ§åˆ¶åŒº
  @Builder PlayerControlSection() {
    Column() {
      // è¿›åº¦æ¡
      Slider({
        value: this.progress,
        min: 0,
        max: 100,
        style: SliderStyle.OutSet
      })
        .width('100%')
        .trackThickness(4)
        .showTips(false)
        .blockColor('#0086f6')
        .trackColor('#e0e0e0')
        .selectedColor('#0086f6')
        .onChange((value: number) => {
          // è·³è½¬åˆ°æŒ‡å®šä½ç½®
          if (this.mediaPlayer && this.mediaPlayer.duration > 0) {
            const targetTime = (value / 100) * this.mediaPlayer.duration;
            this.mediaPlayer.seek(targetTime);
            this.progress = value;
          }
        })

      // æ—¶é—´æ˜¾ç¤º
      Row() {
        Text(this.currentTime)
          .fontSize(12)
          .fontColor('#666666')
        
        Text(this.totalTime)
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ top: 8 })

      // æ’­æ”¾æ§åˆ¶æŒ‰é’®
      Row() {
        // åé€€15ç§’
        Column() {
          Text('âª')
            .fontSize(24)
          Text('-15s')
            .fontSize(10)
            .fontColor('#666666')
        }
        .onClick(() => {
          this.seekBackward(15000);
        })

        // æ’­æ”¾/æš‚åœæŒ‰é’®
        Text(this.isPlaying ? 'â¸ï¸' : 'â–¶ï¸')
          .fontSize(48)
          .onClick(() => {
            this.togglePlay();
          })

        // å‰è¿›15ç§’
        Column() {
          Text('â©')
            .fontSize(24)
          Text('+15s')
            .fontSize(10)
            .fontColor('#666666')
        }
        .onClick(() => {
          this.seekForward(15000);
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .margin({ top: 20 })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 20 })
    .backgroundColor('#ffffff')
    .borderRadius(16)
  }

  // è¯¦æƒ…ä»‹ç»åŒº
  @Builder DetailSection() {
    Column() {
      Row() {
        Text(this.audioInfo.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Row() {
          Text(this.isFavorite ? 'â­' : 'â˜†')
            .fontSize(14)
          Text(this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—')
            .fontSize(14)
            .fontColor('#0086f6')
            .margin({ left: 4 })
        }
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .backgroundColor('#e6f4ff')
        .borderRadius(14)
        .onClick(() => {
          this.toggleFavorite();
        })
      }
      .width('100%')
      .margin({ bottom: 12 })

      Text('æ™¯ç‚¹è¯¦ç»†ä»‹ç»')
        .fontSize(14)
        .lineHeight(24)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Start)
      
      Text(this.getDetailDescription())
        .fontSize(14)
        .lineHeight(24)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Start)
        .maxLines(10)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .padding(16)
    .margin({ top: 10 })
    .backgroundColor('#ffffff')
    .borderRadius(16)
  }

  // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
  private async togglePlay() {
    if (!this.mediaPlayer) {
      promptAction.showToast({
        message: 'æ’­æ”¾å™¨æœªåˆå§‹åŒ–',
        duration: 2000
      });
      return;
    }
    
    try {
      if (this.isPlaying) {
        await this.mediaPlayer.pause();
        Logger.info('Playback paused');
      } else {
        await this.mediaPlayer.play();
        Logger.info('Playback started');
      }
    } catch (error) {
      Logger.error('Toggle play failed:', (error as Error).message);
      promptAction.showToast({
        message: 'æ’­æ”¾æ§åˆ¶å¤±è´¥',
        duration: 2000
      });
    }
  }
  
  // å¿«é€€
  private async seekBackward(ms: number) {
    if (!this.mediaPlayer) return;
    
    const targetTime = Math.max(0, this.mediaPlayer.currentTime - ms);
    await this.mediaPlayer.seek(targetTime);
  }
  
  // å¿«è¿›
  private async seekForward(ms: number) {
    if (!this.mediaPlayer) return;
    
    const targetTime = Math.min(this.mediaPlayer.duration, this.mediaPlayer.currentTime + ms);
    await this.mediaPlayer.seek(targetTime);
  }
  
  // åˆ‡æ¢æ”¶è—çŠ¶æ€
  private toggleFavorite() {
    this.isFavorite = !this.isFavorite;
    promptAction.showToast({
      message: this.isFavorite ? 'å·²æ·»åŠ åˆ°æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—',
      duration: 2000
    });
  }

  // è·å–è¯¦ç»†æè¿°
  private getDetailDescription(): string {
    return 'è¿™é‡Œæ˜¯æ™¯ç‚¹çš„è¯¦ç»†ä»‹ç»å†…å®¹ã€‚åŒ…æ‹¬æ™¯ç‚¹çš„å†å²èƒŒæ™¯ã€æ–‡åŒ–å†…æ¶µã€å»ºç­‘ç‰¹è‰²ã€æ¸¸è§ˆå»ºè®®ç­‰ä¿¡æ¯ã€‚' +
      'æ‚¨å¯ä»¥é€šè¿‡è¯­éŸ³è®²è§£æ·±å…¥äº†è§£æ™¯ç‚¹çš„æ•…äº‹å’Œç‰¹è‰²ï¼Œè·å¾—æ›´å¥½çš„æ¸¸è§ˆä½“éªŒã€‚';
  }
}
