import webview from "@ohos.web.webview";
import Prompt from "@system.prompt";
import { BusinessError } from "@kit.BasicServicesKit";
import util from "@ohos.util";
import { ActivityDetail, MessageModel, routerParams } from "../../model/ActivityModel";
import { router } from "@kit.ArkUI";
import { VoicePlayerComponent } from "../../components/VoicePlayerComponent";
import { mapCommon, site } from '@kit.MapKit';
import { MetroInfo } from '../../model/MetroStationModel';
import { MapConstants } from '../../constants/MapConstants';
import { MarkerViewModel } from '../../viewmodel/MarkerViewModel';
import { ErrorHandler } from '../../utils/ErrorHandler';

@Entry
@Component
export struct ActivityDetailPage {
  activityDetailPath: Resource = $rawfile('activity_detail.html')
  controller: webview.WebviewController = new webview.WebviewController();
  ports: webview.WebMessagePort[] = [];
  nativePort: webview.WebMessagePort | null = null;
  @State activitiesDetail: ActivityDetail = {} as ActivityDetail;
  @State receiveMessage: MessageModel = {} as MessageModel;
  @State params: routerParams = router.getParams() as routerParams;
  @State activityId: number = Number(this.params.src);
  @State metros: MetroInfo[] = [];
  private markerVM: MarkerViewModel = MarkerViewModel.instance;

  async aboutToAppear() {
    await this.loadActivitiesDetailFromFile();
  }

  initWebviewPort() {
    try {
      this.ports = this.controller.createWebMessagePorts();
      this.ports[1].onMessageEvent((result: webview.WebMessage) => {
        let msg: MessageModel;
        if (typeof (result) === "string") {
          console.log("received string message from html5, string is:" + result);
          // æ”¶åˆ° HTML å‘é€è¿‡æ¥çš„æ´»åŠ¨ ID
          let message: MessageModel = JSON.parse(result);
          msg = message;
          if (message.type == 'back') {
            router.back();
          } else if (message.type == 'event') {
            const content = message.content;
            this.selectEvent(content);
          } else {
            console.error("æ¶ˆæ¯çš„typeæ˜¯ï¼š", message.type)
            console.error("æ¶ˆæ¯çš„å†…å®¹æ˜¯ï¼š", message.content)
          }
        } else {
          console.log("received unknown message type from html5");
          msg = {
            type: 'error',
            content: 'æ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹æœªçŸ¥'
          };
        }
        this.receiveMessage = msg;
      });
      this.controller.postMessage('__init_port__', [this.ports[0]], '*');
    } catch (error) {
      console.error(`ErrorCode: ${(error as BusinessError).code},  Message: ${(error as BusinessError).message}`);
    }
  }

  async loadActivitiesDetailFromFile() {
    try {
      getContext().resourceManager.getRawFileContent("data/activity_details.json").then(async (value: Uint8Array) => {
        let rawFile = value;
        let decoder = util.TextDecoder.create('utf-8');
        let content = decoder.decodeToString(rawFile);
        let json: ActivityDetail[] = JSON.parse(content);
        this.activitiesDetail = json[this.activityId - 1];
        console.error(JSON.stringify(this.activitiesDetail));
        // æ•°æ®åŠ è½½å®Œæˆåï¼Œå¦‚æœæœ‰ä½ç½®ä¿¡æ¯ï¼Œæœç´¢å‘¨è¾¹åœ°é“ç«™
        if (this.activitiesDetail.location) {
          await this.searchNearbyMetros();
        }
      }).catch((error: BusinessError) => {
        console.error("getRawFileContent promise error is " + error);
      });
    } catch (error) {
      let code = (error as BusinessError).code;
      let message = (error as BusinessError).message;
      console.error(`promise getRawFileContent failed, error code: ${code}, message: ${message}.`);
    }
  }

  postMessageToHtml(content: string) {
    try {
      if (this.ports && this.ports[1]) {
        this.ports[1].postMessageEvent(content);
      } else {
        console.error(`ports is null, Please initialize first`);
      }
    } catch (error) {
      console.error(`ErrorCode: ${(error as BusinessError).code},  Message: ${(error as BusinessError).message}`);
    }
  }

  selectEvent(event: string) {
    switch (event) {
      case 'signup':
        router.pushUrl({
          url: 'pages/activity/SignUpPage',
          params: new routerParams(this.activitiesDetail.activityId.toString() + this.activitiesDetail.title)
        })
        break
      default:
        return
    }
  }

  // æœç´¢å‘¨è¾¹åœ°é“ç«™
  async searchNearbyMetros() {
    if (!this.activitiesDetail.location) {
      return;
    }
    try {
      const center: mapCommon.LatLng = {
        latitude: this.activitiesDetail.location.latitude,
        longitude: this.activitiesDetail.location.longitude
      };
      
      let params: site.SearchByTextParams = {
        query: 'åœ°é“ç«™',
        location: center,
        poiTypes: ['SUBWAY'],
        isChildren: true,
        language: 'zh_CN',
        radius: MapConstants.DISTANCE
      };
      
      let result = await site.searchByText(params);
      if (result.sites) {
        this.metros.length = 0;
        for (let siteItem of result.sites) {
          if (siteItem.distance! <= MapConstants.DISTANCE && !siteItem.name!.endsWith('(è§„åˆ’ä¸­)')) {
            let metro: MetroInfo = {
              siteId: siteItem.siteId,
              name: siteItem.name,
              address: siteItem.formatAddress,
              location: siteItem.location,
              distance: siteItem.distance
            } as MetroInfo;
            this.metros.push(metro);
          }
        }
        this.metros.sort((a, b) => a.distance - b.distance);
        this.markerVM.metros = this.metros;
      }
    } catch (error) {
      console.error('æœç´¢å‘¨è¾¹åœ°é“ç«™å¤±è´¥:', error);
    }
  }

  // è·³è½¬åˆ°åœ°å›¾é¡µé¢
  navigateToMap() {
    if (!this.activitiesDetail.location) {
      Prompt.showToast({
        message: 'è¯¥æ´»åŠ¨æš‚æ— ä½ç½®ä¿¡æ¯',
        duration: 2000
      });
      return;
    }
    
    router.pushUrl({
      url: 'pages/activity/ActivityMapPage',
      params: {
        metros: this.metros,
        center: {
          latitude: this.activitiesDetail.location.latitude,
          longitude: this.activitiesDetail.location.longitude
        }
      }
    });
  }

  build() {
    Stack() {
      Column() {
        // è¯­éŸ³æ’­æ”¾ç»„ä»¶ï¼ˆå¦‚æœæœ‰éŸ³é¢‘èµ„æºï¼‰
        if (this.activitiesDetail.audioResource) {
          VoicePlayerComponent({
            audioResource: this.activitiesDetail.audioResource,
            audioId: `activity_${this.activitiesDetail.activityId}`
          })
          .margin({ top: 8, left: 16, right: 16 })
        }
        
        // æŸ¥çœ‹åœ°å›¾æŒ‰é’®ï¼ˆå¦‚æœæœ‰ä½ç½®ä¿¡æ¯ï¼‰
        if (this.activitiesDetail.location) {
          this.mapButtonBuilder()
        }
        
        // WebView æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
        Web({ src: this.activityDetailPath, controller: this.controller })
          .onPageEnd(() => {
            this.initWebviewPort();
            this.postMessageToHtml(JSON.stringify(this.activitiesDetail));
          })
          .layoutWeight(1)
          .margin({ bottom: 80 }) // ä¸ºåº•éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´
      }
      .width('100%')
      .height('100%')
      
      // è¿”å›æŒ‰é’®
      Row() {
        Text('â¬…ï¸')// ä½¿ç”¨å·¦ç®­å¤´ emoji
          .fontSize(24)// è°ƒæ•´ emoji å¤§å°
          .onClick(() => {
            router.back();
          })
      }
      .width(36) // æŒ‰é’®å®½åº¦
      .height(36) // æŒ‰é’®é«˜åº¦
      .backgroundColor(Color.Gray) // ç°è‰²èƒŒæ™¯
      .borderRadius(24) // åœ†è§’ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒä¸€ä¸ªåœ†å½¢æŒ‰é’®
      .opacity(0.8) // åŠé€æ˜æ•ˆæœ
      .position({ x: 16, y: 16 }) // å®šä½åˆ°å·¦ä¸Šè§’ï¼Œè·ç¦»å·¦è¾¹å’Œé¡¶éƒ¨å„16vp
      .zIndex(1) // ç¡®ä¿æŒ‰é’®åœ¨ WebView ä¸Šå±‚
      .alignItems(VerticalAlign.Center) // å±…ä¸­å›¾ç‰‡
      .justifyContent(FlexAlign.Center)

      // è´­ç¥¨æŒ‰é’®
      this.ticketButtonBuilder()
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  mapButtonBuilder() {
    Row() {
      Row({ space: 8 }) {
        Text('ğŸ“')
          .fontSize(18)
        Column({ space: 2 }) {
          Text('æŸ¥çœ‹åœ°å›¾')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White) // ç™½è‰²æ–‡å­—åœ¨ç»¿è‰²èƒŒæ™¯ä¸Š
          if (this.metros.length > 0) {
            Text(`é™„è¿‘${this.metros[0].name}Â·ç›¸è·${this.metros[0].distance.toFixed(0)}m`)
              .fontSize(12)
              .fontColor('#f0f0f0') // æµ…è‰²æ–‡å­—
          } else if (this.activitiesDetail.location?.address) {
            Text(this.activitiesDetail.location.address)
              .fontSize(12)
              .fontColor('#f0f0f0') // æµ…è‰²æ–‡å­—
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        Text('â¡ï¸')
          .fontSize(16)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    }
    .width('100%')
    .backgroundColor('#22c55e') // ç»¿è‰²èƒŒæ™¯
    .margin({ top: 8, left: 16, right: 16 })
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#1F000000',
      offsetX: 0,
      offsetY: 2
    })
    .zIndex(1) // ç¡®ä¿åœ¨çº¢è‰²æŒ‰é’®ä¸‹æ–¹
    .onClick(() => {
      this.navigateToMap();
    })
  }

  @Builder
  ticketButtonBuilder() {
    Row() {
      Button('ç«‹å³è´­ç¥¨')
        .backgroundColor('#ef4444')
        .fontColor(Color.White)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .borderRadius(8)
        .layoutWeight(1)
        .onClick(() => {
          ErrorHandler.safeExecute(async (): Promise<void> => {
            await router.pushUrl({
              url: 'pages/booking/EnhancedBookingPage',
              params: { 
                id: this.activityId.toString(),
                name: this.activitiesDetail.title || 'æ™¯ç‚¹é—¨ç¥¨'
              }
            });
          }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è´­ç¥¨é¡µé¢'));
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .position({ x: 0, y: '100%' })
    .translate({ x: 0, y: -76 }) // è°ƒæ•´ä½ç½®ï¼Œé¿å…ä¸ç»¿è‰²æŒ‰é’®é‡å 
    .zIndex(2)
    .border({ width: { top: 1 }, color: '#e5e7eb' })
  }
}