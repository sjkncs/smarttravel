import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface Activity {
  id: number;
  title: string;
  subtitle: string;
  price: string;
  originalPrice?: string;
  rating: number;
  reviewCount: number;
  category: string;
  tags: string[];
  image: string;
  time: string;
  location: string;
  description: string;
}

interface Category {
  name: string;
  color: string;
}

@Entry
@Component
export struct ActivityPageNew {
  @State selectedCategory: string = 'çƒ­é—¨æ¨è';
  @State activities: Activity[] = [];
  @State filteredActivities: Activity[] = [];
  @State isLoading: boolean = false;

  private categories: Category[] = [
    { name: 'çƒ­é—¨æ¨è', color: '#ff6b6b' },
    { name: 'æ–‡åŒ–ä½“éªŒ', color: '#4ecdc4' },
    { name: 'è‡ªç„¶æ¢ç´¢', color: '#45b7d1' },
    { name: 'å¨±ä¹ä¼‘é—²', color: '#96ceb4' },
    { name: 'è¿åŠ¨å¥èº«', color: '#feca57' },
    { name: 'äº²å­æ´»åŠ¨', color: '#ff9ff3' }
  ];

  aboutToAppear() {
    console.log('[ActivityPageNew] aboutToAppear - é¡µé¢åˆå§‹åŒ–');
    try {
      // ä»AppStorageè·å–é€‰ä¸­çš„åˆ†ç±»
      this.selectedCategory = AppStorage.get('selectedCategory') as string || 'çƒ­é—¨æ¨è';
      this.loadActivities();
      
      // ç›‘å¬AppStorageå˜åŒ–
      AppStorage.setAndLink('selectedCategory', this.selectedCategory);
    } catch (error) {
      console.error('[ActivityPageNew] åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  // ç›‘å¬åˆ†ç±»å˜åŒ–ï¼Œé‡æ–°è¿‡æ»¤æ´»åŠ¨
  onPageShow() {
    this.filterActivities();
  }

  private loadActivities() {
    this.isLoading = true;
    // æ¨¡æ‹ŸåŠ è½½æ•°æ®
    setTimeout(() => {
      this.activities = [
        {
          id: 1,
          title: 'ä¸–ç•Œä¹‹çª—å›½é™…æ–‡åŒ–èŠ‚',
          subtitle: 'ä¸€æ—¥æ¸¸éä¸–ç•Œï¼Œæ„Ÿå—å¤šå…ƒæ–‡åŒ–é­…åŠ›',
          price: 'Â¥168',
          originalPrice: 'Â¥220',
          rating: 4.8,
          reviewCount: 1256,
          category: 'æ–‡åŒ–ä½“éªŒ',
          tags: ['å›½é™…æ–‡åŒ–', 'ä¸»é¢˜å…¬å›­', 'è¡¨æ¼”è‰ºæœ¯'],
          image: 'ğŸ›ï¸',
          time: '2025å¹´10æœˆ10æ—¥-12æ—¥',
          location: 'ä¸–ç•Œä¹‹çª—ä¸»é¢˜å…¬å›­',
          description: 'æ±‡èš130ä¸ªä¸–ç•Œè‘—åæ™¯è§‚ï¼Œä½“éªŒå„å›½æ–‡åŒ–è¡¨æ¼”ã€ç¾é£ŸèŠ‚ã€æ‰‹å·¥è‰ºåˆ¶ä½œç­‰ç²¾å½©æ´»åŠ¨ã€‚'
        },
        {
          id: 2,
          title: 'æ¬¢ä¹è°·ä¸‡åœ£èŠ‚ç‹‚æ¬¢å¤œ',
          subtitle: 'æƒŠé™©åˆºæ¿€çš„ä¸‡åœ£èŠ‚ä¸»é¢˜å¤œåœºä½“éªŒ',
          price: 'Â¥128',
          originalPrice: 'Â¥180',
          rating: 4.6,
          reviewCount: 892,
          category: 'å¨±ä¹ä¼‘é—²',
          tags: ['ä¸‡åœ£èŠ‚', 'ä¸»é¢˜ä¹å›­', 'å¤œåœº'],
          image: 'ğŸ¢',
          time: '2025å¹´10æœˆ15æ—¥-31æ—¥',
          location: 'æ·±åœ³æ¬¢ä¹è°·',
          description: 'å…¨å›­ææ€–ä¸»é¢˜è£…é¥°ï¼Œé¬¼å±‹æ¢é™©ã€ä¸‡åœ£èŠ‚æ¸¸è¡Œã€å˜è£…å¤§èµ›ç­‰æƒŠé™©åˆºæ¿€ä½“éªŒã€‚'
        },
        {
          id: 3,
          title: 'ä¸œéƒ¨åä¾¨åŸç”Ÿæ€å¾’æ­¥',
          subtitle: 'äº²è¿‘è‡ªç„¶ï¼Œæ¢ç´¢ç”Ÿæ€ä¹‹ç¾',
          price: 'Â¥88',
          rating: 4.7,
          reviewCount: 634,
          category: 'è‡ªç„¶æ¢ç´¢',
          tags: ['ç”Ÿæ€å¾’æ­¥', 'è‡ªç„¶é£å…‰', 'ç¯ä¿æ•™è‚²'],
          image: 'ğŸŒ¿',
          time: '2025å¹´10æœˆ18æ—¥',
          location: 'ä¸œéƒ¨åä¾¨åŸç”Ÿæ€æ™¯åŒº',
          description: 'ä¸“ä¸šè®¾è®¡çš„å¾’æ­¥è·¯çº¿ï¼Œæ¤ç‰©ç§‘æ™®ã€è§‚é¸Ÿæ´»åŠ¨ã€ç¯ä¿æ•™è‚²ç­‰è‡ªç„¶ä½“éªŒã€‚'
        },
        {
          id: 4,
          title: 'å¤§æ¢…æ²™æµ·æ»¨éŸ³ä¹èŠ‚',
          subtitle: 'æ²™æ»©ä¸Šçš„éŸ³ä¹ç››å®´',
          price: 'Â¥98',
          rating: 4.5,
          reviewCount: 423,
          category: 'å¨±ä¹ä¼‘é—²',
          tags: ['éŸ³ä¹èŠ‚', 'æµ·æ»¨', 'æ²™æ»©æ´¾å¯¹'],
          image: 'ğŸµ',
          time: '2025å¹´10æœˆ22æ—¥',
          location: 'å¤§æ¢…æ²™æµ·æ»¨å…¬å›­',
          description: 'ç°åœºéŸ³ä¹è¡¨æ¼”ã€æ²™æ»©æ´¾å¯¹ã€ç¾é£Ÿå¸‚é›†ã€äº’åŠ¨æ¸¸æˆç­‰æµ·æ»¨éŸ³ä¹ä½“éªŒã€‚'
        },
        {
          id: 5,
          title: 'è²èŠ±å±±å…¬å›­é£ç­èŠ‚',
          subtitle: 'æ”¾é£æ¢¦æƒ³ï¼Œäº«å—äº²å­æ—¶å…‰',
          price: 'å…è´¹',
          rating: 4.4,
          reviewCount: 567,
          category: 'äº²å­æ´»åŠ¨',
          tags: ['é£ç­èŠ‚', 'äº²å­æ´»åŠ¨', 'ä¼ ç»Ÿæ–‡åŒ–'],
          image: 'ğŸª',
          time: '2025å¹´10æœˆ28æ—¥',
          location: 'è²èŠ±å±±å…¬å›­',
          description: 'é£ç­åˆ¶ä½œã€æ¯”èµ›ã€å±•è§ˆã€äº²å­æ´»åŠ¨ç­‰ä¼ ç»Ÿæ–‡åŒ–ä½“éªŒã€‚'
        },
        {
          id: 6,
          title: 'æ·±åœ³æ¹¾å…¬å›­è§‚é¸ŸèŠ‚',
          subtitle: 'æ¢ç´¢é¸Ÿç±»ä¸–ç•Œï¼Œæ„Ÿå—ç”Ÿæ€ä¹‹ç¾',
          price: 'å…è´¹',
          rating: 4.6,
          reviewCount: 312,
          category: 'è‡ªç„¶æ¢ç´¢',
          tags: ['è§‚é¸Ÿ', 'ç”Ÿæ€ä¿æŠ¤', 'ç§‘æ™®æ•™è‚²'],
          image: 'ğŸ¦…',
          time: '2025å¹´10æœˆ5æ—¥',
          location: 'æ·±åœ³æ¹¾å…¬å›­è§‚é¸Ÿå°',
          description: 'ä¸“ä¸šè§‚é¸ŸæŒ‡å¯¼ã€é¸Ÿç±»æ‘„å½±ã€çŸ¥è¯†è®²åº§ã€ç”Ÿæ€ä¿æŠ¤æ•™è‚²ç­‰ã€‚'
        }
      ];
      this.filterActivities();
      this.isLoading = false;
    }, 500);
  }

  private filterActivities() {
    if (this.selectedCategory === 'çƒ­é—¨æ¨è') {
      // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºæ–°æ•°ç»„å¼•ç”¨ï¼Œè§¦å‘UIæ›´æ–°
      this.filteredActivities = [...this.activities];
    } else {
      const filtered = this.activities.filter(activity => 
        activity.category === this.selectedCategory
      );
      // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºæ–°æ•°ç»„å¼•ç”¨ï¼Œè§¦å‘UIæ›´æ–°
      this.filteredActivities = [...filtered];
    }
    console.log('[ActivityPageNew] filterActivities - è¿‡æ»¤åæ•°é‡:', this.filteredActivities.length);
  }

  private onCategoryChange(category: string) {
    this.selectedCategory = category;
    this.filterActivities();
  }

  private onActivityClick(activity: Activity) {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/activity/ActivityDetailPage',
        params: {
          activityId: activity.id,
          src: activity.id
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ´»åŠ¨è¯¦æƒ…é¡µé¢'));
  }

  private onBookingClick(activity: Activity) {
    const price = activity.price === 'å…è´¹' ? 0 : parseInt(activity.price.replace('Â¥', '')) || 0;
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/booking/UnifiedBookingPage',
        params: {
          id: activity.id.toString(),
          name: activity.title,
          price: price
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'è´­ç¥¨æŠ¥åé¡µé¢'));
  }

  private getActivityColor(category: string): string {
    switch (category) {
      case 'æ–‡åŒ–ä½“éªŒ': return '#ff6b6b';
      case 'å¨±ä¹ä¼‘é—²': return '#4ecdc4';
      case 'è‡ªç„¶æ¢ç´¢': return '#45b7d1';
      case 'äº²å­æ´»åŠ¨': return '#96ceb4';
      case 'è¿åŠ¨å¥èº«': return '#feca57';
      default: return '#74b9ff';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.HeaderSection()
      
      // åˆ†ç±»æ ‡ç­¾æ 
      this.CategoryTabs()
      
      // æ´»åŠ¨åˆ—è¡¨
      this.ActivityList()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder HeaderSection() {
    Row() {
      // è¿”å›æŒ‰é’®
      Text('â†')
        .fontSize(24)
        .fontColor('#1e40af')
        .fontWeight(FontWeight.Bold)
        .margin({ right: 12 })
        .onClick(() => {
          ErrorHandler.safeExecute(async (): Promise<void> => {
            await router.back();
          }, (error: Error): void => ErrorHandler.handleGenericError(error, 'è¿”å›ä¸Šé¡µ'));
        })
      
      Text('ç¤¾åŒºæ´»åŠ¨')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e40af')
      
      Blank()
      
      // æœç´¢æŒ‰é’®
      Button() {
        Text('ğŸ”')
          .fontSize(20)
          .fontColor('#64748b')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .borderRadius(20)
      .onClick(() => {
        // æœç´¢åŠŸèƒ½
      })
    }
    .width('100%')
    .height(60)
    .padding({ left: 20, right: 20, top: 10, bottom: 10 })
    .backgroundColor(Color.White)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder CategoryTabs() {
    Scroll() {
      Row() {
        ForEach(this.categories ?? [], (category: Category, index: number) => {
          Button() {
            Text(category.name)
              .fontSize(14)
              .fontWeight(this.selectedCategory === category.name ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.selectedCategory === category.name ? Color.White : '#64748b')
          }
          .width(80)
          .height(36)
          .backgroundColor(this.selectedCategory === category.name ? category.color : '#f1f5f9')
          .borderRadius(18)
          .margin({ right: 12 })
          .onClick(() => {
            this.onCategoryChange(category.name);
          })
        }, (category: Category, index: number) => `cat-${index}-${category.name}`)
      }
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
  }

  @Builder ActivityList() {
    if (this.isLoading) {
      this.LoadingView()
    } else {
      Scroll() {
        Column() {
          ForEach(this.filteredActivities ?? [], (activity: Activity, index: number) => {
            this.ActivityCard(activity, index)
          }, (activity: Activity, index: number) => `act-${activity.id}-${index}`)
        }
        .padding({ left: 20, right: 20, bottom: 20 })
      }
      .scrollBar(BarState.Auto)
    }
  }

  @Builder LoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#1e40af')
      
      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor('#64748b')
        .margin({ top: 16 })
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder ActivityCard(activity: Activity, index: number) {
    Column() {
      // æ´»åŠ¨å›¾ç‰‡
      Stack() {
        // èƒŒæ™¯è‰²å—
        Column() {
          Text(activity.image)
            .fontSize(80)
            .fontColor(Color.White)
        }
        .width('100%')
        .height(200)
        .backgroundColor(this.getActivityColor(activity.category))
        .borderRadius({ topLeft: 12, topRight: 12 })
        .justifyContent(FlexAlign.Center)
        
        // ä»·æ ¼æ ‡ç­¾
        Row() {
          Text(activity.price)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
          
          if (activity.originalPrice) {
            Text(activity.originalPrice)
              .fontSize(12)
              .fontColor(Color.White)
              .decoration({ type: TextDecorationType.LineThrough })
              .margin({ left: 8 })
          }
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor('rgba(0,0,0,0.6)')
        .borderRadius(20)
        .position({ x: 12, y: 12 })
        
        // è¯„åˆ†æ ‡ç­¾
        Row() {
          Text('â­')
            .fontSize(14)
            .fontColor('#ffd700')
          
          Text(activity.rating.toString())
            .fontSize(12)
            .fontColor('#1e40af')
            .margin({ left: 4 })
          
          Text(`(${activity.reviewCount})`)
            .fontSize(12)
            .fontColor('#64748b')
            .margin({ left: 4 })
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(Color.White)
        .borderRadius(12)
        .position({ x: 12, y: 50 })
      }
      .width('100%')
      .height(200)
      .borderRadius({ topLeft: 12, topRight: 12 })
      
      // æ´»åŠ¨ä¿¡æ¯
      Column() {
        // æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        Column() {
          Text(activity.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Text(activity.subtitle)
            .fontSize(14)
            .fontColor('#64748b')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        
        // æ´»åŠ¨æè¿°
        Text(activity.description)
          .fontSize(13)
          .fontColor('#475569')
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(18)
          .margin({ top: 8 })
          .width('100%')
        
        // æ ‡ç­¾
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(activity.tags ?? [], (tag: string, tagIndex: number) => {
            Text(tag)
              .fontSize(12)
              .fontColor('#1e40af')
              .backgroundColor('#dbeafe')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
              .margin({ right: 8, bottom: 8 })
          }, (tag: string, tagIndex: number) => `atag-${activity.id}-${tagIndex}-${tag}`)
        }
        .margin({ top: 12 })
        
        // æ—¶é—´å’Œåœ°ç‚¹
        Row() {
          Row() {
            Text('ğŸ•’')
              .fontSize(16)
              .fontColor('#64748b')
            
            Text(activity.time)
              .fontSize(12)
              .fontColor('#64748b')
              .margin({ left: 4 })
          }
          
          Blank()
          
          Row() {
            Text('ğŸ“')
              .fontSize(16)
              .fontColor('#64748b')
            
            Text(activity.location)
              .fontSize(12)
              .fontColor('#64748b')
              .margin({ left: 4 })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
          .layoutWeight(1)
          .justifyContent(FlexAlign.End)
        }
        .width('100%')
        .margin({ top: 12 })
        
        // ç«‹å³æŠ¥åæŒ‰é’®
        Button() {
          Text(activity.price === 'å…è´¹' ? 'å…è´¹å‚ä¸' : 'ç«‹å³è´­ç¥¨')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
        }
        .width('100%')
        .height(44)
        .backgroundColor('#1e40af')
        .borderRadius(22)
        .margin({ top: 16 })
        .onClick(() => {
          this.onBookingClick(activity);
        })
      }
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius({ bottomLeft: 12, bottomRight: 12 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 20 })
    .onClick(() => {
      this.onActivityClick(activity);
    })
  }
}