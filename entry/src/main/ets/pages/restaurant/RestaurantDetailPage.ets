import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ResourceManager } from '../../utils/ResourceManager';
import { ImageConstants } from '../../constants/ImageConstants';

interface RestaurantData {
  id: string;
  name: string;
  category: string;
  rating: number;
  reviewCount: number;
  priceRange: string;
  address: string;
  openHours: string;
  phone: string;
  description: string;
  specialties: string[];
  tags: string[];
  images: string[];
  facilities: string[];
}

@Entry
@Component
export struct RestaurantDetailPage {
  @State restaurantId: string = '';
  @State restaurantData: RestaurantData | null = null;
  @State isFavorite: boolean = false;
  @State restaurantImage: Resource = $r('app.media.placeholder');
  
  private resourceManager = ResourceManager.getInstance();

  async aboutToAppear() {
    const params = router.getParams() as Record<string, string>;
    if (params && params.id) {
      this.restaurantId = params.id;
      await this.loadRestaurantData();
    } else {
      // Âä†ËΩΩÈªòËÆ§Á§∫‰æãÊï∞ÊçÆ
      this.loadDefaultData();
    }
  }

  /**
   * ‰ªéJSONÊñá‰ª∂Âä†ËΩΩÈ§êÂéÖÊï∞ÊçÆ
   */
  private async loadRestaurantData() {
    try {
      // TODO: ÂÆûÈôÖÂ∫î‰ªérawfile/data/restaurants.jsonÂä†ËΩΩ
      // const data = await loadJsonData('restaurants.json');
      // this.restaurantData = data.find(r => r.id === this.restaurantId);
      
      // ‰∏¥Êó∂‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
      this.loadDefaultData();
    } catch (error) {
      console.error('Âä†ËΩΩÈ§êÂéÖÊï∞ÊçÆÂ§±Ë¥•:', error);
      this.loadDefaultData();
    }
  }

  /**
   * Âä†ËΩΩÈªòËÆ§Á§∫‰æãÊï∞ÊçÆ
   */
  private loadDefaultData() {
    this.restaurantData = {
      id: 'restaurant_001',
      name: 'Ê∑±Âú≥ÊπæÊµ∑È≤úÂ§ßÊéíÊ°£',
      category: 'seafood',
      rating: 4.8,
      reviewCount: 856,
      priceRange: '¬•120/‰∫∫',
      address: 'ÂçóÂ±±Âå∫Ê∑±Âú≥Êπæ',
      openHours: '10:00-22:00',
      phone: '0755-12345678',
      description: 'Êñ∞È≤úÊµ∑È≤úÔºåÁé∞ÁÇπÁé∞ÂÅöÔºåÁéØÂ¢É‰ºòÈõÖÔºåÈÄÇÂêàËÅöÈ§ê',
      specialties: ['Ê∏ÖËí∏Áü≥ÊñëÈ±º', 'Ê§íÁõêÊøëÂ∞øËôæ', 'ÂßúËë±ÁÇíËüπ'],
      tags: ['Êµ∑È≤ú', 'Á≤§Ëèú', 'ËÅöÈ§ê'],
      images: ['seafood_restaurant_01.jpg'],
      facilities: ['ÂÅúËΩ¶Âú∫', 'ÂåÖÂé¢', 'WiFi', 'ÂÑøÁ´•Â∫ßÊ§Ö']
    };

    // ‰ΩøÁî®ResourceManagerËé∑ÂèñÂõæÁâá
    this.restaurantImage = this.resourceManager.getRestaurantImage('seafood');
  }

  build() {
    Column() {
      TopNavigationBar({ title: 'È§êÂéÖËØ¶ÊÉÖ', showBack: true })

      Scroll() {
        Column() {
          // È§êÂéÖÂõæÁâá
          if (this.restaurantData) {
            Image(this.restaurantImage)
              .width('100%')
              .height(250)
              .objectFit(ImageFit.Cover)
              .borderRadius({ bottomLeft: 16, bottomRight: 16 })
              .margin({ bottom: 20 })
          }
          
          if (this.restaurantData) {
            Text(this.restaurantData.name)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 16 })

            // Ê†áÁ≠æÂ±ïÁ§∫
            Flex({ wrap: FlexWrap.Wrap }) {
              ForEach(this.restaurantData?.tags ?? [], (item: string) => {
                Text(item)
                  .fontSize(14)
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .backgroundColor('#eff6ff')
                  .fontColor('#3b82f6')
                  .borderRadius(16)
                  .margin({ right: 8, bottom: 8 })
              }, (item: string) => item)
            }.margin({ bottom: 16 })

            Row({ space: 8 }) {
              Text(`‚≠ê ${this.restaurantData.rating}`)
              Text(`(${this.restaurantData.reviewCount}Êù°ËØÑ‰ª∑)`)
                .fontSize(14)
                .fontColor('#6b7280')
            }
            .margin({ bottom: 16 })

            Column() {
              Row() {
                Text('üìç ‰ΩçÁΩÆÔºö').fontColor('#6b7280')
                Text(this.restaurantData.address)
              }.width('100%').margin({ bottom: 8 })

              Row() {
                Text('üí∞ ‰∫∫ÂùáÔºö').fontColor('#6b7280')
                Text(this.restaurantData.priceRange).fontColor('#ef4444')
              }.width('100%').margin({ bottom: 8 })

              Row() {
                Text('‚è∞ Ëê•‰∏öÊó∂Èó¥Ôºö').fontColor('#6b7280')
                Text(this.restaurantData.openHours)
              }.width('100%').margin({ bottom: 8 })

              Row() {
                Text('üìû ÁîµËØùÔºö').fontColor('#6b7280')
                Text(this.restaurantData.phone)
              }.width('100%')
            }
            .width('90%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })

            Column() {
              Text('È§êÂéÖ‰ªãÁªç')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 12 })

              Text(this.restaurantData.description)
                .fontSize(14)
                .fontColor('#4b5563')
                .lineHeight(22)
            }
            .width('90%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })

            // ÁâπËâ≤ËèúÂìÅ
            Column() {
              Text('ÊãõÁâåÁâπËâ≤')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 12 })

              Column({ space: 8 }) {
                ForEach(this.restaurantData?.specialties ?? [], (item: string, index: number) => {
                  Row() {
                    Text(`${index + 1}.`).fontColor('#6b7280').margin({ right: 8 })
                    Text(item).fontSize(15)
                  }.width('100%')
                }, (item: string) => item)
              }
            }
            .width('90%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })

            // ËÆæÊñΩÊ†áÁ≠æ
            Column() {
              Text('È§êÂéÖËÆæÊñΩ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 12 })

              Flex({ wrap: FlexWrap.Wrap }) {
                ForEach(this.restaurantData?.facilities ?? [], (item: string) => {
                  Text(item)
                    .fontSize(14)
                    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                    .backgroundColor('#f3f4f6')
                    .borderRadius(16)
                    .margin({ right: 8, bottom: 8 })
                }, (item: string) => item)
              }
            }
            .width('90%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })
          }
        }
        .padding({ bottom: 80 })
      }
      .width('100%')
      .layoutWeight(1)

      // Â∫ïÈÉ®Êìç‰ΩúÊ†è
      Row() {
        Button('Êî∂Ëóè')
          .width('45%')
          .height(44)
          .backgroundColor(this.isFavorite ? '#fbbf24' : Color.White)
          .fontColor(this.isFavorite ? Color.White : '#6b7280')
          .border({ width: 1, color: '#e5e7eb' })
          .onClick(() => {
            this.isFavorite = !this.isFavorite;
          })

        Button('Á´ãÂç≥È¢ÑËÆ¢')
          .width('45%')
          .height(44)
          .backgroundColor('#0A59F7')
          .fontColor(Color.White)
          .onClick(() => {
            // TODO: Ë∑≥ËΩ¨Âà∞È¢ÑËÆ¢È°µÈù¢
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .justifyContent(FlexAlign.SpaceBetween)
      .shadow({
        radius: 8,
        color: 'rgba(0,0,0,0.1)',
        offsetY: -2
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }
}
