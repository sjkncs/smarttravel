import { Prompt } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface ScanOption {
  icon: string;
  name: string;
  description: string;
  color: string;
}

interface ScanHistoryItem {
  content: string;
  type: string;
  time: string;
}

@Entry
@Component
export struct ScanPage {
  @State isScanning: boolean = false;
  @State scanResult: string = '';
  @State flashOn: boolean = false;

  private scanOptions: ScanOption[] = [
    { icon: 'ğŸ“±', name: 'æ‰«ä¸€æ‰«', description: 'æ‰«æäºŒç»´ç ã€æ¡å½¢ç ', color: '#3b82f6' },
    { icon: 'ğŸ·ï¸', name: 'å•†å“ç ', description: 'æ‰«æå•†å“æ¡ç ', color: '#10b981' },
    { icon: 'ğŸ“„', name: 'æ–‡æ¡£æ‰«æ', description: 'æ‰«ææ–‡æ¡£ã€åç‰‡', color: '#f59e0b' },
    { icon: 'ğŸŒ', name: 'ç½‘é¡µé“¾æ¥', description: 'æ‰«æç½‘é¡µäºŒç»´ç ', color: '#8b5cf6' },
    { icon: 'ğŸ’°', name: 'æ”¯ä»˜ç ', description: 'æ‰«ææ”¯ä»˜äºŒç»´ç ', color: '#ef4444' },
    { icon: 'ğŸš—', name: 'è½¦ç‰Œè¯†åˆ«', description: 'è¯†åˆ«è½¦ç‰Œå·ç ', color: '#06b6d4' }
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æ‰«ä¸€æ‰«',
        showBack: true,
        showSearch: false,
        showNotification: false
      })
      
      Column() {
        // æ‰«æåŒºåŸŸ
        this.ScanArea()
        
        // æ‰«æé€‰é¡¹
        this.ScanOptions()
        
        // å†å²è®°å½•
        this.ScanHistory()
      }
      .layoutWeight(1)
      .backgroundColor('#f8fafc')
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder ScanArea() {
    Column() {
      // æ‰«ææ¡†
      Stack() {
        // èƒŒæ™¯
        Column()
          .width('100%')
          .height(300)
          .backgroundColor(Color.Black)
        
        // æ‰«ææ¡†
        Column()
          .width(250)
          .height(250)
          .border({
            width: 2,
            color: this.isScanning ? '#3b82f6' : '#ffffff',
            style: BorderStyle.Solid
          })
          .borderRadius(12)
          .backgroundColor('transparent')
        
        // å››ä¸ªè§’çš„è£…é¥°
        this.ScanCorner(0, 0) // å·¦ä¸Š
        this.ScanCorner(250, 0) // å³ä¸Š
        this.ScanCorner(0, 250) // å·¦ä¸‹
        this.ScanCorner(250, 250) // å³ä¸‹
        
        // æ‰«æçº¿åŠ¨ç”»
        if (this.isScanning) {
          Column()
            .width(250)
            .height(2)
            .backgroundColor(Color.Blue)
            .animation({
              duration: 2000,
              curve: Curve.Linear,
              iterations: -1,
              playMode: PlayMode.Normal
            })
            .translate({ y: -125 })
        }
      }
      .width('100%')
      .height(300)
      .alignContent(Alignment.Center)
      .margin({ bottom: 20 })

      // æ‰«ææç¤º
      Text('å°†äºŒç»´ç /æ¡å½¢ç æ”¾å…¥æ¡†å†…ï¼Œå³å¯è‡ªåŠ¨æ‰«æ')
        .fontSize(14)
        .fontColor('#6b7280')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })

      // æ§åˆ¶æŒ‰é’®
      Row({ space: 20 }) {
        // ç›¸å†ŒæŒ‰é’®
        Column() {
          Text('ğŸ“·')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text('ç›¸å†Œ')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .onClick(() => {
          Prompt.showToast({ message: 'é€‰æ‹©ç›¸å†Œå›¾ç‰‡' })
        })

        // æ‰«ææŒ‰é’®
        Button(this.isScanning ? 'åœæ­¢æ‰«æ' : 'å¼€å§‹æ‰«æ')
          .fontSize(16)
          .fontColor('#ffffff')
          .backgroundColor('#3b82f6')
          .borderRadius(25)
          .padding({ left: 30, right: 30, top: 12, bottom: 12 })
          .onClick(() => {
            this.toggleScanning()
          })

        // é—ªå…‰ç¯æŒ‰é’®
        Column() {
          Text(this.flashOn ? 'ğŸ’¡' : 'ğŸ”¦')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text('é—ªå…‰ç¯')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .onClick(() => {
          this.toggleFlash()
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 40, right: 40 })
      .margin({ bottom: 30 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .padding(20)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ScanCorner(x: number, y: number) {
    Column() {
      Row() {
        Column()
          .width(20)
          .height(3)
          .backgroundColor('#3b82f6')
        
        Column()
          .width(3)
          .height(20)
          .backgroundColor('#3b82f6')
      }
    }
    .position({ x: x, y: y })
  }

  @Builder ScanOptions() {
    Column() {
      Text('æ‰«æåŠŸèƒ½')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      GridRow({
        columns: 3,
        gutter: { x: 12, y: 12 }
      }) {
        ForEach(this.scanOptions, (option: ScanOption) => {
          GridCol({ span: 1 }) {
            this.ScanOptionItem(option)
          }
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin({ left: 16, right: 16, bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ScanOptionItem(option: ScanOption) {
    Column() {
      Text(option.icon)
        .fontSize(24)
        .margin({ bottom: 8 })
      
      Text(option.name)
        .fontSize(12)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 4 })
      
      Text(option.description)
        .fontSize(10)
        .fontColor('#6b7280')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(80)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      Prompt.showToast({ message: `é€‰æ‹©åŠŸèƒ½ï¼š${option.name}` })
    })
  }

  @Builder ScanHistory() {
    Column() {
      Row() {
        Text('æ‰«æå†å²')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
        
        Text('æ¸…ç©ºå†å² >')
          .fontSize(12)
          .fontColor('#6b7280')
          .onClick(() => {
            Prompt.showToast({ message: 'æ¸…ç©ºæ‰«æå†å²' })
          })
      }
      .width('100%')
      .margin({ bottom: 16 })

      // å†å²è®°å½•åˆ—è¡¨
      Column({ space: 8 }) {
        this.HistoryItem('https://www.smarttravel.com', 'ç½‘é¡µé“¾æ¥', '2åˆ†é’Ÿå‰')
        this.HistoryItem('å•†å“ç ï¼š1234567890', 'å•†å“ä¿¡æ¯', '1å°æ—¶å‰')
        this.HistoryItem('å¾®ä¿¡æ”¯ä»˜ç ', 'æ”¯ä»˜äºŒç»´ç ', 'æ˜¨å¤©')
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .margin({ left: 16, right: 16 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder HistoryItem(content: string, type: string, time: string) {
    Row() {
      Text('ğŸ“±')
        .fontSize(20)
        .margin({ right: 12 })
      
      Column() {
        Text(content)
          .fontSize(14)
          .fontColor('#1f2937')
          .margin({ bottom: 2 })
        
        Text(`${type} Â· ${time}`)
          .fontSize(12)
          .fontColor('#6b7280')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
      Text('>')
        .fontSize(16)
        .fontColor('#d1d5db')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#f8fafc')
    .borderRadius(8)
    .onClick(() => {
      Prompt.showToast({ message: `æŸ¥çœ‹ï¼š${content}` })
    })
  }

  private toggleScanning() {
    this.isScanning = !this.isScanning
    
    if (this.isScanning) {
      Prompt.showToast({ message: 'å¼€å§‹æ‰«æ...' })
      // æ¨¡æ‹Ÿæ‰«æç»“æœ
      setTimeout(() => {
        this.scanResult = 'https://www.smarttravel.com'
        Prompt.showToast({ message: 'æ‰«ææˆåŠŸï¼' })
        this.isScanning = false
        // å¤„ç†æ‰«æç»“æœ
        this.handleScanResult(this.scanResult)
      }, 3000)
    } else {
      Prompt.showToast({ message: 'åœæ­¢æ‰«æ' })
    }
  }

  // å¤„ç†æ‰«æç»“æœ
  private handleScanResult(result: string) {
    // åˆ¤æ–­æ‰«æç»“æœç±»å‹å¹¶è¿›è¡Œç›¸åº”å¤„ç†
    if (result.startsWith('http')) {
      // ç½‘é¡µé“¾æ¥
      Prompt.showToast({ message: 'æ£€æµ‹åˆ°ç½‘é¡µé“¾æ¥ï¼Œæ­£åœ¨æ‰“å¼€...' })
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ‰“å¼€ç½‘é¡µçš„é€»è¾‘
    } else if (result.includes('æ”¯ä»˜')) {
      // æ”¯ä»˜äºŒç»´ç 
      Prompt.showToast({ message: 'æ£€æµ‹åˆ°æ”¯ä»˜ç ' })
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ”¯ä»˜å¤„ç†é€»è¾‘
    } else {
      // å…¶ä»–ç±»å‹
      Prompt.showToast({ message: `æ‰«æç»“æœ: ${result}` })
    }
    
    // æ·»åŠ åˆ°å†å²è®°å½•
    this.addToHistory(result)
  }

  // æ·»åŠ åˆ°æ‰«æå†å²
  private addToHistory(result: string) {
    const historyItem: ScanHistoryItem = {
      content: result,
      type: this.getResultType(result),
      time: this.formatTime(new Date())
    }
    // è¿™é‡Œå¯ä»¥ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    console.log('æ·»åŠ æ‰«æå†å²:', historyItem)
  }

  // è·å–ç»“æœç±»å‹
  private getResultType(result: string): string {
    if (result.startsWith('http')) return 'ç½‘é¡µé“¾æ¥'
    if (result.includes('æ”¯ä»˜')) return 'æ”¯ä»˜äºŒç»´ç '
    if (/^\d+$/.test(result)) return 'å•†å“ç '
    return 'æ–‡æœ¬ä¿¡æ¯'
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(date: Date): string {
    const now = new Date()
    const diff = now.getTime() - date.getTime()
    
    if (diff < 60000) return 'åˆšåˆš'
    if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`
    return 'æ˜¨å¤©'
  }

  private toggleFlash() {
    this.flashOn = !this.flashOn
    Prompt.showToast({ message: this.flashOn ? 'é—ªå…‰ç¯å·²å¼€å¯' : 'é—ªå…‰ç¯å·²å…³é—­' })
  }
}
