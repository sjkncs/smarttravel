import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface GuideItem {
  id: string;
  title: string;
  description: string;
  coverImage: string;
  author: string;
  createTime: string;
  updateTime: string;
  views: number;
  likes: number;
  comments: number;
  tags: string[];
  status: 'draft' | 'published' | 'archived';
  content: string;
  locations: string[];
  duration: string;
  difficulty: 'easy' | 'medium' | 'hard';
}

@Entry
@Component
export struct MyGuidesPage {
  @State guideList: GuideItem[] = [
    {
      id: '1',
      title: 'æ·±åœ³ä¸€æ—¥æ¸¸å®Œç¾Žæ”»ç•¥',
      description: 'ä»Žæ—©åˆ°æ™šï¼Œå¸¦ä½ çŽ©è½¬æ·±åœ³æœ€ç²¾åŽçš„æ™¯ç‚¹ï¼Œä½“éªŒè¿™åº§çŽ°ä»£åŒ–éƒ½å¸‚çš„é­…åŠ›ã€‚',
      coverImage: 'https://picsum.photos/300/200?random=1',
      author: 'syt',
      createTime: '2024-06-01',
      updateTime: '2024-06-05',
      views: 1250,
      likes: 89,
      comments: 23,
      tags: ['ä¸€æ—¥æ¸¸', 'æ·±åœ³', 'ç²¾åŽè·¯çº¿'],
      status: 'published',
      content: 'è¯¦ç»†æ”»ç•¥å†…å®¹...',
      locations: ['æ·±åœ³æ¹¾å…¬å›­', 'èŽ²èŠ±å±±å…¬å›­', 'ä¸œé—¨è€è¡—'],
      duration: '1å¤©',
      difficulty: 'easy'
    },
    {
      id: '2',
      title: 'æ·±åœ³ç¾Žé£ŸæŽ¢åº—æŒ‡å—',
      description: 'ç²¾é€‰æ·±åœ³æœ€åœ°é“çš„é¤åŽ…å’Œå°åƒï¼Œä»Žç²¤èœåˆ°å·èœï¼Œæ»¡è¶³ä½ çš„å‘³è•¾ã€‚',
      coverImage: 'https://picsum.photos/300/200?random=2',
      author: 'syt',
      createTime: '2024-06-02',
      updateTime: '2024-06-06',
      views: 980,
      likes: 67,
      comments: 18,
      tags: ['ç¾Žé£Ÿ', 'æŽ¢åº—', 'ç²¤èœ'],
      status: 'published',
      content: 'ç¾Žé£Ÿæ”»ç•¥å†…å®¹...',
      locations: ['è°­å¸ˆå‚…ç§æˆ¿èœ', 'ä¸€æ—¬ä¸€å‘³', 'ä¸œé—¨å°åƒè¡—'],
      duration: 'åŠå¤©',
      difficulty: 'easy'
    },
    {
      id: '3',
      title: 'æ·±åœ³å¤œæ™¯æ‹æ‘„æ”»ç•¥',
      description: 'ä¸“ä¸šæ‘„å½±å¸ˆæ•™ä½ å¦‚ä½•æ‹æ‘„æ·±åœ³æœ€ç¾Žçš„å¤œæ™¯ï¼ŒåŒ…å«æœ€ä½³æ‹æ‘„ç‚¹å’ŒæŠ€å·§ã€‚',
      coverImage: 'https://picsum.photos/300/200?random=3',
      author: 'syt',
      createTime: '2024-06-03',
      updateTime: '2024-06-07',
      views: 756,
      likes: 45,
      comments: 12,
      tags: ['æ‘„å½±', 'å¤œæ™¯', 'æŠ€å·§'],
      status: 'published',
      content: 'æ‘„å½±æ”»ç•¥å†…å®¹...',
      locations: ['æ·±åœ³æ¹¾', 'èŽ²èŠ±å±±', 'å¹³å®‰é‡‘èžä¸­å¿ƒ'],
      duration: '2-3å°æ—¶',
      difficulty: 'medium'
    },
    {
      id: '4',
      title: 'æ·±åœ³æˆ·å¤–å¾’æ­¥è·¯çº¿',
      description: 'æŽ¢ç´¢æ·±åœ³å‘¨è¾¹çš„è‡ªç„¶é£Žå…‰ï¼ŒæŽ¨èå‡ æ¡é€‚åˆä¸åŒéš¾åº¦çº§åˆ«çš„å¾’æ­¥è·¯çº¿ã€‚',
      coverImage: 'https://picsum.photos/300/200?random=4',
      author: 'syt',
      createTime: '2024-06-04',
      updateTime: '2024-06-08',
      views: 634,
      likes: 38,
      comments: 8,
      tags: ['å¾’æ­¥', 'æˆ·å¤–', 'è‡ªç„¶'],
      status: 'draft',
      content: 'å¾’æ­¥æ”»ç•¥å†…å®¹...',
      locations: ['æ¢§æ¡å±±', 'ä¸ƒå¨˜å±±', 'é©¬å³¦å±±'],
      duration: '1-2å¤©',
      difficulty: 'hard'
    },
    {
      id: '5',
      title: 'æ·±åœ³è´­ç‰©æ”»ç•¥',
      description: 'ä»Žå¥¢ä¾ˆå“åˆ°å¹³ä»·å•†å“ï¼Œä»Žå•†åœºåˆ°å¤œå¸‚ï¼Œå…¨é¢è¦†ç›–æ·±åœ³è´­ç‰©æŒ‡å—ã€‚',
      coverImage: 'https://picsum.photos/300/200?random=5',
      author: 'syt',
      createTime: '2024-06-05',
      updateTime: '2024-06-09',
      views: 892,
      likes: 52,
      comments: 15,
      tags: ['è´­ç‰©', 'å•†åœº', 'å¤œå¸‚'],
      status: 'published',
      content: 'è´­ç‰©æ”»ç•¥å†…å®¹...',
      locations: ['åŽå¼ºåŒ—', 'ä¸œé—¨', 'æµ·å²¸åŸŽ'],
      duration: '1å¤©',
      difficulty: 'easy'
    }
  ];

  @State selectedTab: number = 0;
  private tabs: string[] = ['å…¨éƒ¨', 'å·²å‘å¸ƒ', 'è‰ç¨¿', 'å·²å½’æ¡£'];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æˆ‘çš„æ”»ç•¥',
        showBack: true,
        showSearch: true,
        showNotification: false
      })

      // ç»Ÿè®¡ä¿¡æ¯
      this.StatisticsCard()

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text('5')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
          Text('æ”»ç•¥æ€»æ•°')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('4')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#10b981')
          Text('å·²å‘å¸ƒ')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('1')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#f59e0b')
          Text('è‰ç¨¿')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('4512')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#3b82f6')
          Text('æ€»é˜…è¯»')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs, (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        ForEach(this.getFilteredGuides(), (guide: GuideItem) => {
          this.GuideCard(guide)
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder GuideCard(guide: GuideItem) {
    Column() {
      Row() {
        // å°é¢å›¾ç‰‡
        Image(guide.coverImage)
          .width(100)
          .height(80)
          .objectFit(ImageFit.Cover)
          .borderRadius(8)
          .margin({ right: 12 })

        // å†…å®¹ä¿¡æ¯
        Column() {
          // æ ‡é¢˜å’ŒçŠ¶æ€æ ‡ç­¾
          Row() {
            Text(guide.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text(this.getStatusText(guide.status))
              .fontSize(10)
              .fontColor(this.getStatusColor(guide.status))
              .backgroundColor(this.getStatusBgColor(guide.status))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
          }
          .width('100%')
          .margin({ bottom: 4 })

          // æè¿°
          Text(guide.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          // éš¾åº¦å’Œæ—¶é•¿
          Row() {
            Text('â±ï¸')
              .fontSize(12)
              .margin({ right: 4 })
            Text(guide.duration)
              .fontSize(12)
              .fontColor('#6b7280')

            Text('ðŸ“Š')
              .fontSize(12)
              .margin({ left: 12, right: 4 })
            Text(this.getDifficultyText(guide.difficulty))
              .fontSize(12)
              .fontColor('#6b7280')
          }
          .width('100%')
          .margin({ bottom: 8 })

          // ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Text('ðŸ‘ï¸')
              .fontSize(12)
              .margin({ right: 2 })
            Text(guide.views.toString())
              .fontSize(12)
              .fontColor('#6b7280')

            Text('â¤ï¸')
              .fontSize(12)
              .margin({ left: 12, right: 2 })
            Text(guide.likes.toString())
              .fontSize(12)
              .fontColor('#6b7280')

            Text('ðŸ’¬')
              .fontSize(12)
              .margin({ left: 12, right: 2 })
            Text(guide.comments.toString())
              .fontSize(12)
              .fontColor('#6b7280')

            Blank()

            Text(`æ›´æ–°äºŽ ${guide.updateTime}`)
              .fontSize(10)
              .fontColor('#9ca3af')
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(guide.tags, (tag: string) => {
          Text(`#${tag}`)
            .fontSize(10)
            .fontColor('#3b82f6')
            .backgroundColor('#dbeafe')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ right: 6, bottom: 4 })
        })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('æŸ¥çœ‹æ”»ç•¥')
          .fontSize(12)
          .fontColor('#3b82f6')
          .backgroundColor('#dbeafe')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.viewGuide(guide.id);
          })

        if (guide.status === 'draft') {
          Button('ç»§ç»­ç¼–è¾‘')
            .fontSize(12)
            .fontColor('#f59e0b')
            .backgroundColor('#fef3c7')
            .borderRadius(8)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .margin({ left: 8 })
            .onClick(() => {
              this.editGuide(guide.id);
            })
        }

        Blank()

        Button('åˆ†äº«')
          .fontSize(12)
          .fontColor('#10b981')
          .backgroundColor('#d1fae5')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.shareGuide(guide.id);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  private getFilteredGuides(): GuideItem[] {
    switch (this.selectedTab) {
      case 1: // å·²å‘å¸ƒ
        return this.guideList.filter(guide => guide.status === 'published');
      case 2: // è‰ç¨¿
        return this.guideList.filter(guide => guide.status === 'draft');
      case 3: // å·²å½’æ¡£
        return this.guideList.filter(guide => guide.status === 'archived');
      default: // å…¨éƒ¨
        return this.guideList;
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'published': return 'å·²å‘å¸ƒ';
      case 'draft': return 'è‰ç¨¿';
      case 'archived': return 'å·²å½’æ¡£';
      default: return 'æœªçŸ¥';
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'published': return '#10b981';
      case 'draft': return '#f59e0b';
      case 'archived': return '#6b7280';
      default: return '#6b7280';
    }
  }

  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'published': return '#d1fae5';
      case 'draft': return '#fef3c7';
      case 'archived': return '#f3f4f6';
      default: return '#f3f4f6';
    }
  }

  private getDifficultyText(difficulty: string): string {
    switch (difficulty) {
      case 'easy': return 'ç®€å•';
      case 'medium': return 'ä¸­ç­‰';
      case 'hard': return 'å›°éš¾';
      default: return 'æœªçŸ¥';
    }
  }

  private viewGuide(id: string): void {
    router.pushUrl({ 
      url: 'pages/guide/GuideDetailPage',
      params: { id: id }
    }).catch((error: Error) => {
      console.error('è·³è½¬æ”»ç•¥è¯¦æƒ…é¡µå¤±è´¥:', error.message);
    });
  }

  private editGuide(id: string): void {
    router.pushUrl({ 
      url: 'pages/guide/GuideEditPage',
      params: { id: id }
    }).catch((error: Error) => {
      console.error('è·³è½¬æ”»ç•¥ç¼–è¾‘é¡µå¤±è´¥:', error.message);
    });
  }

  private shareGuide(id: string): void {
    // åˆ†äº«åŠŸèƒ½å®žçŽ°
    console.log(`åˆ†äº«æ”»ç•¥: ${id}`);
  }
}
