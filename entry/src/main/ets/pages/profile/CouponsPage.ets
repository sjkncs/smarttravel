import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface CouponItem {
  id: string;
  title: string;
  description: string;
  discountType: 'percentage' | 'amount' | 'free';
  discountValue: number;
  minAmount?: number;
  maxDiscount?: number;
  validFrom: string;
  validTo: string;
  status: 'available' | 'used' | 'expired';
  applicableActivities: string[];
  conditions: string[];
  imageUrl: string;
}

@Entry
@Component
export struct CouponsPage {
  @State couponList: CouponItem[] = [
    {
      id: '1',
      title: 'æ–°ç”¨æˆ·ä¸“äº«åˆ¸',
      description: 'é¦–æ¬¡æ³¨å†Œç”¨æˆ·ä¸“äº«ï¼Œå…¨åœºæ´»åŠ¨é€šç”¨',
      discountType: 'percentage',
      discountValue: 20,
      minAmount: 100,
      maxDiscount: 50,
      validFrom: '2024-06-01',
      validTo: '2024-06-30',
      status: 'available',
      applicableActivities: ['å…¨éƒ¨æ´»åŠ¨'],
      conditions: ['æ–°ç”¨æˆ·ä¸“äº«', 'æ»¡100å…ƒå¯ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=1'
    },
    {
      id: '2',
      title: 'ç«¯åˆæ´»åŠ¨åˆ¸',
      description: 'ç«¯åˆæ°‘ä¿—å˜‰å¹´åŽä¸“ç”¨ä¼˜æƒ åˆ¸',
      discountType: 'amount',
      discountValue: 30,
      minAmount: 200,
      validFrom: '2024-06-08',
      validTo: '2024-06-12',
      status: 'available',
      applicableActivities: ['ç«¯åˆæ°‘ä¿—å˜‰å¹´åŽ'],
      conditions: ['é™ç«¯åˆæ´»åŠ¨ä½¿ç”¨', 'æ»¡200å…ƒå¯ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=2'
    },
    {
      id: '3',
      title: 'ç¾Žé£ŸæŽ¢åº—åˆ¸',
      description: 'è°­å¸ˆå‚…ç§æˆ¿èœä¸“ç”¨ä¼˜æƒ åˆ¸',
      discountType: 'percentage',
      discountValue: 15,
      minAmount: 150,
      maxDiscount: 30,
      validFrom: '2024-06-01',
      validTo: '2024-06-20',
      status: 'used',
      applicableActivities: ['è°­å¸ˆå‚…ç§æˆ¿èœ'],
      conditions: ['é™æŒ‡å®šé¤åŽ…ä½¿ç”¨', 'æ»¡150å…ƒå¯ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=3'
    },
    {
      id: '4',
      title: 'å…è´¹ä½“éªŒåˆ¸',
      description: 'ä¸œæ¹–å…¬å›­è·èŠ±èŠ‚å…è´¹é—¨ç¥¨',
      discountType: 'free',
      discountValue: 0,
      validFrom: '2024-06-15',
      validTo: '2024-06-25',
      status: 'available',
      applicableActivities: ['ä¸œæ¹–å…¬å›­è·èŠ±èŠ‚'],
      conditions: ['å…è´¹ä½“éªŒ', 'é™1äººä½¿ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=4'
    },
    {
      id: '5',
      title: 'ä¼šå‘˜ä¸“äº«åˆ¸',
      description: 'ç™½é“¶ä¼šå‘˜ä¸“äº«ï¼Œå…¨åœºé€šç”¨',
      discountType: 'amount',
      discountValue: 50,
      minAmount: 300,
      validFrom: '2024-05-01',
      validTo: '2024-05-31',
      status: 'expired',
      applicableActivities: ['å…¨éƒ¨æ´»åŠ¨'],
      conditions: ['ä¼šå‘˜ä¸“äº«', 'æ»¡300å…ƒå¯ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=5'
    },
    {
      id: '6',
      title: 'å¤œæ¸¸ç¯ä¼šåˆ¸',
      description: 'æ·±åœ³æ¹¾å…¬å›­å¤œæ¸¸ç¯ä¼šä¸“ç”¨',
      discountType: 'percentage',
      discountValue: 25,
      minAmount: 80,
      maxDiscount: 20,
      validFrom: '2024-06-10',
      validTo: '2024-06-20',
      status: 'available',
      applicableActivities: ['å¤œæ¸¸ç¯ä¼šå¤§èµ'],
      conditions: ['é™å¤œæ¸¸æ´»åŠ¨ä½¿ç”¨', 'æ»¡80å…ƒå¯ç”¨'],
      imageUrl: 'https://picsum.photos/300/150?random=6'
    }
  ];

  @State selectedTab: number = 0;
  private tabs: string[] = ['å…¨éƒ¨', 'å¯ç”¨', 'å·²ä½¿ç”¨', 'å·²è¿‡æœŸ'];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'ä¼˜æƒ åˆ¸',
        showBack: true,
        showSearch: false,
        showNotification: false
      })

      // ç»Ÿè®¡ä¿¡æ¯
      this.StatisticsCard()

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text('6')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
          Text('ä¼˜æƒ åˆ¸æ€»æ•°')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('4')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#10b981')
          Text('å¯ç”¨')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('1')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#6b7280')
          Text('å·²ä½¿ç”¨')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('1')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ef4444')
          Text('å·²è¿‡æœŸ')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs ?? [], (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      }, (tab: string, index: number) => `tab-${index}-${tab}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        ForEach(this.getFilteredCoupons() ?? [], (coupon: CouponItem, index: number) => {
          this.CouponCard(coupon)
        }, (coupon: CouponItem, index: number) => `coupon-${coupon.id}-${index}`)
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder CouponCard(coupon: CouponItem) {
    Column() {
      // ä¼˜æƒ åˆ¸ä¸»ä½“
      Row() {
        // å·¦ä¾§æŠ˜æ‰£ä¿¡æ¯
        Column() {
          if (coupon.discountType === 'percentage') {
            Text(`${coupon.discountValue}%`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getStatusColor(coupon.status))
          } else if (coupon.discountType === 'amount') {
            Text(`Â¥${coupon.discountValue}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getStatusColor(coupon.status))
          } else {
            Text('å…è´¹')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getStatusColor(coupon.status))
          }

          if (coupon.minAmount) {
            Text(`æ»¡Â¥${coupon.minAmount}å¯ç”¨`)
              .fontSize(10)
              .fontColor('#6b7280')
              .margin({ top: 4 })
          }
        }
        .width(80)
        .height(100)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getStatusBgColor(coupon.status))
        .borderRadius({ topLeft: 12, bottomLeft: 12 })

        // å³ä¾§è¯¦ç»†ä¿¡æ¯
        Column() {
          // æ ‡é¢˜å’ŒçŠ¶æ€
          Row() {
            Text(coupon.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text(this.getStatusText(coupon.status))
              .fontSize(10)
              .fontColor(this.getStatusColor(coupon.status))
              .backgroundColor(this.getStatusBgColor(coupon.status))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
          }
          .width('100%')
          .margin({ bottom: 4 })

          // æè¿°
          Text(coupon.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          // æœ‰æ•ˆæœŸ
          Row() {
            Text('ðŸ“…')
              .fontSize(12)
              .margin({ right: 4 })
            Text(`${coupon.validFrom} è‡³ ${coupon.validTo}`)
              .fontSize(10)
              .fontColor('#9ca3af')
          }
          .width('100%')
          .margin({ bottom: 8 })

          // é€‚ç”¨æ´»åŠ¨
          Text(`é€‚ç”¨: ${coupon.applicableActivities.join(', ')}`)
            .fontSize(10)
            .fontColor('#6b7280')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
        .padding(12)
        .alignItems(HorizontalAlign.Start)
        .backgroundColor(Color.White)
        .borderRadius({ topRight: 12, bottomRight: 12 })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ä½¿ç”¨æ¡ä»¶
      if (coupon.conditions.length > 0) {
        Column() {
          Text('ä½¿ç”¨æ¡ä»¶:')
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 4 })

          ForEach(coupon.conditions ?? [], (condition: string, index: number) => {
            Row() {
              Text('â€¢')
                .fontSize(12)
                .fontColor('#6b7280')
                .margin({ right: 4 })
              Text(condition)
                .fontSize(12)
                .fontColor('#6b7280')
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
            .margin({ bottom: 2 })
          }, (condition: string, index: number) => `cond-${coupon.id}-${index}`)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f9fafb')
        .borderRadius(8)
        .margin({ bottom: 12 })
      }

      // æ“ä½œæŒ‰é’®
      if (coupon.status === 'available') {
        Row() {
          Button('ç«‹å³ä½¿ç”¨')
            .fontSize(14)
            .fontColor(Color.White)
            .backgroundColor('#3b82f6')
            .borderRadius(8)
            .padding({ left: 24, right: 24, top: 10, bottom: 10 })
            .onClick(() => {
              this.useCoupon(coupon.id);
            })

          Blank()

          Button('æŸ¥çœ‹è¯¦æƒ…')
            .fontSize(14)
            .fontColor('#3b82f6')
            .backgroundColor('#dbeafe')
            .borderRadius(8)
            .padding({ left: 24, right: 24, top: 10, bottom: 10 })
            .onClick(() => {
              this.viewCouponDetail(coupon.id);
            })
        }
        .width('100%')
      } else {
        Row() {
          Button(this.getActionText(coupon.status))
            .fontSize(14)
            .fontColor('#6b7280')
            .backgroundColor('#f3f4f6')
            .borderRadius(8)
            .padding({ left: 24, right: 24, top: 10, bottom: 10 })
            .enabled(false)

          Blank()

          Button('æŸ¥çœ‹è¯¦æƒ…')
            .fontSize(14)
            .fontColor('#6b7280')
            .backgroundColor('#f3f4f6')
            .borderRadius(8)
            .padding({ left: 24, right: 24, top: 10, bottom: 10 })
            .onClick(() => {
              this.viewCouponDetail(coupon.id);
            })
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  private getFilteredCoupons(): CouponItem[] {
    switch (this.selectedTab) {
      case 1: // å¯ç”¨
        return this.couponList.filter(coupon => coupon.status === 'available');
      case 2: // å·²ä½¿ç”¨
        return this.couponList.filter(coupon => coupon.status === 'used');
      case 3: // å·²è¿‡æœŸ
        return this.couponList.filter(coupon => coupon.status === 'expired');
      default: // å…¨éƒ¨
        return this.couponList;
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'available': return 'å¯ç”¨';
      case 'used': return 'å·²ä½¿ç”¨';
      case 'expired': return 'å·²è¿‡æœŸ';
      default: return 'æœªçŸ¥';
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'available': return '#10b981';
      case 'used': return '#6b7280';
      case 'expired': return '#ef4444';
      default: return '#6b7280';
    }
  }

  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'available': return '#d1fae5';
      case 'used': return '#f3f4f6';
      case 'expired': return '#fee2e2';
      default: return '#f3f4f6';
    }
  }

  private getActionText(status: string): string {
    switch (status) {
      case 'used': return 'å·²ä½¿ç”¨';
      case 'expired': return 'å·²è¿‡æœŸ';
      default: return 'ä¸å¯ç”¨';
    }
  }

  private useCoupon(id: string): void {
    // ä½¿ç”¨ä¼˜æƒ åˆ¸é€»è¾‘
    const index = this.couponList.findIndex(coupon => coupon.id === id);
    if (index !== -1) {
      this.couponList[index].status = 'used';
    }
  }

  private viewCouponDetail(id: string): void {
    try {
      router.pushUrl({ 
        url: 'pages/coupon/CouponDetailPage',
        params: { id: id }
      });
    } catch (error) {
      console.error('Failed to navigate to coupon detail:', error);
    }
  }
}
