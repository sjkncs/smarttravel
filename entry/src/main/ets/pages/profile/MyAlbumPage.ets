import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface PhotoItem {
  id: string;
  url: string;
  title: string;
  location: string;
  date: string;
  likes: number;
  comments: number;
  tags: string[];
}

interface AlbumCategory {
  id: string;
  name: string;
  count: number;
  coverUrl: string;
}

@Entry
@Component
export struct MyAlbumPage {
  @State photoList: PhotoItem[] = [
    {
      id: '1',
      url: 'https://picsum.photos/300/200?random=1',
      title: 'æ·±åœ³æ¹¾æ—¥å‡º',
      location: 'æ·±åœ³æ¹¾å…¬å›­',
      date: '2024-06-01',
      likes: 128,
      comments: 23,
      tags: ['æ—¥å‡º', 'æ·±åœ³æ¹¾', 'è‡ªç„¶é£å…‰']
    },
    {
      id: '2',
      url: 'https://picsum.photos/300/200?random=2',
      title: 'è²èŠ±å±±å¤œæ™¯',
      location: 'è²èŠ±å±±å…¬å›­',
      date: '2024-06-02',
      likes: 95,
      comments: 15,
      tags: ['å¤œæ™¯', 'åŸå¸‚', 'è²èŠ±å±±']
    },
    {
      id: '3',
      url: 'https://picsum.photos/300/200?random=3',
      title: 'ä¸œæ¹–è·èŠ±',
      location: 'ä¸œæ¹–å…¬å›­',
      date: '2024-06-03',
      likes: 156,
      comments: 31,
      tags: ['è·èŠ±', 'å¤å­£', 'ä¸œæ¹–']
    },
    {
      id: '4',
      url: 'https://picsum.photos/300/200?random=4',
      title: 'æ°‘ä¿—æ–‡åŒ–èŠ‚',
      location: 'å¸‚æ°‘ä¸­å¿ƒ',
      date: '2024-06-04',
      likes: 89,
      comments: 18,
      tags: ['æ°‘ä¿—', 'æ–‡åŒ–', 'èŠ‚æ—¥']
    },
    {
      id: '5',
      url: 'https://picsum.photos/300/200?random=5',
      title: 'æµ·è¾¹æ—¥è½',
      location: 'å¤§æ¢…æ²™',
      date: '2024-06-05',
      likes: 203,
      comments: 42,
      tags: ['æ—¥è½', 'æµ·è¾¹', 'æµªæ¼«']
    },
    {
      id: '6',
      url: 'https://picsum.photos/300/200?random=6',
      title: 'åŸå¸‚é©¬æ‹‰æ¾',
      location: 'æ·±åœ³æ¹¾ä½“è‚²ä¸­å¿ƒ',
      date: '2024-06-06',
      likes: 167,
      comments: 28,
      tags: ['è¿åŠ¨', 'é©¬æ‹‰æ¾', 'æ´»åŠ›']
    }
  ];

  @State albumCategories: AlbumCategory[] = [
    { id: '1', name: 'è‡ªç„¶é£å…‰', count: 15, coverUrl: 'https://picsum.photos/150/150?random=10' },
    { id: '2', name: 'åŸå¸‚å»ºç­‘', count: 8, coverUrl: 'https://picsum.photos/150/150?random=11' },
    { id: '3', name: 'äººæ–‡çºªå®', count: 12, coverUrl: 'https://picsum.photos/150/150?random=12' },
    { id: '4', name: 'ç¾é£Ÿæ¢åº—', count: 6, coverUrl: 'https://picsum.photos/150/150?random=13' }
  ];

  @State selectedTab: number = 0;
  @State selectedCategory: string = '';
  private tabs: string[] = ['å…¨éƒ¨', 'åˆ†ç±»', 'æ”¶è—'];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æˆ‘çš„ç›¸å†Œ',
        showBack: true,
        showSearch: true,
        showNotification: false
      })

      // ç»Ÿè®¡ä¿¡æ¯
      this.StatisticsCard()

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text('6')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
          Text('ç…§ç‰‡æ€»æ•°')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('838')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#10b981')
          Text('æ€»è·èµ')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('157')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#3b82f6')
          Text('æ€»è¯„è®º')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('4')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#f59e0b')
          Text('ç›¸å†Œåˆ†ç±»')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs ?? [], (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      }, (tab: string, index: number) => `tab-${index}-${tab}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        if (this.selectedTab === 0) {
          // å…¨éƒ¨ç…§ç‰‡ - ç½‘æ ¼å¸ƒå±€
          this.PhotoGrid()
        } else if (this.selectedTab === 1) {
          // åˆ†ç±»ç›¸å†Œ
          this.AlbumCategories()
        } else {
          // æ”¶è—ç…§ç‰‡
          this.FavoritePhotos()
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder PhotoGrid() {
    GridRow({
      columns: 2,
      gutter: { x: 12, y: 12 }
    }) {
      ForEach(this.photoList ?? [], (photo: PhotoItem, index: number) => {
        GridCol({ span: 1 }) {
          this.PhotoCard(photo)
        }
      }, (photo: PhotoItem, index: number) => `photo-${photo.id}-${index}`)
    }
    .width('100%')
  }

  @Builder PhotoCard(photo: PhotoItem) {
    Column() {
      // ç…§ç‰‡
      Stack() {
        Image(photo.url)
          .width('100%')
          .height(200)
          .objectFit(ImageFit.Cover)
          .borderRadius(12)

        // ç‚¹èµå’Œè¯„è®ºæ•°
        Row() {
          Blank()
          Row({ space: 8 }) {
            Text('â¤ï¸')
              .fontSize(12)
            Text(photo.likes.toString())
              .fontSize(12)
              .fontColor(Color.White)
          }
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('rgba(0,0,0,0.5)')
          .borderRadius(12)
          .margin({ right: 8 })

          Row({ space: 8 }) {
            Text('ğŸ’¬')
              .fontSize(12)
            Text(photo.comments.toString())
              .fontSize(12)
              .fontColor(Color.White)
          }
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('rgba(0,0,0,0.5)')
          .borderRadius(12)
        }
        .width('100%')
        .padding(8)
      }
      .width('100%')

      // ç…§ç‰‡ä¿¡æ¯
      Column() {
        Text(photo.title)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .margin({ bottom: 4 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(`${photo.location} Â· ${photo.date}`)
          .fontSize(12)
          .fontColor('#6b7280')
          .margin({ bottom: 8 })

        // æ ‡ç­¾
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach((photo.tags ?? []).slice(0, 2), (tag: string, index: number) => {
            Text(`#${tag}`)
              .fontSize(10)
              .fontColor('#3b82f6')
              .backgroundColor('#dbeafe')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .margin({ right: 4, bottom: 4 })
          }, (tag: string, index: number) => `tag-${photo.id}-${index}-${tag}`)
        }
        .width('100%')
      }
      .width('100%')
      .padding(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.viewPhotoDetail(photo.id);
    })
  }

  @Builder AlbumCategories() {
    Column() {
      ForEach(this.albumCategories ?? [], (category: AlbumCategory, index: number) => {
        Row() {
          // å°é¢å›¾ç‰‡
          Image(category.coverUrl)
            .width(60)
            .height(60)
            .objectFit(ImageFit.Cover)
            .borderRadius(8)
            .margin({ right: 12 })

          // åˆ†ç±»ä¿¡æ¯
          Column() {
            Text(category.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .margin({ bottom: 4 })

            Text(`${category.count} å¼ ç…§ç‰‡`)
              .fontSize(12)
              .fontColor('#6b7280')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          // ç®­å¤´
          Text('>')
            .fontSize(16)
            .fontColor('#9ca3af')
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ bottom: 12 })
        .shadow({
          radius: 4,
          color: 'rgba(0,0,0,0.05)',
          offsetX: 0,
          offsetY: 2
        })
        .onClick(() => {
          this.viewCategory(category.id);
        })
      }, (category: AlbumCategory, index: number) => `cat-${category.id ?? ''}-${index}`)
    }
    .width('100%')
  }

  @Builder FavoritePhotos() {
    Column() {
      Text('æ”¶è—çš„ç…§ç‰‡')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      GridRow({
        columns: 3,
        gutter: { x: 8, y: 8 }
      }) {
        ForEach((this.photoList ?? []).slice(0, 6), (photo: PhotoItem, index: number) => {
          GridCol({ span: 1 }) {
            Image(photo.url)
              .width('100%')
              .height(100)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
              .onClick(() => {
                this.viewPhotoDetail(photo.id);
              })
          }
        }, (photo: PhotoItem, index: number) => `fav-${photo.id}-${index}`)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  private viewPhotoDetail(id: string): void {
    // è·³è½¬åˆ°ç…§ç‰‡è¯¦æƒ…é¡µé¢
    router.pushUrl({ 
      url: 'pages/photo/PhotoDetailPage',
      params: { id: id }
    }).catch((error: Error) => {
      console.error('è·³è½¬ç…§ç‰‡è¯¦æƒ…é¡µé¢å¤±è´¥:', error.message);
    });
  }

  private viewCategory(categoryId: string): void {
    // è·³è½¬åˆ°åˆ†ç±»è¯¦æƒ…é¡µé¢
    router.pushUrl({ 
      url: 'pages/album/AlbumCategoryPage',
      params: { id: categoryId }
    }).catch((error: Error) => {
      console.error('è·³è½¬ç›¸å†Œåˆ†ç±»é¡µé¢å¤±è´¥:', error.message);
    });
  }
}
