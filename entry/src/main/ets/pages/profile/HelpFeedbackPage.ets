import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface HelpItem {
  id: string;
  title: string;
  description: string;
  icon: string;
  color: string;
}

interface FeedbackItem {
  id: string;
  type: 'bug' | 'suggestion' | 'complaint' | 'praise';
  title: string;
  content: string;
  status: 'pending' | 'processing' | 'resolved';
  createTime: string;
  reply?: string;
}

@Entry
@Component
export struct HelpFeedbackPage {
  @State selectedTab: number = 0;
  @State feedbackContent: string = '';
  @State feedbackType: string = 'suggestion';
  @State contactInfo: string = '';

  private tabs: string[] = ['å¸®åŠ©ä¸­å¿ƒ', 'æ„è§åé¦ˆ', 'å¸¸è§é—®é¢˜'];

  private helpItems: HelpItem[] = [
    {
      id: '1',
      title: 'ä½¿ç”¨æŒ‡å—',
      description: 'äº†è§£å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹SmartTravel',
      icon: 'ğŸ“–',
      color: '#3b82f6'
    },
    {
      id: '2',
      title: 'æ´»åŠ¨æŠ¥å',
      description: 'å¦‚ä½•æŠ¥åå‚åŠ æ´»åŠ¨',
      icon: 'ğŸ«',
      color: '#10b981'
    },
    {
      id: '3',
      title: 'æ”¯ä»˜é—®é¢˜',
      description: 'æ”¯ä»˜å¤±è´¥ã€é€€æ¬¾ç­‰',
      icon: 'ğŸ’³',
      color: '#f59e0b'
    },
    {
      id: '4',
      title: 'è´¦æˆ·å®‰å…¨',
      description: 'å¯†ç æ‰¾å›ã€è´¦æˆ·ä¿æŠ¤',
      icon: 'ğŸ”’',
      color: '#ef4444'
    },
    {
      id: '5',
      title: 'è”ç³»å®¢æœ',
      description: 'åœ¨çº¿å®¢æœã€ç”µè¯å’¨è¯¢',
      icon: 'ğŸ§',
      color: '#8b5cf6'
    },
    {
      id: '6',
      title: 'éšç§æ”¿ç­–',
      description: 'äº†è§£æˆ‘ä»¬çš„éšç§ä¿æŠ¤',
      icon: 'ğŸ›¡ï¸',
      color: '#6b7280'
    }
  ];

  private feedbackList: FeedbackItem[] = [
    {
      id: '1',
      type: 'suggestion',
      title: 'å»ºè®®å¢åŠ å¤œé—´æ¨¡å¼',
      content: 'å¸Œæœ›åº”ç”¨èƒ½å¤Ÿæ”¯æŒæ·±è‰²æ¨¡å¼ï¼Œåœ¨å¤œé—´ä½¿ç”¨æ—¶æ›´åŠ æŠ¤çœ¼ã€‚',
      status: 'resolved',
      createTime: '2024-06-01',
      reply: 'æ„Ÿè°¢æ‚¨çš„å»ºè®®ï¼æˆ‘ä»¬å·²ç»åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­å¢åŠ äº†æ·±è‰²æ¨¡å¼åŠŸèƒ½ã€‚'
    },
    {
      id: '2',
      type: 'bug',
      title: 'æ´»åŠ¨è¯¦æƒ…é¡µé¢åŠ è½½ç¼“æ…¢',
      content: 'åœ¨æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…æ—¶ï¼Œé¡µé¢åŠ è½½é€Ÿåº¦è¾ƒæ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚',
      status: 'processing',
      createTime: '2024-06-03'
    },
    {
      id: '3',
      type: 'praise',
      title: 'ç•Œé¢è®¾è®¡å¾ˆæ£’',
      content: 'åº”ç”¨çš„ç•Œé¢è®¾è®¡éå¸¸ç¾è§‚ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå¥½ï¼',
      status: 'resolved',
      createTime: '2024-06-05',
      reply: 'è°¢è°¢æ‚¨çš„è®¤å¯ï¼æˆ‘ä»¬ä¼šç»§ç»­åŠªåŠ›æä¾›æ›´å¥½çš„æœåŠ¡ã€‚'
    }
  ];

  private faqItems: HelpItem[] = [
    {
      id: '1',
      title: 'å¦‚ä½•æŠ¥åå‚åŠ æ´»åŠ¨ï¼Ÿ',
      description: 'åœ¨æ´»åŠ¨è¯¦æƒ…é¡µé¢ç‚¹å‡»"ç«‹å³æŠ¥å"æŒ‰é’®ï¼Œå¡«å†™ç›¸å…³ä¿¡æ¯å³å¯å®ŒæˆæŠ¥åã€‚',
      icon: 'â“',
      color: '#3b82f6'
    },
    {
      id: '2',
      title: 'æŠ¥ååå¯ä»¥å–æ¶ˆå—ï¼Ÿ',
      description: 'åœ¨æ´»åŠ¨å¼€å§‹å‰24å°æ—¶å†…å¯ä»¥å–æ¶ˆæŠ¥åï¼Œå…·ä½“è§„åˆ™è¯·æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…ã€‚',
      icon: 'â“',
      color: '#10b981'
    },
    {
      id: '3',
      title: 'å¦‚ä½•æŸ¥çœ‹æˆ‘çš„æŠ¥åè®°å½•ï¼Ÿ',
      description: 'åœ¨"æˆ‘çš„"é¡µé¢ç‚¹å‡»"æŠ¥åæƒ…å†µ"å³å¯æŸ¥çœ‹æ‰€æœ‰æŠ¥åè®°å½•ã€‚',
      icon: 'â“',
      color: '#f59e0b'
    },
    {
      id: '4',
      title: 'å¿˜è®°å¯†ç æ€ä¹ˆåŠï¼Ÿ',
      description: 'åœ¨ç™»å½•é¡µé¢ç‚¹å‡»"å¿˜è®°å¯†ç "ï¼Œé€šè¿‡æ‰‹æœºéªŒè¯ç é‡ç½®å¯†ç ã€‚',
      icon: 'â“',
      color: '#ef4444'
    },
    {
      id: '5',
      title: 'å¦‚ä½•è”ç³»å®¢æœï¼Ÿ',
      description: 'å¯ä»¥é€šè¿‡åº”ç”¨å†…å®¢æœåŠŸèƒ½æˆ–æ‹¨æ‰“å®¢æœçƒ­çº¿400-123-4567è”ç³»æˆ‘ä»¬ã€‚',
      icon: 'â“',
      color: '#8b5cf6'
    }
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'å¸®åŠ©ä¸åé¦ˆ',
        showBack: true,
        showSearch: false,
        showNotification: false
      })

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs ?? [], (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      }, (tab: string, index: number) => `tab-${index}-${tab}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        if (this.selectedTab === 0) {
          // å¸®åŠ©ä¸­å¿ƒ
          this.HelpCenter()
        } else if (this.selectedTab === 1) {
          // æ„è§åé¦ˆ
          this.FeedbackSection()
        } else {
          // å¸¸è§é—®é¢˜
          this.FAQSection()
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder HelpCenter() {
    Column() {
      Text('å¸®åŠ©ä¸­å¿ƒ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      GridRow({
        columns: 2,
        gutter: { x: 12, y: 12 }
      }) {
        ForEach(this.helpItems ?? [], (item: HelpItem, index: number) => {
          GridCol({ span: 1 }) {
            this.HelpCard(item)
          }
        }, (item: HelpItem, index: number) => `help-${item.id}-${index}`)
      }
      .width('100%')
    }
    .width('100%')
  }

  @Builder HelpCard(item: HelpItem) {
    Column() {
      Text(item.icon)
        .fontSize(32)
        .margin({ bottom: 8 })

      Text(item.title)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 4 })
        .textAlign(TextAlign.Center)

      Text(item.description)
        .fontSize(12)
        .fontColor('#6b7280')
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height(120)
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.openHelpDetail(item.id);
    })
  }

  @Builder FeedbackSection() {
    Column() {
      // åé¦ˆè¡¨å•
      this.FeedbackForm()

      // å†å²åé¦ˆ
      this.FeedbackHistory()
    }
    .width('100%')
  }

  @Builder FeedbackForm() {
    Column() {
      Text('æäº¤åé¦ˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      // åé¦ˆç±»å‹é€‰æ‹©
      Column() {
        Text('åé¦ˆç±»å‹')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Row({ space: 12 }) {
          this.FeedbackTypeButton('å»ºè®®', 'suggestion', this.feedbackType === 'suggestion')
          this.FeedbackTypeButton('Bug', 'bug', this.feedbackType === 'bug')
          this.FeedbackTypeButton('æŠ•è¯‰', 'complaint', this.feedbackType === 'complaint')
          this.FeedbackTypeButton('è¡¨æ‰¬', 'praise', this.feedbackType === 'praise')
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 16 })
      .shadow({
        radius: 4,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: 2
      })

      // åé¦ˆå†…å®¹
      Column() {
        Text('åé¦ˆå†…å®¹')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        TextArea({ placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®...' })
          .width('100%')
          .height(120)
          .fontSize(14)
          .backgroundColor('#f9fafb')
          .borderRadius(8)
          .onChange((value: string) => {
            this.feedbackContent = value;
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 16 })
      .shadow({
        radius: 4,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: 2
      })

      // è”ç³»æ–¹å¼
      Column() {
        Text('è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'æ‰‹æœºå·æˆ–é‚®ç®±ï¼Œæ–¹ä¾¿æˆ‘ä»¬å›å¤' })
          .width('100%')
          .height(40)
          .fontSize(14)
          .backgroundColor('#f9fafb')
          .borderRadius(8)
          .onChange((value: string) => {
            this.contactInfo = value;
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 16 })
      .shadow({
        radius: 4,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: 2
      })

      // æäº¤æŒ‰é’®
      Button('æäº¤åé¦ˆ')
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor('#3b82f6')
        .borderRadius(12)
        .width('100%')
        .height(48)
        .onClick(() => {
          this.submitFeedback();
        })
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  @Builder FeedbackTypeButton(text: string, type: string, isSelected: boolean) {
    Text(text)
      .fontSize(12)
      .fontColor(isSelected ? '#3b82f6' : '#6b7280')
      .backgroundColor(isSelected ? '#dbeafe' : '#f3f4f6')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .onClick(() => {
        this.feedbackType = type;
      })
  }

  @Builder FeedbackHistory() {
    Column() {
      Text('å†å²åé¦ˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      ForEach(this.feedbackList ?? [], (feedback: FeedbackItem, index: number) => {
        this.FeedbackHistoryCard(feedback)
      }, (feedback: FeedbackItem, index: number) => `fb-${feedback.id}-${index}`)
    }
    .width('100%')
  }

  @Builder FeedbackHistoryCard(feedback: FeedbackItem) {
    Column() {
      Row() {
        Text(this.getFeedbackTypeText(feedback.type))
          .fontSize(12)
          .fontColor(this.getFeedbackTypeColor(feedback.type))
          .backgroundColor(this.getFeedbackTypeBgColor(feedback.type))
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(8)

        Blank()

        Text(this.getStatusText(feedback.status))
          .fontSize(12)
          .fontColor(this.getStatusColor(feedback.status))
          .backgroundColor(this.getStatusBgColor(feedback.status))
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(8)
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(feedback.title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      Text(feedback.content)
        .fontSize(14)
        .fontColor('#6b7280')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })

      if (feedback.reply) {
        Column() {
          Text('å®˜æ–¹å›å¤:')
            .fontSize(12)
            .fontColor('#10b981')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 4 })

          Text(feedback.reply)
            .fontSize(14)
            .fontColor('#374151')
            .alignSelf(ItemAlign.Start)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#f0fdf4')
        .borderRadius(8)
        .margin({ bottom: 8 })
      }

      Text(`æäº¤æ—¶é—´: ${feedback.createTime}`)
        .fontSize(12)
        .fontColor('#9ca3af')
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder FAQSection() {
    Column() {
      Text('å¸¸è§é—®é¢˜')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })

      ForEach(this.faqItems ?? [], (item: HelpItem, index: number) => {
        this.FAQCard(item)
      }, (item: HelpItem, index: number) => `faq-${item.id}-${index}`)
    }
    .width('100%')
  }

  @Builder FAQCard(item: HelpItem) {
    Column() {
      Row() {
        Text(item.icon)
          .fontSize(20)
          .margin({ right: 12 })

        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)
          .alignSelf(ItemAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(item.description)
        .fontSize(14)
        .fontColor('#6b7280')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 32 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.openFAQDetail(item.id);
    })
  }

  private getFeedbackTypeText(type: string): string {
    switch (type) {
      case 'suggestion': return 'å»ºè®®';
      case 'bug': return 'Bug';
      case 'complaint': return 'æŠ•è¯‰';
      case 'praise': return 'è¡¨æ‰¬';
      default: return 'å…¶ä»–';
    }
  }

  private getFeedbackTypeColor(type: string): string {
    switch (type) {
      case 'suggestion': return '#3b82f6';
      case 'bug': return '#ef4444';
      case 'complaint': return '#f59e0b';
      case 'praise': return '#10b981';
      default: return '#6b7280';
    }
  }

  private getFeedbackTypeBgColor(type: string): string {
    switch (type) {
      case 'suggestion': return '#dbeafe';
      case 'bug': return '#fee2e2';
      case 'complaint': return '#fef3c7';
      case 'praise': return '#d1fae5';
      default: return '#f3f4f6';
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'pending': return 'å¾…å¤„ç†';
      case 'processing': return 'å¤„ç†ä¸­';
      case 'resolved': return 'å·²è§£å†³';
      default: return 'æœªçŸ¥';
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'pending': return '#f59e0b';
      case 'processing': return '#3b82f6';
      case 'resolved': return '#10b981';
      default: return '#6b7280';
    }
  }

  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'pending': return '#fef3c7';
      case 'processing': return '#dbeafe';
      case 'resolved': return '#d1fae5';
      default: return '#f3f4f6';
    }
  }

  private openHelpDetail(id: string): void {
    router.pushUrl({ 
      url: 'pages/help/HelpDetailPage',
      params: { id: id }
    });
  }

  private openFAQDetail(id: string): void {
    router.pushUrl({ 
      url: 'pages/help/FAQDetailPage',
      params: { id: id }
    });
  }

  private submitFeedback(): void {
    if (!this.feedbackContent.trim()) {
      console.log('è¯·å¡«å†™åé¦ˆå†…å®¹');
      return;
    }

    // æäº¤åé¦ˆé€»è¾‘
    console.log('åé¦ˆå·²æäº¤');
    this.feedbackContent = '';
    this.contactInfo = '';
  }
}
