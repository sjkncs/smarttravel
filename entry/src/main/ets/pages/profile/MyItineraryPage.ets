import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface ItineraryItem {
  id: string;
  title: string;
  description: string;
  startDate: string;
  endDate: string;
  status: 'planning' | 'ongoing' | 'completed' | 'cancelled';
  activities: ActivityItem[];
  totalCost: number;
  participants: number;
  coverImage: string;
  tags: string[];
}

interface ActivityItem {
  id: string;
  name: string;
  time: string;
  location: string;
  cost: number;
  status: 'pending' | 'confirmed' | 'completed' | 'cancelled';
  type: 'activity' | 'transport' | 'accommodation' | 'meal';
}

@Entry
@Component
export struct MyItineraryPage {
  @State itineraryList: ItineraryItem[] = [
    {
      id: '1',
      title: 'æ·±åœ³å‘¨æœ«æ¸¸',
      description: 'æŽ¢ç´¢æ·±åœ³æœ€ç²¾åŽçš„æ™¯ç‚¹ï¼Œä½“éªŒçŽ°ä»£åŒ–éƒ½å¸‚çš„é­…åŠ›',
      startDate: '2024-06-15',
      endDate: '2024-06-16',
      status: 'planning',
      activities: [
        { id: '1', name: 'æ·±åœ³æ¹¾å…¬å›­', time: '09:00-11:00', location: 'æ·±åœ³æ¹¾å…¬å›­', cost: 0, status: 'confirmed', type: 'activity' },
        { id: '2', name: 'è°­å¸ˆå‚…ç§æˆ¿èœ', time: '12:00-13:30', location: 'ç¦ç”°åŒº', cost: 200, status: 'confirmed', type: 'meal' },
        { id: '3', name: 'èŽ²èŠ±å±±å…¬å›­', time: '15:00-17:00', location: 'èŽ²èŠ±å±±å…¬å›­', cost: 0, status: 'pending', type: 'activity' },
        { id: '4', name: 'ä¸œé—¨è€è¡—', time: '18:00-20:00', location: 'ä¸œé—¨è€è¡—', cost: 150, status: 'pending', type: 'activity' }
      ],
      totalCost: 350,
      participants: 2,
      coverImage: 'https://picsum.photos/300/200?random=1',
      tags: ['å‘¨æœ«æ¸¸', 'æ·±åœ³', '2å¤©1å¤œ']
    },
    {
      id: '2',
      title: 'ç«¯åˆæ°‘ä¿—ä½“éªŒ',
      description: 'æ„Ÿå—ä¼ ç»Ÿç«¯åˆæ–‡åŒ–ï¼Œå‚ä¸Žæ°‘ä¿—æ´»åŠ¨',
      startDate: '2024-06-10',
      endDate: '2024-06-10',
      status: 'ongoing',
      activities: [
        { id: '5', name: 'ç«¯åˆæ°‘ä¿—å˜‰å¹´åŽ', time: '09:00-18:00', location: 'å¸‚æ°‘ä¸­å¿ƒå¹¿åœº', cost: 50, status: 'completed', type: 'activity' },
        { id: '6', name: 'ç²½å­åˆ¶ä½œä½“éªŒ', time: '14:00-16:00', location: 'å¸‚æ°‘ä¸­å¿ƒå¹¿åœº', cost: 30, status: 'confirmed', type: 'activity' },
        { id: '7', name: 'é¾™èˆŸæ¯”èµ›è§‚çœ‹', time: '16:30-18:00', location: 'æ·±åœ³æ¹¾', cost: 0, status: 'pending', type: 'activity' }
      ],
      totalCost: 80,
      participants: 1,
      coverImage: 'https://picsum.photos/300/200?random=2',
      tags: ['ç«¯åˆ', 'æ°‘ä¿—', 'ä¼ ç»Ÿæ–‡åŒ–']
    },
    {
      id: '3',
      title: 'æ·±åœ³ç¾Žé£Ÿä¹‹æ—…',
      description: 'å“å°æ·±åœ³æœ€åœ°é“çš„ç²¤èœå’Œç‰¹è‰²å°åƒ',
      startDate: '2024-06-08',
      endDate: '2024-06-08',
      status: 'completed',
      activities: [
        { id: '8', name: 'æ—©èŒ¶ä½“éªŒ', time: '08:00-10:00', location: 'ä¸€æ—¬ä¸€å‘³', cost: 120, status: 'completed', type: 'meal' },
        { id: '9', name: 'ä¸œé—¨å°åƒè¡—', time: '12:00-14:00', location: 'ä¸œé—¨è€è¡—', cost: 80, status: 'completed', type: 'meal' },
        { id: '10', name: 'è°­å¸ˆå‚…ç§æˆ¿èœ', time: '18:00-20:00', location: 'ç¦ç”°åŒº', cost: 300, status: 'completed', type: 'meal' }
      ],
      totalCost: 500,
      participants: 2,
      coverImage: 'https://picsum.photos/300/200?random=3',
      tags: ['ç¾Žé£Ÿ', 'ç²¤èœ', 'æŽ¢åº—']
    },
    {
      id: '4',
      title: 'æ·±åœ³å¤œæ™¯æ‘„å½±',
      description: 'æ‹æ‘„æ·±åœ³æœ€ç¾Žçš„å¤œæ™¯ï¼Œè®°å½•åŸŽå¸‚é£Žå…‰',
      startDate: '2024-06-20',
      endDate: '2024-06-20',
      status: 'planning',
      activities: [
        { id: '11', name: 'æ·±åœ³æ¹¾å¤œæ™¯', time: '19:00-21:00', location: 'æ·±åœ³æ¹¾å…¬å›­', cost: 0, status: 'pending', type: 'activity' },
        { id: '12', name: 'å¹³å®‰é‡‘èžä¸­å¿ƒ', time: '21:30-23:00', location: 'å¹³å®‰é‡‘èžä¸­å¿ƒ', cost: 100, status: 'pending', type: 'activity' }
      ],
      totalCost: 100,
      participants: 1,
      coverImage: 'https://picsum.photos/300/200?random=4',
      tags: ['æ‘„å½±', 'å¤œæ™¯', 'åŸŽå¸‚é£Žå…‰']
    }
  ];

  @State selectedTab: number = 0;
  private tabs: string[] = ['å…¨éƒ¨', 'è§„åˆ’ä¸­', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æˆ‘çš„è¡Œç¨‹',
        showBack: true,
        showSearch: true,
        showNotification: false
      })

      // ç»Ÿè®¡ä¿¡æ¯
      this.StatisticsCard()

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text('4')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
          Text('è¡Œç¨‹æ€»æ•°')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('2')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#f59e0b')
          Text('è§„åˆ’ä¸­')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('1')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#3b82f6')
          Text('è¿›è¡Œä¸­')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('1')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#10b981')
          Text('å·²å®Œæˆ')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs ?? [], (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(20)
          .onClick(() => {
            this.selectedTab = index;
          })
      }, (tab: string, index: number) => `tab-${index}-${tab}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        ForEach(this.getFilteredItineraries() ?? [], (itinerary: ItineraryItem, index: number) => {
          this.ItineraryCard(itinerary)
        }, (itinerary: ItineraryItem, index: number) => `iti-${itinerary.id}-${index}`)
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder ItineraryCard(itinerary: ItineraryItem) {
    Column() {
      // å°é¢å›¾ç‰‡å’ŒåŸºæœ¬ä¿¡æ¯
      Row() {
        Image(itinerary.coverImage)
          .width(100)
          .height(80)
          .objectFit(ImageFit.Cover)
          .borderRadius(8)
          .margin({ right: 12 })

        Column() {
          // æ ‡é¢˜å’ŒçŠ¶æ€
          Row() {
            Text(itinerary.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text(this.getStatusText(itinerary.status))
              .fontSize(10)
              .fontColor(this.getStatusColor(itinerary.status))
              .backgroundColor(this.getStatusBgColor(itinerary.status))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
          }
          .width('100%')
          .margin({ bottom: 4 })

          // æè¿°
          Text(itinerary.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          // æ—¥æœŸå’Œè´¹ç”¨
          Row() {
            Text('ðŸ“…')
              .fontSize(12)
              .margin({ right: 4 })
            Text(`${itinerary.startDate} - ${itinerary.endDate}`)
              .fontSize(12)
              .fontColor('#6b7280')

            Text('ðŸ’°')
              .fontSize(12)
              .margin({ left: 12, right: 4 })
            Text(`Â¥${itinerary.totalCost}`)
              .fontSize(12)
              .fontColor('#10b981')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .margin({ bottom: 8 })

          // å‚ä¸Žäººæ•°
          Row() {
            Text('ðŸ‘¥')
              .fontSize(12)
              .margin({ right: 4 })
            Text(`${itinerary.participants} äºº`)
              .fontSize(12)
              .fontColor('#6b7280')
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ´»åŠ¨åˆ—è¡¨é¢„è§ˆ
      Column() {
        Text('è¡Œç¨‹å®‰æŽ’')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        ForEach((itinerary.activities ?? []).slice(0, 3), (activity: ActivityItem, idx: number) => {
          this.ActivityItem(activity)
        }, (activity: ActivityItem, idx: number) => `act-${itinerary.id}-${idx}-${activity.id}`)

        if (itinerary.activities.length > 3) {
          Text(`è¿˜æœ‰ ${itinerary.activities.length - 3} ä¸ªæ´»åŠ¨...`)
            .fontSize(12)
            .fontColor('#6b7280')
            .alignSelf(ItemAlign.Start)
            .margin({ top: 8 })
        }
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#f9fafb')
      .borderRadius(8)
      .margin({ bottom: 12 })

      // æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(itinerary.tags ?? [], (tag: string, idx: number) => {
          Text(`#${tag}`)
            .fontSize(10)
            .fontColor('#3b82f6')
            .backgroundColor('#dbeafe')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ right: 6, bottom: 4 })
        }, (tag: string, idx: number) => `tag-${itinerary.id}-${idx}-${tag}`)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#3b82f6')
          .backgroundColor('#dbeafe')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.viewItineraryDetail(itinerary.id);
          })

        if (itinerary.status === 'planning') {
          Button('ç¼–è¾‘è¡Œç¨‹')
            .fontSize(12)
            .fontColor('#f59e0b')
            .backgroundColor('#fef3c7')
            .borderRadius(8)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .margin({ left: 8 })
            .onClick(() => {
              this.editItinerary(itinerary.id);
            })
        }

        Blank()

        Button('åˆ†äº«')
          .fontSize(12)
          .fontColor('#10b981')
          .backgroundColor('#d1fae5')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.shareItinerary(itinerary.id);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ActivityItem(activity: ActivityItem) {
    Row() {
      Text(this.getActivityTypeIcon(activity.type))
        .fontSize(12)
        .margin({ right: 8 })

      Text(activity.name)
        .fontSize(12)
        .fontColor('#374151')
        .layoutWeight(1)

      Text(activity.time)
        .fontSize(10)
        .fontColor('#6b7280')
        .margin({ right: 8 })

      Text(this.getActivityStatusText(activity.status))
        .fontSize(10)
        .fontColor(this.getActivityStatusColor(activity.status))
        .backgroundColor(this.getActivityStatusBgColor(activity.status))
        .padding({ left: 4, right: 4, top: 2, bottom: 2 })
        .borderRadius(4)
    }
    .width('100%')
    .margin({ bottom: 4 })
  }

  private getFilteredItineraries(): ItineraryItem[] {
    switch (this.selectedTab) {
      case 1: // è§„åˆ’ä¸­
        return this.itineraryList.filter(itinerary => itinerary.status === 'planning');
      case 2: // è¿›è¡Œä¸­
        return this.itineraryList.filter(itinerary => itinerary.status === 'ongoing');
      case 3: // å·²å®Œæˆ
        return this.itineraryList.filter(itinerary => itinerary.status === 'completed');
      default: // å…¨éƒ¨
        return this.itineraryList;
    }
  }

  private getStatusText(status: string): string {
    switch (status) {
      case 'planning': return 'è§„åˆ’ä¸­';
      case 'ongoing': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      case 'cancelled': return 'å·²å–æ¶ˆ';
      default: return 'æœªçŸ¥';
    }
  }

  private getStatusColor(status: string): string {
    switch (status) {
      case 'planning': return '#f59e0b';
      case 'ongoing': return '#3b82f6';
      case 'completed': return '#10b981';
      case 'cancelled': return '#ef4444';
      default: return '#6b7280';
    }
  }

  private getStatusBgColor(status: string): string {
    switch (status) {
      case 'planning': return '#fef3c7';
      case 'ongoing': return '#dbeafe';
      case 'completed': return '#d1fae5';
      case 'cancelled': return '#fee2e2';
      default: return '#f3f4f6';
    }
  }

  private getActivityTypeIcon(type: string): string {
    switch (type) {
      case 'activity': return 'ðŸŽ¯';
      case 'transport': return 'ðŸš—';
      case 'accommodation': return 'ðŸ¨';
      case 'meal': return 'ðŸ½ï¸';
      default: return 'ðŸ“';
    }
  }

  private getActivityStatusText(status: string): string {
    switch (status) {
      case 'pending': return 'å¾…å®š';
      case 'confirmed': return 'å·²ç¡®è®¤';
      case 'completed': return 'å·²å®Œæˆ';
      case 'cancelled': return 'å·²å–æ¶ˆ';
      default: return 'æœªçŸ¥';
    }
  }

  private getActivityStatusColor(status: string): string {
    switch (status) {
      case 'pending': return '#f59e0b';
      case 'confirmed': return '#10b981';
      case 'completed': return '#3b82f6';
      case 'cancelled': return '#ef4444';
      default: return '#6b7280';
    }
  }

  private getActivityStatusBgColor(status: string): string {
    switch (status) {
      case 'pending': return '#fef3c7';
      case 'confirmed': return '#d1fae5';
      case 'completed': return '#dbeafe';
      case 'cancelled': return '#fee2e2';
      default: return '#f3f4f6';
    }
  }

  private viewItineraryDetail(id: string): void {
    router.pushUrl({ 
      url: 'pages/itinerary/ItineraryDetailPage',
      params: { id: id }
    }).catch((error: Error) => {
      console.error('è·³è½¬è¡Œç¨‹è¯¦æƒ…é¡µå¤±è´¥:', error.message);
    });
  }

  private editItinerary(id: string): void {
    router.pushUrl({ 
      url: 'pages/itinerary/ItineraryEditPage',
      params: { id: id }
    }).catch((error: Error) => {
      console.error('è·³è½¬è¡Œç¨‹ç¼–è¾‘é¡µå¤±è´¥:', error.message);
    });
  }

  private shareItinerary(id: string): void {
    console.log(`åˆ†äº«è¡Œç¨‹: ${id}`);
  }
}
