import { router } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface FavoriteItem {
  id: string;
  type: 'activity' | 'place' | 'restaurant' | 'hotel';
  title: string;
  description: string;
  imageUrl: string;
  location: string;
  rating: number;
  price?: string;
  favoriteTime: string;
  tags: string[];
}

@Entry
@Component
export struct MyFavoritesPage {
  @State favoriteList: FavoriteItem[] = [
    {
      id: '1',
      type: 'activity',
      title: 'æ·±åœ³æ¹¾å…¬å›­å¤œæ¸¸',
      description: 'æ·±åœ³æ¹¾å…¬å›­æ˜¯æ·±åœ³æœ€ç¾çš„æµ·æ»¨å…¬å›­ï¼Œå¤œæ™šæ—¶åˆ†ç¯å…‰ç’€ç’¨ï¼Œæ˜¯ä¼‘é—²æ•£æ­¥çš„å¥½å»å¤„ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=1',
      location: 'æ·±åœ³æ¹¾å…¬å›­',
      rating: 4.8,
      favoriteTime: '2024-06-01',
      tags: ['å…¬å›­', 'å¤œæ™¯', 'ä¼‘é—²']
    },
    {
      id: '2',
      type: 'restaurant',
      title: 'è°­å¸ˆå‚…ç§æˆ¿èœ',
      description: 'ä¼ ç»Ÿç²¤èœé¤å…ï¼Œç¯å¢ƒä¼˜é›…ï¼Œèœå“ç²¾è‡´ï¼Œæ˜¯å•†åŠ¡å®´è¯·å’Œå®¶åº­èšé¤çš„ç†æƒ³é€‰æ‹©ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=2',
      location: 'ç¦ç”°åŒº',
      rating: 4.6,
      price: 'Â¥200-300/äºº',
      favoriteTime: '2024-06-02',
      tags: ['ç²¤èœ', 'ç§æˆ¿èœ', 'å•†åŠ¡å®´è¯·']
    },
    {
      id: '3',
      type: 'place',
      title: 'è²èŠ±å±±å…¬å›­',
      description: 'æ·±åœ³å¸‚ä¸­å¿ƒçš„å¤§å‹åŸå¸‚å…¬å›­ï¼Œå±±é¡¶å¯ä¿¯ç°æ•´ä¸ªæ·±åœ³å¸‚åŒºï¼Œæ˜¯å¸‚æ°‘ä¼‘é—²å¥èº«çš„çƒ­é—¨åœºæ‰€ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=3',
      location: 'ç¦ç”°åŒº',
      rating: 4.7,
      favoriteTime: '2024-06-03',
      tags: ['å…¬å›­', 'ç™»å±±', 'åŸå¸‚æ™¯è§‚']
    },
    {
      id: '4',
      type: 'hotel',
      title: 'æ·±åœ³æ¹¾ä¸‡è±ªé…’åº—',
      description: 'è±ªåäº”æ˜Ÿçº§é…’åº—ï¼Œä½äºæ·±åœ³æ¹¾æ ¸å¿ƒåŒºåŸŸï¼Œæ‹¥æœ‰æ— æ•Œæµ·æ™¯å’Œé¡¶çº§æœåŠ¡è®¾æ–½ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=4',
      location: 'å—å±±åŒº',
      rating: 4.9,
      price: 'Â¥800-1500/æ™š',
      favoriteTime: '2024-06-04',
      tags: ['è±ªåé…’åº—', 'æµ·æ™¯', 'å•†åŠ¡']
    },
    {
      id: '5',
      type: 'activity',
      title: 'ä¸œæ¹–å…¬å›­è·èŠ±èŠ‚',
      description: 'æ¯å¹´å¤å­£ä¸¾åŠçš„è·èŠ±èŠ‚ï¼Œå±•ç¤ºå„ç§çç¨€è·èŠ±å“ç§ï¼Œæ˜¯æ‘„å½±çˆ±å¥½è€…çš„å¤©å ‚ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=5',
      location: 'ä¸œæ¹–å…¬å›­',
      rating: 4.5,
      favoriteTime: '2024-06-05',
      tags: ['è·èŠ±', 'æ‘„å½±', 'èŠ‚åº†']
    },
    {
      id: '6',
      type: 'restaurant',
      title: 'ä¸€æ—¬ä¸€å‘³',
      description: 'åˆ›æ„èåˆèœé¤å…ï¼Œå°†ä¼ ç»Ÿç²¤èœä¸ç°ä»£çƒ¹é¥ªæŠ€æ³•å®Œç¾ç»“åˆï¼Œæ¯é“èœéƒ½æ˜¯è‰ºæœ¯å“ã€‚',
      imageUrl: 'https://picsum.photos/300/200?random=6',
      location: 'å—å±±åŒº',
      rating: 4.7,
      price: 'Â¥150-250/äºº',
      favoriteTime: '2024-06-06',
      tags: ['èåˆèœ', 'åˆ›æ„', 'è‰ºæœ¯']
    }
  ];

  @State selectedTab: number = 0;
  private tabs: string[] = ['å…¨éƒ¨', 'æ´»åŠ¨', 'æ™¯ç‚¹', 'é¤å…', 'é…’åº—'];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æˆ‘çš„æ”¶è—',
        showBack: true,
        showSearch: true,
        showNotification: false
      })

      // ç»Ÿè®¡ä¿¡æ¯
      this.StatisticsCard()

      // æ ‡ç­¾é¡µ
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      this.ContentArea()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder StatisticsCard() {
    Column() {
      Row() {
        Column() {
          Text('6')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
          Text('æ”¶è—æ€»æ•°')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('2')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#10b981')
          Text('æ´»åŠ¨')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('2')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#3b82f6')
          Text('é¤å…')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)

        Column() {
          Text('2')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#f59e0b')
          Text('å…¶ä»–')
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 20, bottom: 20 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder TabBar() {
    Row() {
      ForEach(this.tabs ?? [], (tab: string, index: number) => {
        Text(tab)
          .fontSize(14)
          .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedTab === index ? '#3b82f6' : '#6b7280')
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .backgroundColor(this.selectedTab === index ? '#dbeafe' : Color.Transparent)
          .borderRadius(16)
          .onClick(() => {
            this.selectedTab = index;
          })
      }, (tab: string, index: number) => `tab-${index}-${tab}`)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Color.White)
    .margin({ left: 16, right: 16, bottom: 12 })
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder ContentArea() {
    Scroll() {
      Column() {
        ForEach(this.getFilteredFavorites() ?? [], (item: FavoriteItem, index: number) => {
          this.FavoriteCard(item)
        }, (item: FavoriteItem, index: number) => `fav-${item.id}-${index}`)
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder FavoriteCard(item: FavoriteItem) {
    Column() {
      Row() {
        // å›¾ç‰‡
        Image(item.imageUrl)
          .width(100)
          .height(80)
          .objectFit(ImageFit.Cover)
          .borderRadius(8)
          .margin({ right: 12 })

        // å†…å®¹ä¿¡æ¯
        Column() {
          // æ ‡é¢˜å’Œç±»å‹æ ‡ç­¾
          Row() {
            Text(item.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text(this.getTypeText(item.type))
              .fontSize(10)
              .fontColor(this.getTypeColor(item.type))
              .backgroundColor(this.getTypeBgColor(item.type))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
          }
          .width('100%')
          .margin({ bottom: 4 })

          // æè¿°
          Text(item.description)
            .fontSize(12)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })

          // ä½ç½®å’Œè¯„åˆ†
          Row() {
            Text('ğŸ“')
              .fontSize(12)
              .margin({ right: 4 })
            Text(item.location)
              .fontSize(12)
              .fontColor('#6b7280')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text('â­')
              .fontSize(12)
              .margin({ right: 2 })
            Text(item.rating.toString())
              .fontSize(12)
              .fontColor('#f59e0b')
          }
          .width('100%')
          .margin({ bottom: 8 })

          // ä»·æ ¼å’Œæ”¶è—æ—¶é—´
          Row() {
            if (item.price) {
              Text(item.price)
                .fontSize(12)
                .fontColor('#10b981')
                .fontWeight(FontWeight.Bold)
            }

            Blank()

            Text(`æ”¶è—äº ${item.favoriteTime}`)
              .fontSize(10)
              .fontColor('#9ca3af')
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(item.tags ?? [], (tag: string, index: number) => {
          Text(`#${tag}`)
            .fontSize(10)
            .fontColor('#3b82f6')
            .backgroundColor('#dbeafe')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ right: 6, bottom: 4 })
        }, (tag: string, index: number) => `tag-${item.id}-${index}-${tag}`)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(12)
          .fontColor('#3b82f6')
          .backgroundColor('#dbeafe')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.viewDetail(item.id, item.type);
          })

        Blank()

        Button('å–æ¶ˆæ”¶è—')
          .fontSize(12)
          .fontColor('#ef4444')
          .backgroundColor('#fef2f2')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.removeFavorite(item.id);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  private getFilteredFavorites(): FavoriteItem[] {
    switch (this.selectedTab) {
      case 1: // æ´»åŠ¨
        return this.favoriteList.filter(item => item.type === 'activity');
      case 2: // æ™¯ç‚¹
        return this.favoriteList.filter(item => item.type === 'place');
      case 3: // é¤å…
        return this.favoriteList.filter(item => item.type === 'restaurant');
      case 4: // é…’åº—
        return this.favoriteList.filter(item => item.type === 'hotel');
      default: // å…¨éƒ¨
        return this.favoriteList;
    }
  }

  private getTypeText(type: string): string {
    switch (type) {
      case 'activity': return 'æ´»åŠ¨';
      case 'place': return 'æ™¯ç‚¹';
      case 'restaurant': return 'é¤å…';
      case 'hotel': return 'é…’åº—';
      default: return 'å…¶ä»–';
    }
  }

  private getTypeColor(type: string): string {
    switch (type) {
      case 'activity': return '#10b981';
      case 'place': return '#3b82f6';
      case 'restaurant': return '#f59e0b';
      case 'hotel': return '#8b5cf6';
      default: return '#6b7280';
    }
  }

  private getTypeBgColor(type: string): string {
    switch (type) {
      case 'activity': return '#d1fae5';
      case 'place': return '#dbeafe';
      case 'restaurant': return '#fef3c7';
      case 'hotel': return '#ede9fe';
      default: return '#f3f4f6';
    }
  }

  private viewDetail(id: string, type: string): void {
    // æ ¹æ®ç±»å‹è·³è½¬åˆ°ä¸åŒçš„è¯¦æƒ…é¡µé¢
    const routeMap: Record<string, string> = {
      'activity': 'pages/activity/ActivityDetailPage',
      'place': 'pages/place/PlaceDetailPage',
      'restaurant': 'pages/restaurant/RestaurantDetailPage',
      'hotel': 'pages/hotel/HotelDetailPage'
    };

    const url = routeMap[type];
    if (url) {
      router.pushUrl({
        url: url,
        params: { id: id }
      }).catch((error: Error) => {
        console.error('è·³è½¬è¯¦æƒ…é¡µå¤±è´¥:', error.message);
      });
    } else {
      console.error('æœªçŸ¥çš„è¯¦æƒ…é¡µç±»å‹:', type);
    }
  }

  private removeFavorite(id: string): void {
    const index = this.favoriteList.findIndex(item => item.id === id);
    if (index !== -1) {
      this.favoriteList.splice(index, 1);
    }
  }
}
