import { router, promptAction } from "@kit.ArkUI";
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface SettingItem {
  id: string;
  title: string;
  subtitle?: string;
  type: 'switch' | 'arrow' | 'button';
  value?: boolean;
  icon: string;
  color?: string;
}

@Entry
@Component
export struct SettingsPage {
  @State notificationEnabled: boolean = true;
  @State locationEnabled: boolean = true;
  @State autoUpdateEnabled: boolean = false;
  @State darkModeEnabled: boolean = false;
  @State cacheSize: string = '125.6 MB';

  private accountSettings: SettingItem[] = [
    { id: '1', title: 'ä¸ªäººèµ„æ–™', subtitle: 'ç¼–è¾‘ä¸ªäººä¿¡æ¯', type: 'arrow', icon: 'ğŸ‘¤', color: '#3b82f6' },
    { id: '2', title: 'è´¦æˆ·å®‰å…¨', subtitle: 'å¯†ç ã€æ‰‹æœºå·ç­‰', type: 'arrow', icon: 'ğŸ”’', color: '#10b981' },
    { id: '3', title: 'éšç§è®¾ç½®', subtitle: 'æ•°æ®ä½¿ç”¨æƒé™', type: 'arrow', icon: 'ğŸ›¡ï¸', color: '#f59e0b' },
    { id: '4', title: 'ä¼šå‘˜ä¸­å¿ƒ', subtitle: 'æŸ¥çœ‹ä¼šå‘˜æƒç›Š', type: 'arrow', icon: 'ğŸ‘‘', color: '#8b5cf6' }
  ];

  private appSettings: SettingItem[] = [
    { id: '5', title: 'æ¶ˆæ¯é€šçŸ¥', subtitle: 'æ¥æ”¶æ´»åŠ¨æé†’', type: 'switch', icon: 'ğŸ””', color: '#ef4444' },
    { id: '6', title: 'ä½ç½®æœåŠ¡', subtitle: 'è·å–é™„è¿‘æ´»åŠ¨', type: 'switch', icon: 'ğŸ“', color: '#3b82f6' },
    { id: '7', title: 'è‡ªåŠ¨æ›´æ–°', subtitle: 'WiFiä¸‹è‡ªåŠ¨æ›´æ–°', type: 'switch', icon: 'ğŸ”„', color: '#10b981' },
    { id: '8', title: 'æ·±è‰²æ¨¡å¼', subtitle: 'æŠ¤çœ¼æ¨¡å¼', type: 'switch', icon: 'ğŸŒ™', color: '#6b7280' }
  ];

  private otherSettings: SettingItem[] = [
    { id: '9', title: 'æ¸…é™¤ç¼“å­˜', subtitle: this.cacheSize, type: 'button', icon: 'ğŸ—‘ï¸', color: '#f59e0b' },
    { id: '10', title: 'æ£€æŸ¥æ›´æ–°', subtitle: 'å½“å‰ç‰ˆæœ¬ v1.0.0', type: 'button', icon: 'ğŸ“±', color: '#3b82f6' },
    { id: '11', title: 'æ„è§åé¦ˆ', subtitle: 'å¸®åŠ©æˆ‘ä»¬æ”¹è¿›', type: 'arrow', icon: 'ğŸ’¬', color: '#10b981' },
    { id: '12', title: 'å…³äºæˆ‘ä»¬', subtitle: 'SmartTravel v1.0.0', type: 'arrow', icon: 'â„¹ï¸', color: '#6b7280' }
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'è®¾ç½®',
        showBack: true,
        showSearch: false,
        showNotification: false
      })

      Scroll() {
        Column() {
          // è´¦æˆ·è®¾ç½®
          this.SettingsSection('è´¦æˆ·è®¾ç½®', this.accountSettings)

          // åº”ç”¨è®¾ç½®
          this.SettingsSection('åº”ç”¨è®¾ç½®', this.appSettings)

          // å…¶ä»–è®¾ç½®
          this.SettingsSection('å…¶ä»–', this.otherSettings)

          // é€€å‡ºç™»å½•
          this.LogoutSection()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }

  @Builder SettingsSection(title: string, items: SettingItem[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })

      Column() {
        ForEach(items, (item: SettingItem, index: number) => {
          this.SettingItem(item, index === items.length - 1)
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({
        radius: 4,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: 2
      })
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  @Builder SettingItem(item: SettingItem, isLast: boolean) {
    Row() {
      // å›¾æ ‡
      Text(item.icon)
        .fontSize(20)
        .width(24)
        .height(24)
        .textAlign(TextAlign.Center)
        .margin({ right: 12 })

      // å†…å®¹
      Column() {
        Text(item.title)
          .fontSize(16)
          .fontColor('#1f2937')
          .margin({ bottom: 2 })

        if (item.subtitle) {
          Text(item.subtitle)
            .fontSize(12)
            .fontColor('#6b7280')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // å³ä¾§æ§ä»¶
      if (item.type === 'switch') {
        Toggle({ type: ToggleType.Switch, isOn: this.getSwitchValue(item.id) })
          .onChange((isOn: boolean) => {
            this.handleSwitchChange(item.id, isOn);
          })
      } else if (item.type === 'arrow') {
        Text('>')
          .fontSize(16)
          .fontColor('#9ca3af')
      } else if (item.type === 'button') {
        Button('æ“ä½œ')
          .fontSize(12)
          .fontColor(item.color || '#3b82f6')
          .backgroundColor(this.getButtonBgColor(item.color || '#3b82f6'))
          .borderRadius(6)
          .padding({ left: 12, right: 12, top: 4, bottom: 4 })
          .onClick(() => {
            this.handleButtonClick(item.id);
          })
      }
    }
    .width('100%')
    .padding(16)
    .onClick(() => {
      if (item.type === 'arrow') {
        this.handleArrowClick(item.id);
      }
    })

    // åˆ†å‰²çº¿
    if (!isLast) {
      Divider()
        .color('#f3f4f6')
        .margin({ left: 52, right: 16 })
    }
  }

  @Builder LogoutSection() {
    Column() {
      Button('é€€å‡ºç™»å½•')
        .fontSize(16)
        .fontColor('#ef4444')
        .backgroundColor('#fef2f2')
        .borderRadius(12)
        .width('100%')
        .height(48)
        .onClick(() => {
          this.logout();
        })
    }
    .width('100%')
    .margin({ top: 20 })
  }

  private getSwitchValue(id: string): boolean {
    switch (id) {
      case '5': return this.notificationEnabled;
      case '6': return this.locationEnabled;
      case '7': return this.autoUpdateEnabled;
      case '8': return this.darkModeEnabled;
      default: return false;
    }
  }

  private handleSwitchChange(id: string, value: boolean): void {
    switch (id) {
      case '5':
        this.notificationEnabled = value;
        break;
      case '6':
        this.locationEnabled = value;
        break;
      case '7':
        this.autoUpdateEnabled = value;
        break;
      case '8':
        this.darkModeEnabled = value;
        break;
    }
  }

  private handleArrowClick(id: string): void {
    switch (id) {
      case '1':
        // ä¸ªäººèµ„æ–™ç¼–è¾‘ - åŠŸèƒ½å¼€å‘ä¸­
        promptAction.showToast({ 
          message: 'ä¸ªäººèµ„æ–™ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
          duration: 2000
        });
        break;
      case '2':
        // è´¦æˆ·å®‰å…¨ - åŠŸèƒ½å¼€å‘ä¸­
        promptAction.showToast({ 
          message: 'è´¦æˆ·å®‰å…¨åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
          duration: 2000
        });
        break;
      case '3':
        // éšç§è®¾ç½® - åŠŸèƒ½å¼€å‘ä¸­
        promptAction.showToast({ 
          message: 'éšç§è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
          duration: 2000
        });
        break;
      case '4':
        // ä¼šå‘˜ä¸­å¿ƒ - åŠŸèƒ½å¼€å‘ä¸­
        promptAction.showToast({ 
          message: 'ä¼šå‘˜ä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
          duration: 2000
        });
        break;
      case '11':
        // æ„è§åé¦ˆ - è·³è½¬åˆ°å¸®åŠ©ä¸åé¦ˆé¡µ
        try {
          router.pushUrl({ url: 'pages/profile/HelpFeedbackPage' });
        } catch (error) {
          console.error('Failed to navigate to HelpFeedbackPage:', error);
          promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥' });
        }
        break;
      case '12':
        // å…³äºæˆ‘ä»¬ - åŠŸèƒ½å¼€å‘ä¸­
        promptAction.showToast({ 
          message: 'å…³äºæˆ‘ä»¬åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
          duration: 2000
        });
        break;
    }
  }

  private handleButtonClick(id: string): void {
    switch (id) {
      case '9':
        this.clearCache();
        break;
      case '10':
        this.checkUpdate();
        break;
    }
  }

  private getButtonBgColor(color: string): string {
    switch (color) {
      case '#3b82f6': return '#dbeafe';
      case '#10b981': return '#d1fae5';
      case '#f59e0b': return '#fef3c7';
      case '#ef4444': return '#fee2e2';
      case '#8b5cf6': return '#ede9fe';
      case '#6b7280': return '#f3f4f6';
      default: return '#f3f4f6';
    }
  }

  private clearCache(): void {
    // æ¸…é™¤ç¼“å­˜é€»è¾‘
    this.cacheSize = '0 MB';
    console.log('ç¼“å­˜å·²æ¸…é™¤');
  }

  private checkUpdate(): void {
    // æ£€æŸ¥æ›´æ–°é€»è¾‘
    console.log('æ£€æŸ¥æ›´æ–°ä¸­...');
  }

  private logout(): void {
    // é€€å‡ºç™»å½•é€»è¾‘
    console.log('é€€å‡ºç™»å½•');
    promptAction.showToast({ 
      message: 'é€€å‡ºç™»å½•åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…',
      duration: 2000
    });
    // TODO: å®ç°é€€å‡ºç™»å½•é€»è¾‘å’Œç™»å½•é¡µé¢åï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
    // router.replaceUrl({ url: 'pages/login/LoginPage' });
  }
}
