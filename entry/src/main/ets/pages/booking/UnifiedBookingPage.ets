import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface ActivityInfo {
  id: string;
  name: string;
  image: string;
  price: number;
  originalPrice?: number;
  description: string;
  validDate: string;
  location: string;
  features: string[];
  notices: string[];
  isFree: boolean;
  type: 'ticket' | 'signup';
}

interface BookingInfo {
  ticketCount: number;
  selectedDate: string;
  contactName: string;
  contactPhone: string;
  idCard: string;
  gender: 'ç”·' | 'å¥³' | '';
  age: number;
  totalPrice: number;
}

interface PaymentMethod {
  id: string;
  name: string;
  icon: string;
  enabled: boolean;
}

@Entry
@Component
export struct UnifiedBookingPage {
  @State activityInfo: ActivityInfo = {} as ActivityInfo;
  @State bookingInfo: BookingInfo = {
    ticketCount: 1,
    selectedDate: '',
    contactName: '',
    contactPhone: '',
    idCard: '',
    gender: '',
    age: 0,
    totalPrice: 0
  };
  @State isLoading: boolean = true;
  @State showDatePicker: boolean = false;
  @State showPaymentMethods: boolean = false;
  @State selectedPaymentMethod: string = '';
  @State availableDates: string[] = [];
  
  private paymentMethods: PaymentMethod[] = [
    { id: 'wechat', name: 'å¾®ä¿¡æ”¯ä»˜', icon: 'ğŸ’š', enabled: true },
    { id: 'alipay', name: 'æ”¯ä»˜å®', icon: 'ğŸ”µ', enabled: true },
    { id: 'bankcard', name: 'é“¶è¡Œå¡', icon: 'ğŸ’³', enabled: true },
    { id: 'creditcard', name: 'ä¿¡ç”¨å¡', icon: 'ğŸ’', enabled: true }
  ];

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    const activityId = params['id'] as string || '1';
    const activityName = params['name'] as string || 'æ´»åŠ¨';
    const price = params['price'] as number || 0;
    this.loadActivityInfo(activityId, activityName, price);
    this.generateAvailableDates();
  }

  private loadActivityInfo(activityId: string, activityName: string, price: number) {
    setTimeout(() => {
      this.activityInfo = {
        id: activityId,
        name: activityName,
        image: 'ğŸ«',
        price: price,
        originalPrice: price > 0 ? price + 20 : 0,
        description: price === 0 ? 'å…è´¹å‚ä¸æ´»åŠ¨ï¼Œéœ€è¦æå‰æŠ¥å' : 'ç²¾å½©æ´»åŠ¨ï¼Œç«‹å³è´­ç¥¨å‚ä¸',
        validDate: '2025å¹´10æœˆ10æ—¥ - 2025å¹´10æœˆ12æ—¥',
        location: 'æ·±åœ³å¸‚å—å±±åŒº',
        features: price === 0 ? ['å…è´¹å‚ä¸', 'æå‰æŠ¥å', 'èº«ä»½éªŒè¯'] : ['ç”µå­ç¥¨', 'å¿«é€Ÿå…¥åœº', 'é€€æ”¹ä¿éšœ'],
        notices: price === 0 ? ['è¯·æºå¸¦èº«ä»½è¯ä»¶', 'æå‰30åˆ†é’Ÿåˆ°åœº', 'æ´»åŠ¨å½“å¤©ç­¾åˆ°'] : ['è¯·åœ¨æœ‰æ•ˆæœŸå†…ä½¿ç”¨', 'ä¸€ç»å”®å‡ºæ¦‚ä¸é€€æ¢', 'è¯·å¦¥å–„ä¿ç®¡ç¥¨æ®'],
        isFree: price === 0,
        type: price === 0 ? 'signup' : 'ticket'
      };
      this.updateTotalPrice();
      this.isLoading = false;
    }, 500);
  }

  private generateAvailableDates() {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 1; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      dates.push(date.toLocaleDateString('zh-CN'));
    }
    this.availableDates = dates;
  }

  private updateTotalPrice() {
    this.bookingInfo.totalPrice = this.activityInfo.price * this.bookingInfo.ticketCount;
  }

  private onTicketCountChange(delta: number) {
    const newCount = this.bookingInfo.ticketCount + delta;
    if (newCount >= 1 && newCount <= 10) {
      this.bookingInfo.ticketCount = newCount;
      this.updateTotalPrice();
    }
  }

  private onConfirmBooking() {
    if (!this.validateBookingInfo()) {
      return;
    }

    if (this.activityInfo.isFree) {
      // å…è´¹æŠ¥åï¼Œç›´æ¥è·³è½¬åˆ°ç¡®è®¤é¡µé¢
      this.navigateToConfirmPage();
    } else {
      // ä»˜è´¹è´­ç¥¨ï¼Œæ˜¾ç¤ºæ”¯ä»˜æ–¹å¼é€‰æ‹©
      this.showPaymentMethods = true;
    }
  }

  private validateBookingInfo(): boolean {
    if (!this.bookingInfo.contactName.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»äººå§“å');
      return false;
    }
    if (!this.bookingInfo.contactPhone.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»äººç”µè¯');
      return false;
    }
    if (!this.bookingInfo.selectedDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©æ´»åŠ¨æ—¥æœŸ');
      return false;
    }
    if (this.activityInfo.type === 'signup') {
      if (!this.bookingInfo.idCard.trim()) {
        ErrorHandler.showToast('è¯·è¾“å…¥èº«ä»½è¯å·');
        return false;
      }
      if (!this.bookingInfo.gender) {
        ErrorHandler.showToast('è¯·é€‰æ‹©æ€§åˆ«');
        return false;
      }
      if (this.bookingInfo.age <= 0) {
        ErrorHandler.showToast('è¯·è¾“å…¥æ­£ç¡®çš„å¹´é¾„');
        return false;
      }
    }
    return true;
  }

  private onPaymentMethodSelected(methodId: string) {
    this.selectedPaymentMethod = methodId;
    this.showPaymentMethods = false;
    this.processPayment(methodId);
  }

  private processPayment(methodId: string) {
    const method = this.paymentMethods.find(m => m.id === methodId);
    if (!method) return;

    ErrorHandler.showToast(`æ­£åœ¨è·³è½¬åˆ°${method.name}...`);
    
    // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
    setTimeout(() => {
      this.navigateToPaymentPage(methodId);
    }, 1000);
  }

  private navigateToConfirmPage() {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/order/OrderConfirmPage',
        params: {
          activityInfo: this.activityInfo,
          bookingInfo: this.bookingInfo
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç¡®è®¤é¡µé¢'));
  }

  private navigateToPaymentPage(paymentMethod: string) {
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/payment/PaymentPage',
        params: {
          orderInfo: {
            orderId: 'ST' + Date.now().toString(),
            activityName: this.activityInfo.name,
            totalPrice: this.bookingInfo.totalPrice,
            paymentMethod: paymentMethod
          },
          bookingInfo: this.bookingInfo
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ”¯ä»˜é¡µé¢'));
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'ç»Ÿä¸€é¢„è®¢',
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.ActivityInfoCard()
            this.BookingFormSection()
            if (!this.activityInfo.isFree) {
              this.PriceSection()
            }
            this.NoticesSection()
          }
          .padding(16)
        }
        .layoutWeight(1)

        this.BottomActionBar()
      }

      if (this.showPaymentMethods) {
        this.PaymentMethodsDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder LoadingView() {
    Column() {
      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder ActivityInfoCard() {
    Column() {
      Row() {
        Text(this.activityInfo.image)
          .fontSize(40)
          .margin({ right: 12 })

        Column() {
          Text(this.activityInfo.name)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.activityInfo.description)
            .fontSize(14)
            .fontColor('#6b7280')
            .margin({ top: 4 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          if (this.activityInfo.isFree) {
            Text('å…è´¹æ´»åŠ¨')
              .fontSize(16)
              .fontColor('#22c55e')
              .fontWeight(FontWeight.Bold)
              .margin({ top: 8 })
          } else {
            Row() {
              Text(`Â¥${this.activityInfo.price}`)
                .fontSize(20)
                .fontColor('#ef4444')
                .fontWeight(FontWeight.Bold)
              
              if (this.activityInfo.originalPrice && this.activityInfo.originalPrice > this.activityInfo.price) {
                Text(`Â¥${this.activityInfo.originalPrice}`)
                  .fontSize(14)
                  .fontColor('#9ca3af')
                  .decoration({ type: TextDecorationType.LineThrough })
                  .margin({ left: 8 })
              }
            }
            .margin({ top: 8 })
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  @Builder BookingFormSection() {
    Column() {
      Text(this.activityInfo.isFree ? 'æŠ¥åä¿¡æ¯' : 'é¢„è®¢ä¿¡æ¯')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 16 })

      // æ•°é‡é€‰æ‹©ï¼ˆä»˜è´¹æ´»åŠ¨ï¼‰
      if (!this.activityInfo.isFree) {
        Row() {
          Text('è´­ä¹°æ•°é‡')
            .fontSize(14)
            .fontColor('#374151')
            .layoutWeight(1)

          Row() {
            Button('-')
              .width(32)
              .height(32)
              .fontSize(16)
              .backgroundColor('#f3f4f6')
              .fontColor('#374151')
              .onClick(() => this.onTicketCountChange(-1))

            Text(this.bookingInfo.ticketCount.toString())
              .fontSize(16)
              .fontColor('#1f2937')
              .width(40)
              .textAlign(TextAlign.Center)

            Button('+')
              .width(32)
              .height(32)
              .fontSize(16)
              .backgroundColor('#f3f4f6')
              .fontColor('#374151')
              .onClick(() => this.onTicketCountChange(1))
          }
        }
        .width('100%')
        .margin({ bottom: 16 })
      }

      // æ—¥æœŸé€‰æ‹©
      Row() {
        Text('æ´»åŠ¨æ—¥æœŸ')
          .fontSize(14)
          .fontColor('#374151')
          .layoutWeight(1)

        Text(this.bookingInfo.selectedDate || 'è¯·é€‰æ‹©æ—¥æœŸ')
          .fontSize(14)
          .fontColor(this.bookingInfo.selectedDate ? '#1f2937' : '#9ca3af')
          .onClick(() => {
            this.showDatePicker = true;
          })
      }
      .width('100%')
      .margin({ bottom: 16 })

      // è”ç³»äººä¿¡æ¯
      Column() {
        TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»äººå§“å' })
          .fontSize(14)
          .height(44)
          .backgroundColor('#f9fafb')
          .onChange((value: string) => {
            this.bookingInfo.contactName = value;
          })
          .margin({ bottom: 12 })

        TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»äººç”µè¯' })
          .fontSize(14)
          .height(44)
          .backgroundColor('#f9fafb')
          .type(InputType.PhoneNumber)
          .onChange((value: string) => {
            this.bookingInfo.contactPhone = value;
          })
          .margin({ bottom: 12 })

        // æŠ¥åæ´»åŠ¨éœ€è¦é¢å¤–ä¿¡æ¯
        if (this.activityInfo.type === 'signup') {
          TextInput({ placeholder: 'è¯·è¾“å…¥èº«ä»½è¯å·' })
            .fontSize(14)
            .height(44)
            .backgroundColor('#f9fafb')
            .onChange((value: string) => {
              this.bookingInfo.idCard = value;
            })
            .margin({ bottom: 12 })

          Row() {
            Text('æ€§åˆ«')
              .fontSize(14)
              .fontColor('#374151')
              .margin({ right: 16 })

            Radio({ value: 'ç”·', group: 'gender' })
              .checked(this.bookingInfo.gender === 'ç”·')
              .onChange((isChecked: boolean) => {
                if (isChecked) this.bookingInfo.gender = 'ç”·';
              })
            Text('ç”·')
              .fontSize(14)
              .margin({ right: 16 })

            Radio({ value: 'å¥³', group: 'gender' })
              .checked(this.bookingInfo.gender === 'å¥³')
              .onChange((isChecked: boolean) => {
                if (isChecked) this.bookingInfo.gender = 'å¥³';
              })
            Text('å¥³')
              .fontSize(14)
          }
          .width('100%')
          .margin({ bottom: 12 })

          TextInput({ placeholder: 'è¯·è¾“å…¥å¹´é¾„' })
            .fontSize(14)
            .height(44)
            .backgroundColor('#f9fafb')
            .type(InputType.Number)
            .onChange((value: string) => {
              this.bookingInfo.age = parseInt(value) || 0;
            })
            .margin({ bottom: 12 })
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder PriceSection() {
    Column() {
      Text('è´¹ç”¨æ˜ç»†')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 16 })

      Row() {
        Text(`${this.activityInfo.name} Ã— ${this.bookingInfo.ticketCount}`)
          .fontSize(14)
          .fontColor('#374151')
          .layoutWeight(1)

        Text(`Â¥${this.activityInfo.price * this.bookingInfo.ticketCount}`)
          .fontSize(14)
          .fontColor('#1f2937')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Divider()
        .color('#e5e7eb')
        .margin({ top: 8, bottom: 8 })

      Row() {
        Text('æ€»è®¡')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1)

        Text(`Â¥${this.bookingInfo.totalPrice}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ef4444')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder NoticesSection() {
    Column() {
      Text('æ³¨æ„äº‹é¡¹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .margin({ bottom: 12 })

      ForEach(this.activityInfo.notices, (notice: string, index: number) => {
        Text(`${index + 1}. ${notice}`)
          .fontSize(12)
          .fontColor('#6b7280')
          .margin({ bottom: 4 })
          .width('100%')
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder BottomActionBar() {
    Row() {
      if (!this.activityInfo.isFree) {
        Column() {
          Text('æ€»è®¡')
            .fontSize(12)
            .fontColor('#6b7280')
          Text(`Â¥${this.bookingInfo.totalPrice}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ef4444')
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ right: 16 })
      }

      Button(this.activityInfo.isFree ? 'ç«‹å³æŠ¥å' : 'ç«‹å³è´­ç¥¨')
        .layoutWeight(1)
        .height(48)
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor(this.activityInfo.isFree ? '#22c55e' : '#ef4444')
        .borderRadius(24)
        .onClick(() => this.onConfirmBooking())
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#e5e7eb' })
  }

  @Builder PaymentMethodsDialog() {
    Column() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showPaymentMethods = false;
        })

      // æ”¯ä»˜æ–¹å¼é€‰æ‹©é¢æ¿
      Column() {
        Row() {
          Text('é€‰æ‹©æ”¯ä»˜æ–¹å¼')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Text('âœ•')
            .fontSize(20)
            .fontColor('#6b7280')
            .onClick(() => {
              this.showPaymentMethods = false;
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .border({ width: { bottom: 1 }, color: '#e5e7eb' })

        Column() {
          ForEach(this.paymentMethods, (method: PaymentMethod) => {
            if (method.enabled) {
              Row() {
                Text(method.icon)
                  .fontSize(24)
                  .margin({ right: 12 })

                Text(method.name)
                  .fontSize(16)
                  .fontColor('#1f2937')
                  .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor('#9ca3af')
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .onClick(() => this.onPaymentMethodSelected(method.id))
              .border({ width: { bottom: 1 }, color: '#f3f4f6' })
            }
          })

          Text('æ”¯æŒåˆ·è„¸æ”¯ä»˜å’Œå¯†ç æ”¯ä»˜')
            .fontSize(12)
            .fontColor('#9ca3af')
            .margin({ top: 16, bottom: 20 })
        }
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius({ topLeft: 16, topRight: 16 })
      .position({ x: 0, y: '100%' })
      .translate({ x: 0, y: -300 })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(999)
  }
}
