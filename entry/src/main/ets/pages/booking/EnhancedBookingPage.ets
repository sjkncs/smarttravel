import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface TicketType {
  id: string;
  name: string;
  price: number;
  originalPrice?: number;
  description: string;
  ageRange: string;
}

interface PaymentMethod {
  id: string;
  name: string;
  icon: string;
  color: string;
}

interface OrderTicket {
  ticketId: string;
  ticketName: string;
  price: number;
  count: number;
}

interface OrderInfo {
  orderId: string;
  activityName: string;
  selectedTickets: OrderTicket[];
  selectedDate: string;
  contactName: string;
  contactPhone: string;
  totalPrice: number;
  createTime: string;
}

interface ActivityInfo {
  id: string;
  name: string;
  image: string;
  ticketTypes: TicketType[];
  description: string;
  validDate: string;
  location: string;
  features: string[];
  notices: string[];
  category: 'scenic' | 'cultural' | 'entertainment';
}

interface BookingInfo {
  selectedTickets: Map<string, number>;
  selectedDate: string;
  contactName: string;
  contactPhone: string;
  totalPrice: number;
}

@Entry
@Component
export struct EnhancedBookingPage {
  @State activityInfo: ActivityInfo = {} as ActivityInfo;
  @State bookingInfo: BookingInfo = {
    selectedTickets: new Map(),
    selectedDate: '',
    contactName: '',
    contactPhone: '',
    totalPrice: 0
  };
  @State isLoading: boolean = true;
  @State showDatePicker: boolean = false;
  @State showPaymentMethods: boolean = false;
  @State selectedPaymentMethod: string = '';
  @State availableDates: string[] = [];
  @State selectedDateIndex: number = 0;

  private paymentMethods: PaymentMethod[] = [
    { id: 'wechat', name: 'å¾®ä¿¡æ”¯ä»˜', icon: 'ğŸŸ¢', color: '#07C160' },
    { id: 'alipay', name: 'æ”¯ä»˜å®', icon: 'ğŸ”µ', color: '#1677FF' },
    { id: 'unionpay', name: 'é“¶è”æ”¯ä»˜', icon: 'ğŸ”´', color: '#E21F27' }
  ];

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    const activityId = params['id'] as string || '1';
    this.loadActivityInfo(activityId);
    this.generateAvailableDates();
  }

  private loadActivityInfo(activityId: string) {
    setTimeout(() => {
      // æ¨¡æ‹ŸçœŸå®æ™¯åŒºå®šä»·
      this.activityInfo = {
        id: activityId,
        name: 'æ·±åœ³ä¸–ç•Œä¹‹çª—',
        image: 'ğŸ›ï¸',
        category: 'scenic',
        ticketTypes: [
          {
            id: 'adult',
            name: 'æˆäººç¥¨',
            price: 220,
            originalPrice: 260,
            description: 'é€‚ç”¨äº18-59å‘¨å²æˆäºº',
            ageRange: '18-59å²'
          },
          {
            id: 'child',
            name: 'å„¿ç«¥ç¥¨',
            price: 110,
            description: 'é€‚ç”¨äº3-17å‘¨å²å„¿ç«¥',
            ageRange: '3-17å²'
          },
          {
            id: 'senior',
            name: 'é•¿è€…ç¥¨',
            price: 110,
            description: 'é€‚ç”¨äº60å‘¨å²ä»¥ä¸Šé•¿è€…',
            ageRange: '60å²ä»¥ä¸Š'
          },
          {
            id: 'student',
            name: 'å­¦ç”Ÿç¥¨',
            price: 165,
            description: 'å…¨æ—¥åˆ¶åœ¨æ ¡å­¦ç”Ÿå‡­å­¦ç”Ÿè¯',
            ageRange: 'å­¦ç”Ÿè¯'
          }
        ],
        description: 'ä¸–ç•Œæ–‡åŒ–ç²¾ç²¹ï¼Œä¸€æ—¥æ¸¸éå…¨çƒ',
        validDate: 'å½“æ—¥æœ‰æ•ˆï¼Œè¿‡æœŸä½œåºŸ',
        location: 'æ·±åœ³å¸‚å—å±±åŒºæ·±å—å¤§é“9037å·',
        features: ['ç”µå­ç¥¨', 'éšä¹°éšç”¨', 'æ— éœ€æ¢ç¥¨'],
        notices: ['è¯·æºå¸¦æœ‰æ•ˆèº«ä»½è¯ä»¶', 'é—¨ç¥¨å½“æ—¥æœ‰æ•ˆ', 'ä¸€ç»å”®å‡ºæ¦‚ä¸é€€æ¢']
      };
      this.isLoading = false;
    }, 500);
  }

  private generateAvailableDates() {
    const dates: string[] = [];
    const today = new Date();
    for (let i = 0; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateStr = date.toLocaleDateString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        weekday: 'short'
      });
      dates.push(dateStr);
    }
    this.availableDates = dates;
  }

  private updateTicketCount(ticketId: string, delta: number) {
    const currentCount = this.bookingInfo.selectedTickets.get(ticketId) || 0;
    const newCount = Math.max(0, Math.min(9, currentCount + delta));
    
    if (newCount === 0) {
      this.bookingInfo.selectedTickets.delete(ticketId);
    } else {
      this.bookingInfo.selectedTickets.set(ticketId, newCount);
    }
    
    this.calculateTotalPrice();
  }

  private calculateTotalPrice() {
    let total = 0;
    this.bookingInfo.selectedTickets.forEach((count, ticketId) => {
      const ticket = this.activityInfo.ticketTypes.find(t => t.id === ticketId);
      if (ticket) {
        total += ticket.price * count;
      }
    });
    this.bookingInfo.totalPrice = total;
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'é—¨ç¥¨é¢„è®¢',
        showBack: true
      })

      if (this.isLoading) {
        this.LoadingView()
      } else {
        Scroll() {
          Column() {
            this.ActivityHeader()
            this.TicketSelection()
            this.DateSelection()
            this.ContactInfo()
            this.PaymentMethodSelection()
            this.OrderSummary()
          }
          .padding(16)
        }
        .layoutWeight(1)

        this.BottomBar()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder LoadingView() {
    Column() {
      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor('#999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder ActivityHeader() {
    Column() {
      Row() {
        Text(this.activityInfo.image)
          .fontSize(48)
          .margin({ right: 16 })

        Column() {
          Text(this.activityInfo.name)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')

          Text(this.activityInfo.description)
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 4 })

          Text(this.activityInfo.location)
            .fontSize(12)
            .fontColor('#999')
            .margin({ top: 8 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  @Builder TicketSelection() {
    Column() {
      Text('é€‰æ‹©é—¨ç¥¨')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1a1a1a')
        .margin({ bottom: 16 })

      ForEach(this.activityInfo.ticketTypes, (ticket: TicketType) => {
        Column() {
          Row() {
            Column() {
              Text(ticket.name)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1a1a1a')

              Text(ticket.description)
                .fontSize(12)
                .fontColor('#666')
                .margin({ top: 2 })

              Row() {
                Text(`Â¥${ticket.price}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ff4444')

                if (ticket.originalPrice && ticket.originalPrice > ticket.price) {
                  Text(`Â¥${ticket.originalPrice}`)
                    .fontSize(14)
                    .fontColor('#999')
                    .decoration({ type: TextDecorationType.LineThrough })
                    .margin({ left: 8 })
                }
              }
              .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            Row() {
              Button('-')
                .width(32)
                .height(32)
                .fontSize(18)
                .backgroundColor('#f0f0f0')
                .fontColor('#666')
                .onClick(() => this.updateTicketCount(ticket.id, -1))

              Text((this.bookingInfo.selectedTickets.get(ticket.id) || 0).toString())
                .fontSize(16)
                .fontColor('#1a1a1a')
                .width(40)
                .textAlign(TextAlign.Center)

              Button('+')
                .width(32)
                .height(32)
                .fontSize(18)
                .backgroundColor('#007AFF')
                .fontColor(Color.White)
                .onClick(() => this.updateTicketCount(ticket.id, 1))
            }
          }
          .width('100%')
          .padding(16)
        }
        .width('100%')
        .backgroundColor(Color.White)
        .borderRadius(8)
        .margin({ bottom: 8 })
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 12 })
  }

  @Builder DateSelection() {
    Column() {
      Row() {
        Text('é€‰æ‹©æ—¥æœŸ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        // Date text container with flex: 1 to take remaining space
        Column() {
          if (this.bookingInfo.selectedDate) {
            Text(this.bookingInfo.selectedDate)
              .fontSize(16)
              .fontColor('#1677FF')
          } else {
            Text('è¯·é€‰æ‹©æ—¥æœŸ')
              .fontSize(16)
              .fontColor('#999')
          }
        }
        .margin({ left: 12 })
        .width('100%')

        // Calendar icon
        Text('ğŸ“…')
          .fontSize(20)
      }
      .width('100%')
      .height(48)
        .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .borderRadius(8)
      .onClick(() => {
        this.showDatePicker = true;
      })

      // æ—¥æœŸé€‰æ‹©å™¨å¼¹çª—
      if (this.showDatePicker) {
        Column() {
          Text('é€‰æ‹©æ—¥æœŸ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 16 })

          Grid() {
            ForEach(this.availableDates, (date: string, index: number) => {
              GridItem() {
                Text(date)
                  .fontSize(14)
                  .fontColor(this.bookingInfo.selectedDate === date ? Color.White : '#1a1a1a')
                  .backgroundColor(this.bookingInfo.selectedDate === date ? '#007AFF' : Color.White)
                  .width(60)
                  .height(40)
                  .textAlign(TextAlign.Center)
                  .borderRadius(8)
                  .border({ width: 1, color: '#e0e0e0' })
                  .onClick(() => {
                    this.bookingInfo.selectedDate = date;
                    this.showDatePicker = false;
                  })
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr 1fr')
          .rowsGap(8)
          .columnsGap(8)
          .height(200)

          Button('å–æ¶ˆ')
            .width('100%')
            .margin({ top: 16 })
            .onClick(() => {
              this.showDatePicker = false;
            })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({ radius: 8, color: '#00000020' })
        .margin({ top: 16 })
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 12 })
  }

  @Builder ContactInfo() {
    Column() {
      Text('è”ç³»äººä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
        .width('100%')
        .textAlign(TextAlign.Start)

      TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»äººå§“å' })
        .fontSize(16)
        .height(48)
        .backgroundColor(Color.White)
        .borderRadius(8)
        .margin({ bottom: 12 })
        .onChange((value: string) => {
          this.bookingInfo.contactName = value;
        })

      TextInput({ placeholder: 'è¯·è¾“å…¥è”ç³»äººæ‰‹æœºå·' })
        .fontSize(16)
        .height(48)
        .backgroundColor(Color.White)
        .borderRadius(8)
        .type(InputType.PhoneNumber)
        .onChange((value: string) => {
          this.bookingInfo.contactPhone = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 12 })
  }

  @Builder PaymentMethodSelection() {
    Column() {
      Text('æ”¯ä»˜æ–¹å¼')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
        .width('100%')
        .textAlign(TextAlign.Start)

      ForEach(this.paymentMethods, (method: PaymentMethod) => (
        Row() {
          Text(method.icon)
            .fontSize(24)
            .margin({ right: 12 })
          
          Text(method.name)
            .fontSize(16)
            .fontColor('#1a1a1a')
            .layoutWeight(1)
          
          if (this.selectedPaymentMethod === method.id) {
            Text('âœ“')
              .fontSize(16)
              .fontColor('#1677FF')
          }
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)
        .borderRadius(8)
        .onClick(() => {
          this.selectedPaymentMethod = method.id;
        })
      ))
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder OrderSummary() {
    Column() {
      Text('è®¢å•æ˜ç»†')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1a1a1a')
        .margin({ bottom: 16 })

      ForEach(Array.from(this.bookingInfo.selectedTickets.entries()).filter(entry => {
        const ticketId = entry[0];
        return this.activityInfo.ticketTypes.find(t => t.id === ticketId) !== undefined;
      }), (entry: [string, number]) => {
        Row() {
          Text(`${this.activityInfo.ticketTypes.find(t => t.id === entry[0])?.name || ''} Ã— ${entry[1]}`)
            .fontSize(14)
            .fontColor('#666')
            .layoutWeight(1)

          Text(`Â¥${(this.activityInfo.ticketTypes.find(t => t.id === entry[0])?.price || 0) * entry[1]}`)
            .fontSize(14)
            .fontColor('#1a1a1a')
        }
        .width('100%')
        .margin({ bottom: 8 })
      })

      Divider()
        .color('#eee')
        .margin({ top: 12, bottom: 12 })

      Row() {
        Text('æ€»è®¡')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1a1a1a')
          .layoutWeight(1)

        Text(`Â¥${this.bookingInfo.totalPrice}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ff4444')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .alignItems(HorizontalAlign.Start)
  }

  private validateForm(): boolean {
    if (this.bookingInfo.selectedTickets.size === 0) {
      // Show error: Please select at least one ticket
      return false;
    }
    
    if (!this.bookingInfo.selectedDate) {
      // Show error: Please select a date
      return false;
    }
    
    if (!this.bookingInfo.contactName.trim()) {
      // Show error: Please enter contact name
      return false;
    }
    
    if (!/^1[3-9]\d{9}$/.test(this.bookingInfo.contactPhone)) {
      // Show error: Please enter a valid phone number
      return false;
    }
    
    if (!this.selectedPaymentMethod) {
      // Show error: Please select a payment method
      return false;
    }
    
    return true;
  }

  private async processPayment() {
    if (!this.validateForm()) {
      // Show appropriate error message
      return;
    }

    try {
      // Simulate payment processing with explicit void generic type
      await new Promise<void>(resolve => setTimeout(resolve, 1500));
      
      // Navigate to payment result page
      router.pushUrl({
        url: 'pages/order/PaymentResultPage',
        params: {
          success: true,
          orderId: `ORD${Date.now()}`,
          amount: this.bookingInfo.totalPrice,
          paymentMethod: this.selectedPaymentMethod
        }
      });
    } catch (error) {
      console.error('Payment failed:', error);
      // Show error message
    }
  }

  @Builder BottomBar() {
    Row() {
      Column() {
        Text('æ€»è®¡')
          .fontSize(12)
          .fontColor('#999')
        
        Text(`Â¥${this.bookingInfo.totalPrice}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ff4444')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.Center)

      Button('æäº¤è®¢å•')
        .width(180)
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(this.bookingInfo.totalPrice > 0 ? '#007AFF' : '#CCCCCC')
        .fontColor(Color.White)
        .onClick(() => this.processPayment())
        .enabled(this.bookingInfo.totalPrice > 0)
    }
    .width('100%')
    .height(72)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#f0f0f0' })
  }

  private validateOrder(): boolean {
    if (this.bookingInfo.selectedTickets.size === 0) {
      ErrorHandler.showToast('è¯·é€‰æ‹©é—¨ç¥¨');
      return false;
    }
    if (!this.bookingInfo.selectedDate) {
      ErrorHandler.showToast('è¯·é€‰æ‹©æ¸¸ç©æ—¥æœŸ');
      return false;
    }
    if (!this.bookingInfo.contactName.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»äººå§“å');
      return false;
    }
    if (!this.bookingInfo.contactPhone.trim()) {
      ErrorHandler.showToast('è¯·è¾“å…¥è”ç³»äººæ‰‹æœºå·');
      return false;
    }
    return true;
  }

  private proceedToPayment() {
    // åˆ›å»ºè®¢å•ä¿¡æ¯
    const orderInfo: OrderInfo = {
      orderId: 'ST' + Date.now().toString(),
      activityName: this.activityInfo.name,
      selectedTickets: Array.from(this.bookingInfo.selectedTickets.entries()).map((entry: [string, number]) => {
        const ticketId = entry[0];
        const count = entry[1];
        const ticket = this.activityInfo.ticketTypes.find(t => t.id === ticketId);
        const orderTicket: OrderTicket = {
          ticketId: ticketId,
          ticketName: ticket?.name || '',
          price: ticket?.price || 0,
          count: count
        };
        return orderTicket;
      }),
      selectedDate: this.bookingInfo.selectedDate,
      contactName: this.bookingInfo.contactName,
      contactPhone: this.bookingInfo.contactPhone,
      totalPrice: this.bookingInfo.totalPrice,
      createTime: new Date().toLocaleString()
    };

    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
    ErrorHandler.safeExecute(async (): Promise<void> => {
      await router.pushUrl({
        url: 'pages/payment/PaymentPage',
        params: {
          orderInfo: orderInfo
        }
      });
    }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ”¯ä»˜é¡µé¢'));
  }
}
