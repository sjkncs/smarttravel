import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';

interface MessageItem {
  id: string;
  title: string;
  content: string;
  time: string;
  unread: boolean;
  avatar: string;
  type: 'order' | 'interactive' | 'account' | 'member';
}

interface GeneratedTypeLiteralInterface_1 {
  icon: string;
  title: string;
  count: number;
  color: string;
}

@Entry
@Component
export struct MessagePage {
  @State messageList: MessageItem[] = [
    {
      id: '1',
      title: 'è®¢å•å‡ºè¡Œ',
      content: 'æ‚¨çš„æ·±åœ³ä¸–ç•Œä¹‹çª—é—¨ç¥¨è®¢å•å·²ç¡®è®¤ï¼Œè¯·æŒ‰æ—¶å‡ºè¡Œ',
      time: '20:05',
      unread: true,
      avatar: 'ðŸ“‹',
      type: 'order'
    },
    {
      id: '2',
      title: 'äº’åŠ¨æ¶ˆæ¯',
      content: 'æ‚¨å‘å¸ƒçš„"æ·±åœ³ä¸€æ—¥æ¸¸æ”»ç•¥"æ”¶åˆ°äº†5ä¸ªèµž',
      time: '19:30',
      unread: true,
      avatar: 'ðŸ’¬',
      type: 'interactive'
    },
    {
      id: '3',
      title: 'è´¦æˆ·é€šçŸ¥',
      content: 'æ‚¨çš„è´¦æˆ·å®‰å…¨è®¾ç½®å·²æ›´æ–°',
      time: '18:45',
      unread: true,
      avatar: 'ðŸ””',
      type: 'account'
    },
    {
      id: '4',
      title: 'ä¼šå‘˜æœåŠ¡',
      content: 'æ­å–œæ‚¨å‡çº§ä¸ºé»„é‡‘ä¼šå‘˜ï¼Œäº«å—æ›´å¤šä¸“å±žæƒç›Š',
      time: '17:20',
      unread: false,
      avatar: 'ðŸ‘‘',
      type: 'member'
    },
    {
      id: '5',
      title: 'æ´»åŠ¨ä¼˜æƒ ',
      content: 'æ·±åœ³æ¬¢ä¹è°·é™æ—¶ä¼˜æƒ ï¼Œé—¨ç¥¨8æŠ˜èµ·',
      time: '16:10',
      unread: false,
      avatar: 'ðŸŽ‰',
      type: 'member'
    }
  ];
  @State unreadCount: number = 3;

  build() {
    Column() {
      // ç»Ÿä¸€çš„é¡¶éƒ¨å¯¼èˆªæ 
      TopNavigationBar({
        title: 'æ¶ˆæ¯',
        showSearch: true,
        showNotification: true,
        notificationCount: this.unreadCount
      })

      // æ¶ˆæ¯åˆ†ç±»
      this.MessageCategories()

      // æ¶ˆæ¯åˆ—è¡¨
      this.MessageList()
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor('#f8fafc')
  }


  @Builder
  MessageCategories() {
    Row({ space: 20 }) {
      ForEach([
        {
          icon: 'ðŸ“‹',
          title: 'è®¢å•å‡ºè¡Œ',
          count: 1,
          color: '#3b82f6'
        },
        {
          icon: 'ðŸ’¬',
          title: 'äº’åŠ¨æ¶ˆæ¯',
          count: 1,
          color: '#f59e0b'
        },
        {
          icon: 'ðŸ””',
          title: 'è´¦æˆ·é€šçŸ¥',
          count: 1,
          color: '#f59e0b'
        },
        {
          icon: 'ðŸ‘‘',
          title: 'ä¼šå‘˜æœåŠ¡',
          count: 2,
          color: '#f59e0b'
        }
      ], (category: GeneratedTypeLiteralInterface_1, index: number) => {
        Column() {
          Stack() {
            Text(category.icon)
              .fontSize(24)
              .fontColor(Color.White)
          }
          .width(48)
          .height(48)
          .backgroundColor(category.color)
          .borderRadius(24)
          .alignContent(Alignment.Center)
          .margin({ bottom: 8 })

          Text(category.title)
            .fontSize(12)
            .fontColor('#374151')
            .textAlign(TextAlign.Center)

          if (category.count > 0) {
            Text(category.count.toString())
              .fontSize(10)
              .fontColor(Color.White)
              .backgroundColor('#ef4444')
              .borderRadius(8)
              .padding({
                left: 6,
                right: 6,
                top: 2,
                bottom: 2
              })
              .margin({ top: 4 })
          }
        }
        .width(60)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          // è·³è½¬åˆ°å¯¹åº”åˆ†ç±»çš„æ¶ˆæ¯
        })
      }, (category: GeneratedTypeLiteralInterface_1, index: number) => `msgcat-${index}-${category.title}`)
    }
    .width('100%')
    .padding({
      left: 16,
      right: 16,
      top: 16,
      bottom: 16
    })
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  @Builder
  MessageList() {
    Scroll() {
      Column() {
        ForEach(this.messageList ?? [], (message: MessageItem, index: number) => {
          this.MessageItem(message)
        }, (message: MessageItem, index: number) => `msg-${message.id}-${index}`)
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  MessageItem(message: MessageItem) {
    Row() {
      // å¤´åƒ
      Text(message.avatar)
        .fontSize(24)
        .width(48)
        .height(48)
        .backgroundColor('#f3f4f6')
        .borderRadius(24)
        .textAlign(TextAlign.Center)
        .margin({ right: 12 })

      // æ¶ˆæ¯å†…å®¹
      Column() {
        Row() {
          Text(message.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Text(message.time)
            .fontSize(12)
            .fontColor('#9ca3af')
        }
        .width('100%')
        .margin({ bottom: 4 })

        Text(message.content)
          .fontSize(14)
          .fontColor('#6b7280')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æœªè¯»æ ‡è¯†
      if (message.unread) {
        Circle({ width: 8, height: 8 })
          .fill('#ef4444')
          .margin({ left: 8 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 8 })
    .shadow({
      radius: 2,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 1
    })
    .onClick(() => {
      // æ ‡è®°ä¸ºå·²è¯»
      message.unread = false;
      this.updateUnreadCount();
    })
  }

  private updateUnreadCount() {
    this.unreadCount = this.messageList.filter(msg => msg.unread).length;
  }
}
