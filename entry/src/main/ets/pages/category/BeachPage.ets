import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { LocalImageConstants } from '../../constants/LocalImageConstants';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface BeachItem {
  id: string;
  name: string;
  image: Resource;
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  tags: string[];
  description: string;
  facilities: string[];
}

@Entry
@Component
export struct BeachPage {
  @State beachList: BeachItem[] = [
    {
      id: '1',
      name: 'å¤§æ¢…æ²™æµ·æ»¨å…¬å›­',
      image: LocalImageConstants.DAMEISHA_BEACH,
      rating: 4.7,
      reviewCount: 3421,
      location: 'ç›ç”°åŒº',
      distance: '25km',
      tags: ['æµ·æ»©', 'æ¸¸æ³³', 'ä¼‘é—²'],
      description: 'æ·±åœ³æœ€è‘—åçš„æµ·æ»©ä¹‹ä¸€ï¼Œæ²™è´¨ç»†è…»ï¼Œæµ·æ°´æ¸…æ¾ˆ',
      facilities: ['æ›´è¡£å®¤', 'æ·‹æµ´', 'åœè½¦åœº', 'å•†åº—', 'é¤å…']
    },
    {
      id: '2',
      name: 'å°æ¢…æ²™',
      image: LocalImageConstants.DAMEISHA_BEACH,
      rating: 4.6,
      reviewCount: 2156,
      location: 'ç›ç”°åŒº',
      distance: '28km',
      tags: ['æµ·æ»©', 'åº¦å‡', 'å¨±ä¹'],
      description: 'é£æ™¯ä¼˜ç¾çš„æµ·æ»©ï¼Œé…å¥—è®¾æ–½å®Œå–„ï¼Œé€‚åˆåº¦å‡',
      facilities: ['æ›´è¡£å®¤', 'æ·‹æµ´', 'åœè½¦åœº', 'æ°´ä¸Šé¡¹ç›®', 'åº¦å‡æ‘']
    },
    {
      id: '3',
      name: 'è¥¿æ¶Œæµ·æ»©',
      image: LocalImageConstants.DAMEISHA_BEACH,
      rating: 4.8,
      reviewCount: 1890,
      location: 'å¤§é¹æ–°åŒº',
      distance: '50km',
      tags: ['æµ·æ»©', 'åŸç”Ÿæ€', 'å¾’æ­¥'],
      description: 'åŸç”Ÿæ€æµ·æ»©ï¼Œäººå°‘æ™¯ç¾ï¼Œé€‚åˆå®‰é™åº¦å‡',
      facilities: ['åœè½¦åœº', 'å•†åº—', 'éœ²è¥åŒº']
    },
    {
      id: '4',
      name: 'æ¨æ¢…å‘',
      image: LocalImageConstants.DAMEISHA_BEACH,
      rating: 4.9,
      reviewCount: 2345,
      location: 'å¤§é¹æ–°åŒº',
      distance: '55km',
      tags: ['æµ·æ»©', 'æ‹ç…§', 'æµªæ¼«'],
      description: 'ç”µå½±ã€Šç¾äººé±¼ã€‹å–æ™¯åœ°ï¼Œé£æ™¯ç»ç¾ï¼Œé€‚åˆæ‹ç…§',
      facilities: ['åœè½¦åœº', 'å•†åº—', 'æ°‘å®¿', 'é¤å…']
    },
    {
      id: '5',
      name: 'æ¡”é’“æ²™',
      image: LocalImageConstants.DAMEISHA_BEACH,
      rating: 4.5,
      reviewCount: 987,
      location: 'å¤§é¹æ–°åŒº',
      distance: '60km',
      tags: ['æµ·æ»©', 'ç§å¯†', 'é«˜ç«¯'],
      description: 'ç§å¯†æ€§è¾ƒå¥½çš„æµ·æ»©ï¼Œç¯å¢ƒä¼˜é›…ï¼Œé€‚åˆé«˜ç«¯åº¦å‡',
      facilities: ['åœè½¦åœº', 'åº¦å‡é…’åº—', 'SPA', 'é¤å…']
    }
  ];

  @State searchKeyword: string = '';

  build() {
    Column() {
      TopNavigationBar({
        title: 'æµ·æ™¯é£å…‰',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢æµ·æ»©...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })

      // æµ·æ»©åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredBeachList, (item: BeachItem) => {
            this.BeachCard(item)
          }, (item: BeachItem) => item.id)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  get filteredBeachList(): BeachItem[] {
    if (!this.beachList || !Array.isArray(this.beachList)) {
      return [];
    }
    if (!this.searchKeyword) {
      return this.beachList;
    }
    return this.beachList.filter(item => 
      item.name.includes(this.searchKeyword) ||
      item.tags.some(tag => tag.includes(this.searchKeyword)) ||
      item.location.includes(this.searchKeyword)
    );
  }

  @Builder BeachCard(item: BeachItem) {
    Column({ space: 12 }) {
      Row() {
        Image(item.image)
          .width(120)
          .height(120)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)

        Column({ space: 8 }) {
          Row() {
            Text(item.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .layoutWeight(1)

            Text(item.distance)
              .fontSize(12)
              .fontColor('#9ca3af')
          }
          .width('100%')

          Row({ space: 8 }) {
            Row({ space: 4 }) {
              Text('â­')
                .fontSize(12)
              Text(item.rating.toFixed(1))
                .fontSize(14)
                .fontColor('#f59e0b')
              Text(`(${item.reviewCount})`)
                .fontSize(12)
                .fontColor('#9ca3af')
            }
          }
          .width('100%')

          Row({ space: 6 }) {
            ForEach(item.tags, (tag: string, index: number) => {
              Text(tag)
                .fontSize(11)
                .fontColor('#0891b2')
                .backgroundColor('#cffafe')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
            }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
          }
          .width('100%')

          Text(item.description)
            .fontSize(13)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(item.location)
            .fontSize(12)
            .fontColor('#6b7280')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }

      // è®¾æ–½ä¿¡æ¯
      if (item.facilities && item.facilities.length > 0) {
        Row({ space: 6 }) {
          Text('ğŸ–ï¸ è®¾æ–½:')
            .fontSize(12)
            .fontColor('#374151')
            .fontWeight(FontWeight.Medium)

          ForEach(item.facilities.slice(0, 4), (facility: string, index: number) => {
            Text(facility)
              .fontSize(11)
              .fontColor('#6b7280')
              .backgroundColor('#f3f4f6')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(3)
          }, (facility: string, index: number) => `${item.id}-facility-${index}`)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ top: 4 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      ErrorHandler.safeExecute(async () => {
        await router.pushUrl({
          url: 'pages/activity/ActivityDetailPage',
          params: { id: item.id, type: 'beach', name: item.name }
        });
      }, (error: Error): void => ErrorHandler.handleRouterError(error, 'æ™¯ç‚¹è¯¦æƒ…é¡µé¢'));
    })
  }
}

