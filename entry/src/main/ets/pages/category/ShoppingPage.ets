import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { RecommendationSection, RecommendationItem } from '../../components/RecommendationSection';
import { RecommendationService } from '../../services/RecommendationService';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface ShoppingItem {
  id: string;
  name: string;
  image: string;
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  category: string;
  tags: string[];
  description: string;
}

@Entry
@Component
export struct ShoppingPage {
  @State shopList: ShoppingItem[] = [
    {
      id: '1',
      name: 'åŽå¼ºåŒ—ç”µå­å¸‚åœº',
      image: 'https://picsum.photos/id/311/400/300',
      rating: 4.7,
      reviewCount: 2356,
      location: 'ç¦ç”°åŒºåŽå¼ºåŒ—',
      distance: '2.1km',
      category: 'ç”µå­äº§å“',
      tags: ['ç”µå­äº§å“', 'æ‰¹å‘', 'æ•°ç '],
      description: 'ä¸­å›½æœ€å¤§çš„ç”µå­äº§å“é›†æ•£åœ°ï¼Œå“ç§é½å…¨ï¼Œä»·æ ¼å®žæƒ '
    },
    {
      id: '2',
      name: 'ä¸‡è±¡åŸŽè´­ç‰©ä¸­å¿ƒ',
      image: 'https://picsum.photos/id/312/400/300',
      rating: 4.8,
      reviewCount: 3421,
      location: 'ç½—æ¹–åŒºä¸‡è±¡åŸŽ',
      distance: '3.5km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['è´­ç‰©ä¸­å¿ƒ', 'å“ç‰Œ', 'æ—¶å°š'],
      description: 'å¤§åž‹ç»¼åˆè´­ç‰©ä¸­å¿ƒï¼Œå›½é™…å“ç‰Œé½å…¨ï¼ŒçŽ¯å¢ƒä¼˜é›…ï¼Œæ˜¯æ·±åœ³é«˜ç«¯è´­ç‰©çš„é¦–é€‰ä¹‹åœ°'
    },
    {
      id: '3',
      name: 'ä¸œé—¨æ­¥è¡Œè¡—',
      image: 'https://picsum.photos/id/313/400/300',
      rating: 4.5,
      reviewCount: 1890,
      location: 'ç½—æ¹–åŒºä¸œé—¨',
      distance: '4.2km',
      category: 'æ­¥è¡Œè¡—',
      tags: ['æ­¥è¡Œè¡—', 'ç‰¹è‰²', 'å°åƒ'],
      description: 'æ·±åœ³æœ€è‘—åçš„å•†ä¸šæ­¥è¡Œè¡—ï¼Œåƒå–çŽ©ä¹ä¸€åº”ä¿±å…¨ï¼Œæ·±åœ³è€å­—å·å•†ä¸šè¡—'
    },
    {
      id: '4',
      name: 'æµ·å²¸åŸŽè´­ç‰©ä¸­å¿ƒ',
      image: 'https://picsum.photos/id/314/400/300',
      rating: 4.6,
      reviewCount: 2123,
      location: 'å—å±±åŒºæµ·å²¸åŸŽ',
      distance: '1.8km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['è´­ç‰©ä¸­å¿ƒ', 'ç¾Žé£Ÿ', 'å¨±ä¹'],
      description: 'é›†è´­ç‰©ã€ç¾Žé£Ÿã€å¨±ä¹äºŽä¸€ä½“çš„å¤§åž‹å•†ä¸šç»¼åˆä½“ï¼Œæ¯—é‚»æ·±åœ³æ¹¾'
    },
    {
      id: '5',
      name: 'æ·±åœ³æ¹¾ä¸‡è±¡åŸŽ',
      image: 'https://picsum.photos/id/315/400/300',
      rating: 4.9,
      reviewCount: 2847,
      location: 'å—å±±åŒºæ·±åœ³æ¹¾',
      distance: '2.3km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['é«˜ç«¯', 'å¥¢ä¾ˆå“', 'æµ·æ™¯'],
      description: 'æ·±åœ³é«˜ç«¯è´­ç‰©ä¸­å¿ƒï¼Œæ±‡é›†å›½é™…ä¸€çº¿å“ç‰Œï¼Œäº«å—æµ·æ™¯è´­ç‰©ä½“éªŒ'
    },
    {
      id: '6',
      name: 'COCO Parkè´­ç‰©å…¬å›­',
      image: 'https://picsum.photos/id/316/400/300',
      rating: 4.7,
      reviewCount: 3156,
      location: 'ç¦ç”°åŒºè´­ç‰©å…¬å›­',
      distance: '2.8km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['æ—¶å°š', 'æ½®æµ', 'å¹´è½»'],
      description: 'æ·±åœ³æ—¶å°šåœ°æ ‡ï¼Œå¹´è½»äººçš„è´­ç‰©å¤©å ‚ï¼Œå“ç‰Œå¤šæ ·ï¼Œæ´»åŠ¨ä¸°å¯Œ'
    },
    {
      id: '7',
      name: 'KK Mall',
      image: 'https://picsum.photos/id/317/400/300',
      rating: 4.6,
      reviewCount: 1567,
      location: 'ç½—æ¹–åŒºç¬‹å²—',
      distance: '4.5km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['äº²å­', 'ä½“éªŒ', 'ç¾Žé£Ÿ'],
      description: 'ä½“éªŒå¼è´­ç‰©ä¸­å¿ƒï¼Œé€‚åˆå®¶åº­å‡ºæ¸¸ï¼Œå„¿ç«¥å¨±ä¹è®¾æ–½é½å…¨'
    },
    {
      id: '8',
      name: 'æ¬¢ä¹æµ·å²¸OCT Bay',
      image: 'https://picsum.photos/id/318/400/300',
      rating: 4.8,
      reviewCount: 2934,
      location: 'å—å±±åŒºåŽä¾¨åŸŽ',
      distance: '3.2km',
      category: 'å•†ä¸šè¡—åŒº',
      tags: ['æ»¨æ°´', 'æ–‡åˆ›', 'å¤œå¸‚'],
      description: 'æ·±åœ³ç½‘çº¢æ‰“å¡åœ°ï¼Œæ»¨æ°´å•†ä¸šè¡—åŒºï¼Œé›†è´­ç‰©ã€é¤é¥®ã€å¨±ä¹äºŽä¸€ä½“'
    },
    {
      id: '9',
      name: 'å£¹æ–¹åŸŽè´­ç‰©ä¸­å¿ƒ',
      image: 'https://picsum.photos/id/319/400/300',
      rating: 4.7,
      reviewCount: 2245,
      location: 'å®å®‰åŒºå®å®‰ä¸­å¿ƒ',
      distance: '8.5km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['å¤§åž‹', 'ç»¼åˆ', 'åœè½¦æ–¹ä¾¿'],
      description: 'å®å®‰åŒºæœ€å¤§çš„è´­ç‰©ä¸­å¿ƒï¼Œå“ç‰Œé½å…¨ï¼Œåœè½¦ä½å……è¶³'
    },
    {
      id: '10',
      name: 'ç›Šç”°å‡æ—¥å¹¿åœº',
      image: 'https://picsum.photos/id/320/400/300',
      rating: 4.6,
      reviewCount: 1876,
      location: 'ç¦ç”°åŒºç¦ç”°ä¸­å¿ƒåŒº',
      distance: '1.5km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['å®¶åº­', 'äº²å­', 'ä¾¿åˆ©'],
      description: 'ç¦ç”°æ ¸å¿ƒå•†åœˆï¼Œäº¤é€šä¾¿åˆ©ï¼Œé€‚åˆå…¨å®¶è´­ç‰©ä¼‘é—²'
    },
    {
      id: '11',
      name: 'é¾™å²—ä¸‡è¾¾å¹¿åœº',
      image: 'https://picsum.photos/id/321/400/300',
      rating: 4.5,
      reviewCount: 1523,
      location: 'é¾™å²—åŒºé¾™å²—ä¸­å¿ƒåŸŽ',
      distance: '15.2km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['ä¸‡è¾¾', 'å½±é™¢', 'ç¾Žé£Ÿ'],
      description: 'é¾™å²—åŒºåŸŸæ€§è´­ç‰©ä¸­å¿ƒï¼Œä¸‡è¾¾å½±åŸŽï¼Œç¾Žé£Ÿå¹¿åœºï¼Œä¸€ç«™å¼è´­ç‰©'
    },
    {
      id: '12',
      name: 'æ·±ä¸šä¸ŠåŸŽ',
      image: 'https://picsum.photos/id/322/400/300',
      rating: 4.8,
      reviewCount: 2678,
      location: 'ç¦ç”°åŒºçš‡å²—',
      distance: '2.0km',
      category: 'å•†ä¸šç»¼åˆä½“',
      tags: ['ç½‘çº¢', 'loft', 'æ–‡è‰º'],
      description: 'æ·±åœ³æ–‡è‰ºåœ°æ ‡ï¼Œlofté£Žæ ¼ï¼Œé›†è´­ç‰©ã€åŠžå…¬ã€åˆ›æ„äºŽä¸€ä½“'
    },
    {
      id: '13',
      name: 'åŽæ¶¦ä¸‡è±¡å¤©åœ°',
      image: 'https://picsum.photos/id/323/400/300',
      rating: 4.9,
      reviewCount: 3234,
      location: 'å—å±±åŒºç§‘æŠ€å›­',
      distance: '3.8km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['é«˜ç«¯', 'è‰ºæœ¯', 'åˆ›æ–°'],
      description: 'å—å±±ç§‘æŠ€å›­é«˜ç«¯å•†ä¸šï¼Œå»ºç­‘è®¾è®¡ç‹¬ç‰¹ï¼Œè´­ç‰©ä½“éªŒä¸€æµ'
    },
    {
      id: '14',
      name: 'å¤©è™¹å•†åœº',
      image: 'https://picsum.photos/id/324/400/300',
      rating: 4.4,
      reviewCount: 1345,
      location: 'ç¦ç”°åŒºåŽå¼ºåŒ—',
      distance: '2.2km',
      category: 'ç™¾è´§å•†åœº',
      tags: ['ç™¾è´§', 'è¶…å¸‚', 'å®žæƒ '],
      description: 'æ·±åœ³è€ç‰Œç™¾è´§å•†åœºï¼Œå•†å“ç§ç±»ä¸°å¯Œï¼Œä»·æ ¼äº²æ°‘'
    },
    {
      id: '15',
      name: 'å¥¥ç‰¹èŽ±æ–¯(æ·±åœ³é¾™å²—)',
      image: 'https://picsum.photos/id/325/400/300',
      rating: 4.7,
      reviewCount: 987,
      location: 'é¾™å²—åŒºåªå±±',
      distance: '25km',
      category: 'æŠ˜æ‰£åº—',
      tags: ['æŠ˜æ‰£', 'å“ç‰Œ', 'ä¼˜æƒ '],
      description: 'æ·±åœ³æœ€å¤§çš„å“ç‰ŒæŠ˜æ‰£è´­ç‰©ä¸­å¿ƒï¼Œå›½é™…å“ç‰Œ3-7æŠ˜ï¼Œæ€§ä»·æ¯”æžé«˜'
    },
    {
      id: '16',
      name: 'å¤§æ¢…æ²™å¥¥ç‰¹èŽ±æ–¯',
      image: 'https://picsum.photos/id/326/400/300',
      rating: 4.6,
      reviewCount: 856,
      location: 'ç›ç”°åŒºå¤§æ¢…æ²™',
      distance: '22km',
      category: 'æŠ˜æ‰£åº—',
      tags: ['æµ·æ™¯', 'æŠ˜æ‰£', 'åº¦å‡'],
      description: 'æµ·æ»¨å¥¥ç‰¹èŽ±æ–¯ï¼Œè´­ç‰©çš„åŒæ—¶äº«å—æµ·æ™¯ï¼Œå‘¨æœ«åº¦å‡é¦–é€‰'
    },
    {
      id: '17',
      name: 'ä¸œéƒ¨åŽä¾¨åŸŽèŒ¶æºªè°·',
      image: 'https://picsum.photos/id/327/400/300',
      rating: 4.8,
      reviewCount: 1234,
      location: 'ç›ç”°åŒºå¤§æ¢…æ²™',
      distance: '20km',
      category: 'ä¸»é¢˜å•†ä¸š',
      tags: ['åº¦å‡', 'æ–‡åˆ›', 'ç‰¹è‰²'],
      description: 'å±±åœ°åº¦å‡å•†ä¸šåŒºï¼Œç‰¹è‰²å•†å“ä¸°å¯Œï¼Œèžåˆè‡ªç„¶ä¸Žè´­ç‰©ä½“éªŒ'
    },
    {
      id: '18',
      name: 'é¾™åŽä¹æ–¹è´­ç‰©ä¸­å¿ƒ',
      image: 'https://picsum.photos/id/328/400/300',
      rating: 4.7,
      reviewCount: 1678,
      location: 'é¾™åŽåŒºé¾™åŽä¸­å¿ƒ',
      distance: '12km',
      category: 'è´­ç‰©ä¸­å¿ƒ',
      tags: ['åœ°é“ç›´è¾¾', 'æ–°å…´', 'ä¾¿åˆ©'],
      description: 'é¾™åŽæ–°å…´å•†ä¸šä¸­å¿ƒï¼Œåœ°é“ç›´è¾¾ï¼Œå¹´è½»æ—¶å°š'
    },
    {
      id: '19',
      name: 'æ°´è´ç å®åŸŽ',
      image: 'https://picsum.photos/id/329/400/300',
      rating: 4.5,
      reviewCount: 2156,
      location: 'ç½—æ¹–åŒºæ°´è´',
      distance: '5.5km',
      category: 'ä¸“ä¸šå¸‚åœº',
      tags: ['ç å®', 'æ‰¹å‘', 'ä¸“ä¸š'],
      description: 'ä¸­å›½æœ€å¤§çš„ç å®æ‰¹å‘å¸‚åœºï¼Œæ¬¾å¼å¤šæ ·ï¼Œä»·æ ¼ä¼˜åŠ¿æ˜Žæ˜¾'
    },
    {
      id: '20',
      name: 'ç¬‹å²—å·¥è‰ºåŸŽ',
      image: 'https://picsum.photos/id/330/400/300',
      rating: 4.3,
      reviewCount: 876,
      location: 'ç½—æ¹–åŒºç¬‹å²—',
      distance: '4.8km',
      category: 'ä¸“ä¸šå¸‚åœº',
      tags: ['å·¥è‰ºå“', 'å®¶å±…', 'æ‰¹å‘'],
      description: 'å·¥è‰ºå“å®¶å±…é›†æ•£åœ°ï¼Œå“ç§é½å…¨ï¼Œé€‚åˆæ·˜è´§'
    }
  ];

  @State searchKeyword: string = '';

  build() {
    Column() {
      TopNavigationBar({
        title: 'è´­ç‰©',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢è´­ç‰©åœºæ‰€...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })

      // è´­ç‰©åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredShopList, (item: ShoppingItem) => {
            this.ShopCard(item)
          }, (item: ShoppingItem) => item.id)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  get filteredShopList(): ShoppingItem[] {
    if (!this.shopList || !Array.isArray(this.shopList)) {
      return [];
    }
    if (!this.searchKeyword) {
      return this.shopList;
    }
    return this.shopList.filter(item => 
      item.name.includes(this.searchKeyword) ||
      item.tags.some(tag => tag.includes(this.searchKeyword)) ||
      item.location.includes(this.searchKeyword) ||
      item.category.includes(this.searchKeyword)
    );
  }

  @Builder ShopCard(item: ShoppingItem) {
    Column({ space: 12 }) {
      // è´­ç‰©åœºæ‰€å›¾ç‰‡
      Stack({ alignContent: Alignment.TopEnd }) {
        Column() {
          Text('ðŸ›ï¸')
            .fontSize(60)
        }
        .width('100%')
        .height(160)
        .backgroundColor('#fef3e8')
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        
        // è¯„åˆ†æ ‡ç­¾
        Row({ space: 4 }) {
          Text('â­')
            .fontSize(12)
          Text(item.rating.toFixed(1))
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .backgroundColor('rgba(0,0,0,0.7)')
        .borderRadius(12)
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .margin({ top: 8, right: 8 })
      }
      
      Column({ space: 8 }) {
        Row() {
          Text(item.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Row({ space: 4 }) {
            Text('ðŸ“')
              .fontSize(12)
            Text(item.distance)
              .fontSize(12)
              .fontColor('#9ca3af')
          }
        }
        .width('100%')

        Row({ space: 8 }) {
          Text(`(${item.reviewCount}æ¡è¯„ä»·)`)
            .fontSize(12)
            .fontColor('#9ca3af')
            .layoutWeight(1)

          Text(item.category)
            .fontSize(12)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
        }
        .width('100%')

        // æ ‡ç­¾
        Row({ space: 6 }) {
          ForEach(item.tags.slice(0, 3), (tag: string, index: number) => {
            Text(tag)
              .fontSize(11)
              .fontColor('#10b981')
              .backgroundColor('#d1fae5')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
        }
        .width('100%')

        Row({ space: 4 }) {
          Text('ðŸ“')
            .fontSize(12)
          Text(item.location)
            .fontSize(12)
            .fontColor('#6b7280')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')

        Text(item.description)
          .fontSize(13)
          .fontColor('#9ca3af')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .padding(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/activity/ActivityDetailPage',
        params: { id: item.id, type: 'shopping' }
      }).catch((error: Error) => {
        console.error('è·³è½¬å¤±è´¥:', error.message);
      });
    })
  }
}

