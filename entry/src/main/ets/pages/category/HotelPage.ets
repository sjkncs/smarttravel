import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { LocalImageConstants } from '../../constants/LocalImageConstants';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface HotelItem {
  id: string;
  name: string;
  image: Resource;
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  price: string;
  tags: string[];
  description: string;
  facilities: string[];
}

@Entry
@Component
export struct HotelPage {
  @State hotelList: HotelItem[] = [
    {
      id: '1',
      name: 'æ·±åœ³æ¹¾ä¸‡è±ªé…’åº—',
      image: LocalImageConstants.LUXURY_HOTEL,
      rating: 4.8,
      reviewCount: 1256,
      location: 'å—å±±åŒºæ·±åœ³æ¹¾',
      distance: '1.2km',
      price: 'Â¥680/æ™š',
      tags: ['äº”æ˜Ÿçº§', 'æµ·æ™¯', 'å•†åŠ¡'],
      description: 'è±ªåæµ·æ™¯é…’åº—ï¼Œè®¾æ–½å®Œå–„ï¼ŒæœåŠ¡ä¸€æµ',
      facilities: ['WiFi', 'åœè½¦åœº', 'å¥èº«æˆ¿', 'æ¸¸æ³³æ± ', 'é¤å…']
    },
    {
      id: '2',
      name: 'ç²¾å“æ°‘å®¿',
      image: LocalImageConstants.BOUTIQUE_HOTEL,
      rating: 4.6,
      reviewCount: 892,
      location: 'ç¦ç”°åŒºä¸­å¿ƒåŒº',
      distance: '2.5km',
      price: 'Â¥280/æ™š',
      tags: ['æ°‘å®¿', 'æ¸©é¦¨', 'æ€§ä»·æ¯”'],
      description: 'æ¸©é¦¨èˆ’é€‚çš„ç²¾å“æ°‘å®¿ï¼Œäº¤é€šä¾¿åˆ©',
      facilities: ['WiFi', 'ç©ºè°ƒ', 'å¨æˆ¿']
    },
    {
      id: '3',
      name: 'ç»æµå‹é…’åº—',
      image: LocalImageConstants.BUSINESS_HOTEL,
      rating: 4.4,
      reviewCount: 1534,
      location: 'ç½—æ¹–åŒºä¸œé—¨',
      distance: '3.8km',
      price: 'Â¥158/æ™š',
      tags: ['ç»æµ', 'ä¾¿æ·', 'å®æƒ '],
      description: 'ä»·æ ¼å®æƒ ï¼Œä½ç½®ä¾¿åˆ©ï¼Œé€‚åˆçŸ­æœŸä½å®¿',
      facilities: ['WiFi', 'ç©ºè°ƒ', '24å°æ—¶å‰å°']
    },
    {
      id: '4',
      name: 'åº¦å‡æ‘',
      image: LocalImageConstants.RESORT_HOTEL,
      rating: 4.9,
      reviewCount: 567,
      location: 'å¤§é¹æ–°åŒº',
      distance: '25km',
      price: 'Â¥1280/æ™š',
      tags: ['åº¦å‡', 'è‡ªç„¶', 'ä¼‘é—²'],
      description: 'ç¯å¢ƒä¼˜ç¾ï¼Œè®¾æ–½é½å…¨ï¼Œé€‚åˆåº¦å‡ä¼‘é—²',
      facilities: ['WiFi', 'åœè½¦åœº', 'å¥èº«æˆ¿', 'æ¸¸æ³³æ± ', 'SPA', 'é¤å…', 'æµ·æ»©']
    },
    {
      id: '5',
      name: 'å•†åŠ¡é…’åº—',
      image: LocalImageConstants.BUSINESS_HOTEL,
      rating: 4.5,
      reviewCount: 768,
      location: 'ç¦ç”°åŒºCBD',
      distance: '1.0km',
      price: 'Â¥450/æ™š',
      tags: ['å•†åŠ¡', 'ä¾¿åˆ©', 'ç°ä»£åŒ–'],
      description: 'åœ°ç†ä½ç½®ä¼˜è¶Šï¼Œé€‚åˆå•†åŠ¡å‡ºè¡Œ',
      facilities: ['WiFi', 'åœè½¦åœº', 'ä¼šè®®å®¤', 'é¤å…', 'å¥èº«æˆ¿']
    }
  ];

  @State searchKeyword: string = '';

  build() {
    Column() {
      TopNavigationBar({
        title: 'ä½å®¿',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢é…’åº—...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })

      // é…’åº—åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredHotelList, (item: HotelItem) => {
            this.HotelCard(item)
          }, (item: HotelItem) => item.id)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  get filteredHotelList(): HotelItem[] {
    if (!this.hotelList || !Array.isArray(this.hotelList)) {
      return [];
    }
    if (!this.searchKeyword) {
      return this.hotelList;
    }
    return this.hotelList.filter(item => 
      item.name.includes(this.searchKeyword) ||
      item.tags.some(tag => tag.includes(this.searchKeyword)) ||
      item.location.includes(this.searchKeyword)
    );
  }

  @Builder HotelCard(item: HotelItem) {
    Column({ space: 12 }) {
      // é…’åº—å›¾ç‰‡
      Stack({ alignContent: Alignment.TopStart }) {
        // ä½¿ç”¨emojiä½œä¸ºåå¤‡æ˜¾ç¤º
        Column() {
          Text(item.image)
            .fontSize(60)
        }
        .width('100%')
        .height(160)
        .backgroundColor('#f0f4f8')
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        
        // è¯„åˆ†æ ‡ç­¾
        Row({ space: 4 }) {
          Text('â­')
            .fontSize(12)
          Text(item.rating.toFixed(1))
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .backgroundColor('rgba(0,0,0,0.7)')
        .borderRadius(12)
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .margin({ top: 8, left: 8 })
      }
      
      Column({ space: 8 }) {
        Row() {
          Text(item.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Row({ space: 4 }) {
            Text('ğŸ“')
              .fontSize(12)
            Text(item.distance)
              .fontSize(12)
              .fontColor('#9ca3af')
          }
        }
        .width('100%')

        Row({ space: 8 }) {
          Text(`(${item.reviewCount}æ¡è¯„ä»·)`)
            .fontSize(12)
            .fontColor('#9ca3af')
            .layoutWeight(1)

          Text(item.price)
            .fontSize(16)
            .fontColor('#ef4444')
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')

        // æ ‡ç­¾
        Row({ space: 6 }) {
          ForEach(item.tags.slice(0, 3), (tag: string, index: number) => {
            Text(tag)
              .fontSize(11)
              .fontColor('#6366f1')
              .backgroundColor('#eef2ff')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
        }
        .width('100%')

        Row({ space: 4 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(item.location)
            .fontSize(12)
            .fontColor('#6b7280')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')

        Text(item.description)
          .fontSize(13)
          .fontColor('#9ca3af')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .padding(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      ErrorHandler.safeExecute(async (): Promise<void> => {
        await router.pushUrl({
          url: 'pages/detail/HotelDetailPage',
          params: { 
            id: item.id, 
            name: item.name
          }
        });
      }, (error: Error): void => ErrorHandler.handleRouterError(error, 'é…’åº—è¯¦æƒ…é¡µé¢'));
    })
  }
}

