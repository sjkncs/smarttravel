import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { ImageConstants } from '../../constants/ImageConstants';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface FoodItem {
  id: string;
  name: string;
  image: string;
  rating: number;
  reviewCount: number;
  location: string;
  distance: string;
  price: string;
  tags: string[];
  description: string;
}

@Entry
@Component
export struct FoodPage {
  @State foodList: FoodItem[] = [];
  @State filteredList: FoodItem[] = [];

  private readonly initialFoodList: FoodItem[] = [
    {
      id: '1',
      name: 'æ·±åœ³æ¹¾æµ·é²œå¤§æŽ’æ¡£',
      image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/292/400/300', 'restaurant'),
      rating: 4.8,
      reviewCount: 1256,
      location: 'å—å±±åŒºæ·±åœ³æ¹¾',
      distance: '1.2km',
      price: 'äººå‡Â¥120',
      tags: ['æµ·é²œ', 'å¤§æŽ’æ¡£', 'å¤œå®µ'],
      description: 'æ–°é²œæµ·é²œï¼ŒçŽ°ç‚¹çŽ°åšï¼ŒçŽ¯å¢ƒä¼˜é›…ï¼Œé€‚åˆèšé¤'
    },
    {
      id: '2',
      name: 'è€å­—å·è‚ ç²‰åº—',
      image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/293/400/300', 'restaurant'),
      rating: 4.6,
      reviewCount: 892,
      location: 'ç¦ç”°åŒºåŽå¼ºåŒ—',
      distance: '2.5km',
      price: 'äººå‡Â¥35',
      tags: ['è‚ ç²‰', 'æ—©é¤', 'è€å­—å·'],
      description: 'ä¼ ç»Ÿå¹¿å¼è‚ ç²‰ï¼Œå£æ„Ÿå«©æ»‘ï¼Œä»·æ ¼å®žæƒ '
    },
    {
      id: '3',
      name: 'å·å‘³ç«é”…åŸŽ',
      image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/294/400/300', 'restaurant'),
      rating: 4.7,
      reviewCount: 1534,
      location: 'ç½—æ¹–åŒºä¸œé—¨',
      distance: '3.8km',
      price: 'äººå‡Â¥150',
      tags: ['ç«é”…', 'å·èœ', 'èšé¤'],
      description: 'æ­£å®—å·å‘³ç«é”…ï¼Œéº»è¾£é²œé¦™ï¼Œé£Ÿææ–°é²œ'
    },
    {
      id: '4',
      name: 'æ—¥å¼æ–™ç†åº—',
      image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/295/400/300', 'restaurant'),
      rating: 4.9,
      reviewCount: 567,
      location: 'å—å±±åŒºæµ·å²¸åŸŽ',
      distance: '0.8km',
      price: 'äººå‡Â¥200',
      tags: ['æ—¥æ–™', 'å¯¿å¸', 'åˆºèº«'],
      description: 'ç²¾è‡´çš„æ—¥å¼æ–™ç†ï¼ŒçŽ¯å¢ƒä¼˜é›…ï¼ŒæœåŠ¡è´´å¿ƒ'
    },
    {
      id: '5',
      name: 'ç‰¹è‰²èŒ¶é¤åŽ…',
      image: ImageConstants.getSafeImageUrl('https://picsum.photos/id/296/400/300', 'restaurant'),
      rating: 4.5,
      reviewCount: 768,
      location: 'ç¦ç”°åŒºä¸­å¿ƒåŒº',
      distance: '1.5km',
      price: 'äººå‡Â¥60',
      tags: ['èŒ¶é¤åŽ…', 'æ¸¯å¼', 'ä¾¿é¤'],
      description: 'åœ°é“æ¸¯å¼èŒ¶é¤åŽ…ï¼Œç»å…¸èœå“ï¼Œæ€§ä»·æ¯”é«˜'
    }
  ];

  @State searchKeyword: string = '';

  aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®
    this.foodList = [...this.initialFoodList];
    this.updateFilteredList();
    console.log('[FoodPage] aboutToAppear - ç¾Žé£Ÿæ•°æ®åŠ è½½å®Œæˆ:', this.foodList.length, 'è¿‡æ»¤åŽ:', this.filteredList.length);
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'ç¾Žé£Ÿ',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢ç¾Žé£Ÿ...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.updateFilteredList();
        })

      // ç¾Žé£Ÿåˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredList, (item: FoodItem) => {
            this.FoodCard(item)
          }, (item: FoodItem) => item.id) // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  /**
   * æ›´æ–°è¿‡æ»¤åˆ—è¡¨ - ä½¿ç”¨æ–¹æ³•ä»£æ›¿computedå±žæ€§
   */
  private updateFilteredList() {
    if (!this.searchKeyword) {
      this.filteredList = [...this.foodList];
    } else {
      const filtered = this.foodList.filter(item => 
        item.name.includes(this.searchKeyword) ||
        item.tags.some(tag => tag.includes(this.searchKeyword)) ||
        item.location.includes(this.searchKeyword)
      );
      this.filteredList = [...filtered];
    }
    console.log('[FoodPage] updateFilteredList - è¿‡æ»¤åŽæ•°é‡:', this.filteredList.length);
  }

  @Builder FoodCard(item: FoodItem) {
    Column({ space: 12 }) {
      // ç¾Žé£Ÿå›¾ç‰‡
      Stack({ alignContent: Alignment.TopEnd }) {
        Image(item.image)
          .width('100%')
          .height(180)
          .borderRadius(12)
          .objectFit(ImageFit.Cover)
          .alt('ðŸ½ï¸')
        
        // è¯„åˆ†æ ‡ç­¾
        Row({ space: 4 }) {
          Text('â­')
            .fontSize(12)
          Text(item.rating.toFixed(1))
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
        .backgroundColor('rgba(0,0,0,0.7)')
        .borderRadius(12)
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .margin({ top: 8, right: 8 })
      }
      
      Column({ space: 8 }) {
        Row() {
          Text(item.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Row({ space: 4 }) {
            Text('ðŸ“')
              .fontSize(12)
            Text(item.distance)
              .fontSize(12)
              .fontColor('#9ca3af')
          }
        }
        .width('100%')

        Row({ space: 8 }) {
          Text(`(${item.reviewCount}æ¡è¯„ä»·)`)
            .fontSize(12)
            .fontColor('#9ca3af')
            .layoutWeight(1)

          Text(item.price)
            .fontSize(16)
            .fontColor('#ef4444')
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')

        // æ ‡ç­¾
        Row({ space: 6 }) {
          ForEach(item.tags.slice(0, 3), (tag: string, index: number) => {
            Text(tag)
              .fontSize(11)
              .fontColor('#6366f1')
              .backgroundColor('#eef2ff')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
        }
        .width('100%')

        Row({ space: 4 }) {
          Text('ðŸ“')
            .fontSize(12)
          Text(item.location)
            .fontSize(12)
            .fontColor('#6b7280')
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
      }
      .padding(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      // è·³è½¬åˆ°ç¾Žé£Ÿè¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/detail/FoodDetailPage',
        params: { id: item.id, name: item.name }
      }).catch((error: Error) => {
        console.error('è·³è½¬å¤±è´¥:', error.message);
      });
    })
  }
}

