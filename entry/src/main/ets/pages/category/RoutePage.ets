import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { RecommendationSection, RecommendationItem } from '../../components/RecommendationSection';
import { RecommendationService } from '../../services/RecommendationService';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface RouteItem {
  id: string;
  name: string;
  image: string;
  duration: string;
  distance: string;
  difficulty: 'ç®€å•' | 'ä¸­ç­‰' | 'å›°éš¾';
  tags: string[];
  description: string;
  waypoints: string[];
}

@Entry
@Component
export struct RoutePage {
  @State routeList: RouteItem[] = [
    {
      id: '1',
      name: 'æ·±åœ³æ¹¾æµ·æ»¨æ ˆé“',
      image: 'https://picsum.photos/id/321/400/300',
      duration: '2-3å°æ—¶',
      distance: '8å…¬é‡Œ',
      difficulty: 'ç®€å•',
      tags: ['æµ·æ»¨', 'å¾’æ­¥', 'ä¼‘é—²'],
      description: 'æ²¿ç€æ·±åœ³æ¹¾æµ·å²¸çº¿ï¼Œæ¬£èµæµ·æ™¯å’ŒåŸŽå¸‚é£Žå…‰',
      waypoints: ['èµ·ç‚¹: æ·±åœ³æ¹¾å…¬å›­', 'ä¸­é€”: çº¢æ ‘æž—', 'ç»ˆç‚¹: è›‡å£ç å¤´']
    },
    {
      id: '2',
      name: 'æ¢§æ¡å±±ç™»å±±è·¯çº¿',
      image: 'https://picsum.photos/id/322/400/300',
      duration: '4-5å°æ—¶',
      distance: '12å…¬é‡Œ',
      difficulty: 'å›°éš¾',
      tags: ['ç™»å±±', 'è‡ªç„¶', 'æŒ‘æˆ˜'],
      description: 'æ·±åœ³ç¬¬ä¸€é«˜å³°ï¼Œç™»é¡¶å¯ä¿¯çž°å…¨åŸŽ',
      waypoints: ['èµ·ç‚¹: æ¢§æ¡å±±å…¥å£', 'ä¸­é€”: å¥½æ±‰å¡', 'ç»ˆç‚¹: æ¢§æ¡å±±é¡¶']
    },
    {
      id: '3',
      name: 'ä¸œéƒ¨åŽä¾¨åŸŽçŽ¯çº¿',
      image: 'https://picsum.photos/id/323/400/300',
      duration: 'å…¨å¤©',
      distance: '15å…¬é‡Œ',
      difficulty: 'ä¸­ç­‰',
      tags: ['ä¸»é¢˜å…¬å›­', 'è‡ªç„¶', 'å¨±ä¹'],
      description: 'ä¸»é¢˜å…¬å›­å†…çš„çŽ¯çº¿æ¸¸è§ˆï¼ŒåŒ…å«å¤šä¸ªæ™¯ç‚¹',
      waypoints: ['èµ·ç‚¹: å…¥å£å¹¿åœº', 'ä¸­é€”: èŒ¶æºªè°·', 'ç»ˆç‚¹: å¤§å³¡è°·']
    },
    {
      id: '4',
      name: 'èŽ²èŠ±å±±å…¬å›­çŽ¯çº¿',
      image: 'https://picsum.photos/id/324/400/300',
      duration: '1-2å°æ—¶',
      distance: '3å…¬é‡Œ',
      difficulty: 'ç®€å•',
      tags: ['å…¬å›­', 'ä¼‘é—²', 'äº²å­'],
      description: 'é€‚åˆå…¨å®¶çš„è½»æ¾æ­¥è¡Œè·¯çº¿',
      waypoints: ['èµ·ç‚¹: å—é—¨', 'ä¸­é€”: å±±é¡¶å¹¿åœº', 'ç»ˆç‚¹: é£Žç­å¹¿åœº']
    },
    {
      id: '5',
      name: 'å¤§æ¢…æ²™æµ·æ»¨è·¯çº¿',
      image: 'https://picsum.photos/id/325/400/300',
      duration: '3-4å°æ—¶',
      distance: '10å…¬é‡Œ',
      difficulty: 'ä¸­ç­‰',
      tags: ['æµ·æ»¨', 'æ²™æ»©', 'æ¸¸æ³³'],
      description: 'æµ·æ»¨åº¦å‡è·¯çº¿ï¼Œå¯ä»¥æ¸¸æ³³å’Œæ²™æ»©æ´»åŠ¨',
      waypoints: ['èµ·ç‚¹: å¤§æ¢…æ²™æµ·æ»¨å…¬å›­', 'ä¸­é€”: æµ·æ»¨æ ˆé“', 'ç»ˆç‚¹: å°æ¢…æ²™']
    }
  ];

  @State searchKeyword: string = '';

  build() {
    Column() {
      TopNavigationBar({
        title: 'æ—…æ¸¸è·¯çº¿',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢è·¯çº¿...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })

      // è·¯çº¿åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredRouteList, (item: RouteItem) => {
            this.RouteCard(item)
          }, (item: RouteItem) => item.id)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  get filteredRouteList(): RouteItem[] {
    if (!this.routeList || !Array.isArray(this.routeList)) {
      return [];
    }
    if (!this.searchKeyword) {
      return this.routeList;
    }
    return this.routeList.filter(item => 
      item.name.includes(this.searchKeyword) ||
      item.tags.some(tag => tag.includes(this.searchKeyword)) ||
      item.difficulty.includes(this.searchKeyword)
    );
  }

  @Builder RouteCard(item: RouteItem) {
    Column({ space: 12 }) {
      Row() {
        Image(item.image)
          .width(120)
          .height(120)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)

        Column({ space: 8 }) {
          Row() {
            Text(item.name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .layoutWeight(1)

            Text(item.difficulty)
              .fontSize(12)
              .fontColor(item.difficulty === 'ç®€å•' ? '#10b981' : item.difficulty === 'ä¸­ç­‰' ? '#f59e0b' : '#ef4444')
              .backgroundColor(item.difficulty === 'ç®€å•' ? '#d1fae5' : item.difficulty === 'ä¸­ç­‰' ? '#fef3c7' : '#fee2e2')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(4)
          }
          .width('100%')

          Text(item.description)
            .fontSize(13)
            .fontColor('#6b7280')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row({ space: 16 }) {
            Row({ space: 4 }) {
              Text('â±ï¸')
                .fontSize(14)
              Text(item.duration)
                .fontSize(13)
                .fontColor('#6b7280')
            }

            Row({ space: 4 }) {
              Text('ðŸ“')
                .fontSize(14)
              Text(item.distance)
                .fontSize(13)
                .fontColor('#6b7280')
            }
          }
          .width('100%')
          .margin({ top: 4 })

          Row({ space: 6 }) {
            ForEach(item.tags, (tag: string, index: number) => {
              Text(tag)
                .fontSize(11)
                .fontColor('#6366f1')
                .backgroundColor('#eef2ff')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
            }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
          }
          .width('100%')
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        .alignItems(HorizontalAlign.Start)
      }

      // è·¯çº¿é€”ç»ç‚¹
      if (item.waypoints && item.waypoints.length > 0) {
        Column({ space: 6 }) {
          Text('ðŸ“ é€”ç»ç‚¹')
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#374151')
            .width('100%')

          Column({ space: 4 }) {
            ForEach(item.waypoints, (waypoint: string, index: number) => {
              Row({ space: 6 }) {
                Text(`${index + 1}`)
                  .fontSize(12)
                  .fontColor(Color.White)
                  .backgroundColor('#6366f1')
                  .width(20)
                  .height(20)
                  .borderRadius(10)
                  .textAlign(TextAlign.Center)
                Text(waypoint)
                  .fontSize(12)
                  .fontColor('#6b7280')
                  .layoutWeight(1)
              }
              .width('100%')
            }, (waypoint: string, index: number) => `${item.id}-waypoint-${index}`)  // æ·»åŠ keyGenerator
          }
        }
        .width('100%')
        .padding(10)
        .backgroundColor('#f9fafb')
        .borderRadius(8)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/activity/ActivityDetailPage',
        params: { id: item.id, type: 'route' }
      }).catch((error: Error) => {
        console.error('è·³è½¬å¤±è´¥:', error.message);
      });
    })
  }
}

