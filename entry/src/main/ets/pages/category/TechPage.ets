import { router } from '@kit.ArkUI';
import { TopNavigationBar } from '../../components/TopNavigationBar';
import { RecommendationSection, RecommendationItem } from '../../components/RecommendationSection';
import { RecommendationService } from '../../services/RecommendationService';
import { ErrorHandler } from '../../utils/ErrorHandler';

interface TechItem {
  id: string;
  name: string;
  image: string;
  description: string;
  tags: string[];
  location: string;
  type: 'ARä½“éªŒ' | 'VRä½“éªŒ' | 'æ™ºèƒ½å¯¼è§ˆ' | 'ç§‘æŠ€å±•è§ˆ' | 'æ•°å­—äº’åŠ¨';
}

@Entry
@Component
export struct TechPage {
  @State techList: TechItem[] = [
    {
      id: '1',
      name: 'ARå®žæ™¯å¯¼èˆª',
      image: 'https://picsum.photos/id/331/400/300',
      description: 'ä½¿ç”¨ARæŠ€æœ¯æä¾›å®žæ™¯å¯¼èˆªæœåŠ¡ï¼Œè®©æ—…è¡Œæ›´æ™ºèƒ½',
      tags: ['AR', 'å¯¼èˆª', 'æ™ºèƒ½'],
      location: 'å…¨åŸŽè¦†ç›–',
      type: 'ARä½“éªŒ'
    },
    {
      id: '2',
      name: 'VRè™šæ‹Ÿæ—…æ¸¸',
      image: 'https://picsum.photos/id/332/400/300',
      description: 'é€šè¿‡VRæŠ€æœ¯ä½“éªŒè™šæ‹Ÿæ—…æ¸¸ï¼Œæå‰æ„Ÿå—æ™¯ç‚¹é­…åŠ›',
      tags: ['VR', 'è™šæ‹Ÿ', 'ä½“éªŒ'],
      location: 'å„å¤§æ™¯ç‚¹',
      type: 'VRä½“éªŒ'
    },
    {
      id: '3',
      name: 'æ™ºèƒ½è¯­éŸ³å¯¼è§ˆ',
      image: 'https://picsum.photos/id/333/400/300',
      description: 'AIæ™ºèƒ½è¯­éŸ³å¯¼è§ˆï¼Œæä¾›ä¸ªæ€§åŒ–è®²è§£æœåŠ¡',
      tags: ['AI', 'è¯­éŸ³', 'å¯¼è§ˆ'],
      location: 'ä¸»è¦æ™¯ç‚¹',
      type: 'æ™ºèƒ½å¯¼è§ˆ'
    },
    {
      id: '4',
      name: 'ç§‘æŠ€å±•è§ˆé¦†',
      image: 'https://picsum.photos/id/334/400/300',
      description: 'å±•ç¤ºæœ€æ–°ç§‘æŠ€äº§å“ï¼Œä½“éªŒå‰æ²¿ç§‘æŠ€',
      tags: ['å±•è§ˆ', 'ç§‘æŠ€', 'äº’åŠ¨'],
      location: 'ç§‘æŠ€é¦†',
      type: 'ç§‘æŠ€å±•è§ˆ'
    },
    {
      id: '5',
      name: 'æ•°å­—äº’åŠ¨ä½“éªŒ',
      image: 'https://picsum.photos/id/335/400/300',
      description: 'å¤šåª’ä½“æ•°å­—äº’åŠ¨ä½“éªŒï¼Œæ²‰æµ¸å¼æ„Ÿå—',
      tags: ['äº’åŠ¨', 'æ•°å­—', 'æ²‰æµ¸'],
      location: 'å„å¤§å±•é¦†',
      type: 'æ•°å­—äº’åŠ¨'
    }
  ];

  @State searchKeyword: string = '';
  @State recommendations: RecommendationItem[] = [];
  @State selectedCategory: string = 'å…¨éƒ¨';

  aboutToAppear() {
    this.loadRecommendations();
  }

  private loadRecommendations() {
    this.recommendations = RecommendationService.getTechRecommendations();
  }

  build() {
    Column() {
      TopNavigationBar({
        title: 'ç§‘æŠ€ä½“éªŒ',
        showBack: true,
        showSearch: true
      })

      // æœç´¢æ 
      TextInput({ placeholder: 'æœç´¢ç§‘æŠ€ä½“éªŒ...' })
        .width('90%')
        .height(40)
        .margin({ top: 12, bottom: 16 })
        .borderRadius(20)
        .backgroundColor('#f5f5f5')
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
        })

      // åˆ†ç±»ç­›é€‰
      this.CategoryFilter()

      // æŽ¨èåŒºåŸŸ
      if (this.recommendations.length > 0) {
        RecommendationSection({
          title: 'ðŸ”¥ çƒ­é—¨ç§‘æŠ€ä½“éªŒ',
          items: this.recommendations,
          categoryType: 'tech'
        })
      }

      // ç§‘æŠ€ä½“éªŒåˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.filteredTechList ?? [], (item: TechItem) => {
            this.TechCard(item)
          }, (item: TechItem) => item.id)  // æ·»åŠ keyGenerator
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc')
  }

  get filteredTechList(): TechItem[] {
    if (!this.techList || !Array.isArray(this.techList)) {
      return [];
    }
    
    let filtered = this.techList;
    
    // åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(item => item.type === this.selectedCategory);
    }
    
    // æœç´¢ç­›é€‰
    if (this.searchKeyword) {
      filtered = filtered.filter(item => 
        item.name.includes(this.searchKeyword) ||
        (item.tags ?? []).some(tag => tag.includes(this.searchKeyword)) ||
        item.type.includes(this.searchKeyword) ||
        item.location.includes(this.searchKeyword)
      );
    }
    
    return filtered;
  }

  @Builder TechCard(item: TechItem) {
    Row() {
      Image(item.image)
        .width(100)
        .height(100)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)

      Column({ space: 8 }) {
        Row() {
          Text(item.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .layoutWeight(1)

          Text(item.type)
            .fontSize(11)
            .fontColor('#8b5cf6')
            .backgroundColor('#f3e8ff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(4)
        }
        .width('100%')

        Text(item.description)
          .fontSize(13)
          .fontColor('#6b7280')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row({ space: 6 }) {
          ForEach((item.tags ?? []), (tag: string, index: number) => {
            Text(tag)
              .fontSize(11)
              .fontColor('#8b5cf6')
              .backgroundColor('#ede9fe')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(4)
          }, (tag: string, index: number) => `${item.id}-tag-${index}`)  // æ·»åŠ keyGenerator
        }
        .width('100%')

        Row({ space: 4 }) {
          Text('ðŸ“')
            .fontSize(12)
          Text(item.location)
            .fontSize(12)
            .fontColor('#6b7280')
        }
        .width('100%')
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      ErrorHandler.safeExecute(async (): Promise<void> => {
        await router.pushUrl({
          url: 'pages/activity/ActivityDetailPage',
          params: { id: item.id, type: 'tech' }
        });
      }, (error: Error): void => ErrorHandler.handleRouterError(error, 'ç§‘æŠ€ä½“éªŒè¯¦æƒ…'));
    })
  }

  @Builder CategoryFilter() {
    Scroll() {
      Row({ space: 8 }) {
        ForEach(['å…¨éƒ¨', 'ARä½“éªŒ', 'VRä½“éªŒ', 'æ™ºèƒ½å¯¼è§ˆ', 'ç§‘æŠ€å±•è§ˆ', 'æ•°å­—äº’åŠ¨'], (category: string) => {
          Text(category)
            .fontSize(14)
            .fontColor(this.selectedCategory === category ? Color.White : '#6366f1')
            .backgroundColor(this.selectedCategory === category ? '#6366f1' : '#eef2ff')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(16)
            .onClick(() => {
              this.selectedCategory = category;
            })
        }, (category: string) => `category-${category}`)  // æ·»åŠ keyGenerator
      }
      .padding({ left: 16, right: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .margin({ bottom: 16 })
  }
}

